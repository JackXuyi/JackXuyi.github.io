<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>奔跑的蜗牛</title>
  
  <subtitle>奔跑的蜗牛</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2022-01-02T08:16:00.334Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>奔跑的蜗牛</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>antd中form表单联动</title>
    <link href="http://yoursite.com/2022/01/02/antd%E4%B8%ADform%E8%A1%A8%E5%8D%95%E8%81%94%E5%8A%A8/"/>
    <id>http://yoursite.com/2022/01/02/antd中form表单联动/</id>
    <published>2022-01-02T15:19:35.000Z</published>
    <updated>2022-01-02T08:16:00.334Z</updated>
    
    <content type="html"><![CDATA[<p>日常开发过程中，经常涉及到 <code>form</code> 表单的联动，在 <code>A</code> 选项中的某个值选中时出现 <code>BCE</code> 选项，其它值选中时不显示</p><p><img src="/images/form/form-a.png" alt="选中 A 时无选项"></p><p>切换选项后新增选项</p><p><img src="/images/form/form-a-more.jpg" alt="切换选项后新增选项"></p><h3 id="监听选项的-onChange-事件实现"><a href="#监听选项的-onChange-事件实现" class="headerlink" title="监听选项的 onChange 事件实现"></a>监听选项的 <code>onChange</code> 事件实现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">export function CustomForm() &#123;</span><br><span class="line">  const [a, setA] = useState()</span><br><span class="line">  return (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;Form.Item name=&quot;testa&quot;&gt;</span><br><span class="line">        &lt;Radio.Group onChange=&#123;(e) =&gt; setA(e.target.value)&#125;&gt;</span><br><span class="line">          &lt;Radio value=&quot;A&quot;&gt;A&lt;/Radio&gt;</span><br><span class="line">          &lt;Radio value=&quot;B&quot;&gt;B&lt;/Radio&gt;</span><br><span class="line">        &lt;/Radio.Group&gt;</span><br><span class="line">      &lt;/Form.Item&gt;</span><br><span class="line">      &#123;a === &apos;B&apos; &amp;&amp; &lt;Form.Item name=&quot;testb&quot;&gt;表单项&lt;/Form.Item&gt;&#125;</span><br><span class="line">    &lt;/&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过监听表单项的 <code>onChange</code> 事件来修改 <code>state</code> ，<code>state</code> 值来驱动表单项的显示，官方已不建议在 form 表单中使用 <code>onChange</code> 事件</p><h3 id="监听表单的-onValuesChange-事件实现"><a href="#监听表单的-onValuesChange-事件实现" class="headerlink" title="监听表单的 onValuesChange 事件实现"></a>监听表单的 <code>onValuesChange</code> 事件实现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">export function CustomForm() &#123;</span><br><span class="line">  const [a, setA] = useState()</span><br><span class="line">  return (</span><br><span class="line">    &lt;Form</span><br><span class="line">      onValuesChange=&#123;(_, values) =&gt; &#123;</span><br><span class="line">        const &#123; testa &#125; = values</span><br><span class="line">        setA(testa)</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;Form.Item name=&quot;testa&quot;&gt;</span><br><span class="line">        &lt;Radio.Group&gt;</span><br><span class="line">          &lt;Radio value=&quot;A&quot;&gt;A&lt;/Radio&gt;</span><br><span class="line">          &lt;Radio value=&quot;B&quot;&gt;B&lt;/Radio&gt;</span><br><span class="line">        &lt;/Radio.Group&gt;</span><br><span class="line">      &lt;/Form.Item&gt;</span><br><span class="line">      &#123;a === &apos;B&apos; &amp;&amp; &lt;Form.Item name=&quot;testb&quot;&gt;表单项&lt;/Form.Item&gt;&#125;</span><br><span class="line">    &lt;/Form&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过监听表单的 <code>onValuesChange</code> 事件来修改 <code>state</code> ，<code>state</code> 值来驱动表单项的显示</p><h3 id="自定义组件-children-的渲染实现"><a href="#自定义组件-children-的渲染实现" class="headerlink" title="自定义组件 children 的渲染实现"></a>自定义组件 <code>children</code> 的渲染实现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">export function Advertise(props: RadioGroupProps) &#123;</span><br><span class="line">  const &#123; value, children, defaultValue, ...otherProps &#125; = props</span><br><span class="line">  const isShowChildren =</span><br><span class="line">    (isUndefined(value) &amp;&amp; defaultValue === 1) || value === 1</span><br><span class="line">  return (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;Radio.Group &#123;...otherProps&#125; value=&#123;value&#125; defaultValue=&#123;defaultValue&#125;&gt;</span><br><span class="line">        &#123;AdActList.map((item) =&gt; (</span><br><span class="line">          &lt;Radio key=&#123;item.value&#125; value=&#123;item.value&#125;&gt;</span><br><span class="line">            &#123;item.label&#125;</span><br><span class="line">          &lt;/Radio&gt;</span><br><span class="line">        ))&#125;</span><br><span class="line">      &lt;/Radio.Group&gt;</span><br><span class="line">      &#123;isShowChildren &amp;&amp; children&#125;</span><br><span class="line">    &lt;/&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过自定义的表单驱动其它元素的渲染，把逻辑收束到组件内</p><h5 id="提示：参考-antd-官方文档实现子定义表单控件"><a href="#提示：参考-antd-官方文档实现子定义表单控件" class="headerlink" title="提示：参考 antd 官方文档实现子定义表单控件"></a>提示：参考 <code>antd</code> 官方文档实现子定义表单控件</h5><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://ant.design/components/form-cn/" target="_blank" rel="noopener">antd form 表单</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;日常开发过程中，经常涉及到 &lt;code&gt;form&lt;/code&gt; 表单的联动，在 &lt;code&gt;A&lt;/code&gt; 选项中的某个值选中时出现 &lt;code&gt;BCE&lt;/code&gt; 选项，其它值选中时不显示&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/form/form-a.pn
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="antd" scheme="http://yoursite.com/tags/antd/"/>
    
      <category term="form" scheme="http://yoursite.com/tags/form/"/>
    
  </entry>
  
  <entry>
    <title>chorme插件开发（一）</title>
    <link href="http://yoursite.com/2021/12/12/chorme%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://yoursite.com/2021/12/12/chorme插件开发（一）/</id>
    <published>2021-12-12T15:10:30.000Z</published>
    <updated>2021-12-12T09:39:51.848Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>谷歌浏览器插件是一种小型的用于定制浏览器体验的程序。每个插件必须在根目录包含 <code>manifest.json</code> 来描述插件，其文件结构如下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">| 插件根目录</span><br><span class="line">|--- manifest.json // 插件描述文件</span><br><span class="line">|--- 其它文件（图标、js 、css 等）</span><br></pre></td></tr></table></figure><h4 id="manifest-json"><a href="#manifest-json" class="headerlink" title="manifest.json"></a><code>manifest.json</code></h4><p>用来描述插件信息，声明插件需要的权限及相关功能的路径</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 必须</span></span><br><span class="line">  <span class="attr">"manifest_version"</span>: <span class="number">3</span>, <span class="comment">// 插件版本，建议使用最新版本 v3</span></span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"My Extension"</span>, <span class="comment">// 插件名称</span></span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"versionString"</span>, <span class="comment">// 插件版本</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Recommended</span></span><br><span class="line">  "action": &#123;...&#125;,</span><br><span class="line">  "default_locale": "en", // 默认语言</span><br><span class="line">  "description": "A plain text description", // 插件描述</span><br><span class="line">  "icons": &#123;...&#125;, // 插件图标</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Optional</span></span><br><span class="line">  "author": ..., // 作者</span><br><span class="line">  "automation": ..., //</span><br><span class="line">  "background": &#123;</span><br><span class="line">    <span class="comment">// Required</span></span><br><span class="line">    "service_worker": "background.js", // background js</span><br><span class="line">    <span class="comment">// Optional</span></span><br><span class="line">    "type": ...</span><br><span class="line">  &#125;,</span><br><span class="line"><span class="comment">//   "chrome_settings_overrides": &#123;...&#125;, // 已不再支持</span></span><br><span class="line"><span class="comment">//   "chrome_url_overrides": &#123;...&#125;, //  已不再支持</span></span><br><span class="line">  "commands": &#123;...&#125;, // 插件自定义右键菜单</span><br><span class="line">  "content_capabilities": ...,</span><br><span class="line">  "content_scripts": [&#123;...&#125;], // web 页面上下文中执行的 js ，可通过其实现页面与插件其它 js 的通信</span><br><span class="line">  "content_security_policy": &#123;...&#125;, // 安全策略</span><br><span class="line"><span class="comment">//   "converted_from_user_script": ...,</span></span><br><span class="line"><span class="comment">//   "cross_origin_embedder_policy": &#123;"value": "require-corp"&#125;,</span></span><br><span class="line"><span class="comment">//   "cross_origin_opener_policy": &#123;"value": "same-origin"&#125;,</span></span><br><span class="line"><span class="comment">//   "current_locale": ...,</span></span><br><span class="line"><span class="comment">//   "declarative_net_request": ...,</span></span><br><span class="line">  "devtools_page": "devtools.html", // 自定义的开发者工具页面</span><br><span class="line"><span class="comment">//   "differential_fingerprint": ...,</span></span><br><span class="line"><span class="comment">//   "event_rules": [&#123;...&#125;],</span></span><br><span class="line"><span class="comment">//   "externally_connectable": &#123;</span></span><br><span class="line"><span class="comment">//     "matches": ["*://*.example.com/*"]</span></span><br><span class="line"><span class="comment">//   &#125;,</span></span><br><span class="line"><span class="comment">//   "file_browser_handlers": [...],</span></span><br><span class="line"><span class="comment">//   "file_system_provider_capabilities": &#123;</span></span><br><span class="line"><span class="comment">//     "configurable": true,</span></span><br><span class="line"><span class="comment">//     "multiple_mounts": true,</span></span><br><span class="line"><span class="comment">//     "source": "network"</span></span><br><span class="line"><span class="comment">//   &#125;,</span></span><br><span class="line">  "homepage_url": "https://path/to/homepage", // 插件首页</span><br><span class="line"><span class="comment">//   "host_permissions": [...],</span></span><br><span class="line"><span class="comment">//   "import": [&#123;"id": "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"&#125;],</span></span><br><span class="line"><span class="comment">//   "incognito": "spanning, split, or not_allowed",</span></span><br><span class="line"><span class="comment">//   "input_components": ...,</span></span><br><span class="line"><span class="comment">//   "key": "publicKey",</span></span><br><span class="line"><span class="comment">//   "minimum_chrome_version": "versionString",</span></span><br><span class="line"><span class="comment">//   "nacl_modules": [...],</span></span><br><span class="line"><span class="comment">//   "natively_connectable": ...,</span></span><br><span class="line"><span class="comment">//   "oauth2": ...,</span></span><br><span class="line"><span class="comment">//   "offline_enabled": true,</span></span><br><span class="line"><span class="comment">//   "omnibox": &#123;</span></span><br><span class="line"><span class="comment">//     "keyword": "aString"</span></span><br><span class="line"><span class="comment">//   &#125;,</span></span><br><span class="line">  "optional_permissions": ["tabs"], // 可选的权限</span><br><span class="line">  "options_page": "options.html", // option 页面</span><br><span class="line">  "options_ui": &#123;</span><br><span class="line">    "chrome_style": true,</span><br><span class="line">    "page": "options.html"</span><br><span class="line">  &#125;,</span><br><span class="line">  "permissions": ["tabs"], // 插件需要的权限，需要在这里声明之后才能使用相关权限</span><br><span class="line"><span class="comment">//   "platforms": ...,</span></span><br><span class="line"><span class="comment">//   "replacement_web_app": ...,</span></span><br><span class="line"><span class="comment">//   "requirements": &#123;...&#125;,</span></span><br><span class="line"><span class="comment">//   "sandbox": [...],</span></span><br><span class="line"><span class="comment">//   "short_name": "Short Name",</span></span><br><span class="line"><span class="comment">//   "storage": &#123;</span></span><br><span class="line"><span class="comment">//     "managed_schema": "schema.json"</span></span><br><span class="line"><span class="comment">//   &#125;,</span></span><br><span class="line"><span class="comment">//   "system_indicator": ...,</span></span><br><span class="line"><span class="comment">//   "tts_engine": &#123;...&#125;,</span></span><br><span class="line"><span class="comment">//   "update_url": "https://path/to/updateInfo.xml",</span></span><br><span class="line"><span class="comment">//   "version_name": "aString",</span></span><br><span class="line"><span class="comment">//   "web_accessible_resources": [...]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="content-scripts"><a href="#content-scripts" class="headerlink" title="content_scripts"></a><code>content_scripts</code></h5><p><code>Chrome</code> 插件中向页面注入脚本的一种形式（虽然名为 <code>script</code>，其实还可以包括 <code>css</code> 的），借助 <code>content-scripts</code> 我们可以实现通过配置的方式轻松向指定页面注入 <code>JS</code> 和 <code>CSS</code></p><h5 id="background"><a href="#background" class="headerlink" title="background"></a><code>background</code></h5><p>一个常驻的页面，它的生命周期是插件中所有类型页面中最长的，它随着浏览器的打开而打开，随着浏览器的关闭而关闭，所以通常把需要一直运行的、启动就运行的、全局的代码放在 <code>background</code> 里面。</p><h5 id="popup"><a href="#popup" class="headerlink" title="popup"></a><code>popup</code></h5><p>点击 <code>browser_action</code> 或者 <code>page_action</code> 图标时打开的一个小窗口网页，焦点离开网页就立即关闭，一般用来做一些临时性的交互。</p><h5 id="homepage-url"><a href="#homepage-url" class="headerlink" title="homepage_url"></a><code>homepage_url</code></h5><p>开发者或者插件主页设置</p><h3 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h3><ol><li>创建好插件文件夹，添加 <code>manifest.json</code>，输入如下内容</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"manifest_version"</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"插件测试"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"0.0.1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>在浏览器中访问 <code>chrome://extensions</code>，打开开发者模式。<br><img src="/images/chrome/plugins-develop-mode.png" alt="charles 代理转发"></li><li>加载解压的插件<br><img src="/images/chrome/plugins-develop-load.png" alt="charles 代理转发"></li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://www.cnblogs.com/liuxianan/p/chrome-plugin-develop.html" target="_blank" rel="noopener">【干货】Chrome 插件(扩展)开发全攻略</a></li><li><a href="https://developer.chrome.com/docs/extensions/mv3/manifest/" target="_blank" rel="noopener">manifest 文件概览</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;概览&quot;&gt;&lt;a href=&quot;#概览&quot; class=&quot;headerlink&quot; title=&quot;概览&quot;&gt;&lt;/a&gt;概览&lt;/h3&gt;&lt;p&gt;谷歌浏览器插件是一种小型的用于定制浏览器体验的程序。每个插件必须在根目录包含 &lt;code&gt;manifest.json&lt;/code&gt; 来描述插
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="浏览器" scheme="http://yoursite.com/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/"/>
    
      <category term="插件" scheme="http://yoursite.com/tags/%E6%8F%92%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>代理</title>
    <link href="http://yoursite.com/2021/10/24/%E4%BB%A3%E7%90%86/"/>
    <id>http://yoursite.com/2021/10/24/代理/</id>
    <published>2021-10-23T21:30:23.000Z</published>
    <updated>2021-10-23T14:50:41.234Z</updated>
    
    <content type="html"><![CDATA[<p>前端开发时，需要 <code>mock</code> 或请求对应的数据，选择一种合适的方式获取数据可以大大提高开发效率</p><h2 id="获取数据方式"><a href="#获取数据方式" class="headerlink" title="获取数据方式"></a>获取数据方式</h2><h3 id="本地-mock"><a href="#本地-mock" class="headerlink" title="本地 mock"></a>本地 mock</h3><ul><li>页面接口请求到达 <code>dev server</code> 之后会转发到 <code>mock</code> 服务上，然后返回 <code>mock</code> 数据</li><li>页面静态资源请求会到达 <code>dev server</code> ，然后直接返回静态资源</li></ul><p><img src="/images/api/dev_server_mock.svg" alt="本地 mock 数据请求流程"></p><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul><li><code>mock</code> 数据只需要配置一次，无需后续的额外操作</li></ul><h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul><li>无法服用线上接口数据</li><li>项目中可能会出现许多 <code>mock</code> 数据相关的代码</li><li>接口之间无关联性</li></ul><h3 id="直接请求线上数据"><a href="#直接请求线上数据" class="headerlink" title="直接请求线上数据"></a>直接请求线上数据</h3><ul><li>页面静态资源请求会到达 <code>dev server</code> ，然后直接返回静态资源</li><li>通过绝对地址或者浏览器代理的方式转发请求到线上服务</li></ul><p><img src="/images/api/online_server.svg" alt="直接请求线上数据"></p><h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><ul><li>通过硬编码绝对路径的方式对代码入侵较大，可以通过浏览器代理插件的方式实现对接口的转发</li><li>当接口需要登陆时，可在浏览器插件中实现注入对应环境 <code>cookie</code> 的功能</li></ul><h4 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h4><ul><li>可以复用线上接口数据</li><li>接口之间存在联动和业务逻辑</li></ul><h4 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h4><ul><li>需要安装额外的插件</li><li>需要在项目之外做额外的配置</li></ul><h3 id="devServer-代理转发"><a href="#devServer-代理转发" class="headerlink" title="devServer 代理转发"></a>devServer 代理转发</h3><ul><li>页面静态资源请求会到达 <code>dev server</code> ，然后直接返回静态资源</li><li>通过 <code>dve server</code> 把接口代理转发到对应服务上</li></ul><p><img src="/images/api/dev_server_proxy.svg" alt="devServer 代理转发请求线上数据"></p><h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h4><ul><li>当接口需要登陆时，可在浏览器插件中实现把对应环境 <code>cookie</code> 注入到开发服务页面下的功能</li></ul><h4 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h4><ul><li>可以复用线上接口数据</li><li>接口之间存在联动和业务逻辑</li></ul><h4 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h4><ul><li>需要安装额外的插件</li><li>需要在项目之外做额外的配置</li></ul><h3 id="charles-代理转发"><a href="#charles-代理转发" class="headerlink" title="charles 代理转发"></a>charles 代理转发</h3><ul><li>页面静态资源会按照规则转发到 <code>dev server</code>上，然后直接返回静态资源</li><li>接口请求会按照规则转发到远端服务</li></ul><p><img src="/images/api/charles_proxy.svg" alt="charles 代理转发"></p><h4 id="问题-2"><a href="#问题-2" class="headerlink" title="问题"></a>问题</h4><ul><li>当接口需要登陆时，本地服务转发需要先注入对应环境的 <code>cookie</code> 才可以请求</li></ul><h4 id="优点-3"><a href="#优点-3" class="headerlink" title="优点"></a>优点</h4><ul><li>可以复用线上接口数据</li><li>接口之间存在联动和业务逻辑</li><li>便于切换环境和账号</li></ul><h4 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h4><ul><li>需要安装额外的软件</li><li>需要学习 charles 相关的配置</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;前端开发时，需要 &lt;code&gt;mock&lt;/code&gt; 或请求对应的数据，选择一种合适的方式获取数据可以大大提高开发效率&lt;/p&gt;
&lt;h2 id=&quot;获取数据方式&quot;&gt;&lt;a href=&quot;#获取数据方式&quot; class=&quot;headerlink&quot; title=&quot;获取数据方式&quot;&gt;&lt;/a&gt;获
      
    
    </summary>
    
    
      <category term="node" scheme="http://yoursite.com/tags/node/"/>
    
      <category term="计算机网络" scheme="http://yoursite.com/tags/network/"/>
    
  </entry>
  
  <entry>
    <title>计算机网络-DNS</title>
    <link href="http://yoursite.com/2021/08/16/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-DNS/"/>
    <id>http://yoursite.com/2021/08/16/计算机网络-DNS/</id>
    <published>2021-08-15T23:05:40.000Z</published>
    <updated>2021-10-23T12:30:00.059Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>通常通过 <code>baidu.com</code> 访问百度的服务，这个 <code>baidu.com</code> 就是百度持有的域名（Domain Name），然而在网络中能够识别的只有 <code>IP</code> ，那就需要把域名转化为对应的 <code>IP</code> 地址。</p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><code>DNS</code> 全名叫做 <code>Domain Name System</code>, 中文叫做 <code>域名服务系统</code>，主要作用是把域名转化为网络中对应的 <code>IP</code> 地址。</p><h2 id="工作原理（以浏览器为例）"><a href="#工作原理（以浏览器为例）" class="headerlink" title="工作原理（以浏览器为例）"></a>工作原理（以浏览器为例）</h2><p><img src="/images/network/dns.svg" alt="浏览器解析域名流程"></p><ol><li>浏览器解析出地址栏中的域名</li><li>在浏览器缓存中查找是否有缓存此域名的地址</li><li>在系统中是否有缓存此域名的地址</li><li>通过 <code>UDP</code> 的方式向系统中配置的 <code>DNS</code> 服务器查找域名对应的 <code>IP</code> 地址</li><li><code>DNS</code> 服务器通过 <code>UDP</code> 向根域名服务器查找域名地址，根域名服务器返回下一个查找的顶级域名服务器的 <code>IP</code> 地址</li><li><code>DNS</code> 服务器通过 <code>UDP</code> 向顶级域名服务器查找域名地址，顶级域名服务器返回下一个查找域名服务器的 <code>IP</code> 地址，不断查找，直到找到域名对应的 <code>IP</code> 地址为止</li><li><code>DNS</code> 服务器返回域名服务器的地址</li></ol><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul><li>域名分别在浏览器、操作系统、域名服务器三个层级做了缓存以提高访问速度</li><li>获取域名时浏览器调用了操作系统的能力委托操作系统到操作系统配置的域名服务器上进行域名查找</li><li>浏览器通过递归的方式分别去浏览器、操作系统和域名服务器上查找，而域名服务器是通过迭代的方式去各级域名服务器上进行查找的</li></ul><h3 id="各层级域名节点"><a href="#各层级域名节点" class="headerlink" title="各层级域名节点"></a>各层级域名节点</h3><ul><li>域名服务器具有层级关系</li><li>每个层级的域名服务器都存储了根域名服务器的地址信息，这样方便快速查找域名服务的信息</li><li>每个层级的域名服务器都需要注册到其对应的上一级域名服务器中</li></ul><p><img src="/images/network/dns-node.svg" alt="域名服务器节点关系图"></p><h2 id="域名服务数据更新"><a href="#域名服务数据更新" class="headerlink" title="域名服务数据更新"></a>域名服务数据更新</h2><p>当域名服务系统数据有变化时就需要去更新对应的数据</p><ul><li>当根域名服务器地址有变化时，各级域名服务需要通过 <code>TCP</code> 的方式更新对应的数据</li><li>当有新的子域名服务器注册或者域名信息注销时需要子域名通过 <code>TCP</code> 的方式把更新信息同步到当前域名服务</li></ul><p><img src="/images/network/dns-update.svg" alt="域名服务器更新数据图"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;通常通过 &lt;code&gt;baidu.com&lt;/code&gt; 访问百度的服务，这个 &lt;code&gt;baidu.com&lt;/code&gt; 就是百度持有的域
      
    
    </summary>
    
    
      <category term="计算机网络" scheme="http://yoursite.com/tags/network/"/>
    
  </entry>
  
  <entry>
    <title>服务端渲染</title>
    <link href="http://yoursite.com/2021/08/08/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93/"/>
    <id>http://yoursite.com/2021/08/08/服务端渲染/</id>
    <published>2021-08-08T13:14:02.000Z</published>
    <updated>2021-08-08T07:50:34.001Z</updated>
    
    <content type="html"><![CDATA[<h2 id="同构应用"><a href="#同构应用" class="headerlink" title="同构应用"></a>同构应用</h2><h3 id="环境区分"><a href="#环境区分" class="headerlink" title="环境区分"></a>环境区分</h3><p>服务端和客户端所处环境有些许区别，打包时要根据不同环境打包出对应的资源</p><h4 id="路由代码"><a href="#路由代码" class="headerlink" title="路由代码"></a>路由代码</h4><ul><li>服务端从请求对象中获取路径，需要先从请求对象中提取出路径之后再通过上下文传递进应用之中</li><li>客户端从全局路由对象中获取路径进行匹配</li></ul><h4 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h4><ul><li>服务端的依赖可以直接从依赖中获取，而客户端则需要把所有依赖打包到对应的 <code>chunk</code> 中</li><li>服务端不关心样式问题，而客户端需要加载对应的样式</li><li>分环境进行打包时，会导致部分资源重复打包和覆盖</li></ul><h3 id="注水和脱水"><a href="#注水和脱水" class="headerlink" title="注水和脱水"></a>注水和脱水</h3><p>服务端渲染时可能会通过接口请求数据，并保存准备好的数据状态，避免客户端做重复的请求</p><ul><li>脱水：服务端返回 <code>HTML</code> 时需要把数据状态通过字符串的形式保存在 <code>HTML</code> 字符串中。</li><li>注水：客户端通过 <code>HTML</code> 中格式化后的数据初始化状态。</li></ul><h4 id="服务端请求"><a href="#服务端请求" class="headerlink" title="服务端请求"></a>服务端请求</h4><ul><li>通过配置文件的方式统一声明服务端需要请求的数据</li><li>通过组件静态方法统一处理请求（需要框架遍历每个组件的属性去请求数据）</li></ul><h3 id="请求认证"><a href="#请求认证" class="headerlink" title="请求认证"></a>请求认证</h3><p>服务端请求时不会自动携带客户端传递来的信息（例如 <code>cookie</code>） ，需要手动把请求中的字段提取出来放入服务端的请求中</p><h3 id="样式处理"><a href="#样式处理" class="headerlink" title="样式处理"></a>样式处理</h3><p>服务端渲染时不需要样式，但是客户端渲染时需要处理样式问题，若通过外部引入会造成在客户端样式的抖动</p><h3 id="meta-tags-处理"><a href="#meta-tags-处理" class="headerlink" title="meta tags 处理"></a>meta tags 处理</h3><p>客户端和服务端渲染时有时需要动态修改 <code>head</code> 里的信息（SEO）</p><h3 id="404-处理"><a href="#404-处理" class="headerlink" title="404 处理"></a>404 处理</h3><p>当服务端匹配不到页面时，应该返回一个 <code>404</code> 的状态码和对应的内容</p><h3 id="安全问题"><a href="#安全问题" class="headerlink" title="安全问题"></a>安全问题</h3><p>上述注水和脱水过程中容易存在 <code>script</code> 脚本注入的风险，在序列化之前需要对对象做转义</p><h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><ul><li>缓存</li><li>单服务改为服务集群</li><li>服务压力过大时改成客户端渲染</li><li>升级 <code>Nodejs</code></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;同构应用&quot;&gt;&lt;a href=&quot;#同构应用&quot; class=&quot;headerlink&quot; title=&quot;同构应用&quot;&gt;&lt;/a&gt;同构应用&lt;/h2&gt;&lt;h3 id=&quot;环境区分&quot;&gt;&lt;a href=&quot;#环境区分&quot; class=&quot;headerlink&quot; title=&quot;环境区分&quot;&gt;&lt;/a
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="react" scheme="http://yoursite.com/tags/react/"/>
    
      <category term="node" scheme="http://yoursite.com/tags/node/"/>
    
  </entry>
  
  <entry>
    <title>简易的express中间件</title>
    <link href="http://yoursite.com/2021/08/07/%E7%AE%80%E6%98%93%E7%9A%84express%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    <id>http://yoursite.com/2021/08/07/简易的express中间件/</id>
    <published>2021-08-07T14:51:11.000Z</published>
    <updated>2021-08-07T07:39:05.806Z</updated>
    
    <content type="html"><![CDATA[<h2 id="express"><a href="#express" class="headerlink" title="express"></a>express</h2><p>基于 <code>Node.js</code> 平台，快速、开放、极简的 <code>Web</code> 开发框架</p><h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><p>从请求到相应过程中执行的一系列函数被称为中间件，使其具有了极高的扩展性</p><h4 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="function"><span class="keyword">function</span> <span class="title">middware1</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 业务逻辑</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">'/test'</span>, <span class="function"><span class="keyword">function</span> <span class="title">middware2</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 业务逻辑</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>当请求 <code>/test</code> 时，会按照 <code>middware1</code> -&gt; <code>middware2</code> 的顺序依次执行注册的中间件</p><h4 id="简易实现"><a href="#简易实现" class="headerlink" title="简易实现"></a>简易实现</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isMathch</span>(<span class="params">source, match</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> source.startsWith(match)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = &#123;</span><br><span class="line">  middwares: [],</span><br><span class="line">  use: <span class="function"><span class="keyword">function</span> (<span class="params">path, fun</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 把注册的中间件放入 middwares 数组中</span></span><br><span class="line">    <span class="keyword">let</span> handler = fun</span><br><span class="line">    <span class="keyword">let</span> matchPath = path</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fun === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">      matchPath = <span class="string">'/'</span></span><br><span class="line">      handler = path</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.middwares.push(&#123; handler, <span class="attr">path</span>: matchPath &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  call: <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 从 middwares 中提取匹配的中间件执行</span></span><br><span class="line">    <span class="keyword">const</span> &#123; pathname = <span class="string">'/'</span> &#125; = req</span><br><span class="line">    <span class="keyword">const</span> middwares = <span class="keyword">this</span>.middwares.filter(<span class="function">(<span class="params">item</span>) =&gt;</span></span><br><span class="line">      isMathch(pathname, item.path)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">const</span> len = middwares.length</span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过 index 控制执行的中间件</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      index++</span><br><span class="line">      <span class="keyword">if</span> (index &lt; len) &#123;</span><br><span class="line">        middwares[index].handler(req, res, next)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next()</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>express 调度实现<a href="https://github.com/expressjs/express/blob/master/lib/router/route.js#L98" target="_blank" rel="noopener">链接</a></li><li>express use 实现<a href="https://github.com/expressjs/express/blob/master/lib/application.js#L187" target="_blank" rel="noopener">链接</a></li></ul><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://www.expressjs.com.cn/guide/writing-middleware.html" target="_blank" rel="noopener">expressjs</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;express&quot;&gt;&lt;a href=&quot;#express&quot; class=&quot;headerlink&quot; title=&quot;express&quot;&gt;&lt;/a&gt;express&lt;/h2&gt;&lt;p&gt;基于 &lt;code&gt;Node.js&lt;/code&gt; 平台，快速、开放、极简的 &lt;code&gt;Web&lt;/co
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="node" scheme="http://yoursite.com/tags/node/"/>
    
  </entry>
  
  <entry>
    <title>跨域</title>
    <link href="http://yoursite.com/2021/08/06/%E8%B7%A8%E5%9F%9F/"/>
    <id>http://yoursite.com/2021/08/06/跨域/</id>
    <published>2021-08-05T22:58:08.000Z</published>
    <updated>2021-08-06T14:41:22.484Z</updated>
    
    <content type="html"><![CDATA[<h2 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h2><p>当”协议+域名+端口”三者相同时，才能够相互访问资源。保证用户信息的安全，防止恶意的网站窃取数据。</p><h3 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h3><ul><li>当前域下的 <code>js</code> 脚本不能够访问其他域下的 <code>cookie</code>、<code>localStorage</code> 和 <code>indexDB</code> 等本地存储</li><li>当前域下的 <code>js</code> 脚本不能够操作访问操作其他域下的 <code>DOM</code>。</li><li>当前域下 <code>ajax</code> 无法发送跨域请求。</li></ul><h2 id="跨域访问"><a href="#跨域访问" class="headerlink" title="跨域访问"></a>跨域访问</h2><h3 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h3><p>跨域资源共享(CORS) 是一种机制，它使用额外的 HTTP 头来告诉浏览器让运行在一个 origin (domain)上的 Web 应用被准许访问来自不同源服务器上的指定的资源。当一个资源从与该资源本身所在的服务器不同的域、协议或端口请求一个资源时，资源会发起一个跨域 HTTP 请求。</p><h4 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h4><p>简单请求不会触发 CORS 预检请求。需要满足以下条件才能成为简单请求</p><h5 id="请求方法"><a href="#请求方法" class="headerlink" title="请求方法"></a>请求方法</h5><ul><li>HEAD</li><li>GET</li><li>POST</li></ul><h5 id="HTTP-的头信息"><a href="#HTTP-的头信息" class="headerlink" title="HTTP 的头信息"></a>HTTP 的头信息</h5><p>不超出以下几种字段：</p><ul><li>Accept</li><li>Accept-Language</li><li>Content-Language</li><li>Last-Event-ID</li><li>Content-Type：只限于三个值 application/x-www-form-urlencoded、multipart/form-data、text/plain</li></ul><h5 id="请求过程"><a href="#请求过程" class="headerlink" title="请求过程"></a>请求过程</h5><ol><li>浏览器会直接发出 CORS 请求，它会在请求的头信息中增加一个 Orign 字段，该字段用来说明本次请求来自哪个源（协议+端口+域名）</li><li>服务器会根据 origin 值来决定是否同意这次请求</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Access-Control-Allow-Origin:</span> <span class="string">http://api.baidu.com</span>  <span class="string">//</span> <span class="string">和</span> <span class="string">Orign</span> <span class="string">一致，必须要包含，可以为</span> <span class="string">*</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Credentials:</span> <span class="literal">true</span>   <span class="string">//</span> <span class="string">表示是否允许发送Cookie</span></span><br><span class="line"><span class="attr">Access-Control-Expose-Headers:</span> <span class="string">FooBar</span>   <span class="string">//</span> <span class="string">指定返回其他字段的值</span></span><br></pre></td></tr></table></figure><h4 id="非简单请求过程"><a href="#非简单请求过程" class="headerlink" title="非简单请求过程"></a>非简单请求过程</h4><p>在正式通信之前进行一次 HTTP 查询请求，称为预检请求</p><h5 id="请求过程-1"><a href="#请求过程-1" class="headerlink" title="请求过程"></a>请求过程</h5><ol><li>使用 <code>OPTIONS</code> 方法向服务端发起预检请求</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Access-Control-Request-Method：该字段是必须的，用来列出浏览器的</span> <span class="string">CORS</span> <span class="string">请求会用到哪些</span> <span class="string">HTTP</span> <span class="string">方法。</span></span><br><span class="line"><span class="string">Access-Control-Request-Headers：</span> <span class="string">该字段是一个逗号分隔的字符串，指定浏览器</span> <span class="string">CORS</span> <span class="string">请求会额外发送的头信息字段。</span></span><br></pre></td></tr></table></figure><ol start="2"><li>服务器在收到浏览器的预检请求之后，会根据头信息的三个字段来进行判断是否允许跨域</li></ol><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Access-Control-Allow-Origin:</span> <span class="string">http://api.baidu.com</span>  <span class="string">//</span> <span class="string">允许跨域的源地址（必须）</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Methods:</span> <span class="string">GET,</span> <span class="string">POST,</span> <span class="string">PUT</span> <span class="string">//</span> <span class="string">服务器支持的所有跨域请求的方法（必须）</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Headers:</span> <span class="string">X-Custom-Header</span>  <span class="string">//</span> <span class="string">服务器支持的所有头信息字段（必须）</span></span><br><span class="line"><span class="attr">Access-Control-Allow-Credentials:</span> <span class="literal">true</span>   <span class="string">//</span> <span class="string">表示是否允许发送Cookie</span></span><br><span class="line"><span class="attr">Access-Control-Max-Age:</span> <span class="number">1728000</span>  <span class="string">//</span> <span class="string">用来指定本次预检请求的有效期，单位为秒</span></span><br></pre></td></tr></table></figure><h5 id="Cookie-相关问题"><a href="#Cookie-相关问题" class="headerlink" title="Cookie 相关问题"></a>Cookie 相关问题</h5><ol><li>默认情况下在跨域请求，浏览器是不带 cookie 的。但是我们可以通过设置 withCredentials 来进行传递 cookie.</li><li>Access-Control-Allow-Credentials 设置为 true</li><li>Access-Control-Allow-Origin 设置为非 <code>*</code></li></ol><h3 id="JSONP"><a href="#JSONP" class="headerlink" title="JSONP"></a>JSONP</h3><p>利用<code>&lt;script&gt;</code> 标签没有跨域限制，通过<code>&lt;script&gt;</code>标签 src 属性，发送带有 callback 参数的 GET 请求，服务端将接口返回数据拼凑到 callback 函数中，返回给浏览器，浏览器解析执行，从而前端拿到 callback 函数返回的数据。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> count = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonp</span>(<span class="params">src, callback</span>) </span>&#123;</span><br><span class="line">  count++</span><br><span class="line">  <span class="keyword">const</span> functionName = <span class="string">'jsonpCallback'</span> + count</span><br><span class="line">  <span class="comment">// 回调执行函数</span></span><br><span class="line">  <span class="built_in">window</span>[functionName] = <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    callback &amp;&amp; callback(res)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</span><br><span class="line">  script.type = <span class="string">'text/javascript'</span></span><br><span class="line">  <span class="comment">// 传参一个回调函数名给后端，方便后端返回时执行这个在前端定义的回调函数</span></span><br><span class="line">  <span class="keyword">const</span> realSrc = src.includes(<span class="string">'?'</span>)</span><br><span class="line">    ? src + <span class="string">'&amp;callback='</span> + functionName</span><br><span class="line">    : src + <span class="string">'?callback='</span> + functionName</span><br><span class="line">  script.src = realSrc</span><br><span class="line">  <span class="built_in">document</span>.head.appendChild(script)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务端实现</span></span><br><span class="line">app.get(<span class="string">'/test'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; callback &#125; = req.query</span><br><span class="line">  res.send(<span class="string">`<span class="subst">$&#123;callback&#125;</span>(&#123; test: "a" &#125;)`</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>通过 <code>script</code> 标签的形式获取到的数据会被自动执行，所以通过返回回调函数调用的方式自动执行代码</p><h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul><li>具有局限性， 仅支持 get 方法</li><li>不安全，可能会遭受 XSS 攻击</li></ul><h3 id="postMessage"><a href="#postMessage" class="headerlink" title="postMessage"></a>postMessage</h3><h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul><li>页面和其打开的新窗口的数据传递</li><li>多窗口之间消息传递</li><li>页面与嵌套的 iframe 消息传递</li><li>上面三个场景的跨域数据传递</li></ul><h3 id="服务代理"><a href="#服务代理" class="headerlink" title="服务代理"></a>服务代理</h3><p>服务端转发请求</p><h3 id="document-domain-iframe"><a href="#document-domain-iframe" class="headerlink" title="document.domain + iframe"></a>document.domain + iframe</h3><p>此方案仅限主域相同，子域不同的跨域应用场景。实现原理：两个页面都通过 js 强制设置 document.domain 为基础主域，就实现了同域。</p><h3 id="location-hash-iframe"><a href="#location-hash-iframe" class="headerlink" title="location.hash + iframe"></a>location.hash + iframe</h3><p>a 欲与 b 跨域相互通信，通过中间页 c 来实现。 三个页面，不同域之间利用 iframe 的 location.hash 传值，相同域之间直接 js 访问来通信。</p><h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><ul><li>A 与 B 不同域，A 向 B 传递消息时通过修改 B 页面的 hash 值，B 监听 hash 值的变化获取数据</li><li>A 与 C 同域，B 与 A 通信时通过修改 C 页面的 hash 值，C 通过各种手段通知 A hash 值的辩护</li></ul><h3 id="window-name-iframe"><a href="#window-name-iframe" class="headerlink" title="window.name + iframe"></a>window.name + iframe</h3><p>window.name 属性的独特之处：name 值在不同的页面（甚至不同域名）加载后依旧存在，并且可以支持非常长的 name 值（2MB）。</p><h3 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h3><p>通过 <code>WebSocket</code> 服务端中转通信</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://juejin.cn/post/6916157109906341902/#heading-55" target="_blank" rel="noopener">如何解决跨越问题</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Glossary/CORS" target="_blank" rel="noopener">MDN CORS</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;同源策略&quot;&gt;&lt;a href=&quot;#同源策略&quot; class=&quot;headerlink&quot; title=&quot;同源策略&quot;&gt;&lt;/a&gt;同源策略&lt;/h2&gt;&lt;p&gt;当”协议+域名+端口”三者相同时，才能够相互访问资源。保证用户信息的安全，防止恶意的网站窃取数据。&lt;/p&gt;
&lt;h3 id=&quot;
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>术语</title>
    <link href="http://yoursite.com/2021/07/26/%E6%9C%AF%E8%AF%AD/"/>
    <id>http://yoursite.com/2021/07/26/术语/</id>
    <published>2021-07-25T22:27:21.000Z</published>
    <updated>2021-10-23T12:30:00.059Z</updated>
    
    <content type="html"><![CDATA[<h2 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h2><ul><li>进程：资源分配的最小单位</li><li>线程：CPU 调度的最小单位</li><li>协程：协程运行在线程之上，当一个协程执行完成后，可以选择主动让出，让另一个协程运行在当前线程之上。协程并没有增加线程数量，只是在线程的基础之上通过分时复用的方式运行多个协程，而且协程的切换在用户态完成，切换的代价比线程从用户态到内核态的代价小很多。</li></ul><h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><ul><li>URL: Uniform Resource Locator, 统一资源定位符</li><li>URI: Uniform Resource Identifier, 统一资源标识符</li><li>FTP: File Transfer Protocol, 文件传输协议</li><li>CGI: Common Gateway Interface, 通用网关接口</li><li>DNS: Domain Name System, 域名服务系统</li><li>协议栈: 操作系统内部的网络控制软件</li><li>MX: Mail eXchange, 邮件交换</li><li>UDP: User Datagram Protocol, 用户数据报协议</li><li>TCP: Transmission Control Protocol, 传输控制协议</li><li>ARP: Address Resolution Protocol, 地址解析协议</li><li>MTU: Maximum Transmission Unit, 最大传输单元</li><li>MSS: Maximum Segment Size, 最大分段大小</li><li>FCS: Frame Check Sequence, 帧校验序列</li><li>SFD: Start Frame Delimiter, 起始帧分界</li></ul><h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><ul><li>PaaS: Platform as a service, 平台即服务。PaaS 给用户提供的能力是使用由云服务提供商支持的编程语言、库、服务以及开发工具来创建、开发应用程序并部署在相关的基础设施上。用户无需管理底层的基础设施，包括网络、服务器，操作系统或者存储。他们只能控制部署在基础设施中操作系统上的应用程序，配置应用程序所托管的环境的可配置参数。常见的 PaaS 服务有数据库服务、web 应用以及容器服务。成熟的 PaaS 服务会简化开发人员，提供完备的 PC 端和移动端软件开发套件（SDK），拥有丰富的开发环境（Inteli、Eclipse、VS 等），完全可托管的数据库服务，可配置式的应用程序构建，支持多语言的开发，面向应用市场。</li><li>SaaS: Software as a Service, 软件即服务。SaaS 给用户提供的能力是使用在云基础架构上运行的云服务提供商的应用程序。可以通过轻量的客户端接口（诸如 web 浏览器（例如，基于 web 的电子邮件））或程序接口从各种客户端设备访问应用程序。 用户无需管理或控制底层云基础架构，包括网络，服务器，操作系统，存储甚至单独的应用程序功能，可能的例外是有限的用户特定应用程序配置设置。类似的服务有：各类的网盘(Dropbox、百度网盘等)，JIRA，GitLab 等服务。而这些应用的提供者不仅仅是云服务提供商，还有众多的第三方提供商（ISV: independent software provider）。</li><li>IaaS: Infrastructure as a service, 基础设施即服务。用户可以在云服务提供商提供的基础设施上部署和运行任何软件，包括操作系统和应用软件。用户没有权限管理和访问底层的基础设施，如服务器、交换机、硬盘等，但是有权管理操作系统、存储内容，可以安装管理应用程序，甚至是有权管理网络组件。简单的说用户使用 IaaS，有权管理操作系统之上的一切功能。我们常见的 IaaS 服务有虚拟机、虚拟网络、以及存储。</li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://zhuanlan.zhihu.com/p/172471249" target="_blank" rel="noopener">什么是协程？</a></li><li><a href="https://www.zhihu.com/question/25532384" target="_blank" rel="noopener">线程和进程的区别是什么？</a></li><li><a href="https://www.zhihu.com/question/20387284" target="_blank" rel="noopener">怎么理解 IaaS、SaaS 和 PaaS 的区别？</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;操作系统&quot;&gt;&lt;a href=&quot;#操作系统&quot; class=&quot;headerlink&quot; title=&quot;操作系统&quot;&gt;&lt;/a&gt;操作系统&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;进程：资源分配的最小单位&lt;/li&gt;
&lt;li&gt;线程：CPU 调度的最小单位&lt;/li&gt;
&lt;li&gt;协程：协程运行在线程
      
    
    </summary>
    
    
      <category term="other" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>js沙箱</title>
    <link href="http://yoursite.com/2021/07/26/js%E6%B2%99%E7%AE%B1/"/>
    <id>http://yoursite.com/2021/07/26/js沙箱/</id>
    <published>2021-07-25T21:06:01.000Z</published>
    <updated>2021-07-25T14:26:02.199Z</updated>
    
    <content type="html"><![CDATA[<p>沙箱，即 <code>sandbox</code>，顾名思义，就是让你的程序跑在一个隔离的环境下，不对外界的其他程序造成影响，通过创建类似沙盒的独立作业环境，在其内部运行的程序并不能对硬盘产生永久性的影响。</p><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul><li>解析或执行不可信的 <code>JS</code></li><li>隔离被执行代码的执行环境</li><li>对执行代码中可访问对象进行限制</li></ul><h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><h4 id="with-new-Function"><a href="#with-new-Function" class="headerlink" title="with + new Function"></a><code>with</code> + <code>new Function</code></h4><p>在 <code>with</code> 的块级作用域下，变量访问会优先查找你传入的参数对象，之后再往上找，所以相当于你变相监控到了代码中的“变量访问”，结合 <code>proxy</code> 代理可以监听所有数据的修改和访问</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxyFanctory</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> target = <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, &#123;</span><br><span class="line">    <span class="keyword">get</span>(target, p) &#123;</span><br><span class="line">      <span class="keyword">if</span> (p === <span class="built_in">Symbol</span>.unscopables) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (target[p] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> target[p]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">set</span>(target, p, value) &#123;</span><br><span class="line">      target[p] = value</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> target</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runWithSanbox</span>(<span class="params">code</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> context = proxyFanctory(&#123; <span class="attr">a</span>: <span class="string">'test'</span>, <span class="attr">b</span>: &#123;&#125; &#125;)</span><br><span class="line">  <span class="keyword">const</span> codeSrc = <span class="string">`with(sandbox)&#123;<span class="subst">$&#123;code&#125;</span>&#125;`</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Function</span>(<span class="string">'sandbox'</span>, codeSrc).call(context, context)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">runWithSanbox(</span><br><span class="line">  <span class="string">'this.b.__proto__.toString=function()&#123;console.log("__proto__.toString")&#125;;console.log(a, this)'</span></span><br><span class="line">) <span class="comment">// test Proxy &#123;a: "test"&#125;</span></span><br><span class="line"><span class="keyword">const</span> t = &#123;&#125;</span><br><span class="line">t.toString() <span class="comment">// __proto__.toString</span></span><br></pre></td></tr></table></figure><h5 id="需要解决的问题"><a href="#需要解决的问题" class="headerlink" title="需要解决的问题"></a>需要解决的问题</h5><ul><li><code>proxy</code> 无法监听深层次数据的访问，可以通过访问原型链的方式，实现沙箱逃逸（代码分析）</li><li><code>window</code> 等固有对象调用（<code>iframe</code> 创建隔离的上下文）</li></ul><h4 id="借助-iframe-实现"><a href="#借助-iframe-实现" class="headerlink" title="借助 iframe 实现"></a>借助 <code>iframe</code> 实现</h4><p><code>sandbox</code> 是 <code>h5</code> 的提出的一个新属性， 启用方式就是在 <code>iframe</code> 标签中使用 <code>sandbox</code> 属性</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">sandbox</span> <span class="attr">src</span>=<span class="string">"url"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h5><ul><li><code>script</code> 脚本不能执行， <code>allow-scripts</code> 属性</li><li>不能发送 <code>ajax</code> 请求，<code>allow-same-origin</code> 允许同域请求</li></ul><p>具体参考 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/iframe#attr-sandbox" target="_blank" rel="noopener">iframe</a></p><h4 id="Web-Worker"><a href="#Web-Worker" class="headerlink" title="Web Worker"></a><code>Web Worker</code></h4><p><code>Web Worker</code> 子线程的形式也是一种天然的沙箱隔离</p><h5 id="限制-1"><a href="#限制-1" class="headerlink" title="限制"></a>限制</h5><ul><li>出于线程安全设计考虑，<code>Web Worker</code> 不支持 <code>DOM</code> 操作，必须通过 <code>postMessage</code> 通知 <code>UI</code> 主线程来实现。</li><li><code>Web Worker</code> 无法访问 <code>window</code>、<code>document</code> 之类的浏览器全局对象。</li></ul><p>通过代理将具体的渲染实现再转发给原 <code>WorkerDomNodeImpl.js</code> 逻辑来实现 <code>DOM</code> 的实际更新。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://juejin.cn/post/6844903954074058760" target="_blank" rel="noopener">说说 JS 中的沙箱</a></li><li><a href="https://developer.aliyun.com/article/761449" target="_blank" rel="noopener">如何“取巧”实现一个微前端沙箱？</a></li><li><a href="https://www.infoq.cn/article/u9dkjjleg2hp6uqhsoii" target="_blank" rel="noopener">字节跳动的微前端沙盒实践</a></li><li><a href="https://segmentfault.com/a/1190000039795656" target="_blank" rel="noopener">浅探 Web Worker 与 JavaScript 沙箱</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;沙箱，即 &lt;code&gt;sandbox&lt;/code&gt;，顾名思义，就是让你的程序跑在一个隔离的环境下，不对外界的其他程序造成影响，通过创建类似沙盒的独立作业环境，在其内部运行的程序并不能对硬盘产生永久性的影响。&lt;/p&gt;
&lt;h3 id=&quot;使用场景&quot;&gt;&lt;a href=&quot;#使用场景&quot;
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>浏览器渲染过程详解</title>
    <link href="http://yoursite.com/2021/07/12/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3/"/>
    <id>http://yoursite.com/2021/07/12/浏览器渲染过程详解/</id>
    <published>2021-07-11T16:03:29.000Z</published>
    <updated>2021-07-11T09:46:42.335Z</updated>
    
    <content type="html"><![CDATA[<h3 id="渲染流程"><a href="#渲染流程" class="headerlink" title="渲染流程"></a>渲染流程</h3><ol><li>浏览器通过网络请求后获取 <code>html</code> 数据，通过 <code>tcp</code> 传给浏览器进程，然后浏览器进程再传递给渲染器进程</li><li><code>DOM</code> - <code>DOM</code> 结构： 主线程将 <code>html</code> 解析构造 <code>DOM</code> 树</li><li><code>style</code> - 样式： 主线程解析页面的 <code>CSS</code> 从而确定每个 <code>DOM</code> 节点的计算样式（<code>computed style</code>）。</li><li><code>layoutTree</code> - 布局树： <code>dom</code>+<code>style</code> 根据 <code>dom</code> 树和样式生成 <code>layoutTree</code></li><li><code>paint</code> - 绘制： 通过遍历 <code>Layout Tree</code> 生成绘制顺序表</li><li><code>laryer</code> - 布局： 主线程将 <code>layoutTree</code> 和绘制信息表传给合成器线程</li><li>合成器线程： 将得到的信息分图层分成更小的图块</li><li>栅格线程： 将更小的图块进行栅格化 <code>raster</code>，返还给合成器线程 <code>draw quads</code> 图块信息，存储在 <code>GPU</code> 中</li><li>合成线程会收集图块上面叫做绘画四边形（<code>draw quads</code>）的信息来构建一个合成帧（<code>compositor frame</code>）。</li><li>合成线程就会通过 <code>IPC</code> 向浏览器进程（<code>browser process</code>）提交（<code>commit</code>）一个渲染帧。</li><li>浏览器进程收到一帧的图像后传给 <code>GPU</code> 进行渲染</li></ol><h4 id="非快速滚动区域-non-fast-scrollable-region"><a href="#非快速滚动区域-non-fast-scrollable-region" class="headerlink" title="非快速滚动区域 - non-fast scrollable region"></a>非快速滚动区域 - non-fast scrollable region</h4><p>当一个页面被合成的时候，合成线程会将页面那些注册了事件监听器的区域标记为“非快速滚动区域”（<code>Non-fast Scrollable Region</code>）。当用户事件发生在这些区域时，合成线程会将输入事件发送给主线程来处理。如果输入事件不是发生在非快速滚动区域，合成线程就无须主线程的参与来合成一个新的帧。</p><h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><p><code>body</code> 元素绑定了事件监听器后其实是将整个页面都标记为一个非快速滚动区域，这就意味着即使你页面的某些区域压根就不在乎是不是有用户输入，当用户输入事件发生时，合成线程每次都会告知主线程并且会等待主线程处理完它才干活。因此这种情况下合成线程就丧失提供流畅用户体验的能力了（<code>smooth scrolling ability</code>）。</p><h5 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h5><p>可以为事件监听器传递 <code>passive：true</code> 选项。 这个选项会告诉浏览器您仍要在主线程中侦听事件，可是合成线程也可以继续合成新的帧。</p><h4 id="查找事件的目标对象（event-target）"><a href="#查找事件的目标对象（event-target）" class="headerlink" title="查找事件的目标对象（event target）"></a>查找事件的目标对象（event target）</h4><p>当合成线程向主线程发送输入事件时，主线程要做的第一件事是通过命中测试（<code>hit test</code>）去找到事件的目标对象（<code>target</code>）。具体的命中测试流程是遍历在渲染流水线中生成的绘画记录（<code>paint records</code>）来找到输入事件出现的 <code>x</code>, <code>y</code> 坐标上面描绘的对象是哪个。</p><h4 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h4><h5 id="DOM-对象"><a href="#DOM-对象" class="headerlink" title="DOM 对象"></a>DOM 对象</h5><p>既是浏览器对当前页面的内部表示，也是 <code>Web</code> 开发人员通过 <code>JavaScript</code> 与网页进行交互的数据结构以及 <code>API</code>。</p><h5 id="光栅化（rasterizing）"><a href="#光栅化（rasterizing）" class="headerlink" title="光栅化（rasterizing）"></a>光栅化（rasterizing）</h5><p>将以上文档结构，元素的样式，元素的几何信息以及它们的绘画顺序转化为显示器的像素的过程</p><h5 id="绘画四边形"><a href="#绘画四边形" class="headerlink" title="绘画四边形"></a>绘画四边形</h5><p>包含图块在内存的位置以及图层合成后图块在页面的位置之类的信息。</p><h5 id="合成帧"><a href="#合成帧" class="headerlink" title="合成帧"></a>合成帧</h5><p>代表页面一个帧的内容的绘制四边形集合。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://zhuanlan.zhihu.com/p/102149546" target="_blank" rel="noopener">一文看懂 Chrome 浏览器运行机制</a></li><li><a href="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#Resources" target="_blank" rel="noopener">浏览器的工作原理：新式网络浏览器幕后揭秘</a></li><li><a href="https://www.html5rocks.com/zh/tutorials/speed/high-performance-animations/" target="_blank" rel="noopener">High Performance Animations</a></li><li><a href="https://www.bilibili.com/video/BV1x54y1B7RE" target="_blank" rel="noopener">【干货】浏览器是如何运作的？</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;渲染流程&quot;&gt;&lt;a href=&quot;#渲染流程&quot; class=&quot;headerlink&quot; title=&quot;渲染流程&quot;&gt;&lt;/a&gt;渲染流程&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;浏览器通过网络请求后获取 &lt;code&gt;html&lt;/code&gt; 数据，通过 &lt;code&gt;tcp&lt;/code&gt; 传给
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>js执行流程</title>
    <link href="http://yoursite.com/2021/07/11/js%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/"/>
    <id>http://yoursite.com/2021/07/11/js执行流程/</id>
    <published>2021-07-10T21:58:37.000Z</published>
    <updated>2021-07-10T16:24:19.939Z</updated>
    
    <content type="html"><![CDATA[<h3 id="js-引擎"><a href="#js-引擎" class="headerlink" title="js 引擎"></a><code>js</code> 引擎</h3><table><thead><tr><th style="text-align:left">浏览器</th><th style="text-align:left"><code>JavaScript</code> 引擎</th></tr></thead><tbody><tr><td style="text-align:left">chrome</td><td style="text-align:left"><code>V8</code></td></tr><tr><td style="text-align:left">safari</td><td style="text-align:left"><code>JavaScriptCore</code></td></tr><tr><td style="text-align:left">Firefox</td><td style="text-align:left"><code>SpiderMonkey</code></td></tr><tr><td style="text-align:left">Edge</td><td style="text-align:left"><code>Chakra</code></td></tr></tbody></table><h3 id="js-执行过程"><a href="#js-执行过程" class="headerlink" title="js 执行过程"></a><code>js</code> 执行过程</h3><ol><li>对源码进行词法分析</li><li>进行语法分析</li><li>生成抽象语法树</li><li>生成可执行代码（可能有优化过程，此处代码可能是字节码或者机器码）</li><li>执行</li></ol><h4 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h4><p>将程序源代码分解成对编程语言来说有意义的代码块，这些代码块被称为词法单元（<code>token</code>）。</p><h4 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h4><p>根据生成的 <code>Token</code> 进行语法分析。</p><h3 id="V8-引擎"><a href="#V8-引擎" class="headerlink" title="V8 引擎"></a><code>V8</code> 引擎</h3><h4 id="主要模块"><a href="#主要模块" class="headerlink" title="主要模块"></a>主要模块</h4><h5 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a><code>Parser</code></h5><p>负责将 <code>JavaScript</code> 源码转换为 <code>Abstract Syntax Tree</code> (<code>AST</code>)。在 <code>V8</code> 中有两个解析器用于解析 <code>JavaScript</code> 代码，分别是 <code>Parser</code> 和 <code>Pre-Parser</code> 。</p><ul><li><code>Parser</code> 解析器又称为 <code>full parser</code>（全量解析） 或者 <code>eager parser</code>（饥饿解析）。它会解析所有立即执行的代码，包括语法检查，生成 <code>AST</code>，以及确定词法作用域。</li><li><code>Pre-Parser</code> 又称为惰性解析，它只解析未被立即执行的代码（如函数），不生成 <code>AST</code> ，只确定作用域，以此来提高性能。当预解析后的代码开始执行时，才进行 <code>Parser</code> 解析。</li></ul><h5 id="Ignition"><a href="#Ignition" class="headerlink" title="Ignition"></a><code>Ignition</code></h5><p><code>interpreter</code>，即解释器，负责将 <code>AST</code> 转换为 <code>Bytecode</code>，解释执行 <code>Bytecode</code>；同时收集 <code>TurboFan</code> 优化编译所需的信息，比如函数参数的类型</p><h5 id="TurboFan"><a href="#TurboFan" class="headerlink" title="TurboFan"></a><code>TurboFan</code></h5><p><code>compiler</code>，即编译器，利用 <code>Ignitio</code> 所收集的类型信息，将 <code>Bytecode</code> 转换为优化的机器代码</p><h5 id="Orinoco"><a href="#Orinoco" class="headerlink" title="Orinoco"></a><code>Orinoco</code></h5><p><code>garbage collector</code>，垃圾回收模块，负责将程序不再需要的内存空间回收；</p><h4 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h4><ol><li>扫描所有的源代码，进行词法分析，生成 <code>Tokens</code></li><li><code>Parser</code> 解析器根据 <code>Tokens</code> 生成 <code>AST</code>，存在预编译和编译</li><li><code>Ignition</code> 解释器将 <code>AST</code> 转换为字节码，并解释执行</li><li><code>TurboFan</code> 编译器负责将热点函数优化编译为机器指令执行</li></ol><p><img src="/images/brower/js_v8.jpg" alt="执行过程"></p><h5 id="优化及优化导致的问题修复"><a href="#优化及优化导致的问题修复" class="headerlink" title="优化及优化导致的问题修复"></a>优化及优化导致的问题修复</h5><p>当 <code>Ignition</code> 开始执行 <code>JavaScript</code> 代码后，<code>V8</code> 会一直观察 <code>JavaScript</code> 代码的执行情况，并记录执行信息，如每个函数的执行次数、每次调用函数时，传递的参数类型等。</p><p>如果一个函数被调用的次数超过了内设的阈值，监视器就会将当前函数标记为热点函数（<code>Hot Function</code>），并将该函数的字节码以及执行的相关信息发送给 <code>TurboFan</code>。<code>TurboFan</code> 会根据执行信息做出一些进一步优化此代码的假设，在假设的基础上将字节码编译为优化的机器代码。如果假设成立，那么当下一次调用该函数时，就会执行优化编译后的机器代码，以提高代码的执行性能；如果假设不成立，不知道你们有没有注意到上图中有一条由 <code>optimized code</code> 指向 <code>bytecode</code> 的红色指向线。此过程叫做 <code>deoptimize</code>（优化回退），将优化编译后的机器代码还原为字节码。</p><p><img src="/images/brower/js_v8_optimize.jpg" alt="优化过程"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://www.bilibili.com/video/BV1zV411z7RX" target="_blank" rel="noopener">8 分钟带你了解 V8 引擎是如何运行 JS</a></li><li><a href="https://zhuanlan.zhihu.com/p/73768338" target="_blank" rel="noopener">JavaScript 深入浅出第 4 课：V8 引擎是如何工作的？</a></li><li><a href="https://v8.dev/blog/launching-ignition-and-turbofan" target="_blank" rel="noopener">Launching Ignition and TurboFan</a></li><li><a href="https://segmentfault.com/a/1190000022062181" target="_blank" rel="noopener">JavaScript 引擎（V8）是如何工作的</a></li><li><a href="https://mlib.wang/2020/02/08/v8-parser-compiler-javascript/" target="_blank" rel="noopener">V8 是如何怎么处理 JavaScript 的</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;js-引擎&quot;&gt;&lt;a href=&quot;#js-引擎&quot; class=&quot;headerlink&quot; title=&quot;js 引擎&quot;&gt;&lt;/a&gt;&lt;code&gt;js&lt;/code&gt; 引擎&lt;/h3&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style=&quot;text-align:left&quot;
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="node" scheme="http://yoursite.com/tags/node/"/>
    
  </entry>
  
  <entry>
    <title>react中hooks实现原理</title>
    <link href="http://yoursite.com/2021/06/28/react%E4%B8%ADhooks%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/"/>
    <id>http://yoursite.com/2021/06/28/react中hooks实现原理/</id>
    <published>2021-06-27T22:34:04.000Z</published>
    <updated>2021-08-08T15:04:52.328Z</updated>
    
    <content type="html"><![CDATA[<h3 id="以客户端-useState-为例"><a href="#以客户端-useState-为例" class="headerlink" title="以客户端 useState 为例"></a>以客户端 <code>useState</code> 为例</h3><ol><li>声明 <code>useState</code>，通过 <code>ReactCurrentDispatcher.current</code> 来实现</li><li><code>ReactCurrentDispatcher.current</code> 的赋值是在 <code>packages/react-reconciler/src/ReactFiberHooks</code> 文件中区分挂载、更新和重新渲染分别实现的</li></ol><h4 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactFiberHooks.new.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountState</span>(<span class="params">initialState</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> hook = mountWorkInProgressHook()</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">'function'</span>) &#123;</span><br><span class="line">    initialState = initialState()</span><br><span class="line">  &#125;</span><br><span class="line">  hook.memoizedState = hook.baseState = initialState</span><br><span class="line">  <span class="keyword">const</span> queue = (hook.queue = &#123;</span><br><span class="line">    pending: <span class="literal">null</span>,</span><br><span class="line">    interleaved: <span class="literal">null</span>,</span><br><span class="line">    lanes: NoLanes,</span><br><span class="line">    dispatch: <span class="literal">null</span>,</span><br><span class="line">    lastRenderedReducer: basicStateReducer,</span><br><span class="line">    lastRenderedState: initialState,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">const</span> dispatch = (queue.dispatch = dispatchAction.bind(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    currentlyRenderingFiber,</span><br><span class="line">    queue</span><br><span class="line">  ))</span><br><span class="line">  <span class="keyword">return</span> [hook.memoizedState, dispatch]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountWorkInProgressHook</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> hook = &#123;</span><br><span class="line">    memoizedState: <span class="literal">null</span>,</span><br><span class="line">    baseState: <span class="literal">null</span>,</span><br><span class="line">    baseQueue: <span class="literal">null</span>,</span><br><span class="line">    queue: <span class="literal">null</span>,</span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This is the first hook in the list</span></span><br><span class="line">    currentlyRenderingFiber.memoizedState = workInProgressHook = hook</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Append to the end of the list</span></span><br><span class="line">    workInProgressHook = workInProgressHook.next = hook</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> workInProgressHook</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberHooks.new.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateState</span>(<span class="params">initialState</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> updateReducer(basicStateReducer, initialState)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateReducer</span>(<span class="params">reducer, initialArg, init</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> hook = updateWorkInProgressHook()</span><br><span class="line">  <span class="keyword">const</span> queue = hook.queue</span><br><span class="line"></span><br><span class="line">  queue.lastRenderedReducer = reducer</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> current = currentHook</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The last rebase update that is NOT part of the base state.</span></span><br><span class="line">  <span class="keyword">let</span> baseQueue = current.baseQueue</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The last pending update that hasn't been processed yet.</span></span><br><span class="line">  <span class="keyword">const</span> pendingQueue = queue.pending</span><br><span class="line">  <span class="keyword">if</span> (pendingQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We have new updates that haven't been processed yet.</span></span><br><span class="line">    <span class="comment">// We'll add them to the base queue.</span></span><br><span class="line">    <span class="keyword">if</span> (baseQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Merge the pending queue and the base queue.</span></span><br><span class="line">      <span class="keyword">const</span> baseFirst = baseQueue.next</span><br><span class="line">      <span class="keyword">const</span> pendingFirst = pendingQueue.next</span><br><span class="line">      baseQueue.next = pendingFirst</span><br><span class="line">      pendingQueue.next = baseFirst</span><br><span class="line">    &#125;</span><br><span class="line">    current.baseQueue = baseQueue = pendingQueue</span><br><span class="line">    queue.pending = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (baseQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We have a queue to process.</span></span><br><span class="line">    <span class="keyword">const</span> first = baseQueue.next</span><br><span class="line">    <span class="keyword">let</span> newState = current.baseState</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> newBaseState = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> newBaseQueueFirst = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> newBaseQueueLast = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> update = first</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> updateLane = update.lane</span><br><span class="line">      <span class="keyword">if</span> (!isSubsetOfLanes(renderLanes, updateLane)) &#123;</span><br><span class="line">        <span class="comment">// Priority is insufficient. Skip this update. If this is the first</span></span><br><span class="line">        <span class="comment">// skipped update, the previous update/state is the new base</span></span><br><span class="line">        <span class="comment">// update/state.</span></span><br><span class="line">        <span class="keyword">const</span> clone = &#123;</span><br><span class="line">          lane: updateLane,</span><br><span class="line">          action: update.action,</span><br><span class="line">          eagerReducer: update.eagerReducer,</span><br><span class="line">          eagerState: update.eagerState,</span><br><span class="line">          next: <span class="literal">null</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newBaseQueueLast === <span class="literal">null</span>) &#123;</span><br><span class="line">          newBaseQueueFirst = newBaseQueueLast = clone</span><br><span class="line">          newBaseState = newState</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          newBaseQueueLast = newBaseQueueLast.next = clone</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Update the remaining priority in the queue.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Don't need to accumulate this. Instead, we can remove</span></span><br><span class="line">        <span class="comment">// renderLanes from the original lanes.</span></span><br><span class="line">        currentlyRenderingFiber.lanes = mergeLanes(</span><br><span class="line">          currentlyRenderingFiber.lanes,</span><br><span class="line">          updateLane</span><br><span class="line">        )</span><br><span class="line">        markSkippedUpdateLanes(updateLane)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This update does have sufficient priority.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newBaseQueueLast !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> clone = &#123;</span><br><span class="line">            <span class="comment">// This update is going to be committed so we never want uncommit</span></span><br><span class="line">            <span class="comment">// it. Using NoLane works because 0 is a subset of all bitmasks, so</span></span><br><span class="line">            <span class="comment">// this will never be skipped by the check above.</span></span><br><span class="line">            lane: NoLane,</span><br><span class="line">            action: update.action,</span><br><span class="line">            eagerReducer: update.eagerReducer,</span><br><span class="line">            eagerState: update.eagerState,</span><br><span class="line">            next: <span class="literal">null</span>,</span><br><span class="line">          &#125;</span><br><span class="line">          newBaseQueueLast = newBaseQueueLast.next = clone</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process this update.</span></span><br><span class="line">        <span class="keyword">if</span> (update.eagerReducer === reducer) &#123;</span><br><span class="line">          <span class="comment">// If this update was processed eagerly, and its reducer matches the</span></span><br><span class="line">          <span class="comment">// current reducer, we can use the eagerly computed state.</span></span><br><span class="line">          newState = update.eagerState</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> action = update.action</span><br><span class="line">          newState = reducer(newState, action)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      update = update.next</span><br><span class="line">    &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span> &amp;&amp; update !== first)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newBaseQueueLast === <span class="literal">null</span>) &#123;</span><br><span class="line">      newBaseState = newState</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      newBaseQueueLast.next = newBaseQueueFirst</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Mark that the fiber performed work, but only if the new state is</span></span><br><span class="line">    <span class="comment">// different from the current state.</span></span><br><span class="line">    <span class="keyword">if</span> (!is(newState, hook.memoizedState)) &#123;</span><br><span class="line">      markWorkInProgressReceivedUpdate()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hook.memoizedState = newState</span><br><span class="line">    hook.baseState = newBaseState</span><br><span class="line">    hook.baseQueue = newBaseQueueLast</span><br><span class="line"></span><br><span class="line">    queue.lastRenderedState = newState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Interleaved updates are stored on a separate queue. We aren't going to</span></span><br><span class="line">  <span class="comment">// process them during this render, but we do need to track which lanes</span></span><br><span class="line">  <span class="comment">// are remaining.</span></span><br><span class="line">  <span class="keyword">const</span> lastInterleaved = queue.interleaved</span><br><span class="line">  <span class="keyword">if</span> (lastInterleaved !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> interleaved = lastInterleaved</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> interleavedLane = interleaved.lane</span><br><span class="line">      currentlyRenderingFiber.lanes = mergeLanes(</span><br><span class="line">        currentlyRenderingFiber.lanes,</span><br><span class="line">        interleavedLane</span><br><span class="line">      )</span><br><span class="line">      markSkippedUpdateLanes(interleavedLane)</span><br><span class="line">      interleaved = interleaved.next</span><br><span class="line">    &#125; <span class="keyword">while</span> (interleaved !== lastInterleaved)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (baseQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// `queue.lanes` is used for entangling transitions. We can set it back to</span></span><br><span class="line">    <span class="comment">// zero once the queue is empty.</span></span><br><span class="line">    queue.lanes = NoLanes</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dispatch = (queue.dispatch: any)</span><br><span class="line">  <span class="keyword">return</span> [hook.memoizedState, dispatch]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="重渲染"><a href="#重渲染" class="headerlink" title="重渲染"></a>重渲染</h4><h4 id="dispatchAction"><a href="#dispatchAction" class="headerlink" title="dispatchAction"></a><code>dispatchAction</code></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchAction</span>(<span class="params">fiber, queue, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> eventTime = requestEventTime()</span><br><span class="line">  <span class="keyword">const</span> lane = requestUpdateLane(fiber)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> update = &#123;</span><br><span class="line">    lane,</span><br><span class="line">    action,</span><br><span class="line">    eagerReducer: <span class="literal">null</span>,</span><br><span class="line">    eagerState: <span class="literal">null</span>,</span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> alternate = fiber.alternate</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    fiber === currentlyRenderingFiber ||</span><br><span class="line">    (alternate !== <span class="literal">null</span> &amp;&amp; alternate === currentlyRenderingFiber)</span><br><span class="line">  ) &#123;</span><br><span class="line">    didScheduleRenderPhaseUpdateDuringThisPass =</span><br><span class="line">      didScheduleRenderPhaseUpdate = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> pending = queue.pending</span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// This is the first update. Create a circular list.</span></span><br><span class="line">      update.next = update</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = pending.next</span><br><span class="line">      pending.next = update</span><br><span class="line">    &#125;</span><br><span class="line">    queue.pending = update</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 其它情况更新</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="basicStateReducer"><a href="#basicStateReducer" class="headerlink" title="basicStateReducer"></a><code>basicStateReducer</code></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">basicStateReducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> action === <span class="string">'function'</span> ? action(state) : action</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所有的 <code>hooks</code> 都是挂载在 <code>ReactCurrentDispatcher</code> 对象上的</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [a, setA] = useState()</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;a&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(</span><br><span class="line">  &lt;Test /&gt;,</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>) || <span class="built_in">document</span>.getElementsByTagName(<span class="string">'body'</span>)[<span class="number">0</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译之后</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> _useState = (<span class="number">0</span>, _react.useState)(<span class="number">0</span>), <span class="comment">// 等价于 _useState = _react.useState(0)</span></span><br><span class="line">    _useState2 = _slicedToArray(_useState, <span class="number">2</span>),</span><br><span class="line">    a = _useState2[<span class="number">0</span>],</span><br><span class="line">    setA = _useState2[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> _react2.default.createElement(<span class="string">'div'</span>, <span class="literal">null</span>, a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_reactDom2.default.render(</span><br><span class="line">  _react2.default.createElement(Test, <span class="literal">null</span>),</span><br><span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>) || <span class="built_in">document</span>.getElementsByTagName(<span class="string">'body'</span>)[<span class="number">0</span>]</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>编译后实际是把函数组件当作参数传递下去了</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://www.jianshu.com/p/b9ac8fa849f1" target="_blank" rel="noopener">React Hooks 原理</a></li><li><a href="https://www.cnblogs.com/cczlovexw/p/13565085.html" target="_blank" rel="noopener">React Hook 的底层实现原理</a></li><li><a href="https://zhuanlan.zhihu.com/p/48584310" target="_blank" rel="noopener">阅读源码后，来讲讲 React Hooks 是怎么实现的</a></li><li><a href="https://zhuanlan.zhihu.com/p/75146261" target="_blank" rel="noopener">React Hook 的实现原理和最佳实践</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;以客户端-useState-为例&quot;&gt;&lt;a href=&quot;#以客户端-useState-为例&quot; class=&quot;headerlink&quot; title=&quot;以客户端 useState 为例&quot;&gt;&lt;/a&gt;以客户端 &lt;code&gt;useState&lt;/code&gt; 为例&lt;/h3&gt;&lt;ol&gt;
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="react" scheme="http://yoursite.com/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>react从dom.render到初次组件渲染完成</title>
    <link href="http://yoursite.com/2021/06/20/react%E4%BB%8Edom-render%E5%88%B0%E5%88%9D%E6%AC%A1%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E5%AE%8C%E6%88%90/"/>
    <id>http://yoursite.com/2021/06/20/react从dom-render到初次组件渲染完成/</id>
    <published>2021-06-19T22:12:44.000Z</published>
    <updated>2021-06-20T06:39:35.058Z</updated>
    
    <content type="html"><![CDATA[<h2 id="从-dom-render-到初次组件渲染完成"><a href="#从-dom-render-到初次组件渲染完成" class="headerlink" title="从 dom.render 到初次组件渲染完成"></a>从 <code>dom.render</code> 到初次组件渲染完成</h2><ol><li><code>render(element,container,callback)</code> 调用 <code>legacyRenderSubtreeIntoContainer(null,element,container,false,callback)</code></li><li><code>legacyRenderSubtreeIntoContainer(parentComponent,children,container,forceHydrate,callback)</code> 调用<code>legacyCreateRootFromDOMContainer(container,false)</code> 创建容器并赋值给 <code>container._reactRootContainer</code></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/client/ReactDOMLegacy.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyRenderSubtreeIntoContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?Function</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> root = container._reactRootContainer</span><br><span class="line">  <span class="keyword">let</span> fiberRoot: FiberRoot</span><br><span class="line">  <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(</span><br><span class="line">      container,</span><br><span class="line">      forceHydrate</span><br><span class="line">    )</span><br><span class="line">    fiberRoot = root._internalRoot</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = getPublicRootInstance(fiberRoot)</span><br><span class="line">        originalCallback.call(instance)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化同步更新</span></span><br><span class="line">    unbatchedUpdates(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      updateContainer(children, fiberRoot, parentComponent, callback)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> getPublicRootInstance(fiberRoot)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>通过 <code>unbatchedUpdates</code> 同步更新容器元素并调用回调函数</li></ol><h3 id="构建容器"><a href="#构建容器" class="headerlink" title="构建容器"></a>构建容器</h3><ol><li><code>legacyCreateRootFromDOMContainer</code> 调用 <code>createLegacyRoot(container)</code> 构建容器</li><li>调用 <code>new ReactDOMLegacyRoot(container)</code> 构建实例</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/client/ReactDOMRoot.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createLegacyRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  options?: RootOptions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">RootType</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ReactDOMLegacyRoot(container, options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>构造函数中调用 <code>createRootImpl(container, ConcurrentRoot)</code> 创建根容器并赋值给 <code>_internalRoot</code> 属性</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/client/ReactDOMRoot.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReactDOMLegacyRoot</span>(<span class="params">container: Container, options: void | RootOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._internalRoot = createRootImpl(container, LegacyRoot, options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOMLegacyRoot.prototype.render = <span class="function"><span class="keyword">function</span> (<span class="params">children: ReactNodeList</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="keyword">this</span>._internalRoot</span><br><span class="line">  updateContainer(children, root, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOMLegacyRoot.prototype.unmount = <span class="function"><span class="keyword">function</span> (<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="keyword">this</span>._internalRoot</span><br><span class="line">  <span class="keyword">const</span> container = root.containerInfo</span><br><span class="line">  updateContainer(<span class="literal">null</span>, root, <span class="literal">null</span>, () =&gt; &#123;</span><br><span class="line">    unmarkContainerAsRoot(container)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRootImpl</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: void | RootOptions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root = createContainer(container, tag)</span><br><span class="line">  markContainerAsRoot(root.current, container)</span><br><span class="line">  <span class="keyword">const</span> rootContainerElement =</span><br><span class="line">    container.nodeType === COMMENT_NODE ? container.parentNode : container</span><br><span class="line">  listenToAllSupportedEvents(rootContainerElement)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>调用 <code>createContainer(container, ConcurrentRoot)</code> 构建根元素</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberRoot.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrationCallbacks: null | SuspenseHydrationCallbacks,</span></span></span><br><span class="line"><span class="function"><span class="params">  isStrictMode: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  concurrentUpdatesByDefaultOverride: null | boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">OpaqueRoot</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createFiberRoot(</span><br><span class="line">    containerInfo,</span><br><span class="line">    tag,</span><br><span class="line">    hydrate,</span><br><span class="line">    hydrationCallbacks,</span><br><span class="line">    isStrictMode,</span><br><span class="line">    concurrentUpdatesByDefaultOverride</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.  调用 `new FiberRootNode(container, ConcurrentRoot)` 构建根元素</span></span><br><span class="line"><span class="comment">// 2.  调用 `createHostRootFiber` 构建 `Fiber`</span></span><br><span class="line"><span class="comment">// 3.  初始化更新队列</span></span><br><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberRoot.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFiberRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrationCallbacks: null | SuspenseHydrationCallbacks,</span></span></span><br><span class="line"><span class="function"><span class="params">  isStrictMode: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  concurrentUpdatesByDefaultOverride: null | boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root: FiberRoot = <span class="keyword">new</span> FiberRootNode(containerInfo, tag, hydrate)</span><br><span class="line">  <span class="keyword">const</span> uninitializedFiber = createHostRootFiber(</span><br><span class="line">    tag,</span><br><span class="line">    isStrictMode,</span><br><span class="line">    concurrentUpdatesByDefaultOverride</span><br><span class="line">  )</span><br><span class="line">  root.current = uninitializedFiber</span><br><span class="line">  uninitializedFiber.stateNode = root</span><br><span class="line">  <span class="keyword">const</span> initialState = &#123; <span class="attr">element</span>: <span class="literal">null</span> &#125;</span><br><span class="line">  uninitializedFiber.memoizedState = initialState</span><br><span class="line">  initializeUpdateQueue(uninitializedFiber)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FiberRootNode</span>(<span class="params">containerInfo, tag, hydrate</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.tag = tag</span><br><span class="line">  <span class="keyword">this</span>.containerInfo = containerInfo</span><br><span class="line">  <span class="keyword">this</span>.pendingChildren = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.current = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.pingCache = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.finishedWork = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.timeoutHandle = noTimeout</span><br><span class="line">  <span class="keyword">this</span>.context = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.pendingContext = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.hydrate = hydrate</span><br><span class="line">  <span class="keyword">this</span>.callbackNode = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.callbackPriority = NoLane</span><br><span class="line">  <span class="keyword">this</span>.eventTimes = createLaneMap(NoLanes)</span><br><span class="line">  <span class="keyword">this</span>.expirationTimes = createLaneMap(NoTimestamp)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.pendingLanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.suspendedLanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.pingedLanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.expiredLanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.mutableReadLanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.finishedLanes = NoLanes</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.entangledLanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.entanglements = createLaneMap(NoLanes)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiber.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createHostRootFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  isStrictMode: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  concurrentUpdatesByDefaultOverride: null | boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> mode</span><br><span class="line">  <span class="keyword">if</span> (tag === ConcurrentRoot) &#123;</span><br><span class="line">    mode = ConcurrentMode</span><br><span class="line">    <span class="keyword">if</span> (isStrictMode === <span class="literal">true</span>) &#123;</span><br><span class="line">      mode |= StrictLegacyMode</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (enableStrictEffects) &#123;</span><br><span class="line">        mode |= StrictEffectsMode</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enableStrictEffects &amp;&amp; createRootStrictEffectsByDefault) &#123;</span><br><span class="line">      mode |= StrictLegacyMode | StrictEffectsMode</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !enableSyncDefaultUpdates ||</span><br><span class="line">      (allowConcurrentByDefault &amp;&amp; concurrentUpdatesByDefaultOverride)</span><br><span class="line">    ) &#123;</span><br><span class="line">      mode |= ConcurrentUpdatesByDefaultMode</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mode = NoMode</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; isDevToolsPresent) &#123;</span><br><span class="line">    mode |= ProfileMode</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> createFiber(HostRoot, <span class="literal">null</span>, <span class="literal">null</span>, mode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FiberNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: WorkTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: null | string,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Instance</span></span><br><span class="line">  <span class="keyword">this</span>.tag = tag</span><br><span class="line">  <span class="keyword">this</span>.key = key</span><br><span class="line">  <span class="keyword">this</span>.elementType = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.type = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.stateNode = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fiber</span></span><br><span class="line">  <span class="keyword">this</span>.return = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.child = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.sibling = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.ref = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.pendingProps = pendingProps</span><br><span class="line">  <span class="keyword">this</span>.memoizedProps = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.updateQueue = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.memoizedState = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.dependencies = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.mode = mode</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Effects</span></span><br><span class="line">  <span class="keyword">this</span>.flags = NoFlags</span><br><span class="line">  <span class="keyword">this</span>.subtreeFlags = NoFlags</span><br><span class="line">  <span class="keyword">this</span>.deletions = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.lanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.childLanes = NoLanes</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.alternate = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: WorkTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: null | string,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FiberNode(tag, pendingProps, key, mode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>调用<code>markContainerAsRoot(root.current, container)</code>标记根元素</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/client/ReactDOMComponentTree.js</span></span><br><span class="line"><span class="keyword">const</span> randomKey = <span class="built_in">Math</span>.random().toString(<span class="number">36</span>).slice(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">const</span> internalContainerInstanceKey = <span class="string">'__reactContainer$'</span> + randomKey</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">markContainerAsRoot</span>(<span class="params">hostRoot: Fiber, node: Container</span>) </span>&#123;</span><br><span class="line">  node[internalContainerInstanceKey] = hostRoot</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="6"><li>调用<code>listenToAllSupportedEvents(rootContainerElement)</code> 向根元素上注册所有原生监听事件，但 <code>selectionchange</code> 事件注册在 <code>document</code> 上</li></ol><h4 id="构建的容器"><a href="#构建的容器" class="headerlink" title="构建的容器"></a>构建的容器</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> container =<span class="built_in">document</span>.getElementById(<span class="string">"root"</span>)</span><br><span class="line"><span class="keyword">const</span> root = container._reactRootContainer = &#123;</span><br><span class="line">  _internalRoot: &#123;</span><br><span class="line">    tag: RootTag,</span><br><span class="line">    containerInfo: container,</span><br><span class="line">    pendingChildren: <span class="literal">null</span>,</span><br><span class="line">    current: <span class="literal">null</span>,</span><br><span class="line">    pingCache: <span class="literal">null</span>,</span><br><span class="line">    finishedWork: <span class="literal">null</span>,</span><br><span class="line">    timeoutHandle: noTimeout</span><br><span class="line">    context: <span class="literal">null</span>,</span><br><span class="line">    pendingContext: <span class="literal">null</span>,</span><br><span class="line">    hydrate: hydrate,</span><br><span class="line">    callbackNode: <span class="literal">null</span>,</span><br><span class="line">    callbackPriority: NoLane,</span><br><span class="line">    eventTimes: [NoLanes],</span><br><span class="line">    expirationTimes: [NoTimestamp],</span><br><span class="line">    pendingLanes: NoLanes,</span><br><span class="line">    suspendedLanes: NoLanes,</span><br><span class="line">    pingedLanes: NoLanes,</span><br><span class="line">    expiredLanes: NoLanes,</span><br><span class="line">    mutableReadLanes: NoLanes,</span><br><span class="line">    finishedLanes: NoLanes,</span><br><span class="line">    entangledLanes: NoLanes,</span><br><span class="line">    entanglements: [NoLanes],</span><br><span class="line">  &#125;,</span><br><span class="line">  current: &#123;</span><br><span class="line">    tag: tag,</span><br><span class="line">    key: key,</span><br><span class="line">    elementType: <span class="literal">null</span>,</span><br><span class="line">    type: <span class="literal">null</span>,</span><br><span class="line">    stateNode: root,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fiber</span></span><br><span class="line">    <span class="keyword">return</span>: <span class="literal">null</span>,</span><br><span class="line">    child: <span class="literal">null</span>,</span><br><span class="line">    sibling: <span class="literal">null</span>,</span><br><span class="line">    index: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    ref: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    pendingProps: pendingProps,</span><br><span class="line">    memoizedProps: <span class="literal">null</span>,</span><br><span class="line">    updateQueue: <span class="literal">null</span>,</span><br><span class="line">    memoizedState: &#123; <span class="attr">element</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">    dependencies: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    mode: NoMode,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Effects</span></span><br><span class="line">    flags: NoFlags,</span><br><span class="line">    subtreeFlags: NoFlags,</span><br><span class="line">    deletions: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    lanes: NoLanes,</span><br><span class="line">    childLanes: NoLanes,</span><br><span class="line"></span><br><span class="line">    alternate: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> fiberRoot = root._internalRoot</span><br><span class="line">container[<span class="string">'__reactContainer$'</span> + randomKey] = root.current</span><br></pre></td></tr></table></figure><h3 id="更新容器"><a href="#更新容器" class="headerlink" title="更新容器"></a>更新容器</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberReconciler.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?Function</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Lane</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = container.current</span><br><span class="line">  <span class="keyword">const</span> eventTime = requestEventTime() <span class="comment">// 获取更新时间</span></span><br><span class="line">  <span class="keyword">const</span> lane = requestUpdateLane(current) <span class="comment">// 获取更新任务的优先级</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> context = getContextForSubtree(parentComponent) <span class="comment">// 获取 context</span></span><br><span class="line">  <span class="keyword">if</span> (container.context === <span class="literal">null</span>) &#123;</span><br><span class="line">    container.context = context</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    container.pendingContext = context</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(eventTime, lane) <span class="comment">// 构建一次更新</span></span><br><span class="line">  update.payload = &#123; element &#125;</span><br><span class="line"></span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    update.callback = callback</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  enqueueUpdate(current, update, lane)</span><br><span class="line">  <span class="keyword">const</span> root = scheduleUpdateOnFiber(current, lane, eventTime)</span><br><span class="line">  <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">    entangleTransitions(root, current, lane)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> lane</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>获取更新优先级，位数越底，优先级越高</li><li>获取 <code>context</code></li><li>通过 <code>createUpdate</code> 创建更新</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createUpdate</span>(<span class="params">eventTime: number, lane: Lane</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> update = &#123;</span><br><span class="line">    eventTime,</span><br><span class="line">    lane,</span><br><span class="line">    tag: UpdateState,</span><br><span class="line">    payload: <span class="literal">null</span>,</span><br><span class="line">    callback: <span class="literal">null</span>,</span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> update</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>通过 <code>enqueueUpdate</code> 把更新放入更新队列</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueueUpdate</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  update: Update&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue = fiber.updateQueue</span><br><span class="line">  <span class="keyword">if</span> (updateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 卸载时执行</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> sharedQueue = updateQueue.shared</span><br><span class="line">  <span class="comment">// 正在更新</span></span><br><span class="line">  <span class="keyword">if</span> (isInterleavedUpdate(fiber, lane)) &#123;</span><br><span class="line">    <span class="keyword">const</span> interleaved = sharedQueue.interleaved</span><br><span class="line">    <span class="keyword">if</span> (interleaved === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 构建更新环，并放入更新队列</span></span><br><span class="line">      update.next = update</span><br><span class="line">      pushInterleavedQueue(sharedQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = interleaved.next</span><br><span class="line">      interleaved.next = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.interleaved = update</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pending = sharedQueue.pending</span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 构建更新环，并放入更新队列</span></span><br><span class="line">      update.next = update</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = pending.next</span><br><span class="line">      pending.next = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.pending = update</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>通过 <code>scheduleUpdateOnFiber</code> 调度更新</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;从-dom-render-到初次组件渲染完成&quot;&gt;&lt;a href=&quot;#从-dom-render-到初次组件渲染完成&quot; class=&quot;headerlink&quot; title=&quot;从 dom.render 到初次组件渲染完成&quot;&gt;&lt;/a&gt;从 &lt;code&gt;dom.render&lt;/
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="react" scheme="http://yoursite.com/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>webpack源码阅读（二）</title>
    <link href="http://yoursite.com/2021/06/17/webpack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>http://yoursite.com/2021/06/17/webpack源码阅读（二）/</id>
    <published>2021-06-16T19:22:20.000Z</published>
    <updated>2021-07-10T15:44:48.156Z</updated>
    
    <content type="html"><![CDATA[<h3 id="webpack-Compilation-执行过程"><a href="#webpack-Compilation-执行过程" class="headerlink" title="webpack Compilation 执行过程"></a>webpack Compilation 执行过程</h3><ol><li>构建 <code>Compilation</code> 实例</li><li>调用 <code>compilation.finish</code> 执行构建</li><li>异步调用 <code>finishModules</code> 钩子函数</li><li>调用 <code>compilation.seal</code> 完成构建</li><li>构建 <code>ChunkGraph</code> 实例，并调用 <code>ChunkGraph.setChunkGraphForModule(module, chunkGraph)</code></li><li>同步调用 <code>seal</code> 钩子函数</li><li>同步调用 <code>optimizeDependencies</code> 钩子函数，等待钩子函数执行完毕</li><li>同步调用 <code>afterOptimizeDependencies</code> 钩子函数</li><li>同步调用 <code>beforeChunks</code> 钩子函数</li><li>构建 <code>chunk</code></li><li>同步调用 <code>afterChunks</code> 钩子函数</li><li>同步调用 <code>optimize</code> 钩子函数</li><li>同步调用 <code>optimizeModules</code> 钩子函数，等待钩子函数执行完毕</li><li>同步调用 <code>afterOptimizeModules</code> 钩子函数</li><li>同步调用 <code>optimizeChunks</code> 钩子函数，等待钩子函数执行完毕</li><li>同步调用 <code>afterOptimizeChunks</code> 钩子函数</li><li>异步调用 <code>optimizeTree</code> 钩子函数</li><li>同步调用 <code>afterOptimizeTree</code> 钩子函数</li><li>异步调用 <code>optimizeChunkModules</code> 钩子函数</li><li>同步调用 <code>afterOptimizeChunkModules</code> 钩子函数</li><li>同步调用 <code>shouldRecord</code> 钩子函数</li><li>同步调用 <code>reviveModules</code> 钩子函数</li><li>同步调用 <code>beforeModuleIds</code> 钩子函数</li><li>同步调用 <code>moduleIds</code> 钩子函数</li><li>同步调用 <code>optimizeModuleIds</code> 钩子函数</li><li>同步调用 <code>afterOptimizeModuleIds</code> 钩子函数</li><li>同步调用 <code>reviveChunks</code> 钩子函数</li><li>同步调用 <code>beforeChunkIds</code> 钩子函数</li><li>同步调用 <code>chunkIds</code> 钩子函数</li><li>同步调用 <code>optimizeChunkIds</code> 钩子函数</li><li>同步调用 <code>afterOptimizeChunkIds</code> 钩子函数</li><li>若 <code>shouldRecord</code> 钩子函数为正，则同步调用 <code>recordModules</code> 钩子函数</li><li>若 <code>shouldRecord</code> 钩子函数为正，则同步调用 <code>recordChunks</code> 钩子函数</li><li>同步调用 <code>optimizeCodeGeneration</code> 钩子函数</li><li>同步调用 <code>beforeModuleHash</code> 钩子函数</li><li>同步调用 <code>afterModuleHash</code> 钩子函数</li><li>同步调用 <code>beforeCodeGeneration</code> 钩子函数</li><li>调用 <code>codeGeneration</code> 生成代码</li><li>同步调用 <code>afterCodeGeneration</code> 钩子函数</li><li>同步调用 <code>beforeRuntimeRequirements</code> 钩子函数</li><li>提取 <code>modules</code> 中的 <code>runtime</code>，对于每个 <code>module</code> 的 <code>runtime</code> 都同步调用 <code>additionalModuleRuntimeRequirements</code> 钩子函数</li><li>若存在对应的 <code>runtimeRequirementInModule</code> 钩子函数，则同步调用该钩子函数</li><li>对每个 <code>chunk</code> 同步调用 <code>additionalChunkRuntimeRequirements</code> 钩子函数</li><li>对每个 <code>chunk</code> 中依赖的 <code>runtime</code> 调用 <code>runtimeRequirementInChunk</code> 钩子函数</li><li>构建含有重复依赖的依赖树</li><li>每个入口文件的依赖进行扁平化处理，去掉重复依赖，然后同步调用 <code>additionalTreeRuntimeRequirements</code> 钩子函数</li><li>每个入口文件的依赖一次调用 <code>runtimeRequirementInTree</code> 钩子函数</li><li>同步调用 <code>afterRuntimeRequirements</code> 钩子函数</li><li>同步调用 <code>beforeHash</code> 钩子函数</li><li>同步调用 <code>updateHash</code> 钩子函数</li><li>若为非 <code>fullHashModules</code> 是同步调用 <code>contentHash</code> 钩子函数</li><li>同步调用 <code>fullHash</code> 钩子函数</li><li>对每个 <code>chunk</code> 同步调用 <code>fullHash</code> 钩子函数</li><li>同步调用 <code>afterHash</code> 钩子函数</li><li>若需要记录则同步调用 <code>shouldRecord</code> 钩子函数</li><li>清理 <code>chunk</code> 记录的文件</li><li>同步调用 <code>beforeModuleAssets</code> 钩子函数</li><li>针对 <code>module</code> 的每一个需要输出的资源同步调用 <code>moduleAsset</code> 钩子函数</li><li>同步调用 <code>shouldGenerateChunkAssets</code> 判断是否需要输出资源</li><li>输出资源前同步调用 <code>beforeChunkAssets</code> 钩子函数</li><li>针对每个 <code>chunk</code> 构建一个 <code>manifest</code> 文件</li><li>为每个 <code>chunk</code> 写入包含的资源</li><li>同步调用 <code>chunkAsset</code> 钩子函数</li><li>异步调用 <code>processAssets</code> 钩子函数</li><li>同步调用 <code>afterProcessAssets</code> 钩子函数</li><li>构建依赖</li><li>若需要记录则同步调用 <code>record</code> 钩子函数</li><li>同步调用 <code>needAdditionalSeal</code> 钩子函数，判读是否需要新增</li><li>异步调用 <code>afterSeal</code> 钩子函数</li><li>回调</li></ol><h4 id="Module"><a href="#Module" class="headerlink" title="Module"></a><code>Module</code></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string&#125;</span> </span>*/</span></span><br><span class="line">type: type,</span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;string&#125;</span> </span>*/</span></span><br><span class="line">context: context,</span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;boolean&#125;</span> </span>*/</span></span><br><span class="line">needId: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// Unique Id</span></span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;number&#125;</span> </span>*/</span></span><br><span class="line">debugId:  debugId++,</span><br><span class="line"></span><br><span class="line"><span class="comment">// Info from Factory</span></span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;ResolveOptions&#125;</span> </span>*/</span></span><br><span class="line">resolveOptions: EMPTY_RESOLVE_OPTIONS,</span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;object | undefined&#125;</span> </span>*/</span></span><br><span class="line">factoryMeta: <span class="literal">undefined</span>,</span><br><span class="line"><span class="comment">// TODO refactor this -&gt; options object filled from Factory</span></span><br><span class="line"><span class="comment">// TODO webpack 6: use an enum</span></span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;boolean&#125;</span> </span>*/</span></span><br><span class="line">useSourceMap: <span class="literal">false</span>,</span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;boolean&#125;</span> </span>*/</span></span><br><span class="line">useSimpleSourceMap: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// Info from Build</span></span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;WebpackError[] | undefined&#125;</span> </span>*/</span></span><br><span class="line">_warnings: <span class="literal">undefined</span>,</span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;WebpackError[] | undefined&#125;</span> </span>*/</span></span><br><span class="line">_errors: <span class="literal">undefined</span>,</span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;BuildMeta&#125;</span> </span>*/</span></span><br><span class="line">buildMeta: <span class="literal">undefined</span>,</span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;object&#125;</span> </span>*/</span></span><br><span class="line">buildInfo: <span class="literal">undefined</span>,</span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;Dependency[] | undefined&#125;</span> </span>*/</span></span><br><span class="line">presentationalDependencies: <span class="literal">undefined</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="chunk-具有的属性"><a href="#chunk-具有的属性" class="headerlink" title="chunk 具有的属性"></a><code>chunk</code> 具有的属性</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;number | string | null&#125;</span> </span>*/</span></span><br><span class="line">  id: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;(number|string)[] | null&#125;</span> </span>*/</span></span><br><span class="line">  ids: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;number&#125;</span> </span>*/</span></span><br><span class="line">  debugId: debugId++,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string&#125;</span> </span>*/</span></span><br><span class="line">  name: name,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;SortableSet&lt;string&gt;&#125;</span> </span>*/</span></span><br><span class="line">  idNameHints: <span class="keyword">new</span> SortableSet(),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;boolean&#125;</span> </span>*/</span></span><br><span class="line">  preventIntegration: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;(string | function(PathData, AssetInfo=): string)?&#125;</span> </span>*/</span></span><br><span class="line">  filenameTemplate: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@private </span><span class="doctag">@type <span class="type">&#123;SortableSet&lt;ChunkGroup&gt;&#125;</span> </span>*/</span></span><br><span class="line">  _groups: <span class="keyword">new</span> SortableSet(<span class="literal">undefined</span>, compareChunkGroupsByIndex),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;RuntimeSpec&#125;</span> </span>*/</span></span><br><span class="line">  runtime: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;Set&lt;string&gt;&#125;</span> </span>*/</span></span><br><span class="line">  files: <span class="keyword">new</span> ChunkFilesSet(),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;Set&lt;string&gt;&#125;</span> </span>*/</span></span><br><span class="line">  auxiliaryFiles: <span class="keyword">new</span> <span class="built_in">Set</span>(),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;boolean&#125;</span> </span>*/</span></span><br><span class="line">  rendered: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string=&#125;</span> </span>*/</span></span><br><span class="line">  hash: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;Record&lt;string, string&gt;&#125;</span> </span>*/</span></span><br><span class="line">  contentHash: <span class="built_in">Object</span>.create(<span class="literal">null</span>),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string=&#125;</span> </span>*/</span></span><br><span class="line">  renderedHash: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string=&#125;</span> </span>*/</span></span><br><span class="line">  chunkReason: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;boolean&#125;</span> </span>*/</span></span><br><span class="line">  extraAsync: <span class="literal">false</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ChunkGraph-具有的属性"><a href="#ChunkGraph-具有的属性" class="headerlink" title="ChunkGraph 具有的属性"></a><code>ChunkGraph</code> 具有的属性</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="comment">/** <span class="doctag">@private </span><span class="doctag">@type <span class="type">&#123;WeakMap&lt;Module, ChunkGraphModule&gt;&#125;</span> </span>*/</span></span><br><span class="line">_modules: <span class="keyword">new</span> <span class="built_in">WeakMap</span>(),</span><br><span class="line"><span class="comment">/** <span class="doctag">@private </span><span class="doctag">@type <span class="type">&#123;WeakMap&lt;Chunk, ChunkGraphChunk&gt;&#125;</span> </span>*/</span></span><br><span class="line">_chunks:  <span class="keyword">new</span> <span class="built_in">WeakMap</span>(),</span><br><span class="line"><span class="comment">/** <span class="doctag">@private </span><span class="doctag">@type <span class="type">&#123;WeakMap&lt;AsyncDependenciesBlock, ChunkGroup&gt;&#125;</span> </span>*/</span></span><br><span class="line">_blockChunkGroups: <span class="keyword">new</span> <span class="built_in">WeakMap</span>(),</span><br><span class="line"><span class="comment">/** <span class="doctag">@private </span><span class="doctag">@type <span class="type">&#123;Map&lt;string, string | number&gt;&#125;</span> </span>*/</span></span><br><span class="line">_runtimeIds: <span class="keyword">new</span> <span class="built_in">Map</span>(),</span><br><span class="line"><span class="comment">/** <span class="doctag">@type <span class="type">&#123;ModuleGraph&#125;</span> </span>*/</span></span><br><span class="line">moduleGraph: moduleGraph;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h4><ol><li>对于一份同逻辑的代码，当我们手写下一个一个的文件，它们无论是 <code>ESM</code> 还是 <code>commonJS</code> 或是 <code>AMD</code>，他们都是 <code>module</code></li><li>当我们写的 <code>module</code> 源文件传到 <code>webpack</code> 进行打包时，<code>webpack</code> 会根据文件引用关系生成 <code>chunk</code> 文件，<code>webpack</code> 会对这个 <code>chunk</code> 文件进行一些操作；</li><li><code>webpack</code> 处理好 <code>chunk</code> 文件后，最后会输出 <code>bundle</code> 文件，这个 <code>bundle</code> 文件包含了经过加载和编译的最终源文件，所以它可以直接在浏览器中运行。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;webpack-Compilation-执行过程&quot;&gt;&lt;a href=&quot;#webpack-Compilation-执行过程&quot; class=&quot;headerlink&quot; title=&quot;webpack Compilation 执行过程&quot;&gt;&lt;/a&gt;webpack Compil
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="webpack" scheme="http://yoursite.com/tags/webpack/"/>
    
  </entry>
  
  <entry>
    <title>webpack源码阅读（一）</title>
    <link href="http://yoursite.com/2021/06/15/webpack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://yoursite.com/2021/06/15/webpack源码阅读（一）/</id>
    <published>2021-06-15T12:52:53.000Z</published>
    <updated>2021-06-19T13:21:56.515Z</updated>
    
    <content type="html"><![CDATA[<h3 id="webpack-compile-执行过程"><a href="#webpack-compile-执行过程" class="headerlink" title="webpack compile 执行过程"></a>webpack compile 执行过程</h3><ol><li>获取默认基础参数</li><li>构建 <code>Compiler</code> 实例</li><li>通过插件 <code>NodeEnvironmentPlugin</code> 插入日志输出，构建缓存，监听文件变化，监听 <code>NodeEnvironmentPlugin</code> 事件</li><li>注入自定义的插件</li><li>设置默认配置</li><li>同步执行 <code>environment</code> 钩子函数</li><li>同步执行 <code>afterEnvironment</code> 钩子函数</li><li>注入预设的插件系统</li><li>同步执行 <code>initialize</code> 钩子函数</li><li>执行 <code>run</code> ，开始构建</li></ol><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: lib/webpack.js</span></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="comment">/** @type &#123;WebpackFunctionSingle &amp; WebpackFunctionMulti&#125; */</span> (</span><br><span class="line">  options,</span><br><span class="line">  callback,</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> create = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> compiler</span><br><span class="line">    <span class="keyword">let</span> watch = <span class="literal">false</span></span><br><span class="line">    <span class="comment">/** @type &#123;WatchOptions|WatchOptions[]&#125; */</span></span><br><span class="line">    <span class="keyword">let</span> watchOptions</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(options)) &#123;</span><br><span class="line">      <span class="comment">// 多个 compiler</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/** @type &#123;Compiler&#125; */</span></span><br><span class="line">      compiler = createCompiler(options)</span><br><span class="line">      <span class="comment">// watch 配置</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123; compiler, watch, watchOptions &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; compiler, watch, watchOptions &#125; = create()</span><br><span class="line">  <span class="comment">// 执行 run ，开始构建</span></span><br><span class="line">  compiler.run(<span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">    compiler.close(<span class="function">(<span class="params">err2</span>) =&gt;</span> &#123;</span><br><span class="line">      callback(err || err2, stats)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> compiler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createCompiler = <span class="function">(<span class="params">rawOptions</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> options = getNormalizedWebpackOptions(rawOptions)</span><br><span class="line">  applyWebpackOptionsBaseDefaults(options) <span class="comment">// 构建默认基础选项</span></span><br><span class="line">  <span class="keyword">const</span> compiler = <span class="keyword">new</span> Compiler(options.context) <span class="comment">// 构建 compiler 实例</span></span><br><span class="line">  compiler.options = options</span><br><span class="line">  <span class="keyword">new</span> NodeEnvironmentPlugin(&#123;</span><br><span class="line">    infrastructureLogging: options.infrastructureLogging,</span><br><span class="line">  &#125;).apply(compiler) <span class="comment">// 插入日志输出，构建缓存系统，监听文件变化，监听 NodeEnvironmentPlugin 事件</span></span><br><span class="line">  <span class="comment">// 注入插件</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(options.plugins)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> plugin of options.plugins) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin === <span class="string">'function'</span>) &#123;</span><br><span class="line">        plugin.call(compiler, compiler)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        plugin.apply(compiler)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  applyWebpackOptionsDefaults(options) <span class="comment">// 设置默认配置</span></span><br><span class="line">  compiler.hooks.environment.call() <span class="comment">// 执行 environment 绑定的事件</span></span><br><span class="line">  compiler.hooks.afterEnvironment.call() <span class="comment">// 执行 afterEnvironment 绑定的事件</span></span><br><span class="line">  <span class="keyword">new</span> WebpackOptionsApply().process(options, compiler) <span class="comment">// 注入预设的插件系统</span></span><br><span class="line">  compiler.hooks.initialize.call() <span class="comment">// 执行 initialize 绑定的事件</span></span><br><span class="line">  <span class="keyword">return</span> compiler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="run-执行过程"><a href="#run-执行过程" class="headerlink" title="run 执行过程"></a><code>run</code> 执行过程</h4><ol><li>异步调用 <code>beforeRun</code> 钩子函数</li><li>异步调用 <code>run</code> 钩子函数</li><li>异步读取构建记录</li><li>实例化 <code>NormalModuleFactory</code> 对象，同步调用 <code>NormalModuleFactory</code> 钩子函数</li><li>实例化 <code>ContextModuleFactory</code> 对象，同步调用 <code>ContextModuleFactory</code> 钩子函数</li><li>构建 <code>Compilation</code> 需要的实例参数</li><li>异步调用 <code>beforeCompile</code> 钩子函数</li><li>同步调用 <code>compile</code> 钩子函数</li><li>构建 <code>Compilation</code> 实例</li><li>注入 <code>name</code> 和 <code>records</code> 属性</li><li>同步调用 <code>thisCompilation</code> 钩子函数</li><li>同步调用 <code>compilation</code> 钩子函数</li><li>异步调用 <code>make</code> 钩子函数</li><li>异步调用 <code>finishMake</code> 钩子函数</li><li>在 <code>nextTick</code> 中依次调用 <code>compilation.finish</code> 和 <code>compilation.seal</code></li><li>异步调用 <code>afterCompile</code> 钩子函数</li><li>同步调用 <code>shouldEmit</code> 钩子判断是否需要输出资源</li><li>输出资源文件，异步调用 <code>emit</code> 钩子函数</li><li>同步调用 <code>needAdditionalPass</code> 钩子函数</li><li>把构建记录 <code>records</code> 写入文件</li><li>异步调用 <code>done</code> 钩子函数</li><li>回调 <code>callback</code> 完成构建</li><li>同步调用 <code>afterDone</code> 钩子函数</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: lib/Compiler.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compiler</span> </span>&#123;</span><br><span class="line">  run(callback) &#123;</span><br><span class="line">    <span class="keyword">const</span> finalCallback = <span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.idle = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">this</span>.cache.beginIdle()</span><br><span class="line">      <span class="keyword">this</span>.idle = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">this</span>.running = <span class="literal">false</span></span><br><span class="line">      <span class="comment">// 回调，然后调用 afterDone 钩子函数，结束构建</span></span><br><span class="line">      <span class="keyword">if</span> (callback !== <span class="literal">undefined</span>) callback(err, stats)</span><br><span class="line">      <span class="keyword">this</span>.hooks.afterDone.call(stats)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startTime = <span class="built_in">Date</span>.now()</span><br><span class="line">    <span class="keyword">this</span>.running = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> onCompiled = <span class="function">(<span class="params">err, compilation</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 不需要输出资源直接结束此次构建</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.hooks.shouldEmit.call(compilation) === <span class="literal">false</span>) &#123;</span><br><span class="line">        compilation.startTime = startTime</span><br><span class="line">        compilation.endTime = <span class="built_in">Date</span>.now()</span><br><span class="line">        <span class="keyword">const</span> stats = <span class="keyword">new</span> Stats(compilation)</span><br><span class="line">        <span class="keyword">this</span>.hooks.done.callAsync(stats, (err) =&gt; &#123;</span><br><span class="line">          <span class="keyword">return</span> finalCallback(<span class="literal">null</span>, stats)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.emitAssets(compilation, (err) =&gt; &#123;</span><br><span class="line">          <span class="comment">// 判断是否需要新增资源，如果需要新增则结束此次编译流程，然后重新启动一个新的编译流程</span></span><br><span class="line">          <span class="keyword">if</span> (compilation.hooks.needAdditionalPass.call()) &#123;</span><br><span class="line">            compilation.needAdditionalPass = <span class="literal">true</span></span><br><span class="line">            compilation.startTime = startTime</span><br><span class="line">            compilation.endTime = <span class="built_in">Date</span>.now()</span><br><span class="line">            <span class="keyword">const</span> stats = <span class="keyword">new</span> Stats(compilation)</span><br><span class="line">            <span class="keyword">this</span>.hooks.done.callAsync(stats, (err) =&gt; &#123;</span><br><span class="line">              <span class="keyword">this</span>.hooks.additionalPass.callAsync(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.compile(onCompiled)</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 输出构建的记录，结束编译流程</span></span><br><span class="line">          <span class="keyword">this</span>.emitRecords(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            compilation.startTime = startTime</span><br><span class="line">            compilation.endTime = <span class="built_in">Date</span>.now()</span><br><span class="line">            <span class="keyword">const</span> stats = <span class="keyword">new</span> Stats(compilation)</span><br><span class="line">            <span class="keyword">this</span>.hooks.done.callAsync(stats, (err) =&gt; &#123;</span><br><span class="line">              <span class="keyword">this</span>.cache.storeBuildDependencies(</span><br><span class="line">                compilation.buildDependencies,</span><br><span class="line">                (err) =&gt; &#123;</span><br><span class="line">                  <span class="keyword">return</span> finalCallback(<span class="literal">null</span>, stats)</span><br><span class="line">                &#125;,</span><br><span class="line">              )</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> run = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.hooks.beforeRun.callAsync(<span class="keyword">this</span>, (err) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.hooks.run.callAsync(<span class="keyword">this</span>, (err) =&gt; &#123;</span><br><span class="line">          <span class="comment">// 读取编译记录</span></span><br><span class="line">          <span class="keyword">this</span>.readRecords(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 开始执行编译</span></span><br><span class="line">            <span class="keyword">this</span>.compile(onCompiled)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    run() <span class="comment">// 开始执行编译进程</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  compile(callback) &#123;</span><br><span class="line">    <span class="keyword">const</span> params = <span class="keyword">this</span>.newCompilationParams() <span class="comment">// 构建 Compilation 参数</span></span><br><span class="line">    <span class="keyword">this</span>.hooks.beforeCompile.callAsync(params, (err) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.hooks.compile.call(params)</span><br><span class="line">      <span class="keyword">const</span> compilation = <span class="keyword">this</span>.newCompilation(params) <span class="comment">// 构建 Compilation 实例，开始一次编译</span></span><br><span class="line">      <span class="keyword">this</span>.hooks.make.callAsync(compilation, (err) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.hooks.finishMake.callAsync(compilation, (err) =&gt; &#123;</span><br><span class="line">          process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 执行 Compilation 内的钩子</span></span><br><span class="line">            compilation.finish(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">              compilation.seal(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 一次编译完成</span></span><br><span class="line">                <span class="keyword">this</span>.hooks.afterCompile.callAsync(compilation, (err) =&gt; &#123;</span><br><span class="line">                  <span class="keyword">return</span> callback(<span class="literal">null</span>, compilation)</span><br><span class="line">                &#125;)</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="代码执行流程图"><a href="#代码执行流程图" class="headerlink" title="代码执行流程图"></a>代码执行流程图</h4><p><img src="/images/webpack-compile.png" alt="webpack compile 代码执行流程"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;webpack-compile-执行过程&quot;&gt;&lt;a href=&quot;#webpack-compile-执行过程&quot; class=&quot;headerlink&quot; title=&quot;webpack compile 执行过程&quot;&gt;&lt;/a&gt;webpack compile 执行过程&lt;/h3&gt;&lt;
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="webpack" scheme="http://yoursite.com/tags/webpack/"/>
    
  </entry>
  
  <entry>
    <title>Performance</title>
    <link href="http://yoursite.com/2021/06/15/Performance/"/>
    <id>http://yoursite.com/2021/06/15/Performance/</id>
    <published>2021-06-14T22:48:44.000Z</published>
    <updated>2021-06-14T15:40:45.361Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><h5 id="navigation"><a href="#navigation" class="headerlink" title="navigation"></a><code>navigation</code></h5><p>只读属性 Performance.navigation 会返回一个 PerformanceNavigation 对象。</p><ul><li>type: 一个无符号短整型，表示是如何导航到这个页面的。<ul><li>TYPE_NAVIGATE (0): 当前页面是通过点击链接，书签和表单提交，或者脚本操作，或者在 url 中直接输入地址;</li><li>TYPE_RELOAD (1): 点击刷新页面按钮或者通过 Location.reload()方法显示的页面;</li><li>TYPE_BACK_FORWARD (2): 页面通过历史记录和前进后退访问时;</li><li>TYPE_RESERVED (255): 任何其他方式。</li></ul></li><li>redirectCount: 无符号短整型，表示在到达这个页面之前重定向了多少次。</li></ul><h5 id="timing"><a href="#timing" class="headerlink" title="timing"></a><code>timing</code></h5><p>只读属性返回一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceTiming" target="_blank" rel="noopener">PerformanceTiming</a> 对象，这个对象包括了页面相关的性能信息。</p><h5 id="timeOrigin"><a href="#timeOrigin" class="headerlink" title="timeOrigin"></a><code>timeOrigin</code></h5><p>只读属性 timeOrigin 返回一个表示 the performance measurement 开始时间的高精度 timestamp</p><h5 id="onresourcetimingbufferfull"><a href="#onresourcetimingbufferfull" class="headerlink" title="onresourcetimingbufferfull"></a><code>onresourcetimingbufferfull</code></h5><p>在 resourcetimingbufferfull 事件触发时会被调用的事件处理器，参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/onresourcetimingbufferfull" target="_blank" rel="noopener">Performance.onresourcetimingbufferfull</a></p><h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><h5 id="Performance-now"><a href="#Performance-now" class="headerlink" title="Performance.now()"></a><code>Performance.now()</code></h5><p>方法返回一个精确到毫秒的事件戳 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DOMHighResTimeStamp" target="_blank" rel="noopener">DOMHighResTimeStamp</a></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">performance.now() <span class="comment">// 38544.5</span></span><br><span class="line"><span class="built_in">Date</span>.now() <span class="comment">// 1623685111685</span></span><br></pre></td></tr></table></figure><h6 id="tips：-测量程序性能时可以使用"><a href="#tips：-测量程序性能时可以使用" class="headerlink" title="tips： 测量程序性能时可以使用"></a>tips： 测量程序性能时可以使用</h6><h5 id="performance-setResourceTimingBufferSize"><a href="#performance-setResourceTimingBufferSize" class="headerlink" title="performance.setResourceTimingBufferSize()"></a><a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/setResourceTimingBufferSize" target="_blank" rel="noopener"><code>performance.setResourceTimingBufferSize()</code></a></h5><p>设置浏览器记录资源加载情况的缓冲区大小，单位是对象个数，最小为 150</p><h5 id="Performance-mark"><a href="#Performance-mark" class="headerlink" title="Performance.mark()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/mark" target="_blank" rel="noopener"><code>Performance.mark()</code></a></h5><p>在浏览器的性能缓冲区中使用给定名称添加一个 timestamp</p><h5 id="Performance-measure"><a href="#Performance-measure" class="headerlink" title="Performance.measure()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/measure" target="_blank" rel="noopener"><code>Performance.measure()</code></a></h5><p>在浏览器性能记录缓存中创建了一个名为时间戳的记录来记录两个特殊标志位（通常称为开始标志和结束标志）。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">performance.mark(<span class="string">'test1'</span>)</span><br><span class="line">performance.mark(<span class="string">'test2'</span>)</span><br><span class="line">performance.measure(<span class="string">'test'</span>, <span class="string">'test1'</span>, <span class="string">'test2'</span>) <span class="comment">// &#123; detail: null, duration: 0.09999999403953552, entryType: "measure", name: "test", startTime: 33062.60000000894 &#125;</span></span><br></pre></td></tr></table></figure><h6 id="tips：-与-Performance-mark-结合可以测量指定项目的时间"><a href="#tips：-与-Performance-mark-结合可以测量指定项目的时间" class="headerlink" title="tips： 与 Performance.mark() 结合可以测量指定项目的时间"></a>tips： 与 <code>Performance.mark()</code> 结合可以测量指定项目的时间</h6><h5 id="Performance-clearResourceTimings"><a href="#Performance-clearResourceTimings" class="headerlink" title="Performance.clearResourceTimings()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearResourceTimings" target="_blank" rel="noopener"><code>Performance.clearResourceTimings()</code></a></h5><p>移除所有的记录</p><h5 id="Performance-clearMarks"><a href="#Performance-clearMarks" class="headerlink" title="Performance.clearMarks()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearMarks" target="_blank" rel="noopener"><code>Performance.clearMarks()</code></a></h5><p>从浏览器的 performance entry 缓存中移除声明的标记。</p><h5 id="Performance-clearMeasures"><a href="#Performance-clearMeasures" class="headerlink" title="Performance.clearMeasures()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearMeasures" target="_blank" rel="noopener"><code>Performance.clearMeasures()</code></a></h5><p>从浏览器的性能入口缓存区中移除声明的度量衡。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Performance&quot;&gt;&lt;a href=&quot;#Performance&quot; class=&quot;headerlink&quot; title=&quot;Performance&quot;&gt;&lt;/a&gt;Performance&lt;/h3&gt;&lt;h4 id=&quot;属性&quot;&gt;&lt;a href=&quot;#属性&quot; class=&quot;head
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>react的同步更新</title>
    <link href="http://yoursite.com/2021/06/14/react%E7%9A%84%E5%90%8C%E6%AD%A5%E6%9B%B4%E6%96%B0/"/>
    <id>http://yoursite.com/2021/06/14/react的同步更新/</id>
    <published>2021-06-13T18:10:34.000Z</published>
    <updated>2021-06-14T11:30:40.428Z</updated>
    
    <content type="html"><![CDATA[<h3 id="react-同步更新"><a href="#react-同步更新" class="headerlink" title="react 同步更新"></a>react 同步更新</h3><h4 id="class-组件"><a href="#class-组件" class="headerlink" title="class 组件"></a>class 组件</h4><p>每个 <code>class</code> 组件初始化时都会注入 <code>updater</code> 的属性</p><h5 id="更新过程"><a href="#更新过程" class="headerlink" title="更新过程"></a>更新过程</h5><ol><li>构建更新节点</li><li>把节点放入更新队列</li><li>调度更新节点</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">const</span> classComponentUpdater = &#123;</span><br><span class="line">  isMounted,</span><br><span class="line">  enqueueSetState(inst, payload, callback) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = getInstance(inst)</span><br><span class="line">    <span class="keyword">const</span> eventTime = requestEventTime()</span><br><span class="line">    <span class="keyword">const</span> lane = requestUpdateLane(fiber) <span class="comment">// 获取更新方式，包括同步更新</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> update = createUpdate(eventTime, lane) <span class="comment">// 构建更新</span></span><br><span class="line">    update.payload = payload</span><br><span class="line">    <span class="keyword">if</span> (callback !== <span class="literal">undefined</span> &amp;&amp; callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      update.callback = callback</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enqueueUpdate(fiber, update, lane) <span class="comment">// 更新放入队列</span></span><br><span class="line">    <span class="keyword">const</span> root = scheduleUpdateOnFiber(fiber, lane, eventTime) <span class="comment">// 调度更新节点</span></span><br><span class="line">    <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">      entangleTransitions(root, fiber, lane)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">      markStateUpdateScheduled(fiber, lane)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  enqueueReplaceState(inst, payload, callback) &#123;</span><br><span class="line">    <span class="comment">// 类似与 enqueueSetState</span></span><br><span class="line">  &#125;,</span><br><span class="line">  enqueueForceUpdate(inst, callback) &#123;</span><br><span class="line">    <span class="comment">// 类似与 enqueueSetState</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="把节点放入更新队列"><a href="#把节点放入更新队列" class="headerlink" title="把节点放入更新队列"></a>把节点放入更新队列</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueueUpdate</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  update: Update&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue = fiber.updateQueue</span><br><span class="line">  <span class="keyword">if</span> (updateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 组件卸载</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sharedQueue = updateQueue.shared</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isInterleavedUpdate(fiber, lane)) &#123;</span><br><span class="line">    <span class="keyword">const</span> interleaved = sharedQueue.interleaved</span><br><span class="line">    <span class="keyword">if</span> (interleaved === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 挂载时构成一个循环链表</span></span><br><span class="line">      update.next = update</span><br><span class="line">      <span class="comment">// At the end of the current render, this queue's interleaved updates will</span></span><br><span class="line">      <span class="comment">// be transfered to the pending queue.</span></span><br><span class="line">      pushInterleavedQueue(sharedQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = interleaved.next</span><br><span class="line">      interleaved.next = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.interleaved = update</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pending = sharedQueue.pending</span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 挂载时构成一个循环链表</span></span><br><span class="line">      update.next = update</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = pending.next</span><br><span class="line">      pending.next = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.pending = update</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="调度更新节点"><a href="#调度更新节点" class="headerlink" title="调度更新节点"></a>调度更新节点</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">scheduleUpdateOnFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventTime: number</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  checkForNestedUpdates()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = markUpdateLaneFromFiberToRoot(fiber, lane) <span class="comment">// 更新从当前 fiber 标记到根节点并返回根节点</span></span><br><span class="line">  <span class="keyword">if</span> (root === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 标记当前节点进入更新队列</span></span><br><span class="line">  markRootUpdated(root, lane, eventTime)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (executionContext &amp; CommitContext) !== NoContext &amp;&amp;</span><br><span class="line">      root === rootCommittingMutationOrLayoutEffects</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (fiber.mode &amp; ProfileMode) &#123;</span><br><span class="line">        <span class="keyword">let</span> current = fiber</span><br><span class="line">        <span class="keyword">while</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (current.tag === Profiler) &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; id, onNestedUpdateScheduled &#125; = current.memoizedProps</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> onNestedUpdateScheduled === <span class="string">'function'</span>) &#123;</span><br><span class="line">              onNestedUpdateScheduled(id)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          current = current.return</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Consolidate with `isInterleavedUpdate` check</span></span><br><span class="line">  <span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">    <span class="comment">// Received an update to a tree that's in the middle of rendering. Mark</span></span><br><span class="line">    <span class="comment">// that there was an interleaved update work on this root. Unless the</span></span><br><span class="line">    <span class="comment">// `deferRenderPhaseUpdateToNextBatch` flag is off and this is a render</span></span><br><span class="line">    <span class="comment">// phase update. In that case, we don't treat render phase updates as if</span></span><br><span class="line">    <span class="comment">// they were interleaved, for backwards compat reasons.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      deferRenderPhaseUpdateToNextBatch ||</span><br><span class="line">      (executionContext &amp; RenderContext) === NoContext</span><br><span class="line">    ) &#123;</span><br><span class="line">      workInProgressRootUpdatedLanes = mergeLanes(</span><br><span class="line">        workInProgressRootUpdatedLanes,</span><br><span class="line">        lane</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (workInProgressRootExitStatus === RootSuspendedWithDelay) &#123;</span><br><span class="line">      <span class="comment">// The root already suspended with a delay, which means this render</span></span><br><span class="line">      <span class="comment">// definitely won't finish. Since we have a new update, let's mark it as</span></span><br><span class="line">      <span class="comment">// suspended now, right before marking the incoming update. This has the</span></span><br><span class="line">      <span class="comment">// effect of interrupting the current render and switching to the update.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Make sure this doesn't override pings that happen while we've</span></span><br><span class="line">      <span class="comment">// already started rendering.</span></span><br><span class="line">      markRootSuspended(root, workInProgressRootRenderLanes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lane === SyncLane) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// Check if we're inside unbatchedUpdates</span></span><br><span class="line">      (executionContext &amp; LegacyUnbatchedContext) !== NoContext &amp;&amp;</span><br><span class="line">      <span class="comment">// Check if we're not already rendering</span></span><br><span class="line">      (executionContext &amp; (RenderContext | CommitContext)) === NoContext</span><br><span class="line">    ) &#123;</span><br><span class="line">      performSyncWorkOnRoot(root) <span class="comment">// 开始同步更新</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ensureRootIsScheduled(root, eventTime)</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        executionContext === NoContext &amp;&amp;</span><br><span class="line">        (fiber.mode &amp; ConcurrentMode) === NoMode</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Flush the synchronous work now, unless we're already working or inside</span></span><br><span class="line">        <span class="comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span></span><br><span class="line">        <span class="comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span></span><br><span class="line">        <span class="comment">// without immediately flushing it. We only do this for user-initiated</span></span><br><span class="line">        <span class="comment">// updates, to preserve historical behavior of legacy mode.</span></span><br><span class="line">        resetRenderTimer()</span><br><span class="line">        flushSyncCallbacksOnlyInLegacyMode()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Schedule other updates after in case the callback is sync.</span></span><br><span class="line">    ensureRootIsScheduled(root, eventTime)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="performSyncWorkOnRoot"><a href="#performSyncWorkOnRoot" class="headerlink" title="performSyncWorkOnRoot"></a><code>performSyncWorkOnRoot</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="comment">// This is the entry point for synchronous tasks that don't go</span></span><br><span class="line"><span class="comment">// through Scheduler</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performSyncWorkOnRoot</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdatePhase) &#123;</span><br><span class="line">    syncNestedUpdateFlag()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  flushPassiveEffects()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> lanes = getNextLanes(root, NoLanes)</span><br><span class="line">  <span class="keyword">if</span> (!includesSomeLane(lanes, SyncLane)) &#123;</span><br><span class="line">    <span class="comment">// 同步任务执行完毕</span></span><br><span class="line">    ensureRootIsScheduled(root, now())</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> exitStatus = renderRootSync(root, lanes)</span><br><span class="line">  <span class="comment">// 错误补偿逻辑</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We now have a consistent tree. Because this is a sync render, we</span></span><br><span class="line">  <span class="comment">// will commit it even if something suspended.</span></span><br><span class="line">  <span class="keyword">const</span> finishedWork = root.current.alternate</span><br><span class="line">  root.finishedWork = finishedWork</span><br><span class="line">  root.finishedLanes = lanes</span><br><span class="line">  commitRoot(root)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before exiting, make sure there's a callback scheduled for the next</span></span><br><span class="line">  <span class="comment">// pending level.</span></span><br><span class="line">  ensureRootIsScheduled(root, now())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="renderRootSync"><a href="#renderRootSync" class="headerlink" title="renderRootSync"></a><code>renderRootSync</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// workInProgressRoot 全局变量</span></span><br><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderRootSync</span>(<span class="params">root: FiberRoot, lanes: Lanes</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext</span><br><span class="line">  executionContext |= RenderContext</span><br><span class="line">  <span class="keyword">const</span> prevDispatcher = pushDispatcher()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the root or lanes have changed, throw out the existing stack</span></span><br><span class="line">  <span class="comment">// and prepare a fresh one. Otherwise we'll continue where we left off.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) &#123;</span><br><span class="line">    prepareFreshStack(root, lanes) <span class="comment">// 更新 context</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    markRenderStarted(lanes)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      workLoopSync()</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">      handleError(root, thrownValue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">  resetContextDependencies()</span><br><span class="line">  executionContext = prevExecutionContext</span><br><span class="line">  popDispatcher(prevDispatcher)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    markRenderStopped()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set this to null to indicate there's no in-progress render.</span></span><br><span class="line">  workInProgressRoot = <span class="literal">null</span></span><br><span class="line">  workInProgressRootRenderLanes = NoLanes</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgressRootExitStatus</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="workLoopSync"><a href="#workLoopSync" class="headerlink" title="workLoopSync"></a><code>workLoopSync</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="comment">// workInProgress 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoopSync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Already timed out, so perform work without checking if we need to yield.</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    performUnitOfWork(workInProgress)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="performUnitOfWork"><a href="#performUnitOfWork" class="headerlink" title="performUnitOfWork"></a><code>performUnitOfWork</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 执行更新任务</span></span><br><span class="line">  <span class="keyword">const</span> current = unitOfWork.alternate</span><br><span class="line">  <span class="keyword">let</span> next = beginWork(current, unitOfWork, subtreeRenderLanes) <span class="comment">// child</span></span><br><span class="line">  unitOfWork.memoizedProps = unitOfWork.pendingProps</span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 没有下一个任务时表示任务已经做完</span></span><br><span class="line">    completeUnitOfWork(unitOfWork)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress = next</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ReactCurrentOwner.current = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a><code>beginWork</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberBeginWork.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> updateLanes = workInProgress.lanes</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldProps = current.memoizedProps</span><br><span class="line">    <span class="keyword">const</span> newProps = workInProgress.pendingProps</span><br><span class="line">    <span class="keyword">if</span> (oldProps !== newProps || hasLegacyContextChanged()) &#123;</span><br><span class="line">      <span class="comment">// props 更新或 context 更新</span></span><br><span class="line">      didReceiveUpdate = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!includesSomeLane(renderLanes, updateLanes)) &#123;</span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">      <span class="comment">// 此次渲染的更新和等待的更新没有任何交集，新增等待的更新等待下次执行</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 其它更新逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清空</span></span><br><span class="line">  workInProgress.lanes = NoLanes</span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps)</span><br><span class="line">      <span class="keyword">return</span> updateClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderLanes</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其它类型组件更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="updateClassComponent"><a href="#updateClassComponent" class="headerlink" title="updateClassComponent"></a>updateClassComponent</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberBeginWork.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextProps: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 提取 context</span></span><br><span class="line">  <span class="keyword">let</span> hasContext</span><br><span class="line">  <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">    hasContext = <span class="literal">true</span></span><br><span class="line">    pushLegacyContextProvider(workInProgress)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    hasContext = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  prepareToReadContext(workInProgress, renderLanes)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.stateNode</span><br><span class="line">  <span class="keyword">let</span> shouldUpdate</span><br><span class="line">  <span class="keyword">if</span> (instance === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 挂载</span></span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// A class component without an instance only mounts if it suspended</span></span><br><span class="line">      <span class="comment">// inside a non-concurrent tree, in an inconsistent state. We want to</span></span><br><span class="line">      <span class="comment">// treat it like a new mount, even though an empty version of it already</span></span><br><span class="line">      <span class="comment">// committed. Disconnect the alternate pointers.</span></span><br><span class="line">      current.alternate = <span class="literal">null</span></span><br><span class="line">      workInProgress.alternate = <span class="literal">null</span></span><br><span class="line">      <span class="comment">// Since this is conceptually a new fiber, schedule a Placement effect</span></span><br><span class="line">      workInProgress.flags |= Placement</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// In the initial pass we might need to construct the instance.</span></span><br><span class="line">    constructClassInstance(workInProgress, Component, nextProps)</span><br><span class="line">    mountClassInstance(workInProgress, Component, nextProps, renderLanes)</span><br><span class="line">    shouldUpdate = <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// In a resume, we'll already have an instance we can reuse.</span></span><br><span class="line">    shouldUpdate = resumeMountClassInstance(</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//   更新</span></span><br><span class="line">    shouldUpdate = updateClassInstance(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> nextUnitOfWork = finishClassComponent(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    Component,</span><br><span class="line">    shouldUpdate,</span><br><span class="line">    hasContext,</span><br><span class="line">    renderLanes</span><br><span class="line">  ) <span class="comment">// child</span></span><br><span class="line">  <span class="keyword">return</span> nextUnitOfWork</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="constructClassInstance"><a href="#constructClassInstance" class="headerlink" title="constructClassInstance"></a><code>constructClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">constructClassInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  ctor: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  props: <span class="built_in">any</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> isLegacyContextConsumer = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> unmaskedContext = emptyContextObject</span><br><span class="line">  <span class="keyword">let</span> context = emptyContextObject</span><br><span class="line">  <span class="keyword">const</span> contextType = ctor.contextType</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提取 context</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">'object'</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">    context = readContext(contextType)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!disableLegacyContext) &#123;</span><br><span class="line">    unmaskedContext = getUnmaskedContext(workInProgress, ctor, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> contextTypes = ctor.contextTypes</span><br><span class="line">    isLegacyContextConsumer =</span><br><span class="line">      contextTypes !== <span class="literal">null</span> &amp;&amp; contextTypes !== <span class="literal">undefined</span></span><br><span class="line">    context = isLegacyContextConsumer</span><br><span class="line">      ? getMaskedContext(workInProgress, unmaskedContext)</span><br><span class="line">      : emptyContextObject</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建组件实例</span></span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">new</span> ctor(props, context)</span><br><span class="line">  <span class="keyword">const</span> state = (workInProgress.memoizedState =</span><br><span class="line">    instance.state !== <span class="literal">null</span> &amp;&amp; instance.state !== <span class="literal">undefined</span></span><br><span class="line">      ? instance.state</span><br><span class="line">      : <span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// fiber 注入更新队列和实例信息，存储实例和 fiber 映射</span></span><br><span class="line">  adoptClassInstance(workInProgress, instance)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓存 context</span></span><br><span class="line">  <span class="keyword">if</span> (isLegacyContextConsumer) &#123;</span><br><span class="line">    cacheContext(workInProgress, unmaskedContext, context)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> instance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="adoptClassInstance"><a href="#adoptClassInstance" class="headerlink" title="adoptClassInstance"></a><code>adoptClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">adoptClassInstance</span>(<span class="params">workInProgress: Fiber, instance: <span class="built_in">any</span></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  instance.updater = classComponentUpdater <span class="comment">// 更新队列</span></span><br><span class="line">  workInProgress.stateNode = instance <span class="comment">// 存储组件实例</span></span><br><span class="line">  <span class="comment">//构建 fiber 和组件实例的映射</span></span><br><span class="line">  setInstance(instance, workInProgress)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="mountClassInstance"><a href="#mountClassInstance" class="headerlink" title="mountClassInstance"></a><code>mountClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountClassInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  ctor: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  newProps: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.stateNode</span><br><span class="line">  instance.props = newProps</span><br><span class="line">  instance.state = workInProgress.memoizedState</span><br><span class="line">  instance.refs = emptyRefsObject</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化队列</span></span><br><span class="line">  initializeUpdateQueue(workInProgress)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 context</span></span><br><span class="line">  <span class="keyword">const</span> contextType = ctor.contextType</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">'object'</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">    instance.context = readContext(contextType)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (disableLegacyContext) &#123;</span><br><span class="line">    instance.context = emptyContextObject</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> unmaskedContext = getUnmaskedContext(workInProgress, ctor, <span class="literal">true</span>)</span><br><span class="line">    instance.context = getMaskedContext(workInProgress, unmaskedContext)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新 state</span></span><br><span class="line">  instance.state = workInProgress.memoizedState</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 getDerivedStateFromProps 更新 state</span></span><br><span class="line">  <span class="keyword">const</span> getDerivedStateFromProps = ctor.getDerivedStateFromProps</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">'function'</span>) &#123;</span><br><span class="line">    applyDerivedStateFromProps(</span><br><span class="line">      workInProgress,</span><br><span class="line">      ctor,</span><br><span class="line">      getDerivedStateFromProps,</span><br><span class="line">      newProps</span><br><span class="line">    )</span><br><span class="line">    instance.state = workInProgress.memoizedState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 componentWillMount 生命周期</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> ctor.getDerivedStateFromProps !== <span class="string">'function'</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> instance.getSnapshotBeforeUpdate !== <span class="string">'function'</span> &amp;&amp;</span><br><span class="line">    (<span class="keyword">typeof</span> instance.UNSAFE_componentWillMount === <span class="string">'function'</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> instance.componentWillMount === <span class="string">'function'</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    callComponentWillMount(workInProgress, instance)</span><br><span class="line">    <span class="comment">// componentWillMount 执行 setState 时立即更新 state</span></span><br><span class="line">    processUpdateQueue(workInProgress, newProps, instance, renderLanes)</span><br><span class="line">    instance.state = workInProgress.memoizedState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.componentDidMount === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> fiberFlags: Flags = Update</span><br><span class="line">    <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics) &#123;</span><br><span class="line">      fiberFlags |= LayoutStatic</span><br><span class="line">    &#125;</span><br><span class="line">    workInProgress.flags |= fiberFlags</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="finishClassComponent"><a href="#finishClassComponent" class="headerlink" title="finishClassComponent"></a><code>finishClassComponent</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finishClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  shouldUpdate: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  hasContext: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Refs should update even if shouldComponentUpdate returns false</span></span><br><span class="line">  markRef(current, workInProgress)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> didCaptureError = (workInProgress.flags &amp; DidCapture) !== NoFlags</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!shouldUpdate &amp;&amp; !didCaptureError) &#123;</span><br><span class="line">    <span class="keyword">return</span> bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.stateNode</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Rerender</span></span><br><span class="line">  ReactCurrentOwner.current = workInProgress</span><br><span class="line">  <span class="keyword">let</span> nextChildren</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    didCaptureError &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> Component.getDerivedStateFromError !== <span class="string">'function'</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 错误处理</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nextChildren = instance.render()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  reconcileChildren(current, workInProgress, nextChildren, renderLanes)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 记录 state</span></span><br><span class="line">  workInProgress.memoizedState = instance.state</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgress.child</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="reconcileChildren"><a href="#reconcileChildren" class="headerlink" title="reconcileChildren"></a><code>reconcileChildren</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextChildren: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 挂载</span></span><br><span class="line">    workInProgress.child = mountChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="ChildReconciler"><a href="#ChildReconciler" class="headerlink" title="ChildReconciler"></a><code>ChildReconciler</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactChildFiber.old.js</span></span><br><span class="line"><span class="keyword">const</span> mountChildFibers = ChildReconciler(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ChildReconciler</span>(<span class="params">shouldTrackSideEffects</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">deleteChild</span>(<span class="params">returnFiber: Fiber, childToDelete: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">deleteRemainingChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">useFiber</span>(<span class="params">fiber: Fiber, pendingProps: mixed</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> clone = createWorkInProgress(fiber, pendingProps) <span class="comment">// 构建一个新的 fiber 节点</span></span><br><span class="line">    clone.index = <span class="number">0</span></span><br><span class="line">    clone.sibling = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">return</span> clone</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">placeChild</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    newFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    lastPlacedIndex: <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    newIndex: <span class="built_in">number</span></span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">    newFiber.index = newIndex</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span> lastPlacedIndex</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回 fiber</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">placeSingleChild</span>(<span class="params">newFiber: Fiber</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> newFiber</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleTextNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    textContent: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    lanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="comment">// There's no need to check for keys on text nodes since we don't have a</span></span><br><span class="line">    <span class="comment">// way to define them.</span></span><br><span class="line">    <span class="keyword">if</span> (currentFirstChild !== <span class="literal">null</span> &amp;&amp; currentFirstChild.tag === HostText) &#123;</span><br><span class="line">      <span class="comment">// We already have an existing node so let's just update it and delete</span></span><br><span class="line">      <span class="comment">// the rest.</span></span><br><span class="line">      deleteRemainingChildren(returnFiber, currentFirstChild.sibling)</span><br><span class="line">      <span class="keyword">const</span> existing = useFiber(currentFirstChild, textContent)</span><br><span class="line">      existing.return = returnFiber</span><br><span class="line">      <span class="keyword">return</span> existing</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The existing first child is not a text node so we need to create one</span></span><br><span class="line">    <span class="comment">// and delete the existing ones.</span></span><br><span class="line">    deleteRemainingChildren(returnFiber, currentFirstChild)</span><br><span class="line">    <span class="keyword">const</span> created = createFiberFromText(textContent, returnFiber.mode, lanes)</span><br><span class="line">    created.return = returnFiber</span><br><span class="line">    <span class="keyword">return</span> created</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 fiber</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    element: ReactElement,</span></span></span><br><span class="line"><span class="function"><span class="params">    lanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> key = element.key</span><br><span class="line">    <span class="keyword">let</span> child = currentFirstChild</span><br><span class="line">    <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> If key === null and child.key === null, then this only applies to</span></span><br><span class="line">      <span class="comment">// the first item in the list.</span></span><br><span class="line">      <span class="keyword">if</span> (child.key === key) &#123;</span><br><span class="line">        <span class="keyword">const</span> elementType = element.type</span><br><span class="line">        <span class="keyword">if</span> (elementType === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">          <span class="keyword">if</span> (child.tag === Fragment) &#123;</span><br><span class="line">            deleteRemainingChildren(returnFiber, child.sibling)</span><br><span class="line">            <span class="keyword">const</span> existing = useFiber(child, element.props.children)</span><br><span class="line">            existing.return = returnFiber</span><br><span class="line">            <span class="keyword">return</span> existing</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            child.elementType === elementType ||</span><br><span class="line">            (enableLazyElements &amp;&amp;</span><br><span class="line">              <span class="keyword">typeof</span> elementType === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">              elementType !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">              elementType.$$<span class="keyword">typeof</span> === REACT_LAZY_TYPE &amp;&amp;</span><br><span class="line">              resolveLazy(elementType) === child.type)</span><br><span class="line">          ) &#123;</span><br><span class="line">            deleteRemainingChildren(returnFiber, child.sibling)</span><br><span class="line">            <span class="keyword">const</span> existing = useFiber(child, element.props)</span><br><span class="line">            existing.ref = coerceRef(returnFiber, child, element)</span><br><span class="line">            existing.return = returnFiber</span><br><span class="line">            <span class="keyword">return</span> existing</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Didn't match.</span></span><br><span class="line">        deleteRemainingChildren(returnFiber, child)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        deleteChild(returnFiber, child)</span><br><span class="line">      &#125;</span><br><span class="line">      child = child.sibling</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (element.type === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromFragment(</span><br><span class="line">        element.props.children,</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        lanes,</span><br><span class="line">        element.key</span><br><span class="line">      )</span><br><span class="line">      created.return = returnFiber</span><br><span class="line">      <span class="keyword">return</span> created</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromElement(element, returnFiber.mode, lanes)</span><br><span class="line">      created.ref = coerceRef(returnFiber, currentFirstChild, element)</span><br><span class="line">      created.return = returnFiber</span><br><span class="line">      <span class="keyword">return</span> created</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 children fiber</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChild: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    lanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 处理 &lt;&gt;&#123;[...]&#125;&lt;/&gt; 和 &lt;&gt;...&lt;/&gt; 组件，从其中提取 children</span></span><br><span class="line">    <span class="keyword">const</span> isUnkeyedTopLevelFragment =</span><br><span class="line">      <span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">      newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">      newChild.key === <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">      newChild = newChild.props.children</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对象类型，为 react 组件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp; newChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (newChild.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">          <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">            reconcileSingleElement(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              lanes</span><br><span class="line">            )</span><br><span class="line">          )</span><br><span class="line">        <span class="comment">// 其它 react 组件类型</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 数组、迭代器，支持 promise 或者 generate</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'string'</span> || <span class="keyword">typeof</span> newChild === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="comment">// 处理字符串或数字类型</span></span><br><span class="line">      <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">        reconcileSingleTextNode(</span><br><span class="line">          returnFiber,</span><br><span class="line">          currentFirstChild,</span><br><span class="line">          <span class="string">''</span> + newChild,</span><br><span class="line">          lanes</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remaining cases are all treated as empty.</span></span><br><span class="line">    <span class="keyword">return</span> deleteRemainingChildren(returnFiber, currentFirstChild)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> reconcileChildFibers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="completeUnitOfWork"><a href="#completeUnitOfWork" class="headerlink" title="completeUnitOfWork"></a><code>completeUnitOfWork</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> completedWork = unitOfWork</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> current = completedWork.alternate <span class="comment">// 更新后的 fiber</span></span><br><span class="line">    <span class="keyword">const</span> returnFiber = completedWork.return <span class="comment">// 父节点 fiber</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((completedWork.flags &amp; Incomplete) === NoFlags) &#123;</span><br><span class="line">      <span class="comment">// 任务未完成</span></span><br><span class="line">      <span class="keyword">let</span> next = completeWork(current, completedWork, subtreeRenderLanes)</span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Completing this fiber spawned new work. Work on that next.</span></span><br><span class="line">        workInProgress = next</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This fiber did not complete because something threw. Pop values off</span></span><br><span class="line">      <span class="comment">// the stack without entering the complete phase. If this is a boundary,</span></span><br><span class="line">      <span class="comment">// capture values if possible.</span></span><br><span class="line">      <span class="keyword">const</span> next = unwindWork(completedWork, subtreeRenderLanes)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Because this fiber did not complete, don't reset its expiration time.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If completing this work spawned new work, do that next. We'll come</span></span><br><span class="line">        <span class="comment">// back here again.</span></span><br><span class="line">        <span class="comment">// Since we're restarting, remove anything that is not a host effect</span></span><br><span class="line">        <span class="comment">// from the effect tag.</span></span><br><span class="line">        next.flags &amp;= HostEffectMask</span><br><span class="line">        workInProgress = next</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Mark the parent fiber as incomplete and clear its subtree flags.</span></span><br><span class="line">        returnFiber.flags |= Incomplete</span><br><span class="line">        returnFiber.subtreeFlags = NoFlags</span><br><span class="line">        returnFiber.deletions = <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> siblingFiber = completedWork.sibling</span><br><span class="line">    <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">      workInProgress = siblingFiber</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise, return to the parent</span></span><br><span class="line">    completedWork = returnFiber</span><br><span class="line">    <span class="comment">// Update the next thing we're working on in case something throws.</span></span><br><span class="line">    workInProgress = completedWork</span><br><span class="line">  &#125; <span class="keyword">while</span> (completedWork !== <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We've reached the root.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRootExitStatus === RootIncomplete) &#123;</span><br><span class="line">    workInProgressRootExitStatus = RootCompleted</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="commitRoot"><a href="#commitRoot" class="headerlink" title="commitRoot"></a><code>commitRoot</code></h5><p>调用 <code>commitRootImpl</code> 提交更新</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRootImpl</span>(<span class="params">root, renderPriorityLevel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// `flushPassiveEffects` will call `flushSyncUpdateQueue` at the end, which</span></span><br><span class="line">    <span class="comment">// means `flushPassiveEffects` will sometimes result in additional</span></span><br><span class="line">    <span class="comment">// passive effects. So we need to keep flushing in a loop until there are</span></span><br><span class="line">    <span class="comment">// no more pending effects.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Might be better if `flushPassiveEffects` did not automatically</span></span><br><span class="line">    <span class="comment">// flush synchronous work at the end, to avoid factoring hazards like this.</span></span><br><span class="line">    flushPassiveEffects();</span><br><span class="line">  &#125; <span class="keyword">while</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> finishedWork = root.finishedWork;</span><br><span class="line">  <span class="keyword">const</span> lanes = root.finishedLanes;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (finishedWork === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  root.finishedWork = <span class="literal">null</span>;</span><br><span class="line">  root.finishedLanes = NoLanes;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// commitRoot never returns a continuation; it always finishes synchronously.</span></span><br><span class="line">  <span class="comment">// So we can clear these now to allow a new callback to be scheduled.</span></span><br><span class="line">  root.callbackNode = <span class="literal">null</span>;</span><br><span class="line">  root.callbackPriority = NoLane;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update the first and last pending times on this root. The new first</span></span><br><span class="line">  <span class="comment">// pending time is whatever is left on the root fiber.</span></span><br><span class="line">  <span class="keyword">let</span> remainingLanes = mergeLanes(finishedWork.lanes, finishedWork.childLanes);</span><br><span class="line">  markRootFinished(root, remainingLanes);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">    <span class="comment">// We can reset these now that they are finished.</span></span><br><span class="line">    workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line">    workInProgress = <span class="literal">null</span>;</span><br><span class="line">    workInProgressRootRenderLanes = NoLanes;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If there are pending passive effects, schedule a callback to process them.</span></span><br><span class="line">  <span class="comment">// Do this as early as possible, so it is queued before anything else that</span></span><br><span class="line">  <span class="comment">// might get scheduled in the commit phase. (See #16714.)</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Delete all other places that schedule the passive effect callback</span></span><br><span class="line">  <span class="comment">// They're redundant.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (finishedWork.subtreeFlags &amp; PassiveMask) !== NoFlags ||</span><br><span class="line">    (finishedWork.flags &amp; PassiveMask) !== NoFlags</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rootDoesHavePassiveEffects) &#123;</span><br><span class="line">      rootDoesHavePassiveEffects = <span class="literal">true</span>;</span><br><span class="line">      scheduleCallback(NormalSchedulerPriority, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        flushPassiveEffects();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there are any effects in the whole tree.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This is left over from the effect list implementation, where we had</span></span><br><span class="line">  <span class="comment">// to check for the existence of `firstEffect` to satsify Flow. I think the</span></span><br><span class="line">  <span class="comment">// only other reason this optimization exists is because it affects profiling.</span></span><br><span class="line">  <span class="comment">// Reconsider whether this is necessary.</span></span><br><span class="line">  <span class="keyword">const</span> subtreeHasEffects =</span><br><span class="line">    (finishedWork.subtreeFlags &amp;</span><br><span class="line">      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==</span><br><span class="line">    NoFlags;</span><br><span class="line">  <span class="keyword">const</span> rootHasEffect =</span><br><span class="line">    (finishedWork.flags &amp;</span><br><span class="line">      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==</span><br><span class="line">    NoFlags;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (subtreeHasEffects || rootHasEffect) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevTransition = ReactCurrentBatchConfig.transition;</span><br><span class="line">    ReactCurrentBatchConfig.transition = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> previousPriority = getCurrentUpdatePriority();</span><br><span class="line">    setCurrentUpdatePriority(DiscreteEventPriority);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">    executionContext |= CommitContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset this to null before calling lifecycles</span></span><br><span class="line">    ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The commit phase is broken into several sub-phases. We do a separate pass</span></span><br><span class="line">    <span class="comment">// of the effect list for each phase: all mutation effects come before all</span></span><br><span class="line">    <span class="comment">// layout effects, and so on.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The first phase a "before mutation" phase. We use this phase to read the</span></span><br><span class="line">    <span class="comment">// state of the host tree right before we mutate it. This is where</span></span><br><span class="line">    <span class="comment">// getSnapshotBeforeUpdate is called.</span></span><br><span class="line">    <span class="keyword">const</span> shouldFireAfterActiveInstanceBlur = commitBeforeMutationEffects(</span><br><span class="line">      root,</span><br><span class="line">      finishedWork,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      <span class="comment">// Mark the current commit time to be shared by all Profilers in this</span></span><br><span class="line">      <span class="comment">// batch. This enables them to be grouped later.</span></span><br><span class="line">      recordCommitTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">      <span class="comment">// Track the root here, rather than in commitLayoutEffects(), because of ref setters.</span></span><br><span class="line">      <span class="comment">// Updates scheduled during ref detachment should also be flagged.</span></span><br><span class="line">      rootCommittingMutationOrLayoutEffects = root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The next phase is the mutation phase, where we mutate the host tree.</span></span><br><span class="line">    commitMutationEffects(root, finishedWork, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldFireAfterActiveInstanceBlur) &#123;</span><br><span class="line">      afterActiveInstanceBlur();</span><br><span class="line">    &#125;</span><br><span class="line">    resetAfterCommit(root.containerInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The work-in-progress tree is now the current tree. This must come after</span></span><br><span class="line">    <span class="comment">// the mutation phase, so that the previous tree is still current during</span></span><br><span class="line">    <span class="comment">// componentWillUnmount, but before the layout phase, so that the finished</span></span><br><span class="line">    <span class="comment">// work is current during componentDidMount/Update.</span></span><br><span class="line">    root.current = finishedWork;</span><br><span class="line">    commitLayoutEffects(finishedWork, root, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">      rootCommittingMutationOrLayoutEffects = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell Scheduler to yield at the end of the frame, so the browser has an</span></span><br><span class="line">    <span class="comment">// opportunity to paint.</span></span><br><span class="line">    requestPaint();</span><br><span class="line"></span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the priority to the previous non-sync value.</span></span><br><span class="line">    setCurrentUpdatePriority(previousPriority);</span><br><span class="line">    ReactCurrentBatchConfig.transition = prevTransition;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No effects.</span></span><br><span class="line">    root.current = finishedWork;</span><br><span class="line">    <span class="comment">// Measure these anyway so the flamegraph explicitly shows that there were</span></span><br><span class="line">    <span class="comment">// no effects.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Maybe there's a better way to report this.</span></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      recordCommitTime();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> rootDidHavePassiveEffects = rootDoesHavePassiveEffects;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rootDoesHavePassiveEffects) &#123;</span><br><span class="line">    <span class="comment">// This commit has passive effects. Stash a reference to them. But don't</span></span><br><span class="line">    <span class="comment">// schedule a callback until after flushing layout work.</span></span><br><span class="line">    rootDoesHavePassiveEffects = <span class="literal">false</span>;</span><br><span class="line">    rootWithPendingPassiveEffects = root;</span><br><span class="line">    pendingPassiveEffectsLanes = lanes;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read this again, since an effect might have updated it</span></span><br><span class="line">  remainingLanes = root.pendingLanes;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there's remaining work on this root</span></span><br><span class="line">  <span class="keyword">if</span> (remainingLanes === NoLanes) &#123;</span><br><span class="line">    <span class="comment">// If there's no remaining work, we can clear the set of already failed</span></span><br><span class="line">    <span class="comment">// error boundaries.</span></span><br><span class="line">    legacyErrorBoundariesThatAlreadyFailed = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (includesSomeLane(remainingLanes, (SyncLane: Lane))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdatePhase) &#123;</span><br><span class="line">      markNestedUpdateScheduled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Count the number of times the root synchronously re-renders without</span></span><br><span class="line">    <span class="comment">// finishing. If there are too many, it indicates an infinite update loop.</span></span><br><span class="line">    <span class="keyword">if</span> (root === rootWithNestedUpdates) &#123;</span><br><span class="line">      nestedUpdateCount++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">      rootWithNestedUpdates = root;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Always call this before exiting `commitRoot`, to ensure that any</span></span><br><span class="line">  <span class="comment">// additional work on this root is scheduled.</span></span><br><span class="line">  ensureRootIsScheduled(root, now());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasUncaughtError) &#123;</span><br><span class="line">    hasUncaughtError = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> error = firstUncaughtError;</span><br><span class="line">    firstUncaughtError = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((executionContext &amp; LegacyUnbatchedContext) !== NoContext) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">      markCommitStopped();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is a legacy edge case. We just committed the initial mount of</span></span><br><span class="line">    <span class="comment">// a ReactDOM.render-ed root inside of batchedUpdates. The commit fired</span></span><br><span class="line">    <span class="comment">// synchronously, but layout updates should be deferred until the end</span></span><br><span class="line">    <span class="comment">// of the batch.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the passive effects are the result of a discrete render, flush them</span></span><br><span class="line">  <span class="comment">// synchronously at the end of the current task so that the result is</span></span><br><span class="line">  <span class="comment">// immediately observable. Otherwise, we assume that they are not</span></span><br><span class="line">  <span class="comment">// order-dependent and do not need to be observed by external systems, so we</span></span><br><span class="line">  <span class="comment">// can wait until after paint.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> We can optimize this by not scheduling the callback earlier. Since we</span></span><br><span class="line">  <span class="comment">// currently schedule the callback in multiple places, will wait until those</span></span><br><span class="line">  <span class="comment">// are consolidated.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    includesSomeLane(pendingPassiveEffectsLanes, SyncLane) &amp;&amp;</span><br><span class="line">    root.tag !== LegacyRoot</span><br><span class="line">  ) &#123;</span><br><span class="line">    flushPassiveEffects();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If layout work was scheduled, flush it now.</span></span><br><span class="line">  flushSyncCallbacks();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    markCommitStopped();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="flushPassiveEffects"><a href="#flushPassiveEffects" class="headerlink" title="flushPassiveEffects"></a><code>flushPassiveEffects</code></h5><p>调用 <code>flushPassiveEffectsImpl</code></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushPassiveEffectsImpl</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (rootWithPendingPassiveEffects === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = rootWithPendingPassiveEffects;</span><br><span class="line">  <span class="keyword">const</span> lanes = pendingPassiveEffectsLanes;</span><br><span class="line">  rootWithPendingPassiveEffects = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This is sometimes out of sync with rootWithPendingPassiveEffects.</span></span><br><span class="line">  <span class="comment">// Figure out why and fix it. It's not causing any known issues (probably</span></span><br><span class="line">  <span class="comment">// because it's only used for profiling), but it's a refactor hazard.</span></span><br><span class="line">  pendingPassiveEffectsLanes = NoLanes;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">  executionContext |= CommitContext;</span><br><span class="line"></span><br><span class="line">  commitPassiveUnmountEffects(root.current);</span><br><span class="line">  commitPassiveMountEffects(root, root.current);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Move to commitPassiveMountEffects</span></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) &#123;</span><br><span class="line">    <span class="keyword">const</span> profilerEffects = pendingPassiveProfilerEffects;</span><br><span class="line">    pendingPassiveProfilerEffects = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; profilerEffects.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> fiber = ((profilerEffects[i]: <span class="built_in">any</span>): Fiber);</span><br><span class="line">      commitPassiveEffectDurations(root, fiber);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  executionContext = prevExecutionContext;</span><br><span class="line">  flushSyncCallbacks();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If additional passive effects were scheduled, increment a counter. If this</span></span><br><span class="line">  <span class="comment">// exceeds the limit, we'll fire a warning.</span></span><br><span class="line">  nestedPassiveUpdateCount =</span><br><span class="line">    rootWithPendingPassiveEffects === <span class="literal">null</span> ? <span class="number">0</span> : nestedPassiveUpdateCount + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = root.current.stateNode;</span><br><span class="line">    stateNode.effectDuration = <span class="number">0</span>;</span><br><span class="line">    stateNode.passiveEffectDuration = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="commitPassiveUnmountEffects"><a href="#commitPassiveUnmountEffects" class="headerlink" title="commitPassiveUnmountEffects"></a><code>commitPassiveUnmountEffects</code></h5><p>执行生命周期钩子，当进入节点时立即执行生命周期函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p><p>调用 <code>commitPassiveUnmountEffects_begin</code> 开启操作，<code>commitPassiveUnmountEffects_complete</code> 完成操作</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountEffects_begin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// curr -&gt; child -&gt; child</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> child = fiber.child</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((nextEffect.flags &amp; ChildDeletion) !== NoFlags) &#123;</span><br><span class="line">      <span class="keyword">const</span> deletions = fiber.deletions</span><br><span class="line">      <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.length; i++) &#123;</span><br><span class="line">          <span class="keyword">const</span> fiberToDelete = deletions[i]</span><br><span class="line">          nextEffect = fiberToDelete</span><br><span class="line">          commitPassiveUnmountEffectsInsideOfDeletedTree_begin(</span><br><span class="line">            fiberToDelete,</span><br><span class="line">            fiber</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="comment">// A fiber was deleted from this parent fiber, but it's still part of</span></span><br><span class="line">          <span class="comment">// the previous (alternate) parent fiber's list of children. Because</span></span><br><span class="line">          <span class="comment">// children are a linked list, an earlier sibling that's still alive</span></span><br><span class="line">          <span class="comment">// will be connected to the deleted fiber via its `alternate`:</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          <span class="comment">//   live fiber</span></span><br><span class="line">          <span class="comment">//   --alternate--&gt; previous live fiber</span></span><br><span class="line">          <span class="comment">//   --sibling--&gt; deleted fiber</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          <span class="comment">// We can't disconnect `alternate` on nodes that haven't been deleted</span></span><br><span class="line">          <span class="comment">// yet, but we can disconnect the `sibling` and `child` pointers.</span></span><br><span class="line">          <span class="keyword">const</span> previousFiber = fiber.alternate</span><br><span class="line">          <span class="keyword">if</span> (previousFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> detachedChild = previousFiber.child</span><br><span class="line">            <span class="keyword">if</span> (detachedChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">              previousFiber.child = <span class="literal">null</span></span><br><span class="line">              <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> detachedSibling = detachedChild.sibling</span><br><span class="line">                detachedChild.sibling = <span class="literal">null</span></span><br><span class="line">                detachedChild = detachedSibling</span><br><span class="line">              &#125; <span class="keyword">while</span> (detachedChild !== <span class="literal">null</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nextEffect = fiber</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fiber.subtreeFlags &amp; PassiveMask) !== NoFlags &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(child, fiber) <span class="comment">// 确保父节点指向 fiber</span></span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      commitPassiveUnmountEffects_complete()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountEffects_complete</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 若存在兄弟节点则遍历下一个兄弟节点，否则返回父节点</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">if</span> ((fiber.flags &amp; Passive) !== NoFlags) &#123;</span><br><span class="line">      commitPassiveUnmountOnFiber(fiber)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, fiber.return)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect = fiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountOnFiber</span>(<span class="params">finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">        commitHookEffectListUnmount(</span><br><span class="line">          HookPassive | HookHasEffect,</span><br><span class="line">          finishedWork,</span><br><span class="line">          finishedWork.return,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountEffectsInsideOfDeletedTree_begin</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  deletedSubtreeRoot: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nearestMountedAncestor: Fiber | <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// p-&gt; child -&gt; child</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="comment">// Deletion effects fire in parent -&gt; child order</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Check if fiber has a PassiveStatic flag</span></span><br><span class="line">    commitPassiveUnmountInsideDeletedTreeOnFiber(fiber, nearestMountedAncestor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.child</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Only traverse subtree if it has a PassiveStatic flag. (But, if we</span></span><br><span class="line">    <span class="comment">// do this, still need to handle `deletedTreeCleanUpLevel` correctly.)</span></span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      commitPassiveUnmountEffectsInsideOfDeletedTree_complete(</span><br><span class="line">        deletedSubtreeRoot</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountInsideDeletedTreeOnFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nearestMountedAncestor: Fiber | <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (current.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      commitHookEffectListUnmount(HookPassive, current, nearestMountedAncestor)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁组件，要销毁的组件存在 updateQueue 中</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitHookEffectListUnmount</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  flags: HookFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nearestMountedAncestor: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue: FunctionComponentUpdateQueue | <span class="literal">null</span> = (finishedWork.updateQueue: <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">const</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.lastEffect : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstEffect = lastEffect.next;</span><br><span class="line">    <span class="keyword">let</span> effect = firstEffect;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((effect.tag &amp; flags) === flags) &#123;</span><br><span class="line">        <span class="comment">// Unmount</span></span><br><span class="line">        <span class="keyword">const</span> destroy = effect.destroy;</span><br><span class="line">        effect.destroy = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          safelyCallDestroy(finishedWork, nearestMountedAncestor, destroy); <span class="comment">// 调用 destroy 销毁组件</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      effect = effect.next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountEffectsInsideOfDeletedTree_complete</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  deletedSubtreeRoot: Fiber</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">const</span> returnFiber = fiber.return</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="comment">// Recursively traverse the entire deleted tree and clean up fiber fields.</span></span><br><span class="line">      <span class="comment">// This is more aggressive than ideal, and the long term goal is to only</span></span><br><span class="line">      <span class="comment">// have to detach the deleted tree at the root.</span></span><br><span class="line">      detachFiberAfterEffects(fiber)</span><br><span class="line">      <span class="keyword">if</span> (fiber === deletedSubtreeRoot) &#123;</span><br><span class="line">        nextEffect = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This is the default branch (level 0). We do not recursively clear all</span></span><br><span class="line">      <span class="comment">// the fiber fields. Only the root of the deleted subtree.</span></span><br><span class="line">      <span class="keyword">if</span> (fiber === deletedSubtreeRoot) &#123;</span><br><span class="line">        detachFiberAfterEffects(fiber)</span><br><span class="line">        nextEffect = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, returnFiber)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = returnFiber</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">detachFiberAfterEffects</span>(<span class="params">fiber: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> alternate = fiber.alternate</span><br><span class="line">  <span class="keyword">if</span> (alternate !== <span class="literal">null</span>) &#123;</span><br><span class="line">    fiber.alternate = <span class="literal">null</span></span><br><span class="line">    detachFiberAfterEffects(alternate)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: Defensively using negation instead of &lt; in case</span></span><br><span class="line">  <span class="comment">// `deletedTreeCleanUpLevel` is undefined.</span></span><br><span class="line">  <span class="keyword">if</span> (!(deletedTreeCleanUpLevel &gt;= <span class="number">2</span>)) &#123;</span><br><span class="line">    <span class="comment">// This is the default branch (level 0).</span></span><br><span class="line">    fiber.child = <span class="literal">null</span></span><br><span class="line">    fiber.deletions = <span class="literal">null</span></span><br><span class="line">    fiber.dependencies = <span class="literal">null</span></span><br><span class="line">    fiber.memoizedProps = <span class="literal">null</span></span><br><span class="line">    fiber.memoizedState = <span class="literal">null</span></span><br><span class="line">    fiber.pendingProps = <span class="literal">null</span></span><br><span class="line">    fiber.sibling = <span class="literal">null</span></span><br><span class="line">    fiber.stateNode = <span class="literal">null</span></span><br><span class="line">    fiber.updateQueue = <span class="literal">null</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Clear cyclical Fiber fields. This level alone is designed to roughly</span></span><br><span class="line">    <span class="comment">// approximate the planned Fiber refactor. In that world, `setState` will be</span></span><br><span class="line">    <span class="comment">// bound to a special "instance" object instead of a Fiber. The Instance</span></span><br><span class="line">    <span class="comment">// object will not have any of these fields. It will only be connected to</span></span><br><span class="line">    <span class="comment">// the fiber tree via a single link at the root. So if this level alone is</span></span><br><span class="line">    <span class="comment">// sufficient to fix memory issues, that bodes well for our plans.</span></span><br><span class="line">    fiber.child = <span class="literal">null</span></span><br><span class="line">    fiber.deletions = <span class="literal">null</span></span><br><span class="line">    fiber.sibling = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The `stateNode` is cyclical because on host nodes it points to the host</span></span><br><span class="line">    <span class="comment">// tree, which has its own pointers to children, parents, and siblings.</span></span><br><span class="line">    <span class="comment">// The other host nodes also point back to fibers, so we should detach that</span></span><br><span class="line">    <span class="comment">// one, too.</span></span><br><span class="line">    <span class="keyword">if</span> (fiber.tag === HostComponent) &#123;</span><br><span class="line">      <span class="keyword">const</span> hostInstance: Instance = fiber.stateNode</span><br><span class="line">      <span class="keyword">if</span> (hostInstance !== <span class="literal">null</span>) &#123;</span><br><span class="line">        detachDeletedInstance(hostInstance) <span class="comment">// 删除 react 相关属性，包括事件、容器等</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fiber.stateNode = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="comment">// Theoretically, nothing in here should be necessary, because we already</span></span><br><span class="line">      <span class="comment">// disconnected the fiber from the tree. So even if something leaks this</span></span><br><span class="line">      <span class="comment">// particular fiber, it won't leak anything else</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// The purpose of this branch is to be super aggressive so we can measure</span></span><br><span class="line">      <span class="comment">// if there's any difference in memory impact. If there is, that could</span></span><br><span class="line">      <span class="comment">// indicate a React leak we don't know about.</span></span><br><span class="line">      fiber.return = <span class="literal">null</span></span><br><span class="line">      fiber.dependencies = <span class="literal">null</span></span><br><span class="line">      fiber.memoizedProps = <span class="literal">null</span></span><br><span class="line">      fiber.memoizedState = <span class="literal">null</span></span><br><span class="line">      fiber.pendingProps = <span class="literal">null</span></span><br><span class="line">      fiber.stateNode = <span class="literal">null</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Move to `commitPassiveUnmountInsideDeletedTreeOnFiber` instead.</span></span><br><span class="line">      fiber.updateQueue = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="commitBeforeMutationEffects"><a href="#commitBeforeMutationEffects" class="headerlink" title="commitBeforeMutationEffects"></a><code>commitBeforeMutationEffects</code></h5><p>执行生命周期钩子，当进入节点时立即执行生命周期函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle 全局变量</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  firstChild: Fiber</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  focusedInstanceHandle = prepareForCommit(root.containerInfo) <span class="comment">// 查找活跃的的节点</span></span><br><span class="line"></span><br><span class="line">  nextEffect = firstChild</span><br><span class="line">  commitBeforeMutationEffects_begin()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We no longer need to track the active instance fiber</span></span><br><span class="line">  <span class="keyword">const</span> shouldFire = shouldFireAfterActiveInstanceBlur</span><br><span class="line">  shouldFireAfterActiveInstanceBlur = <span class="literal">false</span></span><br><span class="line">  focusedInstanceHandle = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> shouldFire</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects_begin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should wrap this in flags check, too, as optimization</span></span><br><span class="line">    <span class="keyword">const</span> deletions = fiber.deletions</span><br><span class="line">    <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> deletion = deletions[i]</span><br><span class="line">        commitBeforeMutationEffectsDeletion(deletion)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.child</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (fiber.subtreeFlags &amp; BeforeMutationMask) !== NoFlags &amp;&amp;</span><br><span class="line">      child !== <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      commitBeforeMutationEffects_complete()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects_complete</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 先兄弟节点再父节点</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    commitBeforeMutationEffectsOnFiber(fiber)</span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, fiber.return)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffectsOnFiber</span>(<span class="params">finishedWork: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.flags</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!shouldFireAfterActiveInstanceBlur &amp;&amp; focusedInstanceHandle !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Check to see if the focused element was inside of a hidden (Suspense) subtree.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Move this out of the hot path using a dedicated effect tag.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      finishedWork.tag === SuspenseComponent &amp;&amp;</span><br><span class="line">      isSuspenseBoundaryBeingHidden(current, finishedWork) &amp;&amp;</span><br><span class="line">      doesFiberContain(finishedWork, focusedInstanceHandle)</span><br><span class="line">    ) &#123;</span><br><span class="line">      shouldFireAfterActiveInstanceBlur = <span class="literal">true</span></span><br><span class="line">      beforeActiveInstanceBlur(finishedWork)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((flags &amp; Snapshot) !== NoFlags) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">      <span class="keyword">case</span> ForwardRef:</span><br><span class="line">      <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevProps = current.memoizedProps</span><br><span class="line">          <span class="keyword">const</span> prevState = current.memoizedState</span><br><span class="line">          <span class="keyword">const</span> instance = finishedWork.stateNode</span><br><span class="line">          <span class="keyword">const</span> snapshot = instance.getSnapshotBeforeUpdate(</span><br><span class="line">            finishedWork.elementType === finishedWork.type</span><br><span class="line">              ? prevProps</span><br><span class="line">              : resolveDefaultProps(finishedWork.type, prevProps),</span><br><span class="line">            prevState</span><br><span class="line">          )</span><br><span class="line">          instance.__reactInternalSnapshotBeforeUpdate = snapshot</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsMutation) &#123;</span><br><span class="line">          <span class="keyword">const</span> root = finishedWork.stateNode</span><br><span class="line">          clearContainer(root.containerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> HostComponent:</span><br><span class="line">      <span class="keyword">case</span> HostText:</span><br><span class="line">      <span class="keyword">case</span> HostPortal:</span><br><span class="line">      <span class="keyword">case</span> IncompleteClassComponent:</span><br><span class="line">        <span class="comment">// Nothing to do for these component types</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">default</span>: &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffectsDeletion</span>(<span class="params">deletion: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// TODO (effects) It would be nice to avoid calling doesFiberContain()</span></span><br><span class="line">  <span class="comment">// Maybe we can repurpose one of the subtreeFlags positions for this instead?</span></span><br><span class="line">  <span class="comment">// Use it to store which part of the tree the focused instance is in?</span></span><br><span class="line">  <span class="comment">// This assumes we can safely determine that instance during the "render" phase.</span></span><br><span class="line">  <span class="keyword">if</span> (doesFiberContain(deletion, focusedInstanceHandle)) &#123;</span><br><span class="line">    shouldFireAfterActiveInstanceBlur = <span class="literal">true</span></span><br><span class="line">    beforeActiveInstanceBlur(deletion)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="commitMutationEffects"><a href="#commitMutationEffects" class="headerlink" title="commitMutationEffects"></a><code>commitMutationEffects</code></h5><p>构建 dom 节点，在离开节点时开始 dom 构建<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle,inProgressLanes,inProgressRoot 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  firstChild: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  inProgressLanes = committedLanes</span><br><span class="line">  inProgressRoot = root</span><br><span class="line">  nextEffect = firstChild</span><br><span class="line"></span><br><span class="line">  commitMutationEffects_begin(root)</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span></span><br><span class="line">  inProgressRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects_begin</span>(<span class="params">root: FiberRoot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should wrap this in flags check, too, as optimization</span></span><br><span class="line">    <span class="keyword">const</span> deletions = fiber.deletions</span><br><span class="line">    <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> childToDelete = deletions[i]</span><br><span class="line">        commitDeletion(root, childToDelete, fiber)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.child</span><br><span class="line">    <span class="keyword">if</span> ((fiber.subtreeFlags &amp; MutationMask) !== NoFlags &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      commitMutationEffects_complete(root)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects_complete</span>(<span class="params">root: FiberRoot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    commitMutationEffectsOnFiber(fiber, root)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, fiber.return)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffectsOnFiber</span>(<span class="params">finishedWork: Fiber, root: FiberRoot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.flags</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; ContentReset) &#123;</span><br><span class="line">    commitResetTextContent(finishedWork)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; Ref) &#123;</span><br><span class="line">    <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      commitDetachRef(current)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> This is a temporary solution that allowed us to transition away</span></span><br><span class="line">      <span class="comment">// from React Flare on www.</span></span><br><span class="line">      <span class="keyword">if</span> (finishedWork.tag === ScopeComponent) &#123;</span><br><span class="line">        commitAttachRef(finishedWork)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The following switch statement is only concerned about placement,</span></span><br><span class="line">  <span class="comment">// updates, and deletions. To avoid needing to add a case for every possible</span></span><br><span class="line">  <span class="comment">// bitmap value, we remove the secondary effects from the effect tag and</span></span><br><span class="line">  <span class="comment">// switch on that value.</span></span><br><span class="line">  <span class="keyword">const</span> primaryFlags = flags &amp; (Placement | Update | Hydrating)</span><br><span class="line">  <span class="keyword">switch</span> (primaryFlags) &#123;</span><br><span class="line">    <span class="keyword">case</span> Placement: &#123;</span><br><span class="line">      commitPlacement(finishedWork)</span><br><span class="line">      <span class="comment">// Clear the "placement" from effect tag so that we know that this is</span></span><br><span class="line">      <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> findDOMNode doesn't rely on this any more but isMounted does</span></span><br><span class="line">      <span class="comment">// and isMounted is deprecated anyway so we should be able to kill this.</span></span><br><span class="line">      finishedWork.flags &amp;= ~Placement</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> PlacementAndUpdate: &#123;</span><br><span class="line">      <span class="comment">// Placement</span></span><br><span class="line">      commitPlacement(finishedWork)</span><br><span class="line">      <span class="comment">// Clear the "placement" from effect tag so that we know that this is</span></span><br><span class="line">      <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">      finishedWork.flags &amp;= ~Placement</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">      commitWork(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Hydrating: &#123;</span><br><span class="line">      finishedWork.flags &amp;= ~Hydrating</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HydratingAndUpdate: &#123;</span><br><span class="line">      finishedWork.flags &amp;= ~Hydrating</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">      commitWork(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Update: &#123;</span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">      commitWork(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitWork</span>(<span class="params">current: Fiber | <span class="literal">null</span>, finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">      <span class="keyword">case</span> ForwardRef:</span><br><span class="line">      <span class="keyword">case</span> MemoComponent:</span><br><span class="line">      <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">        <span class="comment">// Layout effects are destroyed during the mutation phase so that all</span></span><br><span class="line">        <span class="comment">// destroy functions for all fibers are called before any create functions.</span></span><br><span class="line">        <span class="comment">// This prevents sibling component effects from interfering with each other,</span></span><br><span class="line">        <span class="comment">// e.g. a destroy function in one component should never override a ref set</span></span><br><span class="line">        <span class="comment">// by a create function in another component during the same commit.</span></span><br><span class="line"></span><br><span class="line">          commitHookEffectListUnmount(</span><br><span class="line">            HookLayout | HookHasEffect,</span><br><span class="line">            finishedWork,</span><br><span class="line">            finishedWork.return,</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> Profiler: &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">        commitSuspenseComponent(finishedWork);</span><br><span class="line">        attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">        attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsHydration) &#123;</span><br><span class="line">          <span class="keyword">const</span> root: FiberRoot = finishedWork.stateNode;</span><br><span class="line">          <span class="keyword">if</span> (root.hydrate) &#123;</span><br><span class="line">            <span class="comment">// We've just hydrated. No need to hydrate again.</span></span><br><span class="line">            root.hydrate = <span class="literal">false</span>;</span><br><span class="line">            commitHydratedContainer(root.containerInfo);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> OffscreenComponent:</span><br><span class="line">      <span class="keyword">case</span> LegacyHiddenComponent: &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    commitContainer(finishedWork);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> MemoComponent:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      <span class="comment">// Layout effects are destroyed during the mutation phase so that all</span></span><br><span class="line">      <span class="comment">// destroy functions for all fibers are called before any create functions.</span></span><br><span class="line">      <span class="comment">// This prevents sibling component effects from interfering with each other,</span></span><br><span class="line">      <span class="comment">// e.g. a destroy function in one component should never override a ref set</span></span><br><span class="line">      <span class="comment">// by a create function in another component during the same commit.</span></span><br><span class="line"></span><br><span class="line">        commitHookEffectListUnmount(</span><br><span class="line">          HookLayout | HookHasEffect,</span><br><span class="line">          finishedWork,</span><br><span class="line">          finishedWork.return,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> instance: Instance = finishedWork.stateNode;</span><br><span class="line">      <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Commit the work prepared earlier.</span></span><br><span class="line">        <span class="keyword">const</span> newProps = finishedWork.memoizedProps;</span><br><span class="line">        <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">        <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">        <span class="comment">// this case.</span></span><br><span class="line">        <span class="keyword">const</span> oldProps = current !== <span class="literal">null</span> ? current.memoizedProps : newProps;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">type</span> = finishedWork.type;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Type the updateQueue to be specific to host components.</span></span><br><span class="line">        <span class="keyword">const</span> updatePayload: <span class="literal">null</span> | UpdatePayload = (finishedWork.updateQueue: <span class="built_in">any</span>);</span><br><span class="line">        finishedWork.updateQueue = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (updatePayload !== <span class="literal">null</span>) &#123;</span><br><span class="line">          commitUpdate(</span><br><span class="line">            instance,</span><br><span class="line">            updatePayload,</span><br><span class="line">            <span class="keyword">type</span>,</span><br><span class="line">            oldProps,</span><br><span class="line">            newProps,</span><br><span class="line">            finishedWork,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostText: &#123;</span><br><span class="line">      <span class="keyword">const</span> textInstance: TextInstance = finishedWork.stateNode;</span><br><span class="line">      <span class="keyword">const</span> newText: <span class="built_in">string</span> = finishedWork.memoizedProps;</span><br><span class="line">      <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">      <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">      <span class="comment">// this case.</span></span><br><span class="line">      <span class="keyword">const</span> oldText: <span class="built_in">string</span> =</span><br><span class="line">        current !== <span class="literal">null</span> ? current.memoizedProps : newText;</span><br><span class="line">      commitTextUpdate(textInstance, oldText, newText);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">      <span class="keyword">if</span> (supportsHydration) &#123;</span><br><span class="line">        <span class="keyword">const</span> root: FiberRoot = finishedWork.stateNode;</span><br><span class="line">        <span class="keyword">if</span> (root.hydrate) &#123;</span><br><span class="line">          <span class="comment">// We've just hydrated. No need to hydrate again.</span></span><br><span class="line">          root.hydrate = <span class="literal">false</span>;</span><br><span class="line">          commitHydratedContainer(root.containerInfo);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Profiler: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">      commitSuspenseComponent(finishedWork);</span><br><span class="line">      attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">      attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> IncompleteClassComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ScopeComponent: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">        <span class="keyword">const</span> scopeInstance = finishedWork.stateNode;</span><br><span class="line">        prepareScopeUpdate(scopeInstance, finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> OffscreenComponent:</span><br><span class="line">    <span class="keyword">case</span> LegacyHiddenComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> newState: OffscreenState | <span class="literal">null</span> = finishedWork.memoizedState;</span><br><span class="line">      <span class="keyword">const</span> isHidden = newState !== <span class="literal">null</span>;</span><br><span class="line">      hideOrUnhideAllChildren(finishedWork, isHidden);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPlacement</span>(<span class="params">finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Recursively insert all host nodes into the parent.</span></span><br><span class="line">  <span class="keyword">const</span> parentFiber = getHostParentFiber(finishedWork);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: these two variables *must* always be updated together.</span></span><br><span class="line">  <span class="keyword">let</span> parent;</span><br><span class="line">  <span class="keyword">let</span> isContainer;</span><br><span class="line">  <span class="keyword">const</span> parentStateNode = parentFiber.stateNode;</span><br><span class="line">  <span class="keyword">switch</span> (parentFiber.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">      parent = parentStateNode;</span><br><span class="line">      isContainer = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HostRoot:</span><br><span class="line">      parent = parentStateNode.containerInfo;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HostPortal:</span><br><span class="line">      parent = parentStateNode.containerInfo;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// eslint-disable-next-line-no-fallthrough</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (parentFiber.flags &amp; ContentReset) &#123;</span><br><span class="line">    <span class="comment">// Reset the text content of the parent before doing any insertions</span></span><br><span class="line">    resetTextContent(parent);</span><br><span class="line">    <span class="comment">// Clear ContentReset from the effect tag</span></span><br><span class="line">    parentFiber.flags &amp;= ~ContentReset;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> before = getHostSibling(finishedWork);</span><br><span class="line">  <span class="comment">// 插入 dom 元素</span></span><br><span class="line">  <span class="keyword">if</span> (isContainer) &#123;</span><br><span class="line">    insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    insertOrAppendPlacementNode(finishedWork, before, parent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isHostParent</span>(<span class="params">fiber: Fiber</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    fiber.tag === HostComponent ||</span><br><span class="line">    fiber.tag === HostRoot ||</span><br><span class="line">    fiber.tag === HostPortal</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getHostSibling</span>(<span class="params">fiber: Fiber</span>): ?<span class="title">Instance</span> </span>&#123;</span><br><span class="line">  <span class="comment">// We're going to search forward into the tree until we find a sibling host</span></span><br><span class="line">  <span class="comment">// node. Unfortunately, if multiple insertions are done in a row we have to</span></span><br><span class="line">  <span class="comment">// search past them. This leads to exponential search for the next sibling.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Find a more efficient way to do this.</span></span><br><span class="line">  <span class="keyword">let</span> node: Fiber = fiber;</span><br><span class="line">  siblings: <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// If we didn't find anything, let's try the next sibling.</span></span><br><span class="line">    <span class="keyword">while</span> (node.sibling === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.return === <span class="literal">null</span> || isHostParent(node.return)) &#123;</span><br><span class="line">        <span class="comment">// If we pop out of the root or hit the parent the fiber we are the</span></span><br><span class="line">        <span class="comment">// last sibling.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.return;</span><br><span class="line">    &#125;</span><br><span class="line">    node.sibling.return = node.return;</span><br><span class="line">    node = node.sibling;</span><br><span class="line">    <span class="keyword">while</span> (</span><br><span class="line">      node.tag !== HostComponent &amp;&amp;</span><br><span class="line">      node.tag !== HostText &amp;&amp;</span><br><span class="line">      node.tag !== DehydratedFragment</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// If it is not host node and, we might have a host node inside it.</span></span><br><span class="line">      <span class="comment">// Try to search down until we find one.</span></span><br><span class="line">      <span class="keyword">if</span> (node.flags &amp; Placement) &#123;</span><br><span class="line">        <span class="comment">// If we don't have a child, try the siblings instead.</span></span><br><span class="line">        <span class="keyword">continue</span> siblings;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// If we don't have a child, try the siblings instead.</span></span><br><span class="line">      <span class="comment">// We also skip portals because they are not part of this host tree.</span></span><br><span class="line">      <span class="keyword">if</span> (node.child === <span class="literal">null</span> || node.tag === HostPortal) &#123;</span><br><span class="line">        <span class="keyword">continue</span> siblings;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node.child.return = node;</span><br><span class="line">        node = node.child;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check if this host node is stable or about to be placed.</span></span><br><span class="line">    <span class="keyword">if</span> (!(node.flags &amp; Placement)) &#123;</span><br><span class="line">      <span class="comment">// Found it!</span></span><br><span class="line">      <span class="keyword">return</span> node.stateNode;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertOrAppendPlacementNodeIntoContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  node: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  before: ?Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">  parent: Container,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;tag&#125; = node;</span><br><span class="line">  <span class="keyword">const</span> isHost = tag === HostComponent || tag === HostText;</span><br><span class="line">  <span class="keyword">if</span> (isHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = node.stateNode;</span><br><span class="line">    <span class="keyword">if</span> (before) &#123;</span><br><span class="line">      insertInContainerBefore(parent, stateNode, before);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      appendChildToContainer(parent, stateNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === HostPortal) &#123;</span><br><span class="line">    <span class="comment">// If the insertion itself is a portal, then we don't want to traverse</span></span><br><span class="line">    <span class="comment">// down its children. Instead, we'll get insertions from each child in</span></span><br><span class="line">    <span class="comment">// the portal directly.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> child = node.child;</span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      insertOrAppendPlacementNodeIntoContainer(child, before, parent);</span><br><span class="line">      <span class="keyword">let</span> sibling = child.sibling;</span><br><span class="line">      <span class="keyword">while</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">        insertOrAppendPlacementNodeIntoContainer(sibling, before, parent);</span><br><span class="line">        sibling = sibling.sibling;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertOrAppendPlacementNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  node: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  before: ?Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">  parent: Instance,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;tag&#125; = node;</span><br><span class="line">  <span class="keyword">const</span> isHost = tag === HostComponent || tag === HostText;</span><br><span class="line">  <span class="keyword">if</span> (isHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = node.stateNode;</span><br><span class="line">    <span class="keyword">if</span> (before) &#123;</span><br><span class="line">      insertBefore(parent, stateNode, before);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      appendChild(parent, stateNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === HostPortal) &#123;</span><br><span class="line">    <span class="comment">// If the insertion itself is a portal, then we don't want to traverse</span></span><br><span class="line">    <span class="comment">// down its children. Instead, we'll get insertions from each child in</span></span><br><span class="line">    <span class="comment">// the portal directly.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> child = node.child;</span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      insertOrAppendPlacementNode(child, before, parent);</span><br><span class="line">      <span class="keyword">let</span> sibling = child.sibling;</span><br><span class="line">      <span class="keyword">while</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">        insertOrAppendPlacementNode(sibling, before, parent);</span><br><span class="line">        sibling = sibling.sibling;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="commitLayoutEffects"><a href="#commitLayoutEffects" class="headerlink" title="commitLayoutEffects"></a><code>commitLayoutEffects</code></h5><p>执行生命周期钩子，在离开当前节点时调用钩子函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle,inProgressLanes,inProgressRoot 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  inProgressLanes = committedLanes</span><br><span class="line">  inProgressRoot = root</span><br><span class="line">  nextEffect = finishedWork</span><br><span class="line"></span><br><span class="line">  commitLayoutEffects_begin(finishedWork, root, committedLanes)</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span></span><br><span class="line">  inProgressRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutEffects_begin</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  subtreeRoot: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Suspense layout effects semantics don't change for legacy roots.</span></span><br><span class="line">  <span class="keyword">const</span> isModernRoot = (subtreeRoot.mode &amp; ConcurrentMode) !== NoMode</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> firstChild = fiber.child</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics &amp;&amp; isModernRoot) &#123;</span><br><span class="line">      <span class="comment">// Keep track of the current Offscreen stack's state.</span></span><br><span class="line">      <span class="keyword">if</span> (fiber.tag === OffscreenComponent) &#123;</span><br><span class="line">        <span class="keyword">const</span> current = fiber.alternate</span><br><span class="line">        <span class="keyword">const</span> wasHidden = current !== <span class="literal">null</span> &amp;&amp; current.memoizedState !== <span class="literal">null</span></span><br><span class="line">        <span class="keyword">const</span> isHidden = fiber.memoizedState !== <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> newOffscreenSubtreeIsHidden = isHidden || offscreenSubtreeIsHidden</span><br><span class="line">        <span class="keyword">const</span> newOffscreenSubtreeWasHidden =</span><br><span class="line">          wasHidden || offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          newOffscreenSubtreeIsHidden !== offscreenSubtreeIsHidden ||</span><br><span class="line">          newOffscreenSubtreeWasHidden !== offscreenSubtreeWasHidden</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevOffscreenSubtreeIsHidden = offscreenSubtreeIsHidden</span><br><span class="line">          <span class="keyword">const</span> prevOffscreenSubtreeWasHidden = offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Traverse the Offscreen subtree with the current Offscreen as the root.</span></span><br><span class="line">          offscreenSubtreeIsHidden = newOffscreenSubtreeIsHidden</span><br><span class="line">          offscreenSubtreeWasHidden = newOffscreenSubtreeWasHidden</span><br><span class="line">          commitLayoutEffects_begin(</span><br><span class="line">            fiber, <span class="comment">// New root; bubble back up to here and stop.</span></span><br><span class="line">            root,</span><br><span class="line">            committedLanes</span><br><span class="line">          )</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Restore Offscreen state and resume in our-progress traversal.</span></span><br><span class="line">          nextEffect = fiber</span><br><span class="line">          offscreenSubtreeIsHidden = prevOffscreenSubtreeIsHidden</span><br><span class="line">          offscreenSubtreeWasHidden = prevOffscreenSubtreeWasHidden</span><br><span class="line">          commitLayoutMountEffects_complete(subtreeRoot, root, committedLanes)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fiber.subtreeFlags &amp; LayoutMask) !== NoFlags &amp;&amp; firstChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(firstChild, fiber)</span><br><span class="line">      nextEffect = firstChild</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics &amp;&amp; isModernRoot) &#123;</span><br><span class="line">        <span class="keyword">const</span> visibilityChanged =</span><br><span class="line">          !offscreenSubtreeIsHidden &amp;&amp; offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO (Offscreen) Also check: subtreeFlags &amp; LayoutStatic</span></span><br><span class="line">        <span class="keyword">if</span> (visibilityChanged &amp;&amp; firstChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// We've just shown or hidden a Offscreen tree that contains layout effects.</span></span><br><span class="line">          <span class="comment">// We only enter this code path for subtrees that are updated,</span></span><br><span class="line">          <span class="comment">// because newly mounted ones would pass the LayoutMask check above.</span></span><br><span class="line">          ensureCorrectReturnPointer(firstChild, fiber)</span><br><span class="line">          nextEffect = firstChild</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      commitLayoutMountEffects_complete(subtreeRoot, root, committedLanes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutMountEffects_complete</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  subtreeRoot: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Suspense layout effects semantics don't change for legacy roots.</span></span><br><span class="line">  <span class="keyword">const</span> isModernRoot = (subtreeRoot.mode &amp; ConcurrentMode) !== NoMode</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      enableSuspenseLayoutEffectSemantics &amp;&amp;</span><br><span class="line">      isModernRoot &amp;&amp;</span><br><span class="line">      offscreenSubtreeWasHidden &amp;&amp;</span><br><span class="line">      !offscreenSubtreeIsHidden</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// Inside of an Offscreen subtree that changed visibility during this commit.</span></span><br><span class="line">      <span class="comment">// If this subtree was hidden, layout effects will have already been destroyed (during mutation phase)</span></span><br><span class="line">      <span class="comment">// but if it was just shown, we need to (re)create the effects now.</span></span><br><span class="line">      <span class="comment">// TODO (Offscreen) Check: flags &amp; LayoutStatic</span></span><br><span class="line">      <span class="keyword">switch</span> (fiber.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">        <span class="keyword">case</span> ForwardRef:</span><br><span class="line">        <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">          safelyCallCommitHookLayoutEffectListMount(fiber, fiber.return)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> instance = fiber.stateNode</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.componentDidMount === <span class="string">'function'</span>) &#123;</span><br><span class="line">            safelyCallComponentDidMount(fiber, fiber.return, instance)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// TODO (Offscreen) Check flags &amp; RefStatic</span></span><br><span class="line">      <span class="keyword">switch</span> (fiber.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent:</span><br><span class="line">        <span class="keyword">case</span> HostComponent:</span><br><span class="line">          safelyAttachRef(fiber, fiber.return)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((fiber.flags &amp; LayoutMask) !== NoFlags) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = fiber.alternate</span><br><span class="line">      commitLayoutEffectOnFiber(root, current, fiber, committedLanes)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fiber === subtreeRoot) &#123;</span><br><span class="line">      nextEffect = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, fiber.return)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;react-同步更新&quot;&gt;&lt;a href=&quot;#react-同步更新&quot; class=&quot;headerlink&quot; title=&quot;react 同步更新&quot;&gt;&lt;/a&gt;react 同步更新&lt;/h3&gt;&lt;h4 id=&quot;class-组件&quot;&gt;&lt;a href=&quot;#class-组件&quot; cla
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="react" scheme="http://yoursite.com/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>react中的事件</title>
    <link href="http://yoursite.com/2021/06/12/react%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6/"/>
    <id>http://yoursite.com/2021/06/12/react中的事件/</id>
    <published>2021-06-12T12:34:30.000Z</published>
    <updated>2021-08-08T09:40:04.169Z</updated>
    
    <content type="html"><![CDATA[<p><img src="/images/react/react-event.jpg" alt="react 中的事件"></p><h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p><img src="/images/react/react-event-init.jpg" alt="react 事件初始化"></p><ol><li>在 <code>react-dom</code> 模块的 <code>src/client/ReactDOM</code> 中引入 <code>ReactDOMEventHandle</code> 文件，把该文件中的 <code>createEventHandle</code> 函数导出为 <code>unstable_createEventHandle</code> 以供第三方使用</li><li><p>在 <code>ReactDOMEventHandle</code> 文件中引入 <code>events/DOMPluginEventSystem</code> 文件，在模块中注册了顶级事件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line">SimpleEventPlugin.registerEvents()</span><br><span class="line">EnterLeaveEventPlugin.registerEvents()</span><br><span class="line">ChangeEventPlugin.registerEvents()</span><br><span class="line">SelectEventPlugin.registerEvents()</span><br><span class="line">BeforeInputEventPlugin.registerEvents()</span><br></pre></td></tr></table></figure></li><li><p>记录 <code>dom</code> 事件和 <code>react</code> 事件的映射关系</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMEventProperties.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> topLevelEventsToReactNames = <span class="keyword">new</span> <span class="built_in">Map</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录 dom event 和 react event 的映射</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerSimpleEvent</span>(<span class="params">domEventName, reactName</span>) </span>&#123;</span><br><span class="line">  topLevelEventsToReactNames.set(domEventName, reactName)</span><br><span class="line">  registerTwoPhaseEvent(reactName, [domEventName])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">registerSimpleEvents</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; simpleEventPluginEvents.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> eventName = ((simpleEventPluginEvents[i]: any): string)</span><br><span class="line">    <span class="keyword">const</span> domEventName = ((eventName.toLowerCase(): any): DOMEventName)</span><br><span class="line">    <span class="keyword">const</span> capitalizedEvent = eventName[<span class="number">0</span>].toUpperCase() + eventName.slice(<span class="number">1</span>)</span><br><span class="line">    registerSimpleEvent(domEventName, <span class="string">'on'</span> + capitalizedEvent)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Special cases where event names don't match.</span></span><br><span class="line">  registerSimpleEvent(ANIMATION_END, <span class="string">'onAnimationEnd'</span>)</span><br><span class="line">  registerSimpleEvent(ANIMATION_ITERATION, <span class="string">'onAnimationIteration'</span>)</span><br><span class="line">  registerSimpleEvent(ANIMATION_START, <span class="string">'onAnimationStart'</span>)</span><br><span class="line">  registerSimpleEvent(<span class="string">'dblclick'</span>, <span class="string">'onDoubleClick'</span>)</span><br><span class="line">  registerSimpleEvent(<span class="string">'focusin'</span>, <span class="string">'onFocus'</span>)</span><br><span class="line">  registerSimpleEvent(<span class="string">'focusout'</span>, <span class="string">'onBlur'</span>)</span><br><span class="line">  registerSimpleEvent(TRANSITION_END, <span class="string">'onTransitionEnd'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在 <code>events/EventRegistry</code> 模块中调用方法把注册的事件放入存储的 <code>Set</code> 和对象中，<code>allNativeEvents Set</code> 负责存储所有注册过的 <code>dom</code> 事件名称，<code>registrationNameDependencies</code> 以 <code>{[reactEventName]: [nativeEventName] }</code>负责存储注册的事件依赖，同时注册了冒泡事件和捕获事件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/EventRegistry.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> allNativeEvents: <span class="built_in">Set</span>&lt;DOMEventName&gt; = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mapping from registration name to event name</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> registrationNameDependencies = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">registerTwoPhaseEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  registrationName: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  dependencies: Array&lt;DOMEventName&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  registerDirectEvent(registrationName, dependencies)</span><br><span class="line">  registerDirectEvent(registrationName + <span class="string">'Capture'</span>, dependencies)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">registerDirectEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  registrationName: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  dependencies: Array&lt;DOMEventName&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  registrationNameDependencies[registrationName] = dependencies</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dependencies.length; i++) &#123;</span><br><span class="line">    allNativeEvents.add(dependencies[i])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>合成事件的初始化完毕</p></li></ol><h4 id="注册原生事件"><a href="#注册原生事件" class="headerlink" title="注册原生事件"></a>注册原生事件</h4><p><img src="/images/react/react-event-init.jpg" alt="react 注册原生事件"></p><ol><li>调用 <code>react-dom</code> 模块中的 <code>render</code> 时，若第一次挂载则递归依次调用 <code>legacyCreateRootFromDOMContainer</code>、<code>createLegacyRoot</code> 创建容器对象 <code>ReactDOMLegacyRoot</code> 的实例</li><li><code>ReactDOMLegacyRoot</code> 递归依次调用 <code>createRootImpl</code>、<code>createContainer</code> 创建了组件挂载的根元素，并表及为根元素</li><li>调用 <code>listenToAllSupportedEvents</code> 在根元素上挂载事件，若当前容器为注释元素，则取当前元素的父元素为事件挂载的节点</li><li><p>在 <code>listenToAllSupportedEvents</code> 中遍历初始化时注册的 <code>allNativeEvents</code> 事件列表注册事件，判断根元素是否为 <code>documet</code> 节点，不是则获取 <code>document</code> 节点，在 <code>document</code> 节点节点上注册 <code>selectionchange</code> 事件</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">const</span> listeningMarker = <span class="string">'_reactListening'</span> +<span class="built_in">Math</span>.random().toString(<span class="number">36</span>).slice(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">listenToAllSupportedEvents</span>(<span class="params">rootContainerElement: EventTarget</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(rootContainerElement: <span class="built_in">any</span>)[listeningMarker]) &#123;</span><br><span class="line">    rootContainerElement[listeningMarker] = <span class="literal">true</span></span><br><span class="line">    allNativeEvents.forEach(<span class="function">(<span class="params">domEventName</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// We handle selectionchange separately because it</span></span><br><span class="line">      <span class="comment">// doesn't bubble and needs to be on the document.</span></span><br><span class="line">      <span class="keyword">if</span> (domEventName !== <span class="string">'selectionchange'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!nonDelegatedEvents.has(domEventName)) &#123;</span><br><span class="line">          listenToNativeEvent(domEventName, <span class="literal">false</span>, rootContainerElement)</span><br><span class="line">        &#125;</span><br><span class="line">        listenToNativeEvent(domEventName, <span class="literal">true</span>, rootContainerElement)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> ownerDocument =</span><br><span class="line">      rootContainerElement.nodeType === DOCUMENT_NODE</span><br><span class="line">        ? rootContainerElement</span><br><span class="line">        : (rootContainerElement).ownerDocument</span><br><span class="line">    <span class="keyword">if</span> (ownerDocument !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// The selectionchange event also needs deduplication</span></span><br><span class="line">      <span class="comment">// but it is attached to the document.</span></span><br><span class="line">      <span class="keyword">if</span> (!(ownerDocument)[listeningMarker]) &#123;</span><br><span class="line">        ownerDocument[listeningMarker] = <span class="literal">true</span></span><br><span class="line">        listenToNativeEvent(<span class="string">'selectionchange'</span>, <span class="literal">false</span>, ownerDocument)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>createEventListenerWrapperWithPriority</code> 函数先获取事件优先级，再根据优先级确定构造监听器的函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/ReactDOMEventListener.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createEventListenerWrapperWithPriority</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> eventPriority = getEventPriority(domEventName)</span><br><span class="line">  <span class="keyword">let</span> listenerWrapper</span><br><span class="line">  <span class="keyword">switch</span> (eventPriority) &#123;</span><br><span class="line">    <span class="keyword">case</span> DiscreteEventPriority:</span><br><span class="line">      listenerWrapper = dispatchDiscreteEvent</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> ContinuousEventPriority:</span><br><span class="line">      listenerWrapper = dispatchContinuousEvent</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> DefaultEventPriority:</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      listenerWrapper = dispatchEvent</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> listenerWrapper.bind(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>调用 <code>createEventListenerWrapperWithPriority</code> 创建监听函数，根据 <code>passive</code> 属性的支持和 <code>capture</code> 情况分别调用不同的事件监听方式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">listenToNativeEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  isCapturePhaseListener: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  target: EventTarget</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> eventSystemFlags = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (isCapturePhaseListener) &#123;</span><br><span class="line">    eventSystemFlags |= IS_CAPTURE_PHASE</span><br><span class="line">  &#125;</span><br><span class="line">  addTrappedEventListener(</span><br><span class="line">    target,</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    isCapturePhaseListener</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addTrappedEventListener</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  isCapturePhaseListener: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  isDeferredListenerForLegacyFBSupport?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> listener = createEventListenerWrapperWithPriority(</span><br><span class="line">    targetContainer,</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// If passive option is not supported, then the event will be</span></span><br><span class="line">  <span class="comment">// active and not passive.</span></span><br><span class="line">  <span class="keyword">let</span> isPassiveListener = <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">if</span> (passiveBrowserEventsSupported) &#123;</span><br><span class="line">    <span class="comment">// 是否支持 passive 属性， https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      domEventName === <span class="string">'touchstart'</span> ||</span><br><span class="line">      domEventName === <span class="string">'touchmove'</span> ||</span><br><span class="line">      domEventName === <span class="string">'wheel'</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      isPassiveListener = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  targetContainer =</span><br><span class="line">    enableLegacyFBSupport &amp;&amp; isDeferredListenerForLegacyFBSupport</span><br><span class="line">      ? (targetContainer: any).ownerDocument</span><br><span class="line">      : targetContainer</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> unsubscribeListener</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> There are too many combinations here. Consolidate them.</span></span><br><span class="line">  <span class="keyword">if</span> (isCapturePhaseListener) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isPassiveListener !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      unsubscribeListener = addEventCaptureListenerWithPassiveFlag(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener,</span><br><span class="line">        isPassiveListener</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      unsubscribeListener = addEventCaptureListener(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isPassiveListener !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      unsubscribeListener = addEventBubbleListenerWithPassiveFlag(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener,</span><br><span class="line">        isPassiveListener</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      unsubscribeListener = addEventBubbleListener(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h4 id="事件触发"><a href="#事件触发" class="headerlink" title="事件触发"></a>事件触发</h4><p><img src="/images/react/react-event-dispatch.jpg" alt="react 事件触发"></p><ol><li>有事件触发时，调用 <code>events/ReactDOMEventListener</code> 下的 <code>dispatchEvent</code> 触发事件</li><li><p>当事件不可重新触发时直接调用 <code>attemptToDispatchEvent</code> 进行事件的触发，否则事件放入队列等待调用</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/ReactDOMEventListener.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> allowReplay = (eventSystemFlags &amp; IS_CAPTURE_PHASE) === <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    allowReplay &amp;&amp;</span><br><span class="line">    hasQueuedDiscreteEvents() &amp;&amp;</span><br><span class="line">    isReplayableDiscreteEvent(domEventName)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">//更新队列中就把事件放入更新队列</span></span><br><span class="line">    queueDiscreteEvent(</span><br><span class="line">      <span class="literal">null</span>, <span class="comment">// Flags that we're not actually blocked on anything as far as we know.</span></span><br><span class="line">      domEventName,</span><br><span class="line">      eventSystemFlags,</span><br><span class="line">      targetContainer,</span><br><span class="line">      nativeEvent</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> blockedOn = attemptToDispatchEvent(</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer,</span><br><span class="line">    nativeEvent</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (blockedOn === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 触发事件成功</span></span><br><span class="line">    <span class="keyword">if</span> (allowReplay) &#123;</span><br><span class="line">      clearIfContinuousEvent(domEventName, nativeEvent)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 其它逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>获取触发事件的元素，然后获取最近的虚拟 <code>dom</code> 节点的实例（向上查找，注：<code>dom</code> 上存储了虚拟 <code>dom</code> 的引用，快速查找），通过虚拟 <code>dom</code> 节点获取最近挂载的 <code>fiber</code> 节点（向上查找）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/ReactDOMEventListener.js</span></span><br><span class="line"><span class="comment">// Attempt dispatching an event. Returns a SuspenseInstance or Container if it's blocked.</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">attemptToDispatchEvent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">null</span> | <span class="title">Container</span> | <span class="title">SuspenseInstance</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> nativeEventTarget = getEventTarget(nativeEvent)</span><br><span class="line">  <span class="keyword">let</span> targetInst = getClosestInstanceFromNode(nativeEventTarget)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (targetInst !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> nearestMounted = getNearestMountedFiber(targetInst)</span><br><span class="line">    <span class="keyword">if</span> (nearestMounted === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 树已经被销毁，触发对象置空</span></span><br><span class="line">      targetInst = <span class="literal">null</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 其它逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  dispatchEventForPluginEventSystem(</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    targetInst,</span><br><span class="line">    targetContainer</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// We're not blocked on anything.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>在 <code>attemptToDispatchEvent</code> 调用 <code>dispatchEventForPluginEventSystem</code>，找出触发事件元素的根节点实例，然后通过 <code>dispatchEventsForPlugins</code> 批量更新</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">dispatchEventForPluginEventSystem</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> ancestorInst = targetInst</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (eventSystemFlags &amp; IS_EVENT_HANDLE_NON_MANAGED_NODE) === <span class="number">0</span> &amp;&amp;</span><br><span class="line">    (eventSystemFlags &amp; IS_NON_DELEGATED) === <span class="number">0</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> targetContainerNode = ((targetContainer: any): Node)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetInst !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// The below logic attempts to work out if we need to change</span></span><br><span class="line">      <span class="comment">// the target fiber to a different ancestor. We had similar logic</span></span><br><span class="line">      <span class="comment">// in the legacy event system, except the big difference between</span></span><br><span class="line">      <span class="comment">// systems is that the modern event system now has an event listener</span></span><br><span class="line">      <span class="comment">// attached to each React Root and React Portal Root. Together,</span></span><br><span class="line">      <span class="comment">// the DOM nodes representing these roots are the "rootContainer".</span></span><br><span class="line">      <span class="comment">// To figure out which ancestor instance we should use, we traverse</span></span><br><span class="line">      <span class="comment">// up the fiber tree from the target instance and attempt to find</span></span><br><span class="line">      <span class="comment">// root boundaries that match that of our current "rootContainer".</span></span><br><span class="line">      <span class="comment">// If we find that "rootContainer", we find the parent fiber</span></span><br><span class="line">      <span class="comment">// sub-tree for that root and make that our ancestor instance.</span></span><br><span class="line">      <span class="keyword">let</span> node = targetInst</span><br><span class="line"></span><br><span class="line">      mainLoop: <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (node === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> nodeTag = node.tag</span><br><span class="line">        <span class="keyword">if</span> (nodeTag === HostRoot || nodeTag === HostPortal) &#123;</span><br><span class="line">          <span class="keyword">let</span> container = node.stateNode.containerInfo</span><br><span class="line">          <span class="keyword">if</span> (isMatchingRootContainer(container, targetContainerNode)) &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (nodeTag === HostPortal) &#123;</span><br><span class="line">            <span class="comment">// The target is a portal, but it's not the rootContainer we're looking for.</span></span><br><span class="line">            <span class="comment">// Normally portals handle their own events all the way down to the root.</span></span><br><span class="line">            <span class="comment">// So we should be able to stop now. However, we don't know if this portal</span></span><br><span class="line">            <span class="comment">// was part of *our* root.</span></span><br><span class="line">            <span class="keyword">let</span> grandNode = node.return</span><br><span class="line">            <span class="keyword">while</span> (grandNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">const</span> grandTag = grandNode.tag</span><br><span class="line">              <span class="keyword">if</span> (grandTag === HostRoot || grandTag === HostPortal) &#123;</span><br><span class="line">                <span class="keyword">const</span> grandContainer = grandNode.stateNode.containerInfo</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                  isMatchingRootContainer(</span><br><span class="line">                    grandContainer,</span><br><span class="line">                    targetContainerNode</span><br><span class="line">                  )</span><br><span class="line">                ) &#123;</span><br><span class="line">                  <span class="comment">// This is the rootContainer we're looking for and we found it as</span></span><br><span class="line">                  <span class="comment">// a parent of the Portal. That means we can ignore it because the</span></span><br><span class="line">                  <span class="comment">// Portal will bubble through to us.</span></span><br><span class="line">                  <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              grandNode = grandNode.return</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Now we need to find it's corresponding host fiber in the other</span></span><br><span class="line">          <span class="comment">// tree. To do this we can use getClosestInstanceFromNode, but we</span></span><br><span class="line">          <span class="comment">// need to validate that the fiber is a host instance, otherwise</span></span><br><span class="line">          <span class="comment">// we need to traverse up through the DOM till we find the correct</span></span><br><span class="line">          <span class="comment">// node that is from the other tree.</span></span><br><span class="line">          <span class="keyword">while</span> (container !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> parentNode = getClosestInstanceFromNode(container)</span><br><span class="line">            <span class="keyword">if</span> (parentNode === <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">const</span> parentTag = parentNode.tag</span><br><span class="line">            <span class="keyword">if</span> (parentTag === HostComponent || parentTag === HostText) &#123;</span><br><span class="line">              node = ancestorInst = parentNode</span><br><span class="line">              <span class="keyword">continue</span> mainLoop</span><br><span class="line">            &#125;</span><br><span class="line">            container = container.parentNode</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        node = node.return</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  batchedEventUpdates(<span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">    dispatchEventsForPlugins(</span><br><span class="line">      domEventName,</span><br><span class="line">      eventSystemFlags,</span><br><span class="line">      nativeEvent,</span><br><span class="line">      ancestorInst,</span><br><span class="line">      targetContainer</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>dispatchEventsForPlugins</code> 先获取当前 <code>Fiber</code> 上绑定的对应事件，然后 <code>processDispatchQueue</code> 通过按照顺序 <code>processDispatchQueueItemsInOrder</code> 处理各个事件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatchEventsForPlugins</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> nativeEventTarget = getEventTarget(nativeEvent)</span><br><span class="line">  <span class="keyword">const</span> dispatchQueue: DispatchQueue = []</span><br><span class="line">  extractEvents(</span><br><span class="line">    dispatchQueue,</span><br><span class="line">    domEventName,</span><br><span class="line">    targetInst,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    nativeEventTarget,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer</span><br><span class="line">  )</span><br><span class="line">  processDispatchQueue(dispatchQueue, eventSystemFlags)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractEvents</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  dispatchQueue: DispatchQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEventTarget: null | EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  SimpleEventPlugin.extractEvents(</span><br><span class="line">    dispatchQueue,</span><br><span class="line">    domEventName,</span><br><span class="line">    targetInst,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    nativeEventTarget,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// 其它逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">processDispatchQueue</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  dispatchQueue: DispatchQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> inCapturePhase = (eventSystemFlags &amp; IS_CAPTURE_PHASE) !== <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dispatchQueue.length; i++) &#123;</span><br><span class="line">    <span class="comment">// 取出事件监听函数执行</span></span><br><span class="line">    <span class="keyword">const</span> &#123; event, listeners &#125; = dispatchQueue[i]</span><br><span class="line">    processDispatchQueueItemsInOrder(event, listeners, inCapturePhase)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processDispatchQueueItemsInOrder</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  event: ReactSyntheticEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  dispatchListeners: Array&lt;DispatchListener&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  inCapturePhase: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> previousInstance</span><br><span class="line">  <span class="keyword">if</span> (inCapturePhase) &#123;</span><br><span class="line">    <span class="comment">// 捕获事件从后往前执行</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = dispatchListeners.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; instance, currentTarget, listener &#125; = dispatchListeners[i]</span><br><span class="line">      <span class="keyword">if</span> (instance !== previousInstance &amp;&amp; event.isPropagationStopped()) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      executeDispatch(event, listener, currentTarget)</span><br><span class="line">      previousInstance = instance</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 冒泡事件从前往后执行</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dispatchListeners.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; instance, currentTarget, listener &#125; = dispatchListeners[i]</span><br><span class="line">      <span class="keyword">if</span> (instance !== previousInstance &amp;&amp; event.isPropagationStopped()) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      executeDispatch(event, listener, currentTarget)</span><br><span class="line">      previousInstance = instance</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>extractEvents</code> 提取事件监听函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/plugins/SimpleEventPlugin.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">extractEvents</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  dispatchQueue: DispatchQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">  domEventName: DOMEventName,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetInst: null | Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEventTarget: null | EventTarget,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  targetContainer: EventTarget</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> reactName = topLevelEventsToReactNames.get(domEventName)</span><br><span class="line">  <span class="keyword">if</span> (reactName === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> SyntheticEventCtor = SyntheticEvent</span><br><span class="line">  <span class="keyword">let</span> reactEventType: string = domEventName</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据事件类型获取对应的构造函数</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> inCapturePhase = (eventSystemFlags &amp; IS_CAPTURE_PHASE) !== <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    enableCreateEventHandleAPI &amp;&amp;</span><br><span class="line">    eventSystemFlags &amp; IS_EVENT_HANDLE_NON_MANAGED_NODE</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> listeners = accumulateEventHandleNonManagedNodeListeners(</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> this cast may not make sense for events like</span></span><br><span class="line">      <span class="comment">// "focus" where React listens to e.g. "focusin".</span></span><br><span class="line">      ((reactEventType: any): DOMEventName),</span><br><span class="line">      targetContainer,</span><br><span class="line">      inCapturePhase</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (listeners.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Intentionally create event lazily.</span></span><br><span class="line">      <span class="keyword">const</span> event = <span class="keyword">new</span> SyntheticEventCtor(</span><br><span class="line">        reactName,</span><br><span class="line">        reactEventType,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        nativeEvent,</span><br><span class="line">        nativeEventTarget</span><br><span class="line">      )</span><br><span class="line">      dispatchQueue.push(&#123; event, listeners &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Some events don't bubble in the browser.</span></span><br><span class="line">    <span class="comment">// In the past, React has always bubbled them, but this can be surprising.</span></span><br><span class="line">    <span class="comment">// We're going to try aligning closer to the browser behavior by not bubbling</span></span><br><span class="line">    <span class="comment">// them in React either. We'll start by not bubbling onScroll, and then expand.</span></span><br><span class="line">    <span class="keyword">const</span> accumulateTargetOnly =</span><br><span class="line">      !inCapturePhase &amp;&amp;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> ideally, we'd eventually add all events from</span></span><br><span class="line">      <span class="comment">// nonDelegatedEvents list in DOMPluginEventSystem.</span></span><br><span class="line">      <span class="comment">// Then we can remove this special list.</span></span><br><span class="line">      <span class="comment">// This is a breaking change that can wait until React 18.</span></span><br><span class="line">      domEventName === <span class="string">'scroll'</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> listeners = accumulateSinglePhaseListeners(</span><br><span class="line">      targetInst,</span><br><span class="line">      reactName,</span><br><span class="line">      nativeEvent.type,</span><br><span class="line">      inCapturePhase,</span><br><span class="line">      accumulateTargetOnly,</span><br><span class="line">      nativeEvent</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (listeners.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Intentionally create event lazily.</span></span><br><span class="line">      <span class="keyword">const</span> event = <span class="keyword">new</span> SyntheticEventCtor(</span><br><span class="line">        reactName,</span><br><span class="line">        reactEventType,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        nativeEvent,</span><br><span class="line">        nativeEventTarget</span><br><span class="line">      )</span><br><span class="line">      dispatchQueue.push(&#123; event, listeners &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>调用 <code>accumulateSinglePhaseListeners</code> 获取事件监听列表，从触发元素递归向上查询注册的事件然后放入监听器列表中返回</p></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">accumulateSinglePhaseListeners</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  targetFiber: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  reactName: string | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEventType: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  inCapturePhase: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  accumulateTargetOnly: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  nativeEvent: AnyNativeEvent</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Array</span>&lt;<span class="title">DispatchListener</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> captureName = reactName !== <span class="literal">null</span> ? reactName + <span class="string">'Capture'</span> : <span class="literal">null</span></span><br><span class="line">  <span class="keyword">const</span> reactEventName = inCapturePhase ? captureName : reactName</span><br><span class="line">  <span class="keyword">let</span> listeners: <span class="built_in">Array</span>&lt;DispatchListener&gt; = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> instance = targetFiber</span><br><span class="line">  <span class="keyword">let</span> lastHostComponent = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Accumulate all instances and listeners via the target -&gt; root path.</span></span><br><span class="line">  <span class="keyword">while</span> (instance !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; stateNode, tag &#125; = instance</span><br><span class="line">    <span class="comment">// Handle listeners that are on HostComponents (i.e. &lt;div&gt;)</span></span><br><span class="line">    <span class="keyword">if</span> (tag === HostComponent &amp;&amp; stateNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">      lastHostComponent = stateNode</span><br><span class="line"></span><br><span class="line">      <span class="comment">// createEventHandle listeners</span></span><br><span class="line">      <span class="keyword">if</span> (enableCreateEventHandleAPI) &#123;</span><br><span class="line">        <span class="keyword">const</span> eventHandlerListeners =</span><br><span class="line">          getEventHandlerListeners(lastHostComponent)</span><br><span class="line">        <span class="keyword">if</span> (eventHandlerListeners !== <span class="literal">null</span>) &#123;</span><br><span class="line">          eventHandlerListeners.forEach(<span class="function">(<span class="params">entry</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">              entry.type === nativeEventType &amp;&amp;</span><br><span class="line">              entry.capture === inCapturePhase</span><br><span class="line">            ) &#123;</span><br><span class="line">              listeners.push(</span><br><span class="line">                createDispatchListener(</span><br><span class="line">                  instance,</span><br><span class="line">                  entry.callback,</span><br><span class="line">                  (lastHostComponent: any)</span><br><span class="line">                )</span><br><span class="line">              )</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Standard React on* listeners, i.e. onClick or onClickCapture</span></span><br><span class="line">      <span class="keyword">if</span> (reactEventName !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> listener = getListener(instance, reactEventName)</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="literal">null</span>) &#123;</span><br><span class="line">          listeners.push(</span><br><span class="line">            createDispatchListener(instance, listener, lastHostComponent)</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    instance = instance.return</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> listeners</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;/images/react/react-event.jpg&quot; alt=&quot;react 中的事件&quot;&gt;&lt;/p&gt;
&lt;h4 id=&quot;初始化&quot;&gt;&lt;a href=&quot;#初始化&quot; class=&quot;headerlink&quot; title=&quot;初始化&quot;&gt;&lt;/a&gt;初始化&lt;/h4&gt;&lt;p&gt;
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="react" scheme="http://yoursite.com/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>react中的jsx语法</title>
    <link href="http://yoursite.com/2021/06/06/react%E4%B8%AD%E7%9A%84jsx%E8%AF%AD%E6%B3%95/"/>
    <id>http://yoursite.com/2021/06/06/react中的jsx语法/</id>
    <published>2021-06-06T14:30:07.000Z</published>
    <updated>2021-06-06T07:38:53.601Z</updated>
    
    <content type="html"><![CDATA[<h2 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a><code>JSX</code></h2><p><code>JSX</code> 是一种嵌入式的类似 <code>XML</code> 的语法。 它可以被转换成合法的 <code>JavaScript</code>，尽管转换的语义是依据不同的实现而定的。 <code>JSX</code> 因 <code>React</code> 框架而流行，但也存在其它的实现。</p><h3 id="React-中的-JSX"><a href="#React-中的-JSX" class="headerlink" title="React 中的 JSX"></a><code>React</code> 中的 <code>JSX</code></h3><p><code>JSX</code> 为我们提供了创建 <code>React</code> 元素方法（<code>React.createElement(component, props, ...children)</code>）的语法糖（<code>syntactic sugar</code>）</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="comment">// 编译后会被转化为</span></span><br><span class="line"><span class="keyword">var</span> element = React.createElement(<span class="string">'div'</span>, <span class="literal">null</span>, <span class="string">'Hello, world!'</span>) <span class="comment">// 返回一个对象</span></span><br></pre></td></tr></table></figure><h4 id="JSX-代表-JS-对象"><a href="#JSX-代表-JS-对象" class="headerlink" title="JSX 代表 JS 对象"></a><code>JSX</code> 代表 <code>JS</code> 对象</h4><p><code>JSX</code> 本身也是一个表达式，在编译后，<code>JSX</code> 表达式会变成普通的 <code>JavaScript</code> 对象。执行 <code>React.createElement</code> 之后最终会执行一下代码生成一个普通的 <code>JavaScript</code> 对象。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ReactElement = <span class="function"><span class="keyword">function</span> (<span class="params">type, key, ref, self, source, owner, props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> element = &#123;</span><br><span class="line">    <span class="comment">// This tag allows us to uniquely identify this as a React Element</span></span><br><span class="line">    $$<span class="keyword">typeof</span>: REACT_ELEMENT_TYPE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Built-in properties that belong on the element</span></span><br><span class="line">    type: type,</span><br><span class="line">    key: key,</span><br><span class="line">    ref: ref,</span><br><span class="line">    props: props,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record the component responsible for creating this element.</span></span><br><span class="line">    _owner: owner,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> element</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由上可以看出，执行 <code>React.createElement</code> 时只支持表达式，同时可以在以下情况中使用</p><ul><li>可以在 <code>if</code> 语句或 <code>for</code> 循环中使用 <code>JSX</code></li><li>可以将它赋值给变量</li><li>可以将它作为参数接收</li><li>可以在函数中返回 <code>JSX</code>。</li></ul><h5 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h5><p>在 <code>JavaScript</code> 中，表达式就是一个短语，<code>Javascript</code> 解释器会将其计算出一个结果，常量就是最简单的一类表达式。常用的表达式有：</p><ul><li>变量名</li><li>函数定义表达式</li><li>属性访问表达式</li><li>函数调用表达式</li><li>算数表达式</li><li>关系表达式</li><li>逻辑表达式</li></ul><p>注意: <code>if</code> 语句以及 <code>for</code> 循环不是 <code>JavaScript</code> 表达式</p><h4 id="JSX-可自动防范注入攻击"><a href="#JSX-可自动防范注入攻击" class="headerlink" title="JSX 可自动防范注入攻击"></a><code>JSX</code> 可自动防范注入攻击</h4><p>在默认情况下，React DOM 会将所有嵌入 JSX 的值进行编码，利用 <code>createTextNode</code> 进行 <code>HTML</code> 转义</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createTextNode</span>(<span class="params">text, rootContainerElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getOwnerDocumentFromRootContainer(rootContainerElement).createTextNode(</span><br><span class="line">    text</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>若希望直接将字符串不经转义编码直接插入到 <code>HTML</code> 文档流，可以使用 <code>dangerouslySetInnerHTML</code> 属性，这是一个 <code>React</code> 版的 <code>innerHTML</code>，该属性接收一个 <code>key</code> 为 <code>__html</code> 的对象</p><h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><ul><li><code>JSX</code> 会自动删除一行中开头和结尾处的空白符；</li><li><code>JSX</code> 会自动删除空行；</li><li><code>JSX</code> 会删除紧邻标签的换行；</li><li><code>JSX</code> 会删除字符串中的换行；</li><li>字符串中的换行会被转换成一个空格。</li></ul><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul><li>允许使用熟悉的语法来定义 <code>HTML</code> 元素树</li><li>提供了更加语义化且易懂的标签</li><li>程序结构更容易被直观化</li><li>抽象了 <code>React Element</code> 的创建过程</li><li>可以随时掌控 <code>HTML</code> 标签以及生成这些标签的代码</li><li>原生 <code>Javascript</code></li></ul><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://www.tslang.cn/docs/handbook/jsx.html" target="_blank" rel="noopener">JSX</a></li><li><a href="https://www.cnblogs.com/candlia/p/11920070.html" target="_blank" rel="noopener">JSX 语法使用详解</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;JSX&quot;&gt;&lt;a href=&quot;#JSX&quot; class=&quot;headerlink&quot; title=&quot;JSX&quot;&gt;&lt;/a&gt;&lt;code&gt;JSX&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;&lt;code&gt;JSX&lt;/code&gt; 是一种嵌入式的类似 &lt;code&gt;XML&lt;/code&gt; 的语法。 它可以被
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="react" scheme="http://yoursite.com/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>react中的异步实现</title>
    <link href="http://yoursite.com/2021/05/30/react%E4%B8%AD%E7%9A%84%E5%BC%82%E6%AD%A5%E5%AE%9E%E7%8E%B0/"/>
    <id>http://yoursite.com/2021/05/30/react中的异步实现/</id>
    <published>2021-05-30T13:37:54.000Z</published>
    <updated>2021-07-18T15:30:14.766Z</updated>
    
    <content type="html"><![CDATA[<h3 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h3><p>由于 <code>JS</code> 是单线程非阻塞的，所有的任务都需要在这个线程中来处理。当需要执行异步任务时主线程会先挂起这个任务，当异步任务执行完毕之后主线程会根据规则执行回调。当任务处理完毕之后， <code>JS</code> 会将这个事件加入队列中，这个队列即被称为事件队列。</p><h4 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h4><ul><li>进程： <code>CPU</code> 在运行指令及加载和保存上下文所需的时间，放在应用上来说就代表了一个程序。</li><li>线程： 进程中的更小单位，描述了执行一段指令所需的时间。</li></ul><p>在浏览器中，当你打开一个 <code>Tab</code> 页时，其实就是创建了一个进程，一个进程中可以有多个线程，比如渲染线程、<code>JS</code> 引擎线程、<code>HTTP</code> 请求线程等等。当你发起一个请求时，其实就是创建了一个线程，当请求结束后，该线程可能就会被销毁。</p><p>在 <code>JS</code> 运行的时候会阻止 <code>UI</code> 渲染，这是因为 <code>JS</code> 可以修改 <code>DOM</code>，如果在 <code>JS</code> 执行的时候 <code>UI</code> 线程还在工作，就可能导致不能安全的渲染 <code>UI</code>。这其实也是一个单线程的好处，得益于 <code>JS</code> 是单线程运行的，可以达到节省内存，节约上下文切换时间，没有锁的问题的好处。</p><p>对于锁的问题，形象的来说就是当我读取一个数字 <code>15</code> 的时候，同时有两个操作对数字进行了加减，这时候结果就出现了错误。解决这个问题也不难，只需要在读取的时候加锁，直到读取完毕之前都不能进行写入操作。</p><h4 id="执行栈"><a href="#执行栈" class="headerlink" title="执行栈"></a>执行栈</h4><p>所有的 <code>JS</code> 代码在运行时都是在执行上下文中进行的。<code>JS</code> 中有三种执行上下文：</p><ul><li>全局执行上下文，默认的，浏览器中是 <code>window</code> 对象，<code>nodejs</code> 中是 <code>global</code>，并且 <code>this</code> 在非严格模式下指向它们。</li><li>函数执行上下文，<code>JS</code> 的函数每当被调用时会创建一个上下文。</li><li><code>Eval</code> 执行上下文，<code>eval</code> 函数会产生自己的上下文。</li></ul><p>栈是一种数据结构，具有先进后出的原则。<code>JS</code> 中的执行栈就具有这样的结构，当引擎第一次遇到 <code>JS</code> 代码时，会产生一个全局执行上下文并压入执行栈，每遇到一个函数调用，就会往栈中压入一个新的上下文。引擎执行栈顶的函数，执行完毕，弹出当前执行上下文。</p><h4 id="微任务和宏任务"><a href="#微任务和宏任务" class="headerlink" title="微任务和宏任务"></a>微任务和宏任务</h4><p>异步任务被分为两种类型，微任务和宏任务</p><h5 id="微任务"><a href="#微任务" class="headerlink" title="微任务"></a>微任务</h5><ul><li><code>Promise.then</code></li><li><code>MutationObserver</code></li><li><code>process.nextTick</code></li></ul><h5 id="宏任务"><a href="#宏任务" class="headerlink" title="宏任务"></a>宏任务</h5><ul><li><code>script</code>(整体代码)</li><li><code>setTimout</code></li><li><code>setInterval</code></li><li><code>setImmediate</code></li><li><code>MessageChannel</code></li><li><code>requestAnimationFrame</code></li><li><code>postMessage</code></li><li><code>I/O</code></li><li><code>UI</code> 交互事件</li></ul><h4 id="事件循环-1"><a href="#事件循环-1" class="headerlink" title="事件循环"></a>事件循环</h4><p><code>Event Loop</code>(事件循环)中，每一次循环称为 <code>tick</code>, 每一次 <code>tick</code> 的任务如下：</p><ol><li>执行栈选择最先进入队列的宏任务(通常是 <code>script</code> 整体代码)，如果有则执行</li><li>检查是否存在 <code>Microtask</code>，如果存在则不停的执行，直至清空 <code>microtask</code> 队列</li><li>更新 <code>render</code>(每一次事件循环，浏览器都可能会去更新渲染)</li><li>重复以上步骤</li></ol><p>宏任务 &gt; 所有微任务 &gt; 宏任务，如下图所示：</p><p><img src="/images/js/eventLoop.jpg" alt="事件循环"></p><ol><li>将所有任务看成两个队列：执行队列与事件队列。</li><li>执行队列是同步的，事件队列是异步的，宏任务放入事件列表，微任务放入执行队列之后，事件队列之前。</li><li>当执行完同步代码之后，就会执行位于执行列表之后的微任务，然后再执行事件列表中的宏任务</li></ol><h3 id="react-中的异步实现"><a href="#react-中的异步实现" class="headerlink" title="react 中的异步实现"></a>react 中的异步实现</h3><p><code>react</code> 中的异步是通过宏任务来实现的，优先使用 <code>setImmediate</code> ，然后使用 <code>MessageChannel</code>，若都不支持则使用 <code>setTimeout</code> 实现</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> schedulePerformWorkUntilDeadline</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> localSetImmediate === <span class="string">'function'</span>) &#123;</span><br><span class="line">  <span class="comment">// Node.js and old IE.</span></span><br><span class="line">  <span class="comment">// There's a few reasons for why we prefer setImmediate.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Unlike MessageChannel, it doesn't prevent a Node.js process from exiting.</span></span><br><span class="line">  <span class="comment">// (Even though this is a DOM fork of the Scheduler, you could get here</span></span><br><span class="line">  <span class="comment">// with a mix of Node.js 15+, which has a MessageChannel, and jsdom.)</span></span><br><span class="line">  <span class="comment">// https://github.com/facebook/react/issues/20756</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// But also, it runs earlier which is the semantic we want.</span></span><br><span class="line">  <span class="comment">// If other browsers ever implement it, it's better to use it.</span></span><br><span class="line">  <span class="comment">// Although both of these would be inferior to native scheduling.</span></span><br><span class="line">  schedulePerformWorkUntilDeadline = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    localSetImmediate(performWorkUntilDeadline)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> MessageChannel !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">  <span class="comment">// DOM and Worker environments.</span></span><br><span class="line">  <span class="comment">// We prefer MessageChannel because of the 4ms setTimeout clamping.</span></span><br><span class="line">  <span class="keyword">const</span> channel = <span class="keyword">new</span> MessageChannel()</span><br><span class="line">  <span class="keyword">const</span> port = channel.port2</span><br><span class="line">  channel.port1.onmessage = performWorkUntilDeadline</span><br><span class="line">  schedulePerformWorkUntilDeadline = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    port.postMessage(<span class="literal">null</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// We should only fallback here in non-browser environments.</span></span><br><span class="line">  schedulePerformWorkUntilDeadline = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    localSetTimeout(performWorkUntilDeadline, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>判断是否存在 <code>setImmediate</code>，如果存在则使用 <code>setImmediate</code>，不存在下一步</li><li>判断是否支持 <code>MessageChannel</code>，如果支持则创建一个消息通道，通过消息通道实现宏任务，否则进行下一步</li><li>回落到 <code>setTimeout</code> 实现异步</li></ol><h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><ol><li>优先选择 <code>MessageChannel</code> 而不是 <code>setTimeout</code> 的原因是由于 <code>setTimeout</code> 有一个最小 <code>4ms</code> 的等待时间，在无宏任务执行时，这个时间会浪费掉</li><li>不选择微任务的原因是，使用微任务的方式时，当前任务任然占据了主线程而没有释放出来，达不到把主线程还给渲染线程的目的</li></ol><h5 id="edge-浏览器测试参考"><a href="#edge-浏览器测试参考" class="headerlink" title="edge 浏览器测试参考"></a><code>edge</code> 浏览器测试参考</h5><p><img src="/images/js/macroTask.png" alt="事件循环"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://zhuanlan.zhihu.com/p/59784952" target="_blank" rel="noopener">深入理解 JavaScript 执行上下文和执行栈</a></li><li><a href="https://segmentfault.com/a/1190000015317434" target="_blank" rel="noopener">Js 的事件循环(Event Loop)机制以及实例讲解</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel" target="_blank" rel="noopener">MessageChannel</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;事件循环&quot;&gt;&lt;a href=&quot;#事件循环&quot; class=&quot;headerlink&quot; title=&quot;事件循环&quot;&gt;&lt;/a&gt;事件循环&lt;/h3&gt;&lt;p&gt;由于 &lt;code&gt;JS&lt;/code&gt; 是单线程非阻塞的，所有的任务都需要在这个线程中来处理。当需要执行异步任务时主线程会先挂
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
      <category term="react" scheme="http://yoursite.com/tags/react/"/>
    
  </entry>
  
</feed>
