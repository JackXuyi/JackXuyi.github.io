<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>奔跑的蜗牛</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前端开发工程师">
<meta property="og:type" content="website">
<meta property="og:title" content="奔跑的蜗牛">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="奔跑的蜗牛">
<meta property="og:description" content="前端开发工程师">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="奔跑的蜗牛">
<meta property="article:tag" content="React、node、webpack">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="0001.jpg#/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="奔跑的蜗牛" type="application/atom+xml">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">奔跑的蜗牛</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">分类</a>
        
      </nav>
      <nav id="sub-nav">
        
        
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-js执行流程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/07/11/js%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/" class="article-date">
  <time datetime="2021-07-10T21:58:37.000Z" itemprop="datePublished">2021-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/11/js%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/">js执行流程</a>
    </h1>
  


        <div style="color: #999; margin-top: 0.3rem" class="post-meta-item"> 共计
    796 字，约需阅读
    2.89
    分钟
</div>
      </header>
    
    
   

    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="js-引擎"><a href="#js-引擎" class="headerlink" title="js 引擎"></a><code>js</code> 引擎</h3><table>
<thead>
<tr>
<th align="left">浏览器</th>
<th align="left"><code>JavaScript</code> 引擎</th>
</tr>
</thead>
<tbody><tr>
<td align="left">chrome</td>
<td align="left"><code>V8</code></td>
</tr>
<tr>
<td align="left">safari</td>
<td align="left"><code>JavaScriptCore</code></td>
</tr>
<tr>
<td align="left">Firefox</td>
<td align="left"><code>SpiderMonkey</code></td>
</tr>
<tr>
<td align="left">Edge</td>
<td align="left"><code>Chakra</code></td>
</tr>
</tbody></table>
<h3 id="js-执行过程"><a href="#js-执行过程" class="headerlink" title="js 执行过程"></a><code>js</code> 执行过程</h3><ol>
<li>对源码进行词法分析</li>
<li>进行语法分析</li>
<li>生成抽象语法树</li>
<li>生成可执行代码（可能有优化过程，此处代码可能是字节码或者机器码）</li>
<li>执行</li>
</ol>
<h4 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h4><p>将程序源代码分解成对编程语言来说有意义的代码块，这些代码块被称为词法单元（<code>token</code>）。</p>
<h4 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h4><p>根据生成的 <code>Token</code> 进行语法分析。</p>
<h3 id="V8-引擎"><a href="#V8-引擎" class="headerlink" title="V8 引擎"></a><code>V8</code> 引擎</h3><h4 id="主要模块"><a href="#主要模块" class="headerlink" title="主要模块"></a>主要模块</h4><h5 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a><code>Parser</code></h5><p>负责将 <code>JavaScript</code> 源码转换为 <code>Abstract Syntax Tree</code> (<code>AST</code>)。在 <code>V8</code> 中有两个解析器用于解析 <code>JavaScript</code> 代码，分别是 <code>Parser</code> 和 <code>Pre-Parser</code> 。</p>
<ul>
<li><code>Parser</code> 解析器又称为 <code>full parser</code>（全量解析） 或者 <code>eager parser</code>（饥饿解析）。它会解析所有立即执行的代码，包括语法检查，生成 <code>AST</code>，以及确定词法作用域。</li>
<li><code>Pre-Parser</code> 又称为惰性解析，它只解析未被立即执行的代码（如函数），不生成 <code>AST</code> ，只确定作用域，以此来提高性能。当预解析后的代码开始执行时，才进行 <code>Parser</code> 解析。</li>
</ul>
<h5 id="Ignition"><a href="#Ignition" class="headerlink" title="Ignition"></a><code>Ignition</code></h5><p><code>interpreter</code>，即解释器，负责将 <code>AST</code> 转换为 <code>Bytecode</code>，解释执行 <code>Bytecode</code>；同时收集 <code>TurboFan</code> 优化编译所需的信息，比如函数参数的类型</p>
<h5 id="TurboFan"><a href="#TurboFan" class="headerlink" title="TurboFan"></a><code>TurboFan</code></h5><p><code>compiler</code>，即编译器，利用 <code>Ignitio</code> 所收集的类型信息，将 <code>Bytecode</code> 转换为优化的机器代码</p>
<h5 id="Orinoco"><a href="#Orinoco" class="headerlink" title="Orinoco"></a><code>Orinoco</code></h5><p><code>garbage collector</code>，垃圾回收模块，负责将程序不再需要的内存空间回收；</p>
<h4 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h4><ol>
<li>扫描所有的源代码，进行词法分析，生成 <code>Tokens</code></li>
<li><code>Parser</code> 解析器根据 <code>Tokens</code> 生成 <code>AST</code>，存在预编译和编译</li>
<li><code>Ignition</code> 解释器将 <code>AST</code> 转换为字节码，并解释执行</li>
<li><code>TurboFan</code> 编译器负责将热点函数优化编译为机器指令执行</li>
</ol>
<p><img src="/images/brower/js_v8.jpg" alt="执行过程"></p>
<h5 id="优化及优化导致的问题修复"><a href="#优化及优化导致的问题修复" class="headerlink" title="优化及优化导致的问题修复"></a>优化及优化导致的问题修复</h5><p>当 <code>Ignition</code> 开始执行 <code>JavaScript</code> 代码后，<code>V8</code> 会一直观察 <code>JavaScript</code> 代码的执行情况，并记录执行信息，如每个函数的执行次数、每次调用函数时，传递的参数类型等。</p>
<p>如果一个函数被调用的次数超过了内设的阈值，监视器就会将当前函数标记为热点函数（<code>Hot Function</code>），并将该函数的字节码以及执行的相关信息发送给 <code>TurboFan</code>。<code>TurboFan</code> 会根据执行信息做出一些进一步优化此代码的假设，在假设的基础上将字节码编译为优化的机器代码。如果假设成立，那么当下一次调用该函数时，就会执行优化编译后的机器代码，以提高代码的执行性能；如果假设不成立，不知道你们有没有注意到上图中有一条由 <code>optimized code</code> 指向 <code>bytecode</code> 的红色指向线。此过程叫做 <code>deoptimize</code>（优化回退），将优化编译后的机器代码还原为字节码。</p>
<p><img src="/images/brower/js_v8_optimize.jpg" alt="优化过程"></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.bilibili.com/video/BV1zV411z7RX">8 分钟带你了解 V8 引擎是如何运行 JS</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/73768338">JavaScript 深入浅出第 4 课：V8 引擎是如何工作的？</a></li>
<li><a href="https://v8.dev/blog/launching-ignition-and-turbofan">Launching Ignition and TurboFan</a></li>
<li><a href="https://segmentfault.com/a/1190000022062181">JavaScript 引擎（V8）是如何工作的</a></li>
<li><a href="https://mlib.wang/2020/02/08/v8-parser-compiler-javascript/">V8 是如何怎么处理 JavaScript 的</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/11/js%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/" data-id="cm1ghkbmx0024zodzd23y6jrc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/" rel="tag">node</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react中hooks实现原理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/28/react%E4%B8%ADhooks%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" class="article-date">
  <time datetime="2021-06-27T22:34:04.000Z" itemprop="datePublished">2021-06-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/28/react%E4%B8%ADhooks%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/">react中hooks实现原理</a>
    </h1>
  


        <div style="color: #999; margin-top: 0.3rem" class="post-meta-item"> 共计
    971 字，约需阅读
    3.53
    分钟
</div>
      </header>
    
    
   

    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="以客户端-useState-为例"><a href="#以客户端-useState-为例" class="headerlink" title="以客户端 useState 为例"></a>以客户端 <code>useState</code> 为例</h3><ol>
<li>声明 <code>useState</code>，通过 <code>ReactCurrentDispatcher.current</code> 来实现</li>
<li><code>ReactCurrentDispatcher.current</code> 的赋值是在 <code>packages/react-reconciler/src/ReactFiberHooks</code> 文件中区分挂载、更新和重新渲染分别实现的</li>
</ol>
<h4 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactFiberHooks.new.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mountState</span>(<span class="params">initialState</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>()</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    initialState = <span class="title function_">initialState</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  hook.<span class="property">memoizedState</span> = hook.<span class="property">baseState</span> = initialState</span><br><span class="line">  <span class="keyword">const</span> queue = (hook.<span class="property">queue</span> = &#123;</span><br><span class="line">    <span class="attr">pending</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">interleaved</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">lanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">dispatch</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">lastRenderedReducer</span>: basicStateReducer,</span><br><span class="line">    <span class="attr">lastRenderedState</span>: initialState,</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">const</span> dispatch = (queue.<span class="property">dispatch</span> = dispatchAction.<span class="title function_">bind</span>(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    currentlyRenderingFiber,</span><br><span class="line">    queue</span><br><span class="line">  ))</span><br><span class="line">  <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mountWorkInProgressHook</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hook = &#123;</span><br><span class="line">    <span class="attr">memoizedState</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">baseState</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">baseQueue</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">queue</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This is the first hook in the list</span></span><br><span class="line">    currentlyRenderingFiber.<span class="property">memoizedState</span> = workInProgressHook = hook</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Append to the end of the list</span></span><br><span class="line">    workInProgressHook = workInProgressHook.<span class="property">next</span> = hook</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> workInProgressHook</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberHooks.new.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateState</span>(<span class="params">initialState</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">updateReducer</span>(basicStateReducer, initialState)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateReducer</span>(<span class="params">reducer, initialArg, init</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hook = <span class="title function_">updateWorkInProgressHook</span>()</span><br><span class="line">  <span class="keyword">const</span> queue = hook.<span class="property">queue</span></span><br><span class="line"></span><br><span class="line">  queue.<span class="property">lastRenderedReducer</span> = reducer</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> current = currentHook</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The last rebase update that is NOT part of the base state.</span></span><br><span class="line">  <span class="keyword">let</span> baseQueue = current.<span class="property">baseQueue</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// The last pending update that hasn&#x27;t been processed yet.</span></span><br><span class="line">  <span class="keyword">const</span> pendingQueue = queue.<span class="property">pending</span></span><br><span class="line">  <span class="keyword">if</span> (pendingQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We have new updates that haven&#x27;t been processed yet.</span></span><br><span class="line">    <span class="comment">// We&#x27;ll add them to the base queue.</span></span><br><span class="line">    <span class="keyword">if</span> (baseQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Merge the pending queue and the base queue.</span></span><br><span class="line">      <span class="keyword">const</span> baseFirst = baseQueue.<span class="property">next</span></span><br><span class="line">      <span class="keyword">const</span> pendingFirst = pendingQueue.<span class="property">next</span></span><br><span class="line">      baseQueue.<span class="property">next</span> = pendingFirst</span><br><span class="line">      pendingQueue.<span class="property">next</span> = baseFirst</span><br><span class="line">    &#125;</span><br><span class="line">    current.<span class="property">baseQueue</span> = baseQueue = pendingQueue</span><br><span class="line">    queue.<span class="property">pending</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (baseQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// We have a queue to process.</span></span><br><span class="line">    <span class="keyword">const</span> first = baseQueue.<span class="property">next</span></span><br><span class="line">    <span class="keyword">let</span> newState = current.<span class="property">baseState</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> newBaseState = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> newBaseQueueFirst = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> newBaseQueueLast = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> update = first</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> updateLane = update.<span class="property">lane</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_">isSubsetOfLanes</span>(renderLanes, updateLane)) &#123;</span><br><span class="line">        <span class="comment">// Priority is insufficient. Skip this update. If this is the first</span></span><br><span class="line">        <span class="comment">// skipped update, the previous update/state is the new base</span></span><br><span class="line">        <span class="comment">// update/state.</span></span><br><span class="line">        <span class="keyword">const</span> clone = &#123;</span><br><span class="line">          <span class="attr">lane</span>: updateLane,</span><br><span class="line">          <span class="attr">action</span>: update.<span class="property">action</span>,</span><br><span class="line">          <span class="attr">eagerReducer</span>: update.<span class="property">eagerReducer</span>,</span><br><span class="line">          <span class="attr">eagerState</span>: update.<span class="property">eagerState</span>,</span><br><span class="line">          <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newBaseQueueLast === <span class="literal">null</span>) &#123;</span><br><span class="line">          newBaseQueueFirst = newBaseQueueLast = clone</span><br><span class="line">          newBaseState = newState</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          newBaseQueueLast = newBaseQueueLast.<span class="property">next</span> = clone</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Update the remaining priority in the queue.</span></span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Don&#x27;t need to accumulate this. Instead, we can remove</span></span><br><span class="line">        <span class="comment">// renderLanes from the original lanes.</span></span><br><span class="line">        currentlyRenderingFiber.<span class="property">lanes</span> = <span class="title function_">mergeLanes</span>(</span><br><span class="line">          currentlyRenderingFiber.<span class="property">lanes</span>,</span><br><span class="line">          updateLane</span><br><span class="line">        )</span><br><span class="line">        <span class="title function_">markSkippedUpdateLanes</span>(updateLane)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This update does have sufficient priority.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newBaseQueueLast !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> clone = &#123;</span><br><span class="line">            <span class="comment">// This update is going to be committed so we never want uncommit</span></span><br><span class="line">            <span class="comment">// it. Using NoLane works because 0 is a subset of all bitmasks, so</span></span><br><span class="line">            <span class="comment">// this will never be skipped by the check above.</span></span><br><span class="line">            <span class="attr">lane</span>: <span class="title class_">NoLane</span>,</span><br><span class="line">            <span class="attr">action</span>: update.<span class="property">action</span>,</span><br><span class="line">            <span class="attr">eagerReducer</span>: update.<span class="property">eagerReducer</span>,</span><br><span class="line">            <span class="attr">eagerState</span>: update.<span class="property">eagerState</span>,</span><br><span class="line">            <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">          &#125;</span><br><span class="line">          newBaseQueueLast = newBaseQueueLast.<span class="property">next</span> = clone</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Process this update.</span></span><br><span class="line">        <span class="keyword">if</span> (update.<span class="property">eagerReducer</span> === reducer) &#123;</span><br><span class="line">          <span class="comment">// If this update was processed eagerly, and its reducer matches the</span></span><br><span class="line">          <span class="comment">// current reducer, we can use the eagerly computed state.</span></span><br><span class="line">          newState = update.<span class="property">eagerState</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> action = update.<span class="property">action</span></span><br><span class="line">          newState = <span class="title function_">reducer</span>(newState, action)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      update = update.<span class="property">next</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span> &amp;&amp; update !== first)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newBaseQueueLast === <span class="literal">null</span>) &#123;</span><br><span class="line">      newBaseState = newState</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      newBaseQueueLast.<span class="property">next</span> = newBaseQueueFirst</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Mark that the fiber performed work, but only if the new state is</span></span><br><span class="line">    <span class="comment">// different from the current state.</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">is</span>(newState, hook.<span class="property">memoizedState</span>)) &#123;</span><br><span class="line">      <span class="title function_">markWorkInProgressReceivedUpdate</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hook.<span class="property">memoizedState</span> = newState</span><br><span class="line">    hook.<span class="property">baseState</span> = newBaseState</span><br><span class="line">    hook.<span class="property">baseQueue</span> = newBaseQueueLast</span><br><span class="line"></span><br><span class="line">    queue.<span class="property">lastRenderedState</span> = newState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Interleaved updates are stored on a separate queue. We aren&#x27;t going to</span></span><br><span class="line">  <span class="comment">// process them during this render, but we do need to track which lanes</span></span><br><span class="line">  <span class="comment">// are remaining.</span></span><br><span class="line">  <span class="keyword">const</span> lastInterleaved = queue.<span class="property">interleaved</span></span><br><span class="line">  <span class="keyword">if</span> (lastInterleaved !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> interleaved = lastInterleaved</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> interleavedLane = interleaved.<span class="property">lane</span></span><br><span class="line">      currentlyRenderingFiber.<span class="property">lanes</span> = <span class="title function_">mergeLanes</span>(</span><br><span class="line">        currentlyRenderingFiber.<span class="property">lanes</span>,</span><br><span class="line">        interleavedLane</span><br><span class="line">      )</span><br><span class="line">      <span class="title function_">markSkippedUpdateLanes</span>(interleavedLane)</span><br><span class="line">      interleaved = interleaved.<span class="property">next</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (interleaved !== lastInterleaved)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (baseQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// `queue.lanes` is used for entangling transitions. We can set it back to</span></span><br><span class="line">    <span class="comment">// zero once the queue is empty.</span></span><br><span class="line">    queue.<span class="property">lanes</span> = <span class="title class_">NoLanes</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dispatch = (queue.<span class="property">dispatch</span>: any)</span><br><span class="line">  <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="重渲染"><a href="#重渲染" class="headerlink" title="重渲染"></a>重渲染</h4><h4 id="dispatchAction"><a href="#dispatchAction" class="headerlink" title="dispatchAction"></a><code>dispatchAction</code></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dispatchAction</span>(<span class="params">fiber, queue, action</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> eventTime = <span class="title function_">requestEventTime</span>()</span><br><span class="line">  <span class="keyword">const</span> lane = <span class="title function_">requestUpdateLane</span>(fiber)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> update = &#123;</span><br><span class="line">    lane,</span><br><span class="line">    action,</span><br><span class="line">    <span class="attr">eagerReducer</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">eagerState</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> alternate = fiber.<span class="property">alternate</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    fiber === currentlyRenderingFiber ||</span><br><span class="line">    (alternate !== <span class="literal">null</span> &amp;&amp; alternate === currentlyRenderingFiber)</span><br><span class="line">  ) &#123;</span><br><span class="line">    didScheduleRenderPhaseUpdateDuringThisPass =</span><br><span class="line">      didScheduleRenderPhaseUpdate = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> pending = queue.<span class="property">pending</span></span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// This is the first update. Create a circular list.</span></span><br><span class="line">      update.<span class="property">next</span> = update</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.<span class="property">next</span> = pending.<span class="property">next</span></span><br><span class="line">      pending.<span class="property">next</span> = update</span><br><span class="line">    &#125;</span><br><span class="line">    queue.<span class="property">pending</span> = update</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 其它情况更新</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="basicStateReducer"><a href="#basicStateReducer" class="headerlink" title="basicStateReducer"></a><code>basicStateReducer</code></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">basicStateReducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span> ? <span class="title function_">action</span>(state) : action</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有的 <code>hooks</code> 都是挂载在 <code>ReactCurrentDispatcher</code> 对象上的</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [a, setA] = <span class="title function_">useState</span>()</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;a&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Test</span> /&gt;</span></span>,</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;root&#x27;</span>) || <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 编译之后</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Test</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> _useState = (<span class="number">0</span>, _react.<span class="property">useState</span>)(<span class="number">0</span>), <span class="comment">// 等价于 _useState = _react.useState(0)</span></span><br><span class="line">    _useState2 = <span class="title function_">_slicedToArray</span>(_useState, <span class="number">2</span>),</span><br><span class="line">    a = _useState2[<span class="number">0</span>],</span><br><span class="line">    setA = _useState2[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> _react2.<span class="property">default</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_reactDom2.<span class="property">default</span>.<span class="title function_">render</span>(</span><br><span class="line">  _react2.<span class="property">default</span>.<span class="title function_">createElement</span>(<span class="title class_">Test</span>, <span class="literal">null</span>),</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;root&#x27;</span>) || <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>编译后实际是把函数组件当作参数传递下去了</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.jianshu.com/p/b9ac8fa849f1">React Hooks 原理</a></li>
<li><a href="https://www.cnblogs.com/cczlovexw/p/13565085.html">React Hook 的底层实现原理</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/48584310">阅读源码后，来讲讲 React Hooks 是怎么实现的</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/75146261">React Hook 的实现原理和最佳实践</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/28/react%E4%B8%ADhooks%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/" data-id="cm1ghkbn50037zodz92cs5tb1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/" rel="tag">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react从dom-render到初次组件渲染完成" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/20/react%E4%BB%8Edom-render%E5%88%B0%E5%88%9D%E6%AC%A1%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E5%AE%8C%E6%88%90/" class="article-date">
  <time datetime="2021-06-19T22:12:44.000Z" itemprop="datePublished">2021-06-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/20/react%E4%BB%8Edom-render%E5%88%B0%E5%88%9D%E6%AC%A1%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E5%AE%8C%E6%88%90/">react从dom.render到初次组件渲染完成</a>
    </h1>
  


        <div style="color: #999; margin-top: 0.3rem" class="post-meta-item"> 共计
    1.3k 字，约需阅读
    4.73
    分钟
</div>
      </header>
    
    
   

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="从-dom-render-到初次组件渲染完成"><a href="#从-dom-render-到初次组件渲染完成" class="headerlink" title="从 dom.render 到初次组件渲染完成"></a>从 <code>dom.render</code> 到初次组件渲染完成</h2><ol>
<li><code>render(element,container,callback) </code> 调用 <code>legacyRenderSubtreeIntoContainer(null,element,container,false,callback)</code></li>
<li><code>legacyRenderSubtreeIntoContainer(parentComponent,children,container,forceHydrate,callback)</code> 调用<code>legacyCreateRootFromDOMContainer(container,false)</code> 创建容器并赋值给 <code>container._reactRootContainer</code></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/client/ReactDOMLegacy.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">legacyRenderSubtreeIntoContainer</span>(<span class="params"></span></span><br><span class="line"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span><br><span class="line"><span class="params">  children: ReactNodeList,</span></span><br><span class="line"><span class="params">  container: Container,</span></span><br><span class="line"><span class="params">  forceHydrate: boolean,</span></span><br><span class="line"><span class="params">  callback: ?<span class="built_in">Function</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> root = container.<span class="property">_reactRootContainer</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">fiberRoot</span>: <span class="title class_">FiberRoot</span></span><br><span class="line">  <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">    root = container.<span class="property">_reactRootContainer</span> = <span class="title function_">legacyCreateRootFromDOMContainer</span>(</span><br><span class="line">      container,</span><br><span class="line">      forceHydrate</span><br><span class="line">    )</span><br><span class="line">    fiberRoot = root.<span class="property">_internalRoot</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback</span><br><span class="line">      callback = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> instance = <span class="title function_">getPublicRootInstance</span>(fiberRoot)</span><br><span class="line">        originalCallback.<span class="title function_">call</span>(instance)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化同步更新</span></span><br><span class="line">    <span class="title function_">unbatchedUpdates</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">updateContainer</span>(children, fiberRoot, parentComponent, callback)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getPublicRootInstance</span>(fiberRoot)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>通过 <code>unbatchedUpdates</code> 同步更新容器元素并调用回调函数</li>
</ol>
<h3 id="构建容器"><a href="#构建容器" class="headerlink" title="构建容器"></a>构建容器</h3><ol>
<li><code>legacyCreateRootFromDOMContainer</code> 调用 <code>createLegacyRoot(container)</code> 构建容器</li>
<li>调用 <code>new ReactDOMLegacyRoot(container)</code> 构建实例</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/client/ReactDOMRoot.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createLegacyRoot</span>(<span class="params"></span></span><br><span class="line"><span class="params">  container: Container,</span></span><br><span class="line"><span class="params">  options?: RootOptions</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">RootType</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReactDOMLegacyRoot</span>(container, options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>构造函数中调用 <code>createRootImpl(container, ConcurrentRoot)</code> 创建根容器并赋值给 <code>_internalRoot</code> 属性</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/client/ReactDOMRoot.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ReactDOMLegacyRoot</span>(<span class="params">container: Container, options: <span class="keyword">void</span> | RootOptions</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_internalRoot</span> = <span class="title function_">createRootImpl</span>(container, <span class="title class_">LegacyRoot</span>, options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReactDOMLegacyRoot</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">render</span> = <span class="keyword">function</span> (<span class="params">children: ReactNodeList</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="variable language_">this</span>.<span class="property">_internalRoot</span></span><br><span class="line">  <span class="title function_">updateContainer</span>(children, root, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReactDOMLegacyRoot</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">unmount</span> = <span class="keyword">function</span> (<span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="variable language_">this</span>.<span class="property">_internalRoot</span></span><br><span class="line">  <span class="keyword">const</span> container = root.<span class="property">containerInfo</span></span><br><span class="line">  <span class="title function_">updateContainer</span>(<span class="literal">null</span>, root, <span class="literal">null</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">unmarkContainerAsRoot</span>(container)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createRootImpl</span>(<span class="params"></span></span><br><span class="line"><span class="params">  container: Container,</span></span><br><span class="line"><span class="params">  tag: RootTag,</span></span><br><span class="line"><span class="params">  options: <span class="keyword">void</span> | RootOptions</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="title function_">createContainer</span>(container, tag)</span><br><span class="line">  <span class="title function_">markContainerAsRoot</span>(root.<span class="property">current</span>, container)</span><br><span class="line">  <span class="keyword">const</span> rootContainerElement =</span><br><span class="line">    container.<span class="property">nodeType</span> === <span class="variable constant_">COMMENT_NODE</span> ? container.<span class="property">parentNode</span> : container</span><br><span class="line">  <span class="title function_">listenToAllSupportedEvents</span>(rootContainerElement)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>调用 <code>createContainer(container, ConcurrentRoot)</code> 构建根元素</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberRoot.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createContainer</span>(<span class="params"></span></span><br><span class="line"><span class="params">  containerInfo: Container,</span></span><br><span class="line"><span class="params">  tag: RootTag,</span></span><br><span class="line"><span class="params">  hydrate: boolean,</span></span><br><span class="line"><span class="params">  hydrationCallbacks: <span class="literal">null</span> | SuspenseHydrationCallbacks,</span></span><br><span class="line"><span class="params">  isStrictMode: boolean,</span></span><br><span class="line"><span class="params">  concurrentUpdatesByDefaultOverride: <span class="literal">null</span> | boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">OpaqueRoot</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createFiberRoot</span>(</span><br><span class="line">    containerInfo,</span><br><span class="line">    tag,</span><br><span class="line">    hydrate,</span><br><span class="line">    hydrationCallbacks,</span><br><span class="line">    isStrictMode,</span><br><span class="line">    concurrentUpdatesByDefaultOverride</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.  调用 `new FiberRootNode(container, ConcurrentRoot)` 构建根元素</span></span><br><span class="line"><span class="comment">// 2.  调用 `createHostRootFiber` 构建 `Fiber`</span></span><br><span class="line"><span class="comment">// 3.  初始化更新队列</span></span><br><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberRoot.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createFiberRoot</span>(<span class="params"></span></span><br><span class="line"><span class="params">  containerInfo: any,</span></span><br><span class="line"><span class="params">  tag: RootTag,</span></span><br><span class="line"><span class="params">  hydrate: boolean,</span></span><br><span class="line"><span class="params">  hydrationCallbacks: <span class="literal">null</span> | SuspenseHydrationCallbacks,</span></span><br><span class="line"><span class="params">  isStrictMode: boolean,</span></span><br><span class="line"><span class="params">  concurrentUpdatesByDefaultOverride: <span class="literal">null</span> | boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">FiberRoot</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">root</span>: <span class="title class_">FiberRoot</span> = <span class="keyword">new</span> <span class="title class_">FiberRootNode</span>(containerInfo, tag, hydrate)</span><br><span class="line">  <span class="keyword">const</span> uninitializedFiber = <span class="title function_">createHostRootFiber</span>(</span><br><span class="line">    tag,</span><br><span class="line">    isStrictMode,</span><br><span class="line">    concurrentUpdatesByDefaultOverride</span><br><span class="line">  )</span><br><span class="line">  root.<span class="property">current</span> = uninitializedFiber</span><br><span class="line">  uninitializedFiber.<span class="property">stateNode</span> = root</span><br><span class="line">  <span class="keyword">const</span> initialState = &#123; <span class="attr">element</span>: <span class="literal">null</span> &#125;</span><br><span class="line">  uninitializedFiber.<span class="property">memoizedState</span> = initialState</span><br><span class="line">  <span class="title function_">initializeUpdateQueue</span>(uninitializedFiber)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">FiberRootNode</span>(<span class="params">containerInfo, tag, hydrate</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">tag</span> = tag</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">containerInfo</span> = containerInfo</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pendingChildren</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">current</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pingCache</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">finishedWork</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">timeoutHandle</span> = noTimeout</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">context</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pendingContext</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">hydrate</span> = hydrate</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">callbackNode</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">callbackPriority</span> = <span class="title class_">NoLane</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">eventTimes</span> = <span class="title function_">createLaneMap</span>(<span class="title class_">NoLanes</span>)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">expirationTimes</span> = <span class="title function_">createLaneMap</span>(<span class="title class_">NoTimestamp</span>)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pendingLanes</span> = <span class="title class_">NoLanes</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">suspendedLanes</span> = <span class="title class_">NoLanes</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pingedLanes</span> = <span class="title class_">NoLanes</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">expiredLanes</span> = <span class="title class_">NoLanes</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mutableReadLanes</span> = <span class="title class_">NoLanes</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">finishedLanes</span> = <span class="title class_">NoLanes</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">entangledLanes</span> = <span class="title class_">NoLanes</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">entanglements</span> = <span class="title function_">createLaneMap</span>(<span class="title class_">NoLanes</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiber.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createHostRootFiber</span>(<span class="params"></span></span><br><span class="line"><span class="params">  tag: RootTag,</span></span><br><span class="line"><span class="params">  isStrictMode: boolean,</span></span><br><span class="line"><span class="params">  concurrentUpdatesByDefaultOverride: <span class="literal">null</span> | boolean</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Fiber</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> mode</span><br><span class="line">  <span class="keyword">if</span> (tag === <span class="title class_">ConcurrentRoot</span>) &#123;</span><br><span class="line">    mode = <span class="title class_">ConcurrentMode</span></span><br><span class="line">    <span class="keyword">if</span> (isStrictMode === <span class="literal">true</span>) &#123;</span><br><span class="line">      mode |= <span class="title class_">StrictLegacyMode</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (enableStrictEffects) &#123;</span><br><span class="line">        mode |= <span class="title class_">StrictEffectsMode</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enableStrictEffects &amp;&amp; createRootStrictEffectsByDefault) &#123;</span><br><span class="line">      mode |= <span class="title class_">StrictLegacyMode</span> | <span class="title class_">StrictEffectsMode</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !enableSyncDefaultUpdates ||</span><br><span class="line">      (allowConcurrentByDefault &amp;&amp; concurrentUpdatesByDefaultOverride)</span><br><span class="line">    ) &#123;</span><br><span class="line">      mode |= <span class="title class_">ConcurrentUpdatesByDefaultMode</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mode = <span class="title class_">NoMode</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; isDevToolsPresent) &#123;</span><br><span class="line">    mode |= <span class="title class_">ProfileMode</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createFiber</span>(<span class="title class_">HostRoot</span>, <span class="literal">null</span>, <span class="literal">null</span>, mode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">FiberNode</span>(<span class="params"></span></span><br><span class="line"><span class="params">  tag: WorkTag,</span></span><br><span class="line"><span class="params">  pendingProps: mixed,</span></span><br><span class="line"><span class="params">  key: <span class="literal">null</span> | string,</span></span><br><span class="line"><span class="params">  mode: TypeOfMode</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Instance</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">tag</span> = tag</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">key</span> = key</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">elementType</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">type</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">stateNode</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fiber</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">return</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">child</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">sibling</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">index</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ref</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pendingProps</span> = pendingProps</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">memoizedProps</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">updateQueue</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">memoizedState</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dependencies</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mode</span> = mode</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Effects</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">flags</span> = <span class="title class_">NoFlags</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">subtreeFlags</span> = <span class="title class_">NoFlags</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">deletions</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lanes</span> = <span class="title class_">NoLanes</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">childLanes</span> = <span class="title class_">NoLanes</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">alternate</span> = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createFiber</span>(<span class="params"></span></span><br><span class="line"><span class="params">  tag: WorkTag,</span></span><br><span class="line"><span class="params">  pendingProps: mixed,</span></span><br><span class="line"><span class="params">  key: <span class="literal">null</span> | string,</span></span><br><span class="line"><span class="params">  mode: TypeOfMode</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Fiber</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FiberNode</span>(tag, pendingProps, key, mode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>调用<code>markContainerAsRoot(root.current, container)</code>标记根元素</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/client/ReactDOMComponentTree.js</span></span><br><span class="line"><span class="keyword">const</span> randomKey = <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">slice</span>(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">const</span> internalContainerInstanceKey = <span class="string">&#x27;__reactContainer$&#x27;</span> + randomKey</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">markContainerAsRoot</span>(<span class="params">hostRoot: Fiber, node: Container</span>) &#123;</span><br><span class="line">  node[internalContainerInstanceKey] = hostRoot</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>调用<code>listenToAllSupportedEvents(rootContainerElement)</code> 向根元素上注册所有原生监听事件，但 <code>selectionchange</code> 事件注册在 <code>document</code> 上</li>
</ol>
<h4 id="构建的容器"><a href="#构建的容器" class="headerlink" title="构建的容器"></a>构建的容器</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> container =<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> root = container.<span class="property">_reactRootContainer</span> = &#123;</span><br><span class="line">  <span class="attr">_internalRoot</span>: &#123;</span><br><span class="line">    <span class="attr">tag</span>: <span class="title class_">RootTag</span>,</span><br><span class="line">    <span class="attr">containerInfo</span>: container,</span><br><span class="line">    <span class="attr">pendingChildren</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">current</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">pingCache</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">finishedWork</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">timeoutHandle</span>: noTimeout</span><br><span class="line">    <span class="attr">context</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">pendingContext</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">hydrate</span>: hydrate,</span><br><span class="line">    <span class="attr">callbackNode</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">callbackPriority</span>: <span class="title class_">NoLane</span>,</span><br><span class="line">    <span class="attr">eventTimes</span>: [<span class="title class_">NoLanes</span>],</span><br><span class="line">    <span class="attr">expirationTimes</span>: [<span class="title class_">NoTimestamp</span>],</span><br><span class="line">    <span class="attr">pendingLanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">suspendedLanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">pingedLanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">expiredLanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">mutableReadLanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">finishedLanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">entangledLanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">entanglements</span>: [<span class="title class_">NoLanes</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">current</span>: &#123;</span><br><span class="line">    <span class="attr">tag</span>: tag,</span><br><span class="line">    <span class="attr">key</span>: key,</span><br><span class="line">    <span class="attr">elementType</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">type</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">stateNode</span>: root,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fiber</span></span><br><span class="line">    <span class="attr">return</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">child</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">sibling</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">index</span>: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">ref</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">pendingProps</span>: pendingProps,</span><br><span class="line">    <span class="attr">memoizedProps</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">updateQueue</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">memoizedState</span>: &#123; <span class="attr">element</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">    <span class="attr">dependencies</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">mode</span>: <span class="title class_">NoMode</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Effects</span></span><br><span class="line">    <span class="attr">flags</span>: <span class="title class_">NoFlags</span>,</span><br><span class="line">    <span class="attr">subtreeFlags</span>: <span class="title class_">NoFlags</span>,</span><br><span class="line">    <span class="attr">deletions</span>: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">lanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line">    <span class="attr">childLanes</span>: <span class="title class_">NoLanes</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">alternate</span>: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> fiberRoot = root.<span class="property">_internalRoot</span></span><br><span class="line">container[<span class="string">&#x27;__reactContainer$&#x27;</span> + randomKey] = root.<span class="property">current</span></span><br></pre></td></tr></table></figure>

<h3 id="更新容器"><a href="#更新容器" class="headerlink" title="更新容器"></a>更新容器</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberReconciler.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">updateContainer</span>(<span class="params"></span></span><br><span class="line"><span class="params">  element: ReactNodeList,</span></span><br><span class="line"><span class="params">  container: OpaqueRoot,</span></span><br><span class="line"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span><br><span class="line"><span class="params">  callback: ?<span class="built_in">Function</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Lane</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> current = container.<span class="property">current</span></span><br><span class="line">  <span class="keyword">const</span> eventTime = <span class="title function_">requestEventTime</span>() <span class="comment">// 获取更新时间</span></span><br><span class="line">  <span class="keyword">const</span> lane = <span class="title function_">requestUpdateLane</span>(current) <span class="comment">// 获取更新任务的优先级</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> context = <span class="title function_">getContextForSubtree</span>(parentComponent) <span class="comment">// 获取 context</span></span><br><span class="line">  <span class="keyword">if</span> (container.<span class="property">context</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">    container.<span class="property">context</span> = context</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    container.<span class="property">pendingContext</span> = context</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> update = <span class="title function_">createUpdate</span>(eventTime, lane) <span class="comment">// 构建一次更新</span></span><br><span class="line">  update.<span class="property">payload</span> = &#123; element &#125;</span><br><span class="line"></span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    update.<span class="property">callback</span> = callback</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">enqueueUpdate</span>(current, update, lane)</span><br><span class="line">  <span class="keyword">const</span> root = <span class="title function_">scheduleUpdateOnFiber</span>(current, lane, eventTime)</span><br><span class="line">  <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">entangleTransitions</span>(root, current, lane)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> lane</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>获取更新优先级，位数越底，优先级越高</li>
<li>获取 <code>context</code></li>
<li>通过 <code>createUpdate</code> 创建更新</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createUpdate</span>(<span class="params">eventTime: number, lane: Lane</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> update = &#123;</span><br><span class="line">    eventTime,</span><br><span class="line">    lane,</span><br><span class="line">    <span class="attr">tag</span>: <span class="title class_">UpdateState</span>,</span><br><span class="line">    <span class="attr">payload</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">callback</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> update</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>通过 <code>enqueueUpdate</code> 把更新放入更新队列</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> enqueueUpdate&lt;<span class="title class_">State</span>&gt;(</span><br><span class="line">  <span class="attr">fiber</span>: <span class="title class_">Fiber</span>,</span><br><span class="line">  <span class="attr">update</span>: <span class="title class_">Update</span>&lt;<span class="title class_">State</span>&gt;,</span><br><span class="line">  <span class="attr">lane</span>: <span class="title class_">Lane</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue = fiber.<span class="property">updateQueue</span></span><br><span class="line">  <span class="keyword">if</span> (updateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 卸载时执行</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> sharedQueue = updateQueue.<span class="property">shared</span></span><br><span class="line">  <span class="comment">// 正在更新</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isInterleavedUpdate</span>(fiber, lane)) &#123;</span><br><span class="line">    <span class="keyword">const</span> interleaved = sharedQueue.<span class="property">interleaved</span></span><br><span class="line">    <span class="keyword">if</span> (interleaved === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 构建更新环，并放入更新队列</span></span><br><span class="line">      update.<span class="property">next</span> = update</span><br><span class="line">      <span class="title function_">pushInterleavedQueue</span>(sharedQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.<span class="property">next</span> = interleaved.<span class="property">next</span></span><br><span class="line">      interleaved.<span class="property">next</span> = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.<span class="property">interleaved</span> = update</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pending = sharedQueue.<span class="property">pending</span></span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 构建更新环，并放入更新队列</span></span><br><span class="line">      update.<span class="property">next</span> = update</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.<span class="property">next</span> = pending.<span class="property">next</span></span><br><span class="line">      pending.<span class="property">next</span> = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.<span class="property">pending</span> = update</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>通过 <code>scheduleUpdateOnFiber</code> 调度更新</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/20/react%E4%BB%8Edom-render%E5%88%B0%E5%88%9D%E6%AC%A1%E7%BB%84%E4%BB%B6%E6%B8%B2%E6%9F%93%E5%AE%8C%E6%88%90/" data-id="cm1ghkbn8003lzodz0roq2imc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/" rel="tag">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-webpack源码阅读（二）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/17/webpack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%BA%8C%EF%BC%89/" class="article-date">
  <time datetime="2021-06-16T19:22:20.000Z" itemprop="datePublished">2021-06-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/17/webpack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%BA%8C%EF%BC%89/">webpack源码阅读（二）</a>
    </h1>
  


        <div style="color: #999; margin-top: 0.3rem" class="post-meta-item"> 共计
    1.2k 字，约需阅读
    4.36
    分钟
</div>
      </header>
    
    
   

    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="webpack-Compilation-执行过程"><a href="#webpack-Compilation-执行过程" class="headerlink" title="webpack Compilation 执行过程"></a>webpack Compilation 执行过程</h3><ol>
<li>构建 <code>Compilation</code> 实例</li>
<li>调用 <code>compilation.finish</code> 执行构建</li>
<li>异步调用 <code>finishModules</code> 钩子函数</li>
<li>调用 <code>compilation.seal</code> 完成构建</li>
<li>构建 <code>ChunkGraph</code> 实例，并调用 <code>ChunkGraph.setChunkGraphForModule(module, chunkGraph)</code></li>
<li>同步调用 <code>seal</code> 钩子函数</li>
<li>同步调用 <code>optimizeDependencies</code> 钩子函数，等待钩子函数执行完毕</li>
<li>同步调用 <code>afterOptimizeDependencies</code> 钩子函数</li>
<li>同步调用 <code>beforeChunks</code> 钩子函数</li>
<li>构建 <code>chunk</code></li>
<li>同步调用 <code>afterChunks</code> 钩子函数</li>
<li>同步调用 <code>optimize</code> 钩子函数</li>
<li>同步调用 <code>optimizeModules</code> 钩子函数，等待钩子函数执行完毕</li>
<li>同步调用 <code>afterOptimizeModules</code> 钩子函数</li>
<li>同步调用 <code>optimizeChunks</code> 钩子函数，等待钩子函数执行完毕</li>
<li>同步调用 <code>afterOptimizeChunks</code> 钩子函数</li>
<li>异步调用 <code>optimizeTree</code> 钩子函数</li>
<li>同步调用 <code>afterOptimizeTree</code> 钩子函数</li>
<li>异步调用 <code>optimizeChunkModules</code> 钩子函数</li>
<li>同步调用 <code>afterOptimizeChunkModules</code> 钩子函数</li>
<li>同步调用 <code>shouldRecord</code> 钩子函数</li>
<li>同步调用 <code>reviveModules</code> 钩子函数</li>
<li>同步调用 <code>beforeModuleIds</code> 钩子函数</li>
<li>同步调用 <code>moduleIds</code> 钩子函数</li>
<li>同步调用 <code>optimizeModuleIds</code> 钩子函数</li>
<li>同步调用 <code>afterOptimizeModuleIds</code> 钩子函数</li>
<li>同步调用 <code>reviveChunks</code> 钩子函数</li>
<li>同步调用 <code>beforeChunkIds</code> 钩子函数</li>
<li>同步调用 <code>chunkIds</code> 钩子函数</li>
<li>同步调用 <code>optimizeChunkIds</code> 钩子函数</li>
<li>同步调用 <code>afterOptimizeChunkIds</code> 钩子函数</li>
<li>若 <code>shouldRecord</code> 钩子函数为正，则同步调用 <code>recordModules</code> 钩子函数</li>
<li>若 <code>shouldRecord</code> 钩子函数为正，则同步调用 <code>recordChunks</code> 钩子函数</li>
<li>同步调用 <code>optimizeCodeGeneration</code> 钩子函数</li>
<li>同步调用 <code>beforeModuleHash</code> 钩子函数</li>
<li>同步调用 <code>afterModuleHash</code> 钩子函数</li>
<li>同步调用 <code>beforeCodeGeneration</code> 钩子函数</li>
<li>调用 <code>codeGeneration</code> 生成代码</li>
<li>同步调用 <code>afterCodeGeneration</code> 钩子函数</li>
<li>同步调用 <code>beforeRuntimeRequirements</code> 钩子函数</li>
<li>提取 <code>modules</code> 中的 <code>runtime</code>，对于每个 <code>module</code> 的 <code>runtime</code> 都同步调用 <code>additionalModuleRuntimeRequirements</code> 钩子函数</li>
<li>若存在对应的 <code>runtimeRequirementInModule</code> 钩子函数，则同步调用该钩子函数</li>
<li>对每个 <code>chunk</code> 同步调用 <code>additionalChunkRuntimeRequirements</code> 钩子函数</li>
<li>对每个 <code>chunk</code> 中依赖的 <code>runtime</code> 调用 <code>runtimeRequirementInChunk</code> 钩子函数</li>
<li>构建含有重复依赖的依赖树</li>
<li>每个入口文件的依赖进行扁平化处理，去掉重复依赖，然后同步调用 <code>additionalTreeRuntimeRequirements</code> 钩子函数</li>
<li>每个入口文件的依赖一次调用 <code>runtimeRequirementInTree</code> 钩子函数</li>
<li>同步调用 <code>afterRuntimeRequirements</code> 钩子函数</li>
<li>同步调用 <code>beforeHash</code> 钩子函数</li>
<li>同步调用 <code>updateHash</code> 钩子函数</li>
<li>若为非 <code>fullHashModules</code> 是同步调用 <code>contentHash</code> 钩子函数</li>
<li>同步调用 <code>fullHash</code> 钩子函数</li>
<li>对每个 <code>chunk</code> 同步调用 <code>fullHash</code> 钩子函数</li>
<li>同步调用 <code>afterHash</code> 钩子函数</li>
<li>若需要记录则同步调用 <code>shouldRecord</code> 钩子函数</li>
<li>清理 <code>chunk</code> 记录的文件</li>
<li>同步调用 <code>beforeModuleAssets</code> 钩子函数</li>
<li>针对 <code>module</code> 的每一个需要输出的资源同步调用 <code>moduleAsset</code> 钩子函数</li>
<li>同步调用 <code>shouldGenerateChunkAssets</code> 判断是否需要输出资源</li>
<li>输出资源前同步调用 <code>beforeChunkAssets</code> 钩子函数</li>
<li>针对每个 <code>chunk</code> 构建一个 <code>manifest</code> 文件</li>
<li>为每个 <code>chunk</code> 写入包含的资源</li>
<li>同步调用 <code>chunkAsset</code> 钩子函数</li>
<li>异步调用 <code>processAssets</code> 钩子函数</li>
<li>同步调用 <code>afterProcessAssets</code> 钩子函数</li>
<li>构建依赖</li>
<li>若需要记录则同步调用 <code>record</code> 钩子函数</li>
<li>同步调用 <code>needAdditionalSeal</code> 钩子函数，判读是否需要新增</li>
<li>异步调用 <code>afterSeal</code> 钩子函数</li>
<li>回调</li>
</ol>
<h4 id="Module"><a href="#Module" class="headerlink" title="Module"></a><code>Module</code></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">		<span class="attr">type</span>: type,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">		<span class="attr">context</span>: context,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">boolean</span>&#125; */</span></span><br><span class="line">		<span class="attr">needId</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Unique Id</span></span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">number</span>&#125; */</span></span><br><span class="line">		<span class="attr">debugId</span>:  debugId++,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Info from Factory</span></span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">ResolveOptions</span>&#125; */</span></span><br><span class="line">		<span class="attr">resolveOptions</span>: <span class="variable constant_">EMPTY_RESOLVE_OPTIONS</span>,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">object | undefined</span>&#125; */</span></span><br><span class="line">		<span class="attr">factoryMeta</span>: <span class="literal">undefined</span>,</span><br><span class="line">		<span class="comment">// TODO refactor this -&gt; options object filled from Factory</span></span><br><span class="line">		<span class="comment">// TODO webpack 6: use an enum</span></span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">boolean</span>&#125; */</span></span><br><span class="line">		<span class="attr">useSourceMap</span>: <span class="literal">false</span>,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">boolean</span>&#125; */</span></span><br><span class="line">		<span class="attr">useSimpleSourceMap</span>: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Info from Build</span></span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">WebpackError[] | undefined</span>&#125; */</span></span><br><span class="line">		<span class="attr">_warnings</span>: <span class="literal">undefined</span>,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">WebpackError[] | undefined</span>&#125; */</span></span><br><span class="line">		<span class="attr">_errors</span>: <span class="literal">undefined</span>,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">BuildMeta</span>&#125; */</span></span><br><span class="line">		<span class="attr">buildMeta</span>: <span class="literal">undefined</span>,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">object</span>&#125; */</span></span><br><span class="line">		<span class="attr">buildInfo</span>: <span class="literal">undefined</span>,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">Dependency[] | undefined</span>&#125; */</span></span><br><span class="line">		<span class="attr">presentationalDependencies</span>: <span class="literal">undefined</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="chunk-具有的属性"><a href="#chunk-具有的属性" class="headerlink" title="chunk 具有的属性"></a><code>chunk</code> 具有的属性</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">number | string | null</span>&#125; */</span></span><br><span class="line">  <span class="attr">id</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">(number|string)[] | null</span>&#125; */</span></span><br><span class="line">  <span class="attr">ids</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">number</span>&#125; */</span></span><br><span class="line">  <span class="attr">debugId</span>: debugId++,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">  <span class="attr">name</span>: name,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">SortableSet&lt;string&gt;</span>&#125; */</span></span><br><span class="line">  <span class="attr">idNameHints</span>: <span class="keyword">new</span> <span class="title class_">SortableSet</span>(),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">boolean</span>&#125; */</span></span><br><span class="line">  <span class="attr">preventIntegration</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">(string | function(PathData, AssetInfo=): string)?</span>&#125; */</span></span><br><span class="line">  <span class="attr">filenameTemplate</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@private</span> <span class="doctag">@type</span> &#123;<span class="type">SortableSet&lt;ChunkGroup&gt;</span>&#125; */</span></span><br><span class="line">  <span class="attr">_groups</span>: <span class="keyword">new</span> <span class="title class_">SortableSet</span>(<span class="literal">undefined</span>, compareChunkGroupsByIndex),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">RuntimeSpec</span>&#125; */</span></span><br><span class="line">  <span class="attr">runtime</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">Set&lt;string&gt;</span>&#125; */</span></span><br><span class="line">  <span class="attr">files</span>: <span class="keyword">new</span> <span class="title class_">ChunkFilesSet</span>(),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">Set&lt;string&gt;</span>&#125; */</span></span><br><span class="line">  <span class="attr">auxiliaryFiles</span>: <span class="keyword">new</span> <span class="title class_">Set</span>(),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">boolean</span>&#125; */</span></span><br><span class="line">  <span class="attr">rendered</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string=</span>&#125; */</span></span><br><span class="line">  <span class="attr">hash</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">Record&lt;string, string&gt;</span>&#125; */</span></span><br><span class="line">  <span class="attr">contentHash</span>: <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string=</span>&#125; */</span></span><br><span class="line">  <span class="attr">renderedHash</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string=</span>&#125; */</span></span><br><span class="line">  <span class="attr">chunkReason</span>: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">boolean</span>&#125; */</span></span><br><span class="line">  <span class="attr">extraAsync</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ChunkGraph-具有的属性"><a href="#ChunkGraph-具有的属性" class="headerlink" title="ChunkGraph 具有的属性"></a><code>ChunkGraph</code> 具有的属性</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="comment">/** <span class="doctag">@private</span> <span class="doctag">@type</span> &#123;<span class="type">WeakMap&lt;Module, ChunkGraphModule&gt;</span>&#125; */</span></span><br><span class="line">		<span class="attr">_modules</span>: <span class="keyword">new</span> <span class="title class_">WeakMap</span>(),</span><br><span class="line">		<span class="comment">/** <span class="doctag">@private</span> <span class="doctag">@type</span> &#123;<span class="type">WeakMap&lt;Chunk, ChunkGraphChunk&gt;</span>&#125; */</span></span><br><span class="line">		<span class="attr">_chunks</span>:  <span class="keyword">new</span> <span class="title class_">WeakMap</span>(),</span><br><span class="line">		<span class="comment">/** <span class="doctag">@private</span> <span class="doctag">@type</span> &#123;<span class="type">WeakMap&lt;AsyncDependenciesBlock, ChunkGroup&gt;</span>&#125; */</span></span><br><span class="line">		<span class="attr">_blockChunkGroups</span>: <span class="keyword">new</span> <span class="title class_">WeakMap</span>(),</span><br><span class="line">		<span class="comment">/** <span class="doctag">@private</span> <span class="doctag">@type</span> &#123;<span class="type">Map&lt;string, string | number&gt;</span>&#125; */</span></span><br><span class="line">		<span class="attr">_runtimeIds</span>: <span class="keyword">new</span> <span class="title class_">Map</span>(),</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">ModuleGraph</span>&#125; */</span></span><br><span class="line">		<span class="attr">moduleGraph</span>: moduleGraph;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h4><ol>
<li>对于一份同逻辑的代码，当我们手写下一个一个的文件，它们无论是 <code>ESM</code> 还是 <code>commonJS</code> 或是 <code>AMD</code>，他们都是 <code>module</code></li>
<li>当我们写的 <code>module</code> 源文件传到 <code>webpack</code> 进行打包时，<code>webpack</code> 会根据文件引用关系生成 <code>chunk</code> 文件，<code>webpack</code> 会对这个 <code>chunk</code> 文件进行一些操作；</li>
<li><code>webpack</code> 处理好 <code>chunk</code> 文件后，最后会输出 <code>bundle</code> 文件，这个 <code>bundle</code> 文件包含了经过加载和编译的最终源文件，所以它可以直接在浏览器中运行。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/17/webpack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%BA%8C%EF%BC%89/" data-id="cm1ghkbnc0044zodz8b1g9z03" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-webpack源码阅读（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/15/webpack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time datetime="2021-06-15T12:52:53.000Z" itemprop="datePublished">2021-06-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/15/webpack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/">webpack源码阅读（一）</a>
    </h1>
  


        <div style="color: #999; margin-top: 0.3rem" class="post-meta-item"> 共计
    1k 字，约需阅读
    3.64
    分钟
</div>
      </header>
    
    
   

    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="webpack-compile-执行过程"><a href="#webpack-compile-执行过程" class="headerlink" title="webpack compile 执行过程"></a>webpack compile 执行过程</h3><ol>
<li>获取默认基础参数</li>
<li>构建 <code>Compiler</code> 实例</li>
<li>通过插件 <code>NodeEnvironmentPlugin</code> 插入日志输出，构建缓存，监听文件变化，监听 <code>NodeEnvironmentPlugin</code> 事件</li>
<li>注入自定义的插件</li>
<li>设置默认配置</li>
<li>同步执行 <code>environment</code> 钩子函数</li>
<li>同步执行 <code>afterEnvironment</code> 钩子函数</li>
<li>注入预设的插件系统</li>
<li>同步执行 <code>initialize</code> 钩子函数</li>
<li>执行 <code>run</code> ，开始构建</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: lib/webpack.js</span></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">WebpackFunctionSingle &amp; WebpackFunctionMulti</span>&#125; */</span> <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  options,</span></span></span><br><span class="line"><span class="params"><span class="function">  callback,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">create</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> compiler</span><br><span class="line">    <span class="keyword">let</span> watch = <span class="literal">false</span></span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">WatchOptions|WatchOptions[]</span>&#125; */</span></span><br><span class="line">    <span class="keyword">let</span> watchOptions</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(options)) &#123;</span><br><span class="line">      <span class="comment">// 多个 compiler</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">Compiler</span>&#125; */</span></span><br><span class="line">      compiler = <span class="title function_">createCompiler</span>(options)</span><br><span class="line">      <span class="comment">// watch 配置</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123; compiler, watch, watchOptions &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; compiler, watch, watchOptions &#125; = <span class="title function_">create</span>()</span><br><span class="line">  <span class="comment">// 执行 run ，开始构建</span></span><br><span class="line">  compiler.<span class="title function_">run</span>(<span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">    compiler.<span class="title function_">close</span>(<span class="function">(<span class="params">err2</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">callback</span>(err || err2, stats)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> compiler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createCompiler</span> = (<span class="params">rawOptions</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> options = <span class="title function_">getNormalizedWebpackOptions</span>(rawOptions)</span><br><span class="line">  <span class="title function_">applyWebpackOptionsBaseDefaults</span>(options) <span class="comment">// 构建默认基础选项</span></span><br><span class="line">  <span class="keyword">const</span> compiler = <span class="keyword">new</span> <span class="title class_">Compiler</span>(options.<span class="property">context</span>) <span class="comment">// 构建 compiler 实例</span></span><br><span class="line">  compiler.<span class="property">options</span> = options</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">NodeEnvironmentPlugin</span>(&#123;</span><br><span class="line">    <span class="attr">infrastructureLogging</span>: options.<span class="property">infrastructureLogging</span>,</span><br><span class="line">  &#125;).<span class="title function_">apply</span>(compiler) <span class="comment">// 插入日志输出，构建缓存系统，监听文件变化，监听 NodeEnvironmentPlugin 事件</span></span><br><span class="line">  <span class="comment">// 注入插件</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(options.<span class="property">plugins</span>)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> options.<span class="property">plugins</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        plugin.<span class="title function_">call</span>(compiler, compiler)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        plugin.<span class="title function_">apply</span>(compiler)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">applyWebpackOptionsDefaults</span>(options) <span class="comment">// 设置默认配置</span></span><br><span class="line">  compiler.<span class="property">hooks</span>.<span class="property">environment</span>.<span class="title function_">call</span>() <span class="comment">// 执行 environment 绑定的事件</span></span><br><span class="line">  compiler.<span class="property">hooks</span>.<span class="property">afterEnvironment</span>.<span class="title function_">call</span>() <span class="comment">// 执行 afterEnvironment 绑定的事件</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">WebpackOptionsApply</span>().<span class="title function_">process</span>(options, compiler) <span class="comment">// 注入预设的插件系统</span></span><br><span class="line">  compiler.<span class="property">hooks</span>.<span class="property">initialize</span>.<span class="title function_">call</span>() <span class="comment">// 执行 initialize 绑定的事件</span></span><br><span class="line">  <span class="keyword">return</span> compiler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="run-执行过程"><a href="#run-执行过程" class="headerlink" title="run 执行过程"></a><code>run</code> 执行过程</h4><ol>
<li>异步调用 <code>beforeRun</code> 钩子函数</li>
<li>异步调用 <code>run</code> 钩子函数</li>
<li>异步读取构建记录</li>
<li>实例化 <code>NormalModuleFactory</code> 对象，同步调用 <code>NormalModuleFactory</code> 钩子函数</li>
<li>实例化 <code>ContextModuleFactory</code> 对象，同步调用 <code>ContextModuleFactory</code> 钩子函数</li>
<li>构建 <code>Compilation</code> 需要的实例参数</li>
<li>异步调用 <code>beforeCompile</code> 钩子函数</li>
<li>同步调用 <code>compile</code> 钩子函数</li>
<li>构建 <code>Compilation</code> 实例</li>
<li>注入 <code>name</code> 和 <code>records</code> 属性</li>
<li>同步调用 <code>thisCompilation</code> 钩子函数</li>
<li>同步调用 <code>compilation</code> 钩子函数</li>
<li>异步调用 <code>make</code> 钩子函数</li>
<li>异步调用 <code>finishMake</code> 钩子函数</li>
<li>在 <code>nextTick</code> 中依次调用 <code>compilation.finish</code> 和 <code>compilation.seal</code></li>
<li>异步调用 <code>afterCompile</code> 钩子函数</li>
<li>同步调用 <code>shouldEmit</code> 钩子判断是否需要输出资源</li>
<li>输出资源文件，异步调用 <code>emit</code> 钩子函数</li>
<li>同步调用 <code>needAdditionalPass</code> 钩子函数</li>
<li>把构建记录 <code>records</code> 写入文件</li>
<li>异步调用 <code>done</code> 钩子函数</li>
<li>回调 <code>callback</code> 完成构建</li>
<li>同步调用 <code>afterDone</code> 钩子函数</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: lib/Compiler.js</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line">  <span class="title function_">run</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">finalCallback</span> = (<span class="params">err, stats</span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">idle</span> = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">beginIdle</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">idle</span> = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">running</span> = <span class="literal">false</span></span><br><span class="line">      <span class="comment">// 回调，然后调用 afterDone 钩子函数，结束构建</span></span><br><span class="line">      <span class="keyword">if</span> (callback !== <span class="literal">undefined</span>) <span class="title function_">callback</span>(err, stats)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">afterDone</span>.<span class="title function_">call</span>(stats)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">running</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">onCompiled</span> = (<span class="params">err, compilation</span>) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 不需要输出资源直接结束此次构建</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">shouldEmit</span>.<span class="title function_">call</span>(compilation) === <span class="literal">false</span>) &#123;</span><br><span class="line">        compilation.<span class="property">startTime</span> = startTime</span><br><span class="line">        compilation.<span class="property">endTime</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        <span class="keyword">const</span> stats = <span class="keyword">new</span> <span class="title class_">Stats</span>(compilation)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">done</span>.<span class="title function_">callAsync</span>(stats, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">finalCallback</span>(<span class="literal">null</span>, stats)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emitAssets</span>(compilation, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 判断是否需要新增资源，如果需要新增则结束此次编译流程，然后重新启动一个新的编译流程</span></span><br><span class="line">          <span class="keyword">if</span> (compilation.<span class="property">hooks</span>.<span class="property">needAdditionalPass</span>.<span class="title function_">call</span>()) &#123;</span><br><span class="line">            compilation.<span class="property">needAdditionalPass</span> = <span class="literal">true</span></span><br><span class="line">            compilation.<span class="property">startTime</span> = startTime</span><br><span class="line">            compilation.<span class="property">endTime</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">            <span class="keyword">const</span> stats = <span class="keyword">new</span> <span class="title class_">Stats</span>(compilation)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">done</span>.<span class="title function_">callAsync</span>(stats, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">additionalPass</span>.<span class="title function_">callAsync</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">compile</span>(onCompiled)</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 输出构建的记录，结束编译流程</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">emitRecords</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            compilation.<span class="property">startTime</span> = startTime</span><br><span class="line">            compilation.<span class="property">endTime</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">            <span class="keyword">const</span> stats = <span class="keyword">new</span> <span class="title class_">Stats</span>(compilation)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">done</span>.<span class="title function_">callAsync</span>(stats, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">storeBuildDependencies</span>(</span><br><span class="line">                compilation.<span class="property">buildDependencies</span>,</span><br><span class="line">                <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="title function_">finalCallback</span>(<span class="literal">null</span>, stats)</span><br><span class="line">                &#125;,</span><br><span class="line">              )</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">run</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">beforeRun</span>.<span class="title function_">callAsync</span>(<span class="variable language_">this</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">run</span>.<span class="title function_">callAsync</span>(<span class="variable language_">this</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 读取编译记录</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">readRecords</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 开始执行编译</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">compile</span>(onCompiled)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>() <span class="comment">// 开始执行编译进程</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">compile</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> params = <span class="variable language_">this</span>.<span class="title function_">newCompilationParams</span>() <span class="comment">// 构建 Compilation 参数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">beforeCompile</span>.<span class="title function_">callAsync</span>(params, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">compile</span>.<span class="title function_">call</span>(params)</span><br><span class="line">      <span class="keyword">const</span> compilation = <span class="variable language_">this</span>.<span class="title function_">newCompilation</span>(params) <span class="comment">// 构建 Compilation 实例，开始一次编译</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">make</span>.<span class="title function_">callAsync</span>(compilation, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">finishMake</span>.<span class="title function_">callAsync</span>(compilation, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 执行 Compilation 内的钩子</span></span><br><span class="line">            compilation.<span class="title function_">finish</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">              compilation.<span class="title function_">seal</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 一次编译完成</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">afterCompile</span>.<span class="title function_">callAsync</span>(compilation, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="title function_">callback</span>(<span class="literal">null</span>, compilation)</span><br><span class="line">                &#125;)</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="代码执行流程图"><a href="#代码执行流程图" class="headerlink" title="代码执行流程图"></a>代码执行流程图</h4><p><img src="/images/webpack-compile.png" alt="webpack compile 代码执行流程"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/15/webpack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="cm1ghkbnc0042zodzd6mu6ccv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Performance" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/15/Performance/" class="article-date">
  <time datetime="2021-06-14T22:48:44.000Z" itemprop="datePublished">2021-06-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/15/Performance/">Performance</a>
    </h1>
  


        <div style="color: #999; margin-top: 0.3rem" class="post-meta-item"> 共计
    474 字，约需阅读
    1.72
    分钟
</div>
      </header>
    
    
   

    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><h5 id="navigation"><a href="#navigation" class="headerlink" title="navigation"></a><code>navigation</code></h5><p>只读属性 Performance.navigation 会返回一个 PerformanceNavigation 对象。</p>
<ul>
<li>type: 一个无符号短整型，表示是如何导航到这个页面的。<ul>
<li>TYPE_NAVIGATE (0): 当前页面是通过点击链接，书签和表单提交，或者脚本操作，或者在 url 中直接输入地址;</li>
<li>TYPE_RELOAD (1): 点击刷新页面按钮或者通过 Location.reload()方法显示的页面;</li>
<li>TYPE_BACK_FORWARD (2): 页面通过历史记录和前进后退访问时;</li>
<li>TYPE_RESERVED (255): 任何其他方式。</li>
</ul>
</li>
<li>redirectCount: 无符号短整型，表示在到达这个页面之前重定向了多少次。</li>
</ul>
<h5 id="timing"><a href="#timing" class="headerlink" title="timing"></a><code>timing</code></h5><p>只读属性返回一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceTiming">PerformanceTiming</a> 对象，这个对象包括了页面相关的性能信息。</p>
<h5 id="timeOrigin"><a href="#timeOrigin" class="headerlink" title="timeOrigin"></a><code>timeOrigin</code></h5><p>只读属性 timeOrigin 返回一个表示 the performance measurement 开始时间的高精度 timestamp</p>
<h5 id="onresourcetimingbufferfull"><a href="#onresourcetimingbufferfull" class="headerlink" title="onresourcetimingbufferfull"></a><code>onresourcetimingbufferfull</code></h5><p>在 resourcetimingbufferfull 事件触发时会被调用的事件处理器，参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/onresourcetimingbufferfull">Performance.onresourcetimingbufferfull</a></p>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><h5 id="Performance-now"><a href="#Performance-now" class="headerlink" title="Performance.now()"></a><code>Performance.now()</code></h5><p>方法返回一个精确到毫秒的事件戳 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DOMHighResTimeStamp">DOMHighResTimeStamp</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">performance.<span class="title function_">now</span>() <span class="comment">// 38544.5</span></span><br><span class="line"><span class="title class_">Date</span>.<span class="title function_">now</span>() <span class="comment">// 1623685111685</span></span><br></pre></td></tr></table></figure>

<h6 id="tips：-测量程序性能时可以使用"><a href="#tips：-测量程序性能时可以使用" class="headerlink" title="tips： 测量程序性能时可以使用"></a>tips： 测量程序性能时可以使用</h6><h5 id="performance-setResourceTimingBufferSize"><a href="#performance-setResourceTimingBufferSize" class="headerlink" title="performance.setResourceTimingBufferSize()"></a><a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/setResourceTimingBufferSize"><code>performance.setResourceTimingBufferSize()</code></a></h5><p>设置浏览器记录资源加载情况的缓冲区大小，单位是对象个数，最小为 150</p>
<h5 id="Performance-mark"><a href="#Performance-mark" class="headerlink" title="Performance.mark()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/mark"><code>Performance.mark()</code></a></h5><p>在浏览器的性能缓冲区中使用给定名称添加一个 timestamp</p>
<h5 id="Performance-measure"><a href="#Performance-measure" class="headerlink" title="Performance.measure()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/measure"><code>Performance.measure()</code></a></h5><p>在浏览器性能记录缓存中创建了一个名为时间戳的记录来记录两个特殊标志位（通常称为开始标志和结束标志）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">performance.<span class="title function_">mark</span>(<span class="string">&#x27;test1&#x27;</span>)</span><br><span class="line">performance.<span class="title function_">mark</span>(<span class="string">&#x27;test2&#x27;</span>)</span><br><span class="line">performance.<span class="title function_">measure</span>(<span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;test1&#x27;</span>, <span class="string">&#x27;test2&#x27;</span>) <span class="comment">// &#123; detail: null, duration: 0.09999999403953552, entryType: &quot;measure&quot;, name: &quot;test&quot;, startTime: 33062.60000000894 &#125;</span></span><br></pre></td></tr></table></figure>

<h6 id="tips：-与-Performance-mark-结合可以测量指定项目的时间"><a href="#tips：-与-Performance-mark-结合可以测量指定项目的时间" class="headerlink" title="tips： 与 Performance.mark() 结合可以测量指定项目的时间"></a>tips： 与 <code>Performance.mark()</code> 结合可以测量指定项目的时间</h6><h5 id="Performance-clearResourceTimings"><a href="#Performance-clearResourceTimings" class="headerlink" title="Performance.clearResourceTimings()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearResourceTimings"><code>Performance.clearResourceTimings()</code></a></h5><p>移除所有的记录</p>
<h5 id="Performance-clearMarks"><a href="#Performance-clearMarks" class="headerlink" title="Performance.clearMarks()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearMarks"><code>Performance.clearMarks()</code></a></h5><p>从浏览器的 performance entry 缓存中移除声明的标记。</p>
<h5 id="Performance-clearMeasures"><a href="#Performance-clearMeasures" class="headerlink" title="Performance.clearMeasures()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearMeasures"><code>Performance.clearMeasures()</code></a></h5><p>从浏览器的性能入口缓存区中移除声明的度量衡。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/15/Performance/" data-id="cm1ghkbmf0006zodz8nzk3li9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react的同步更新" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/14/react%E7%9A%84%E5%90%8C%E6%AD%A5%E6%9B%B4%E6%96%B0/" class="article-date">
  <time datetime="2021-06-13T18:10:34.000Z" itemprop="datePublished">2021-06-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/14/react%E7%9A%84%E5%90%8C%E6%AD%A5%E6%9B%B4%E6%96%B0/">react的同步更新</a>
    </h1>
  


        <div style="color: #999; margin-top: 0.3rem" class="post-meta-item"> 共计
    7.6k 字，约需阅读
    27.64
    分钟
</div>
      </header>
    
    
   

    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="react-同步更新"><a href="#react-同步更新" class="headerlink" title="react 同步更新"></a>react 同步更新</h3><h4 id="class-组件"><a href="#class-组件" class="headerlink" title="class 组件"></a>class 组件</h4><p>每个 <code>class</code> 组件初始化时都会注入 <code>updater</code> 的属性</p>
<h5 id="更新过程"><a href="#更新过程" class="headerlink" title="更新过程"></a>更新过程</h5><ol>
<li>构建更新节点</li>
<li>把节点放入更新队列</li>
<li>调度更新节点</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">const</span> classComponentUpdater = &#123;</span><br><span class="line">  isMounted,</span><br><span class="line">  <span class="title function_">enqueueSetState</span>(<span class="params">inst, payload, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = <span class="title function_">getInstance</span>(inst)</span><br><span class="line">    <span class="keyword">const</span> eventTime = <span class="title function_">requestEventTime</span>()</span><br><span class="line">    <span class="keyword">const</span> lane = <span class="title function_">requestUpdateLane</span>(fiber) <span class="comment">// 获取更新方式，包括同步更新</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> update = <span class="title function_">createUpdate</span>(eventTime, lane) <span class="comment">// 构建更新</span></span><br><span class="line">    update.<span class="property">payload</span> = payload</span><br><span class="line">    <span class="keyword">if</span> (callback !== <span class="literal">undefined</span> &amp;&amp; callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      update.<span class="property">callback</span> = callback</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">enqueueUpdate</span>(fiber, update, lane) <span class="comment">// 更新放入队列</span></span><br><span class="line">    <span class="keyword">const</span> root = <span class="title function_">scheduleUpdateOnFiber</span>(fiber, lane, eventTime) <span class="comment">// 调度更新节点</span></span><br><span class="line">    <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">entangleTransitions</span>(root, fiber, lane)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">      <span class="title function_">markStateUpdateScheduled</span>(fiber, lane)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">enqueueReplaceState</span>(<span class="params">inst, payload, callback</span>) &#123;</span><br><span class="line">    <span class="comment">// 类似与 enqueueSetState</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">enqueueForceUpdate</span>(<span class="params">inst, callback</span>) &#123;</span><br><span class="line">    <span class="comment">// 类似与 enqueueSetState</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="把节点放入更新队列"><a href="#把节点放入更新队列" class="headerlink" title="把节点放入更新队列"></a>把节点放入更新队列</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> enqueueUpdate&lt;<span class="title class_">State</span>&gt;(</span><br><span class="line">  <span class="attr">fiber</span>: <span class="title class_">Fiber</span>,</span><br><span class="line">  <span class="attr">update</span>: <span class="title class_">Update</span>&lt;<span class="title class_">State</span>&gt;,</span><br><span class="line">  <span class="attr">lane</span>: <span class="title class_">Lane</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue = fiber.<span class="property">updateQueue</span></span><br><span class="line">  <span class="keyword">if</span> (updateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 组件卸载</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sharedQueue = updateQueue.<span class="property">shared</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isInterleavedUpdate</span>(fiber, lane)) &#123;</span><br><span class="line">    <span class="keyword">const</span> interleaved = sharedQueue.<span class="property">interleaved</span></span><br><span class="line">    <span class="keyword">if</span> (interleaved === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 挂载时构成一个循环链表</span></span><br><span class="line">      update.<span class="property">next</span> = update</span><br><span class="line">      <span class="comment">// At the end of the current render, this queue&#x27;s interleaved updates will</span></span><br><span class="line">      <span class="comment">// be transfered to the pending queue.</span></span><br><span class="line">      <span class="title function_">pushInterleavedQueue</span>(sharedQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.<span class="property">next</span> = interleaved.<span class="property">next</span></span><br><span class="line">      interleaved.<span class="property">next</span> = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.<span class="property">interleaved</span> = update</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pending = sharedQueue.<span class="property">pending</span></span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 挂载时构成一个循环链表</span></span><br><span class="line">      update.<span class="property">next</span> = update</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.<span class="property">next</span> = pending.<span class="property">next</span></span><br><span class="line">      pending.<span class="property">next</span> = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.<span class="property">pending</span> = update</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="调度更新节点"><a href="#调度更新节点" class="headerlink" title="调度更新节点"></a>调度更新节点</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">scheduleUpdateOnFiber</span>(<span class="params"></span></span><br><span class="line"><span class="params">  fiber: Fiber,</span></span><br><span class="line"><span class="params">  lane: Lane,</span></span><br><span class="line"><span class="params">  eventTime: number</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">FiberRoot</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="title function_">checkForNestedUpdates</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = <span class="title function_">markUpdateLaneFromFiberToRoot</span>(fiber, lane) <span class="comment">// 更新从当前 fiber 标记到根节点并返回根节点</span></span><br><span class="line">  <span class="keyword">if</span> (root === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 标记当前节点进入更新队列</span></span><br><span class="line">  <span class="title function_">markRootUpdated</span>(root, lane, eventTime)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (executionContext &amp; <span class="title class_">CommitContext</span>) !== <span class="title class_">NoContext</span> &amp;&amp;</span><br><span class="line">      root === rootCommittingMutationOrLayoutEffects</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (fiber.<span class="property">mode</span> &amp; <span class="title class_">ProfileMode</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> current = fiber</span><br><span class="line">        <span class="keyword">while</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (current.<span class="property">tag</span> === <span class="title class_">Profiler</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; id, onNestedUpdateScheduled &#125; = current.<span class="property">memoizedProps</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> onNestedUpdateScheduled === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">              <span class="title function_">onNestedUpdateScheduled</span>(id)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          current = current.<span class="property">return</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Consolidate with `isInterleavedUpdate` check</span></span><br><span class="line">  <span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">    <span class="comment">// Received an update to a tree that&#x27;s in the middle of rendering. Mark</span></span><br><span class="line">    <span class="comment">// that there was an interleaved update work on this root. Unless the</span></span><br><span class="line">    <span class="comment">// `deferRenderPhaseUpdateToNextBatch` flag is off and this is a render</span></span><br><span class="line">    <span class="comment">// phase update. In that case, we don&#x27;t treat render phase updates as if</span></span><br><span class="line">    <span class="comment">// they were interleaved, for backwards compat reasons.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      deferRenderPhaseUpdateToNextBatch ||</span><br><span class="line">      (executionContext &amp; <span class="title class_">RenderContext</span>) === <span class="title class_">NoContext</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      workInProgressRootUpdatedLanes = <span class="title function_">mergeLanes</span>(</span><br><span class="line">        workInProgressRootUpdatedLanes,</span><br><span class="line">        lane</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (workInProgressRootExitStatus === <span class="title class_">RootSuspendedWithDelay</span>) &#123;</span><br><span class="line">      <span class="comment">// The root already suspended with a delay, which means this render</span></span><br><span class="line">      <span class="comment">// definitely won&#x27;t finish. Since we have a new update, let&#x27;s mark it as</span></span><br><span class="line">      <span class="comment">// suspended now, right before marking the incoming update. This has the</span></span><br><span class="line">      <span class="comment">// effect of interrupting the current render and switching to the update.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Make sure this doesn&#x27;t override pings that happen while we&#x27;ve</span></span><br><span class="line">      <span class="comment">// already started rendering.</span></span><br><span class="line">      <span class="title function_">markRootSuspended</span>(root, workInProgressRootRenderLanes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lane === <span class="title class_">SyncLane</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// Check if we&#x27;re inside unbatchedUpdates</span></span><br><span class="line">      (executionContext &amp; <span class="title class_">LegacyUnbatchedContext</span>) !== <span class="title class_">NoContext</span> &amp;&amp;</span><br><span class="line">      <span class="comment">// Check if we&#x27;re not already rendering</span></span><br><span class="line">      (executionContext &amp; (<span class="title class_">RenderContext</span> | <span class="title class_">CommitContext</span>)) === <span class="title class_">NoContext</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="title function_">performSyncWorkOnRoot</span>(root) <span class="comment">// 开始同步更新</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">ensureRootIsScheduled</span>(root, eventTime)</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        executionContext === <span class="title class_">NoContext</span> &amp;&amp;</span><br><span class="line">        (fiber.<span class="property">mode</span> &amp; <span class="title class_">ConcurrentMode</span>) === <span class="title class_">NoMode</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Flush the synchronous work now, unless we&#x27;re already working or inside</span></span><br><span class="line">        <span class="comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span></span><br><span class="line">        <span class="comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span></span><br><span class="line">        <span class="comment">// without immediately flushing it. We only do this for user-initiated</span></span><br><span class="line">        <span class="comment">// updates, to preserve historical behavior of legacy mode.</span></span><br><span class="line">        <span class="title function_">resetRenderTimer</span>()</span><br><span class="line">        <span class="title function_">flushSyncCallbacksOnlyInLegacyMode</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Schedule other updates after in case the callback is sync.</span></span><br><span class="line">    <span class="title function_">ensureRootIsScheduled</span>(root, eventTime)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="performSyncWorkOnRoot"><a href="#performSyncWorkOnRoot" class="headerlink" title="performSyncWorkOnRoot"></a><code>performSyncWorkOnRoot</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="comment">// This is the entry point for synchronous tasks that don&#x27;t go</span></span><br><span class="line"><span class="comment">// through Scheduler</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">performSyncWorkOnRoot</span>(<span class="params">root</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdatePhase) &#123;</span><br><span class="line">    <span class="title function_">syncNestedUpdateFlag</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">flushPassiveEffects</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> lanes = <span class="title function_">getNextLanes</span>(root, <span class="title class_">NoLanes</span>)</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">includesSomeLane</span>(lanes, <span class="title class_">SyncLane</span>)) &#123;</span><br><span class="line">    <span class="comment">// 同步任务执行完毕</span></span><br><span class="line">    <span class="title function_">ensureRootIsScheduled</span>(root, <span class="title function_">now</span>())</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> exitStatus = <span class="title function_">renderRootSync</span>(root, lanes)</span><br><span class="line">  <span class="comment">// 错误补偿逻辑</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We now have a consistent tree. Because this is a sync render, we</span></span><br><span class="line">  <span class="comment">// will commit it even if something suspended.</span></span><br><span class="line">  <span class="keyword">const</span> finishedWork = root.<span class="property">current</span>.<span class="property">alternate</span></span><br><span class="line">  root.<span class="property">finishedWork</span> = finishedWork</span><br><span class="line">  root.<span class="property">finishedLanes</span> = lanes</span><br><span class="line">  <span class="title function_">commitRoot</span>(root)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before exiting, make sure there&#x27;s a callback scheduled for the next</span></span><br><span class="line">  <span class="comment">// pending level.</span></span><br><span class="line">  <span class="title function_">ensureRootIsScheduled</span>(root, <span class="title function_">now</span>())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="renderRootSync"><a href="#renderRootSync" class="headerlink" title="renderRootSync"></a><code>renderRootSync</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// workInProgressRoot 全局变量</span></span><br><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">renderRootSync</span>(<span class="params">root: FiberRoot, lanes: Lanes</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext</span><br><span class="line">  executionContext |= <span class="title class_">RenderContext</span></span><br><span class="line">  <span class="keyword">const</span> prevDispatcher = <span class="title function_">pushDispatcher</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the root or lanes have changed, throw out the existing stack</span></span><br><span class="line">  <span class="comment">// and prepare a fresh one. Otherwise we&#x27;ll continue where we left off.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) &#123;</span><br><span class="line">    <span class="title function_">prepareFreshStack</span>(root, lanes) <span class="comment">// 更新 context</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    <span class="title function_">markRenderStarted</span>(lanes)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="title function_">workLoopSync</span>()</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">      <span class="title function_">handleError</span>(root, thrownValue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">  <span class="title function_">resetContextDependencies</span>()</span><br><span class="line">  executionContext = prevExecutionContext</span><br><span class="line">  <span class="title function_">popDispatcher</span>(prevDispatcher)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    <span class="title function_">markRenderStopped</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set this to null to indicate there&#x27;s no in-progress render.</span></span><br><span class="line">  workInProgressRoot = <span class="literal">null</span></span><br><span class="line">  workInProgressRootRenderLanes = <span class="title class_">NoLanes</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgressRootExitStatus</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="workLoopSync"><a href="#workLoopSync" class="headerlink" title="workLoopSync"></a><code>workLoopSync</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="comment">// workInProgress 全局变量</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">workLoopSync</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Already timed out, so perform work without checking if we need to yield.</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">performUnitOfWork</span>(workInProgress)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="performUnitOfWork"><a href="#performUnitOfWork" class="headerlink" title="performUnitOfWork"></a><code>performUnitOfWork</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// 执行更新任务</span></span><br><span class="line">  <span class="keyword">const</span> current = unitOfWork.<span class="property">alternate</span></span><br><span class="line">  <span class="keyword">let</span> next = <span class="title function_">beginWork</span>(current, unitOfWork, subtreeRenderLanes) <span class="comment">// child</span></span><br><span class="line">  unitOfWork.<span class="property">memoizedProps</span> = unitOfWork.<span class="property">pendingProps</span></span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 没有下一个任务时表示任务已经做完</span></span><br><span class="line">    <span class="title function_">completeUnitOfWork</span>(unitOfWork)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress = next</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">ReactCurrentOwner</span>.<span class="property">current</span> = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a><code>beginWork</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberBeginWork.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">beginWork</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">current</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">renderLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Fiber</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> updateLanes = workInProgress.<span class="property">lanes</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldProps = current.<span class="property">memoizedProps</span></span><br><span class="line">    <span class="keyword">const</span> newProps = workInProgress.<span class="property">pendingProps</span></span><br><span class="line">    <span class="keyword">if</span> (oldProps !== newProps || <span class="title function_">hasLegacyContextChanged</span>()) &#123;</span><br><span class="line">      <span class="comment">// props 更新或 context 更新</span></span><br><span class="line">      didReceiveUpdate = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title function_">includesSomeLane</span>(renderLanes, updateLanes)) &#123;</span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">      <span class="comment">// 此次渲染的更新和等待的更新没有任何交集，新增等待的更新等待下次执行</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 其它更新逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清空</span></span><br><span class="line">  workInProgress.<span class="property">lanes</span> = <span class="title class_">NoLanes</span></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title class_">Component</span> = workInProgress.<span class="property">type</span></span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.<span class="property">pendingProps</span></span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.<span class="property">elementType</span> === <span class="title class_">Component</span></span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : <span class="title function_">resolveDefaultProps</span>(<span class="title class_">Component</span>, unresolvedProps)</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">updateClassComponent</span>(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        <span class="title class_">Component</span>,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderLanes</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其它类型组件更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="updateClassComponent"><a href="#updateClassComponent" class="headerlink" title="updateClassComponent"></a>updateClassComponent</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberBeginWork.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateClassComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  workInProgress: Fiber,</span></span><br><span class="line"><span class="params">  Component: any,</span></span><br><span class="line"><span class="params">  nextProps: any,</span></span><br><span class="line"><span class="params">  renderLanes: Lanes</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 提取 context</span></span><br><span class="line">  <span class="keyword">let</span> hasContext</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isLegacyContextProvider</span>(<span class="title class_">Component</span>)) &#123;</span><br><span class="line">    hasContext = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">pushLegacyContextProvider</span>(workInProgress)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    hasContext = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">prepareToReadContext</span>(workInProgress, renderLanes)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span></span><br><span class="line">  <span class="keyword">let</span> shouldUpdate</span><br><span class="line">  <span class="keyword">if</span> (instance === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 挂载</span></span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// A class component without an instance only mounts if it suspended</span></span><br><span class="line">      <span class="comment">// inside a non-concurrent tree, in an inconsistent state. We want to</span></span><br><span class="line">      <span class="comment">// treat it like a new mount, even though an empty version of it already</span></span><br><span class="line">      <span class="comment">// committed. Disconnect the alternate pointers.</span></span><br><span class="line">      current.<span class="property">alternate</span> = <span class="literal">null</span></span><br><span class="line">      workInProgress.<span class="property">alternate</span> = <span class="literal">null</span></span><br><span class="line">      <span class="comment">// Since this is conceptually a new fiber, schedule a Placement effect</span></span><br><span class="line">      workInProgress.<span class="property">flags</span> |= <span class="title class_">Placement</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// In the initial pass we might need to construct the instance.</span></span><br><span class="line">    <span class="title function_">constructClassInstance</span>(workInProgress, <span class="title class_">Component</span>, nextProps)</span><br><span class="line">    <span class="title function_">mountClassInstance</span>(workInProgress, <span class="title class_">Component</span>, nextProps, renderLanes)</span><br><span class="line">    shouldUpdate = <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// In a resume, we&#x27;ll already have an instance we can reuse.</span></span><br><span class="line">    shouldUpdate = <span class="title function_">resumeMountClassInstance</span>(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="title class_">Component</span>,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//   更新</span></span><br><span class="line">    shouldUpdate = <span class="title function_">updateClassInstance</span>(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="title class_">Component</span>,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> nextUnitOfWork = <span class="title function_">finishClassComponent</span>(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    <span class="title class_">Component</span>,</span><br><span class="line">    shouldUpdate,</span><br><span class="line">    hasContext,</span><br><span class="line">    renderLanes</span><br><span class="line">  ) <span class="comment">// child</span></span><br><span class="line">  <span class="keyword">return</span> nextUnitOfWork</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="constructClassInstance"><a href="#constructClassInstance" class="headerlink" title="constructClassInstance"></a><code>constructClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">constructClassInstance</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">ctor</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">props</span>: <span class="built_in">any</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">any</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> isLegacyContextConsumer = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> unmaskedContext = emptyContextObject</span><br><span class="line">  <span class="keyword">let</span> context = emptyContextObject</span><br><span class="line">  <span class="keyword">const</span> contextType = ctor.<span class="property">contextType</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提取 context</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">&#x27;object&#x27;</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">    context = <span class="title function_">readContext</span>(contextType)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!disableLegacyContext) &#123;</span><br><span class="line">    unmaskedContext = <span class="title function_">getUnmaskedContext</span>(workInProgress, ctor, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> contextTypes = ctor.<span class="property">contextTypes</span></span><br><span class="line">    isLegacyContextConsumer =</span><br><span class="line">      contextTypes !== <span class="literal">null</span> &amp;&amp; contextTypes !== <span class="literal">undefined</span></span><br><span class="line">    context = isLegacyContextConsumer</span><br><span class="line">      ? <span class="title function_">getMaskedContext</span>(workInProgress, unmaskedContext)</span><br><span class="line">      : emptyContextObject</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建组件实例</span></span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">new</span> <span class="title function_">ctor</span>(props, context)</span><br><span class="line">  <span class="keyword">const</span> state = (workInProgress.<span class="property">memoizedState</span> =</span><br><span class="line">    instance.<span class="property">state</span> !== <span class="literal">null</span> &amp;&amp; instance.<span class="property">state</span> !== <span class="literal">undefined</span></span><br><span class="line">      ? instance.<span class="property">state</span></span><br><span class="line">      : <span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// fiber 注入更新队列和实例信息，存储实例和 fiber 映射</span></span><br><span class="line">  <span class="title function_">adoptClassInstance</span>(workInProgress, instance)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓存 context</span></span><br><span class="line">  <span class="keyword">if</span> (isLegacyContextConsumer) &#123;</span><br><span class="line">    <span class="title function_">cacheContext</span>(workInProgress, unmaskedContext, context)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> instance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="adoptClassInstance"><a href="#adoptClassInstance" class="headerlink" title="adoptClassInstance"></a><code>adoptClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">adoptClassInstance</span>(<span class="params"><span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>, <span class="attr">instance</span>: <span class="built_in">any</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  instance.<span class="property">updater</span> = classComponentUpdater <span class="comment">// 更新队列</span></span><br><span class="line">  workInProgress.<span class="property">stateNode</span> = instance <span class="comment">// 存储组件实例</span></span><br><span class="line">  <span class="comment">//构建 fiber 和组件实例的映射</span></span><br><span class="line">  <span class="title function_">setInstance</span>(instance, workInProgress)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="mountClassInstance"><a href="#mountClassInstance" class="headerlink" title="mountClassInstance"></a><code>mountClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mountClassInstance</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">ctor</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">newProps</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">renderLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span></span><br><span class="line">  instance.<span class="property">props</span> = newProps</span><br><span class="line">  instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span></span><br><span class="line">  instance.<span class="property">refs</span> = emptyRefsObject</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化队列</span></span><br><span class="line">  <span class="title function_">initializeUpdateQueue</span>(workInProgress)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 context</span></span><br><span class="line">  <span class="keyword">const</span> contextType = ctor.<span class="property">contextType</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">&#x27;object&#x27;</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">    instance.<span class="property">context</span> = <span class="title function_">readContext</span>(contextType)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (disableLegacyContext) &#123;</span><br><span class="line">    instance.<span class="property">context</span> = emptyContextObject</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> unmaskedContext = <span class="title function_">getUnmaskedContext</span>(workInProgress, ctor, <span class="literal">true</span>)</span><br><span class="line">    instance.<span class="property">context</span> = <span class="title function_">getMaskedContext</span>(workInProgress, unmaskedContext)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新 state</span></span><br><span class="line">  instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 getDerivedStateFromProps 更新 state</span></span><br><span class="line">  <span class="keyword">const</span> getDerivedStateFromProps = ctor.<span class="property">getDerivedStateFromProps</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">applyDerivedStateFromProps</span>(</span><br><span class="line">      workInProgress,</span><br><span class="line">      ctor,</span><br><span class="line">      getDerivedStateFromProps,</span><br><span class="line">      newProps</span><br><span class="line">    )</span><br><span class="line">    instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 componentWillMount 生命周期</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> ctor.<span class="property">getDerivedStateFromProps</span> !== <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> instance.<span class="property">getSnapshotBeforeUpdate</span> !== <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">    (<span class="keyword">typeof</span> instance.<span class="property">UNSAFE_componentWillMount</span> === <span class="string">&#x27;function&#x27;</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> instance.<span class="property">componentWillMount</span> === <span class="string">&#x27;function&#x27;</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">callComponentWillMount</span>(workInProgress, instance)</span><br><span class="line">    <span class="comment">// componentWillMount 执行 setState 时立即更新 state</span></span><br><span class="line">    <span class="title function_">processUpdateQueue</span>(workInProgress, newProps, instance, renderLanes)</span><br><span class="line">    instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.<span class="property">componentDidMount</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">fiberFlags</span>: <span class="title class_">Flags</span> = <span class="title class_">Update</span></span><br><span class="line">    <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics) &#123;</span><br><span class="line">      fiberFlags |= <span class="title class_">LayoutStatic</span></span><br><span class="line">    &#125;</span><br><span class="line">    workInProgress.<span class="property">flags</span> |= fiberFlags</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="finishClassComponent"><a href="#finishClassComponent" class="headerlink" title="finishClassComponent"></a><code>finishClassComponent</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">finishClassComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">current</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="title class_">Component</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">shouldUpdate</span>: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">hasContext</span>: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">renderLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Refs should update even if shouldComponentUpdate returns false</span></span><br><span class="line">  <span class="title function_">markRef</span>(current, workInProgress)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> didCaptureError = (workInProgress.<span class="property">flags</span> &amp; <span class="title class_">DidCapture</span>) !== <span class="title class_">NoFlags</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!shouldUpdate &amp;&amp; !didCaptureError) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">bailoutOnAlreadyFinishedWork</span>(current, workInProgress, renderLanes)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Rerender</span></span><br><span class="line">  <span class="title class_">ReactCurrentOwner</span>.<span class="property">current</span> = workInProgress</span><br><span class="line">  <span class="keyword">let</span> nextChildren</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    didCaptureError &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> <span class="title class_">Component</span>.<span class="property">getDerivedStateFromError</span> !== <span class="string">&#x27;function&#x27;</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 错误处理</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nextChildren = instance.<span class="title function_">render</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">reconcileChildren</span>(current, workInProgress, nextChildren, renderLanes)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 记录 state</span></span><br><span class="line">  workInProgress.<span class="property">memoizedState</span> = instance.<span class="property">state</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgress.<span class="property">child</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="reconcileChildren"><a href="#reconcileChildren" class="headerlink" title="reconcileChildren"></a><code>reconcileChildren</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildren</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">current</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">nextChildren</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">renderLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 挂载</span></span><br><span class="line">    workInProgress.<span class="property">child</span> = <span class="title function_">mountChildFibers</span>(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ChildReconciler"><a href="#ChildReconciler" class="headerlink" title="ChildReconciler"></a><code>ChildReconciler</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactChildFiber.old.js</span></span><br><span class="line"><span class="keyword">const</span> mountChildFibers = <span class="title class_">ChildReconciler</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ChildReconciler</span>(<span class="params">shouldTrackSideEffects</span>) &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">deleteChild</span>(<span class="params"><span class="attr">returnFiber</span>: <span class="title class_">Fiber</span>, <span class="attr">childToDelete</span>: <span class="title class_">Fiber</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">deleteRemainingChildren</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">returnFiber</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">currentFirstChild</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params">  </span>): <span class="literal">null</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">useFiber</span>(<span class="params"><span class="attr">fiber</span>: <span class="title class_">Fiber</span>, <span class="attr">pendingProps</span>: mixed</span>): <span class="title class_">Fiber</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> clone = <span class="title function_">createWorkInProgress</span>(fiber, pendingProps) <span class="comment">// 构建一个新的 fiber 节点</span></span><br><span class="line">    clone.<span class="property">index</span> = <span class="number">0</span></span><br><span class="line">    clone.<span class="property">sibling</span> = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">return</span> clone</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">placeChild</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">newFiber</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lastPlacedIndex</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">newIndex</span>: <span class="built_in">number</span></span></span><br><span class="line"><span class="params">  </span>): <span class="built_in">number</span> &#123;</span><br><span class="line">    newFiber.<span class="property">index</span> = newIndex</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span> lastPlacedIndex</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回 fiber</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">placeSingleChild</span>(<span class="params"><span class="attr">newFiber</span>: <span class="title class_">Fiber</span></span>): <span class="title class_">Fiber</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> newFiber</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">reconcileSingleTextNode</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">returnFiber</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">currentFirstChild</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">textContent</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Fiber</span> &#123;</span><br><span class="line">    <span class="comment">// There&#x27;s no need to check for keys on text nodes since we don&#x27;t have a</span></span><br><span class="line">    <span class="comment">// way to define them.</span></span><br><span class="line">    <span class="keyword">if</span> (currentFirstChild !== <span class="literal">null</span> &amp;&amp; currentFirstChild.<span class="property">tag</span> === <span class="title class_">HostText</span>) &#123;</span><br><span class="line">      <span class="comment">// We already have an existing node so let&#x27;s just update it and delete</span></span><br><span class="line">      <span class="comment">// the rest.</span></span><br><span class="line">      <span class="title function_">deleteRemainingChildren</span>(returnFiber, currentFirstChild.<span class="property">sibling</span>)</span><br><span class="line">      <span class="keyword">const</span> existing = <span class="title function_">useFiber</span>(currentFirstChild, textContent)</span><br><span class="line">      existing.<span class="property">return</span> = returnFiber</span><br><span class="line">      <span class="keyword">return</span> existing</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The existing first child is not a text node so we need to create one</span></span><br><span class="line">    <span class="comment">// and delete the existing ones.</span></span><br><span class="line">    <span class="title function_">deleteRemainingChildren</span>(returnFiber, currentFirstChild)</span><br><span class="line">    <span class="keyword">const</span> created = <span class="title function_">createFiberFromText</span>(textContent, returnFiber.<span class="property">mode</span>, lanes)</span><br><span class="line">    created.<span class="property">return</span> = returnFiber</span><br><span class="line">    <span class="keyword">return</span> created</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 fiber</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">reconcileSingleElement</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">returnFiber</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">currentFirstChild</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">element</span>: <span class="title class_">ReactElement</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Fiber</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = element.<span class="property">key</span></span><br><span class="line">    <span class="keyword">let</span> child = currentFirstChild</span><br><span class="line">    <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> If key === null and child.key === null, then this only applies to</span></span><br><span class="line">      <span class="comment">// the first item in the list.</span></span><br><span class="line">      <span class="keyword">if</span> (child.<span class="property">key</span> === key) &#123;</span><br><span class="line">        <span class="keyword">const</span> elementType = element.<span class="property">type</span></span><br><span class="line">        <span class="keyword">if</span> (elementType === <span class="variable constant_">REACT_FRAGMENT_TYPE</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (child.<span class="property">tag</span> === <span class="title class_">Fragment</span>) &#123;</span><br><span class="line">            <span class="title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="property">sibling</span>)</span><br><span class="line">            <span class="keyword">const</span> existing = <span class="title function_">useFiber</span>(child, element.<span class="property">props</span>.<span class="property">children</span>)</span><br><span class="line">            existing.<span class="property">return</span> = returnFiber</span><br><span class="line">            <span class="keyword">return</span> existing</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            child.<span class="property">elementType</span> === elementType ||</span><br><span class="line">            (enableLazyElements &amp;&amp;</span><br><span class="line">              <span class="keyword">typeof</span> elementType === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">              elementType !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">              elementType.<span class="property">$$typeof</span> === <span class="variable constant_">REACT_LAZY_TYPE</span> &amp;&amp;</span><br><span class="line">              <span class="title function_">resolveLazy</span>(elementType) === child.<span class="property">type</span>)</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="property">sibling</span>)</span><br><span class="line">            <span class="keyword">const</span> existing = <span class="title function_">useFiber</span>(child, element.<span class="property">props</span>)</span><br><span class="line">            existing.<span class="property">ref</span> = <span class="title function_">coerceRef</span>(returnFiber, child, element)</span><br><span class="line">            existing.<span class="property">return</span> = returnFiber</span><br><span class="line">            <span class="keyword">return</span> existing</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Didn&#x27;t match.</span></span><br><span class="line">        <span class="title function_">deleteRemainingChildren</span>(returnFiber, child)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">deleteChild</span>(returnFiber, child)</span><br><span class="line">      &#125;</span><br><span class="line">      child = child.<span class="property">sibling</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (element.<span class="property">type</span> === <span class="variable constant_">REACT_FRAGMENT_TYPE</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> created = <span class="title function_">createFiberFromFragment</span>(</span><br><span class="line">        element.<span class="property">props</span>.<span class="property">children</span>,</span><br><span class="line">        returnFiber.<span class="property">mode</span>,</span><br><span class="line">        lanes,</span><br><span class="line">        element.<span class="property">key</span></span><br><span class="line">      )</span><br><span class="line">      created.<span class="property">return</span> = returnFiber</span><br><span class="line">      <span class="keyword">return</span> created</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> created = <span class="title function_">createFiberFromElement</span>(element, returnFiber.<span class="property">mode</span>, lanes)</span><br><span class="line">      created.<span class="property">ref</span> = <span class="title function_">coerceRef</span>(returnFiber, currentFirstChild, element)</span><br><span class="line">      created.<span class="property">return</span> = returnFiber</span><br><span class="line">      <span class="keyword">return</span> created</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 children fiber</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">reconcileChildFibers</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">returnFiber</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">currentFirstChild</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">newChild</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Fiber</span> | <span class="literal">null</span> &#123;</span><br><span class="line">    <span class="comment">// 处理 &lt;&gt;&#123;[...]&#125;&lt;/&gt; 和 &lt;&gt;...&lt;/&gt; 组件，从其中提取 children</span></span><br><span class="line">    <span class="keyword">const</span> isUnkeyedTopLevelFragment =</span><br><span class="line">      <span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">      newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      newChild.<span class="property">type</span> === <span class="variable constant_">REACT_FRAGMENT_TYPE</span> &amp;&amp;</span><br><span class="line">      newChild.<span class="property">key</span> === <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">      newChild = newChild.<span class="property">props</span>.<span class="property">children</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对象类型，为 react 组件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp; newChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (newChild.<span class="property">$$typeof</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="attr">REACT_ELEMENT_TYPE</span>:</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">placeSingleChild</span>(</span><br><span class="line">            <span class="title function_">reconcileSingleElement</span>(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              lanes</span><br><span class="line">            )</span><br><span class="line">          )</span><br><span class="line">        <span class="comment">// 其它 react 组件类型</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 数组、迭代器，支持 promise 或者 generate</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&#x27;string&#x27;</span> || <span class="keyword">typeof</span> newChild === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 处理字符串或数字类型</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">placeSingleChild</span>(</span><br><span class="line">        <span class="title function_">reconcileSingleTextNode</span>(</span><br><span class="line">          returnFiber,</span><br><span class="line">          currentFirstChild,</span><br><span class="line">          <span class="string">&#x27;&#x27;</span> + newChild,</span><br><span class="line">          lanes</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remaining cases are all treated as empty.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">deleteRemainingChildren</span>(returnFiber, currentFirstChild)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> reconcileChildFibers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="completeUnitOfWork"><a href="#completeUnitOfWork" class="headerlink" title="completeUnitOfWork"></a><code>completeUnitOfWork</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">completeUnitOfWork</span>(<span class="params"><span class="attr">unitOfWork</span>: <span class="title class_">Fiber</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> completedWork = unitOfWork</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> current = completedWork.<span class="property">alternate</span> <span class="comment">// 更新后的 fiber</span></span><br><span class="line">    <span class="keyword">const</span> returnFiber = completedWork.<span class="property">return</span> <span class="comment">// 父节点 fiber</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((completedWork.<span class="property">flags</span> &amp; <span class="title class_">Incomplete</span>) === <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">      <span class="comment">// 任务未完成</span></span><br><span class="line">      <span class="keyword">let</span> next = <span class="title function_">completeWork</span>(current, completedWork, subtreeRenderLanes)</span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Completing this fiber spawned new work. Work on that next.</span></span><br><span class="line">        workInProgress = next</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This fiber did not complete because something threw. Pop values off</span></span><br><span class="line">      <span class="comment">// the stack without entering the complete phase. If this is a boundary,</span></span><br><span class="line">      <span class="comment">// capture values if possible.</span></span><br><span class="line">      <span class="keyword">const</span> next = <span class="title function_">unwindWork</span>(completedWork, subtreeRenderLanes)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Because this fiber did not complete, don&#x27;t reset its expiration time.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If completing this work spawned new work, do that next. We&#x27;ll come</span></span><br><span class="line">        <span class="comment">// back here again.</span></span><br><span class="line">        <span class="comment">// Since we&#x27;re restarting, remove anything that is not a host effect</span></span><br><span class="line">        <span class="comment">// from the effect tag.</span></span><br><span class="line">        next.<span class="property">flags</span> &amp;= <span class="title class_">HostEffectMask</span></span><br><span class="line">        workInProgress = next</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Mark the parent fiber as incomplete and clear its subtree flags.</span></span><br><span class="line">        returnFiber.<span class="property">flags</span> |= <span class="title class_">Incomplete</span></span><br><span class="line">        returnFiber.<span class="property">subtreeFlags</span> = <span class="title class_">NoFlags</span></span><br><span class="line">        returnFiber.<span class="property">deletions</span> = <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> siblingFiber = completedWork.<span class="property">sibling</span></span><br><span class="line">    <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">      workInProgress = siblingFiber</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise, return to the parent</span></span><br><span class="line">    completedWork = returnFiber</span><br><span class="line">    <span class="comment">// Update the next thing we&#x27;re working on in case something throws.</span></span><br><span class="line">    workInProgress = completedWork</span><br><span class="line">  &#125; <span class="keyword">while</span> (completedWork !== <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We&#x27;ve reached the root.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRootExitStatus === <span class="title class_">RootIncomplete</span>) &#123;</span><br><span class="line">    workInProgressRootExitStatus = <span class="title class_">RootCompleted</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="commitRoot"><a href="#commitRoot" class="headerlink" title="commitRoot"></a><code>commitRoot</code></h5><p>调用 <code>commitRootImpl</code> 提交更新</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitRootImpl</span>(<span class="params">root, renderPriorityLevel</span>) &#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// `flushPassiveEffects` will call `flushSyncUpdateQueue` at the end, which</span></span><br><span class="line">    <span class="comment">// means `flushPassiveEffects` will sometimes result in additional</span></span><br><span class="line">    <span class="comment">// passive effects. So we need to keep flushing in a loop until there are</span></span><br><span class="line">    <span class="comment">// no more pending effects.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Might be better if `flushPassiveEffects` did not automatically</span></span><br><span class="line">    <span class="comment">// flush synchronous work at the end, to avoid factoring hazards like this.</span></span><br><span class="line">    <span class="title function_">flushPassiveEffects</span>();</span><br><span class="line">  &#125; <span class="keyword">while</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> finishedWork = root.<span class="property">finishedWork</span>;</span><br><span class="line">  <span class="keyword">const</span> lanes = root.<span class="property">finishedLanes</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (finishedWork === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  root.<span class="property">finishedWork</span> = <span class="literal">null</span>;</span><br><span class="line">  root.<span class="property">finishedLanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// commitRoot never returns a continuation; it always finishes synchronously.</span></span><br><span class="line">  <span class="comment">// So we can clear these now to allow a new callback to be scheduled.</span></span><br><span class="line">  root.<span class="property">callbackNode</span> = <span class="literal">null</span>;</span><br><span class="line">  root.<span class="property">callbackPriority</span> = <span class="title class_">NoLane</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update the first and last pending times on this root. The new first</span></span><br><span class="line">  <span class="comment">// pending time is whatever is left on the root fiber.</span></span><br><span class="line">  <span class="keyword">let</span> remainingLanes = <span class="title function_">mergeLanes</span>(finishedWork.<span class="property">lanes</span>, finishedWork.<span class="property">childLanes</span>);</span><br><span class="line">  <span class="title function_">markRootFinished</span>(root, remainingLanes);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">    <span class="comment">// We can reset these now that they are finished.</span></span><br><span class="line">    workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line">    workInProgress = <span class="literal">null</span>;</span><br><span class="line">    workInProgressRootRenderLanes = <span class="title class_">NoLanes</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If there are pending passive effects, schedule a callback to process them.</span></span><br><span class="line">  <span class="comment">// Do this as early as possible, so it is queued before anything else that</span></span><br><span class="line">  <span class="comment">// might get scheduled in the commit phase. (See #16714.)</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Delete all other places that schedule the passive effect callback</span></span><br><span class="line">  <span class="comment">// They&#x27;re redundant.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (finishedWork.<span class="property">subtreeFlags</span> &amp; <span class="title class_">PassiveMask</span>) !== <span class="title class_">NoFlags</span> ||</span><br><span class="line">    (finishedWork.<span class="property">flags</span> &amp; <span class="title class_">PassiveMask</span>) !== <span class="title class_">NoFlags</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rootDoesHavePassiveEffects) &#123;</span><br><span class="line">      rootDoesHavePassiveEffects = <span class="literal">true</span>;</span><br><span class="line">      <span class="title function_">scheduleCallback</span>(<span class="title class_">NormalSchedulerPriority</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">flushPassiveEffects</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there are any effects in the whole tree.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This is left over from the effect list implementation, where we had</span></span><br><span class="line">  <span class="comment">// to check for the existence of `firstEffect` to satsify Flow. I think the</span></span><br><span class="line">  <span class="comment">// only other reason this optimization exists is because it affects profiling.</span></span><br><span class="line">  <span class="comment">// Reconsider whether this is necessary.</span></span><br><span class="line">  <span class="keyword">const</span> subtreeHasEffects =</span><br><span class="line">    (finishedWork.<span class="property">subtreeFlags</span> &amp;</span><br><span class="line">      (<span class="title class_">BeforeMutationMask</span> | <span class="title class_">MutationMask</span> | <span class="title class_">LayoutMask</span> | <span class="title class_">PassiveMask</span>)) !==</span><br><span class="line">    <span class="title class_">NoFlags</span>;</span><br><span class="line">  <span class="keyword">const</span> rootHasEffect =</span><br><span class="line">    (finishedWork.<span class="property">flags</span> &amp;</span><br><span class="line">      (<span class="title class_">BeforeMutationMask</span> | <span class="title class_">MutationMask</span> | <span class="title class_">LayoutMask</span> | <span class="title class_">PassiveMask</span>)) !==</span><br><span class="line">    <span class="title class_">NoFlags</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (subtreeHasEffects || rootHasEffect) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevTransition = <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span>;</span><br><span class="line">    <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> previousPriority = <span class="title function_">getCurrentUpdatePriority</span>();</span><br><span class="line">    <span class="title function_">setCurrentUpdatePriority</span>(<span class="title class_">DiscreteEventPriority</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">    executionContext |= <span class="title class_">CommitContext</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset this to null before calling lifecycles</span></span><br><span class="line">    <span class="title class_">ReactCurrentOwner</span>.<span class="property">current</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The commit phase is broken into several sub-phases. We do a separate pass</span></span><br><span class="line">    <span class="comment">// of the effect list for each phase: all mutation effects come before all</span></span><br><span class="line">    <span class="comment">// layout effects, and so on.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The first phase a &quot;before mutation&quot; phase. We use this phase to read the</span></span><br><span class="line">    <span class="comment">// state of the host tree right before we mutate it. This is where</span></span><br><span class="line">    <span class="comment">// getSnapshotBeforeUpdate is called.</span></span><br><span class="line">    <span class="keyword">const</span> shouldFireAfterActiveInstanceBlur = <span class="title function_">commitBeforeMutationEffects</span>(</span><br><span class="line">      root,</span><br><span class="line">      finishedWork,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      <span class="comment">// Mark the current commit time to be shared by all Profilers in this</span></span><br><span class="line">      <span class="comment">// batch. This enables them to be grouped later.</span></span><br><span class="line">      <span class="title function_">recordCommitTime</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">      <span class="comment">// Track the root here, rather than in commitLayoutEffects(), because of ref setters.</span></span><br><span class="line">      <span class="comment">// Updates scheduled during ref detachment should also be flagged.</span></span><br><span class="line">      rootCommittingMutationOrLayoutEffects = root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The next phase is the mutation phase, where we mutate the host tree.</span></span><br><span class="line">    <span class="title function_">commitMutationEffects</span>(root, finishedWork, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldFireAfterActiveInstanceBlur) &#123;</span><br><span class="line">      <span class="title function_">afterActiveInstanceBlur</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">resetAfterCommit</span>(root.<span class="property">containerInfo</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The work-in-progress tree is now the current tree. This must come after</span></span><br><span class="line">    <span class="comment">// the mutation phase, so that the previous tree is still current during</span></span><br><span class="line">    <span class="comment">// componentWillUnmount, but before the layout phase, so that the finished</span></span><br><span class="line">    <span class="comment">// work is current during componentDidMount/Update.</span></span><br><span class="line">    root.<span class="property">current</span> = finishedWork;</span><br><span class="line">    <span class="title function_">commitLayoutEffects</span>(finishedWork, root, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">      rootCommittingMutationOrLayoutEffects = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell Scheduler to yield at the end of the frame, so the browser has an</span></span><br><span class="line">    <span class="comment">// opportunity to paint.</span></span><br><span class="line">    <span class="title function_">requestPaint</span>();</span><br><span class="line"></span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the priority to the previous non-sync value.</span></span><br><span class="line">    <span class="title function_">setCurrentUpdatePriority</span>(previousPriority);</span><br><span class="line">    <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span> = prevTransition;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No effects.</span></span><br><span class="line">    root.<span class="property">current</span> = finishedWork;</span><br><span class="line">    <span class="comment">// Measure these anyway so the flamegraph explicitly shows that there were</span></span><br><span class="line">    <span class="comment">// no effects.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Maybe there&#x27;s a better way to report this.</span></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      <span class="title function_">recordCommitTime</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> rootDidHavePassiveEffects = rootDoesHavePassiveEffects;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rootDoesHavePassiveEffects) &#123;</span><br><span class="line">    <span class="comment">// This commit has passive effects. Stash a reference to them. But don&#x27;t</span></span><br><span class="line">    <span class="comment">// schedule a callback until after flushing layout work.</span></span><br><span class="line">    rootDoesHavePassiveEffects = <span class="literal">false</span>;</span><br><span class="line">    rootWithPendingPassiveEffects = root;</span><br><span class="line">    pendingPassiveEffectsLanes = lanes;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read this again, since an effect might have updated it</span></span><br><span class="line">  remainingLanes = root.<span class="property">pendingLanes</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there&#x27;s remaining work on this root</span></span><br><span class="line">  <span class="keyword">if</span> (remainingLanes === <span class="title class_">NoLanes</span>) &#123;</span><br><span class="line">    <span class="comment">// If there&#x27;s no remaining work, we can clear the set of already failed</span></span><br><span class="line">    <span class="comment">// error boundaries.</span></span><br><span class="line">    legacyErrorBoundariesThatAlreadyFailed = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">includesSomeLane</span>(remainingLanes, (<span class="title class_">SyncLane</span>: <span class="title class_">Lane</span>))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdatePhase) &#123;</span><br><span class="line">      <span class="title function_">markNestedUpdateScheduled</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Count the number of times the root synchronously re-renders without</span></span><br><span class="line">    <span class="comment">// finishing. If there are too many, it indicates an infinite update loop.</span></span><br><span class="line">    <span class="keyword">if</span> (root === rootWithNestedUpdates) &#123;</span><br><span class="line">      nestedUpdateCount++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">      rootWithNestedUpdates = root;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Always call this before exiting `commitRoot`, to ensure that any</span></span><br><span class="line">  <span class="comment">// additional work on this root is scheduled.</span></span><br><span class="line">  <span class="title function_">ensureRootIsScheduled</span>(root, <span class="title function_">now</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasUncaughtError) &#123;</span><br><span class="line">    hasUncaughtError = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> error = firstUncaughtError;</span><br><span class="line">    firstUncaughtError = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((executionContext &amp; <span class="title class_">LegacyUnbatchedContext</span>) !== <span class="title class_">NoContext</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">      <span class="title function_">markCommitStopped</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is a legacy edge case. We just committed the initial mount of</span></span><br><span class="line">    <span class="comment">// a ReactDOM.render-ed root inside of batchedUpdates. The commit fired</span></span><br><span class="line">    <span class="comment">// synchronously, but layout updates should be deferred until the end</span></span><br><span class="line">    <span class="comment">// of the batch.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the passive effects are the result of a discrete render, flush them</span></span><br><span class="line">  <span class="comment">// synchronously at the end of the current task so that the result is</span></span><br><span class="line">  <span class="comment">// immediately observable. Otherwise, we assume that they are not</span></span><br><span class="line">  <span class="comment">// order-dependent and do not need to be observed by external systems, so we</span></span><br><span class="line">  <span class="comment">// can wait until after paint.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> We can optimize this by not scheduling the callback earlier. Since we</span></span><br><span class="line">  <span class="comment">// currently schedule the callback in multiple places, will wait until those</span></span><br><span class="line">  <span class="comment">// are consolidated.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="title function_">includesSomeLane</span>(pendingPassiveEffectsLanes, <span class="title class_">SyncLane</span>) &amp;&amp;</span><br><span class="line">    root.<span class="property">tag</span> !== <span class="title class_">LegacyRoot</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">flushPassiveEffects</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If layout work was scheduled, flush it now.</span></span><br><span class="line">  <span class="title function_">flushSyncCallbacks</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    <span class="title function_">markCommitStopped</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="flushPassiveEffects"><a href="#flushPassiveEffects" class="headerlink" title="flushPassiveEffects"></a><code>flushPassiveEffects</code></h5><p>调用 <code>flushPassiveEffectsImpl</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">flushPassiveEffectsImpl</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (rootWithPendingPassiveEffects === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = rootWithPendingPassiveEffects;</span><br><span class="line">  <span class="keyword">const</span> lanes = pendingPassiveEffectsLanes;</span><br><span class="line">  rootWithPendingPassiveEffects = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This is sometimes out of sync with rootWithPendingPassiveEffects.</span></span><br><span class="line">  <span class="comment">// Figure out why and fix it. It&#x27;s not causing any known issues (probably</span></span><br><span class="line">  <span class="comment">// because it&#x27;s only used for profiling), but it&#x27;s a refactor hazard.</span></span><br><span class="line">  pendingPassiveEffectsLanes = <span class="title class_">NoLanes</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">  executionContext |= <span class="title class_">CommitContext</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">commitPassiveUnmountEffects</span>(root.<span class="property">current</span>);</span><br><span class="line">  <span class="title function_">commitPassiveMountEffects</span>(root, root.<span class="property">current</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Move to commitPassiveMountEffects</span></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) &#123;</span><br><span class="line">    <span class="keyword">const</span> profilerEffects = pendingPassiveProfilerEffects;</span><br><span class="line">    pendingPassiveProfilerEffects = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; profilerEffects.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> fiber = ((profilerEffects[i]: <span class="built_in">any</span>): <span class="title class_">Fiber</span>);</span><br><span class="line">      <span class="title function_">commitPassiveEffectDurations</span>(root, fiber);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  executionContext = prevExecutionContext;</span><br><span class="line">  <span class="title function_">flushSyncCallbacks</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If additional passive effects were scheduled, increment a counter. If this</span></span><br><span class="line">  <span class="comment">// exceeds the limit, we&#x27;ll fire a warning.</span></span><br><span class="line">  nestedPassiveUpdateCount =</span><br><span class="line">    rootWithPendingPassiveEffects === <span class="literal">null</span> ? <span class="number">0</span> : nestedPassiveUpdateCount + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = root.<span class="property">current</span>.<span class="property">stateNode</span>;</span><br><span class="line">    stateNode.<span class="property">effectDuration</span> = <span class="number">0</span>;</span><br><span class="line">    stateNode.<span class="property">passiveEffectDuration</span> = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="commitPassiveUnmountEffects"><a href="#commitPassiveUnmountEffects" class="headerlink" title="commitPassiveUnmountEffects"></a><code>commitPassiveUnmountEffects</code></h5><p>执行生命周期钩子，当进入节点时立即执行生命周期函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<p>调用 <code>commitPassiveUnmountEffects_begin</code> 开启操作，<code>commitPassiveUnmountEffects_complete</code> 完成操作</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect 全局变量</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountEffects_begin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// curr -&gt; child -&gt; child</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> child = fiber.<span class="property">child</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((nextEffect.<span class="property">flags</span> &amp; <span class="title class_">ChildDeletion</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> deletions = fiber.<span class="property">deletions</span></span><br><span class="line">      <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.<span class="property">length</span>; i++) &#123;</span><br><span class="line">          <span class="keyword">const</span> fiberToDelete = deletions[i]</span><br><span class="line">          nextEffect = fiberToDelete</span><br><span class="line">          <span class="title function_">commitPassiveUnmountEffectsInsideOfDeletedTree_begin</span>(</span><br><span class="line">            fiberToDelete,</span><br><span class="line">            fiber</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="comment">// A fiber was deleted from this parent fiber, but it&#x27;s still part of</span></span><br><span class="line">          <span class="comment">// the previous (alternate) parent fiber&#x27;s list of children. Because</span></span><br><span class="line">          <span class="comment">// children are a linked list, an earlier sibling that&#x27;s still alive</span></span><br><span class="line">          <span class="comment">// will be connected to the deleted fiber via its `alternate`:</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          <span class="comment">//   live fiber</span></span><br><span class="line">          <span class="comment">//   --alternate--&gt; previous live fiber</span></span><br><span class="line">          <span class="comment">//   --sibling--&gt; deleted fiber</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          <span class="comment">// We can&#x27;t disconnect `alternate` on nodes that haven&#x27;t been deleted</span></span><br><span class="line">          <span class="comment">// yet, but we can disconnect the `sibling` and `child` pointers.</span></span><br><span class="line">          <span class="keyword">const</span> previousFiber = fiber.<span class="property">alternate</span></span><br><span class="line">          <span class="keyword">if</span> (previousFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> detachedChild = previousFiber.<span class="property">child</span></span><br><span class="line">            <span class="keyword">if</span> (detachedChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">              previousFiber.<span class="property">child</span> = <span class="literal">null</span></span><br><span class="line">              <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> detachedSibling = detachedChild.<span class="property">sibling</span></span><br><span class="line">                detachedChild.<span class="property">sibling</span> = <span class="literal">null</span></span><br><span class="line">                detachedChild = detachedSibling</span><br><span class="line">              &#125; <span class="keyword">while</span> (detachedChild !== <span class="literal">null</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nextEffect = fiber</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fiber.<span class="property">subtreeFlags</span> &amp; <span class="title class_">PassiveMask</span>) !== <span class="title class_">NoFlags</span> &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(child, fiber) <span class="comment">// 确保父节点指向 fiber</span></span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">commitPassiveUnmountEffects_complete</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountEffects_complete</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 若存在兄弟节点则遍历下一个兄弟节点，否则返回父节点</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">if</span> ((fiber.<span class="property">flags</span> &amp; <span class="title class_">Passive</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">      <span class="title function_">commitPassiveUnmountOnFiber</span>(fiber)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.<span class="property">sibling</span></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(sibling, fiber.<span class="property">return</span>)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect = fiber.<span class="property">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountOnFiber</span>(<span class="params"><span class="attr">finishedWork</span>: <span class="title class_">Fiber</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">        <span class="title function_">commitHookEffectListUnmount</span>(</span><br><span class="line">          <span class="title class_">HookPassive</span> | <span class="title class_">HookHasEffect</span>,</span><br><span class="line">          finishedWork,</span><br><span class="line">          finishedWork.<span class="property">return</span>,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountEffectsInsideOfDeletedTree_begin</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">deletedSubtreeRoot</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">nearestMountedAncestor</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// p-&gt; child -&gt; child</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="comment">// Deletion effects fire in parent -&gt; child order</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Check if fiber has a PassiveStatic flag</span></span><br><span class="line">    <span class="title function_">commitPassiveUnmountInsideDeletedTreeOnFiber</span>(fiber, nearestMountedAncestor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.<span class="property">child</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Only traverse subtree if it has a PassiveStatic flag. (But, if we</span></span><br><span class="line">    <span class="comment">// do this, still need to handle `deletedTreeCleanUpLevel` correctly.)</span></span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">commitPassiveUnmountEffectsInsideOfDeletedTree_complete</span>(</span><br><span class="line">        deletedSubtreeRoot</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountInsideDeletedTreeOnFiber</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">current</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">nearestMountedAncestor</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (current.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">      <span class="title function_">commitHookEffectListUnmount</span>(<span class="title class_">HookPassive</span>, current, nearestMountedAncestor)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁组件，要销毁的组件存在 updateQueue 中</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitHookEffectListUnmount</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">flags</span>: <span class="title class_">HookFlags</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">finishedWork</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">nearestMountedAncestor</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">updateQueue</span>: <span class="title class_">FunctionComponentUpdateQueue</span> | <span class="literal">null</span> = (finishedWork.<span class="property">updateQueue</span>: <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">const</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.<span class="property">lastEffect</span> : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstEffect = lastEffect.<span class="property">next</span>;</span><br><span class="line">    <span class="keyword">let</span> effect = firstEffect;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((effect.<span class="property">tag</span> &amp; flags) === flags) &#123;</span><br><span class="line">        <span class="comment">// Unmount</span></span><br><span class="line">        <span class="keyword">const</span> destroy = effect.<span class="property">destroy</span>;</span><br><span class="line">        effect.<span class="property">destroy</span> = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          <span class="title function_">safelyCallDestroy</span>(finishedWork, nearestMountedAncestor, destroy); <span class="comment">// 调用 destroy 销毁组件</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      effect = effect.<span class="property">next</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountEffectsInsideOfDeletedTree_complete</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">deletedSubtreeRoot</span>: <span class="title class_">Fiber</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.<span class="property">sibling</span></span><br><span class="line">    <span class="keyword">const</span> returnFiber = fiber.<span class="property">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="comment">// Recursively traverse the entire deleted tree and clean up fiber fields.</span></span><br><span class="line">      <span class="comment">// This is more aggressive than ideal, and the long term goal is to only</span></span><br><span class="line">      <span class="comment">// have to detach the deleted tree at the root.</span></span><br><span class="line">      <span class="title function_">detachFiberAfterEffects</span>(fiber)</span><br><span class="line">      <span class="keyword">if</span> (fiber === deletedSubtreeRoot) &#123;</span><br><span class="line">        nextEffect = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This is the default branch (level 0). We do not recursively clear all</span></span><br><span class="line">      <span class="comment">// the fiber fields. Only the root of the deleted subtree.</span></span><br><span class="line">      <span class="keyword">if</span> (fiber === deletedSubtreeRoot) &#123;</span><br><span class="line">        <span class="title function_">detachFiberAfterEffects</span>(fiber)</span><br><span class="line">        nextEffect = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(sibling, returnFiber)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = returnFiber</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">detachFiberAfterEffects</span>(<span class="params"><span class="attr">fiber</span>: <span class="title class_">Fiber</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> alternate = fiber.<span class="property">alternate</span></span><br><span class="line">  <span class="keyword">if</span> (alternate !== <span class="literal">null</span>) &#123;</span><br><span class="line">    fiber.<span class="property">alternate</span> = <span class="literal">null</span></span><br><span class="line">    <span class="title function_">detachFiberAfterEffects</span>(alternate)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: Defensively using negation instead of &lt; in case</span></span><br><span class="line">  <span class="comment">// `deletedTreeCleanUpLevel` is undefined.</span></span><br><span class="line">  <span class="keyword">if</span> (!(deletedTreeCleanUpLevel &gt;= <span class="number">2</span>)) &#123;</span><br><span class="line">    <span class="comment">// This is the default branch (level 0).</span></span><br><span class="line">    fiber.<span class="property">child</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">deletions</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">dependencies</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">memoizedProps</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">memoizedState</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">pendingProps</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">sibling</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">stateNode</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">updateQueue</span> = <span class="literal">null</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Clear cyclical Fiber fields. This level alone is designed to roughly</span></span><br><span class="line">    <span class="comment">// approximate the planned Fiber refactor. In that world, `setState` will be</span></span><br><span class="line">    <span class="comment">// bound to a special &quot;instance&quot; object instead of a Fiber. The Instance</span></span><br><span class="line">    <span class="comment">// object will not have any of these fields. It will only be connected to</span></span><br><span class="line">    <span class="comment">// the fiber tree via a single link at the root. So if this level alone is</span></span><br><span class="line">    <span class="comment">// sufficient to fix memory issues, that bodes well for our plans.</span></span><br><span class="line">    fiber.<span class="property">child</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">deletions</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">sibling</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The `stateNode` is cyclical because on host nodes it points to the host</span></span><br><span class="line">    <span class="comment">// tree, which has its own pointers to children, parents, and siblings.</span></span><br><span class="line">    <span class="comment">// The other host nodes also point back to fibers, so we should detach that</span></span><br><span class="line">    <span class="comment">// one, too.</span></span><br><span class="line">    <span class="keyword">if</span> (fiber.<span class="property">tag</span> === <span class="title class_">HostComponent</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">hostInstance</span>: <span class="title class_">Instance</span> = fiber.<span class="property">stateNode</span></span><br><span class="line">      <span class="keyword">if</span> (hostInstance !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title function_">detachDeletedInstance</span>(hostInstance) <span class="comment">// 删除 react 相关属性，包括事件、容器等</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fiber.<span class="property">stateNode</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="comment">// Theoretically, nothing in here should be necessary, because we already</span></span><br><span class="line">      <span class="comment">// disconnected the fiber from the tree. So even if something leaks this</span></span><br><span class="line">      <span class="comment">// particular fiber, it won&#x27;t leak anything else</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// The purpose of this branch is to be super aggressive so we can measure</span></span><br><span class="line">      <span class="comment">// if there&#x27;s any difference in memory impact. If there is, that could</span></span><br><span class="line">      <span class="comment">// indicate a React leak we don&#x27;t know about.</span></span><br><span class="line">      fiber.<span class="property">return</span> = <span class="literal">null</span></span><br><span class="line">      fiber.<span class="property">dependencies</span> = <span class="literal">null</span></span><br><span class="line">      fiber.<span class="property">memoizedProps</span> = <span class="literal">null</span></span><br><span class="line">      fiber.<span class="property">memoizedState</span> = <span class="literal">null</span></span><br><span class="line">      fiber.<span class="property">pendingProps</span> = <span class="literal">null</span></span><br><span class="line">      fiber.<span class="property">stateNode</span> = <span class="literal">null</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Move to `commitPassiveUnmountInsideDeletedTreeOnFiber` instead.</span></span><br><span class="line">      fiber.<span class="property">updateQueue</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="commitBeforeMutationEffects"><a href="#commitBeforeMutationEffects" class="headerlink" title="commitBeforeMutationEffects"></a><code>commitBeforeMutationEffects</code></h5><p>执行生命周期钩子，当进入节点时立即执行生命周期函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle 全局变量</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">root</span>: <span class="title class_">FiberRoot</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">firstChild</span>: <span class="title class_">Fiber</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  focusedInstanceHandle = <span class="title function_">prepareForCommit</span>(root.<span class="property">containerInfo</span>) <span class="comment">// 查找活跃的的节点</span></span><br><span class="line"></span><br><span class="line">  nextEffect = firstChild</span><br><span class="line">  <span class="title function_">commitBeforeMutationEffects_begin</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We no longer need to track the active instance fiber</span></span><br><span class="line">  <span class="keyword">const</span> shouldFire = shouldFireAfterActiveInstanceBlur</span><br><span class="line">  shouldFireAfterActiveInstanceBlur = <span class="literal">false</span></span><br><span class="line">  focusedInstanceHandle = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> shouldFire</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects_begin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should wrap this in flags check, too, as optimization</span></span><br><span class="line">    <span class="keyword">const</span> deletions = fiber.<span class="property">deletions</span></span><br><span class="line">    <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> deletion = deletions[i]</span><br><span class="line">        <span class="title function_">commitBeforeMutationEffectsDeletion</span>(deletion)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.<span class="property">child</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (fiber.<span class="property">subtreeFlags</span> &amp; <span class="title class_">BeforeMutationMask</span>) !== <span class="title class_">NoFlags</span> &amp;&amp;</span><br><span class="line">      child !== <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">commitBeforeMutationEffects_complete</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects_complete</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 先兄弟节点再父节点</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="title function_">commitBeforeMutationEffectsOnFiber</span>(fiber)</span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.<span class="property">sibling</span></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(sibling, fiber.<span class="property">return</span>)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.<span class="property">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffectsOnFiber</span>(<span class="params"><span class="attr">finishedWork</span>: <span class="title class_">Fiber</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span></span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.<span class="property">flags</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!shouldFireAfterActiveInstanceBlur &amp;&amp; focusedInstanceHandle !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Check to see if the focused element was inside of a hidden (Suspense) subtree.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Move this out of the hot path using a dedicated effect tag.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      finishedWork.<span class="property">tag</span> === <span class="title class_">SuspenseComponent</span> &amp;&amp;</span><br><span class="line">      <span class="title function_">isSuspenseBoundaryBeingHidden</span>(current, finishedWork) &amp;&amp;</span><br><span class="line">      <span class="title function_">doesFiberContain</span>(finishedWork, focusedInstanceHandle)</span><br><span class="line">    ) &#123;</span><br><span class="line">      shouldFireAfterActiveInstanceBlur = <span class="literal">true</span></span><br><span class="line">      <span class="title function_">beforeActiveInstanceBlur</span>(finishedWork)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((flags &amp; <span class="title class_">Snapshot</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevProps = current.<span class="property">memoizedProps</span></span><br><span class="line">          <span class="keyword">const</span> prevState = current.<span class="property">memoizedState</span></span><br><span class="line">          <span class="keyword">const</span> instance = finishedWork.<span class="property">stateNode</span></span><br><span class="line">          <span class="keyword">const</span> snapshot = instance.<span class="title function_">getSnapshotBeforeUpdate</span>(</span><br><span class="line">            finishedWork.<span class="property">elementType</span> === finishedWork.<span class="property">type</span></span><br><span class="line">              ? prevProps</span><br><span class="line">              : <span class="title function_">resolveDefaultProps</span>(finishedWork.<span class="property">type</span>, prevProps),</span><br><span class="line">            prevState</span><br><span class="line">          )</span><br><span class="line">          instance.<span class="property">__reactInternalSnapshotBeforeUpdate</span> = snapshot</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostRoot</span>: &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsMutation) &#123;</span><br><span class="line">          <span class="keyword">const</span> root = finishedWork.<span class="property">stateNode</span></span><br><span class="line">          <span class="title function_">clearContainer</span>(root.<span class="property">containerInfo</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostText</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostPortal</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">IncompleteClassComponent</span>:</span><br><span class="line">        <span class="comment">// Nothing to do for these component types</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="attr">default</span>: &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffectsDeletion</span>(<span class="params"><span class="attr">deletion</span>: <span class="title class_">Fiber</span></span>) &#123;</span><br><span class="line">  <span class="comment">// TODO (effects) It would be nice to avoid calling doesFiberContain()</span></span><br><span class="line">  <span class="comment">// Maybe we can repurpose one of the subtreeFlags positions for this instead?</span></span><br><span class="line">  <span class="comment">// Use it to store which part of the tree the focused instance is in?</span></span><br><span class="line">  <span class="comment">// This assumes we can safely determine that instance during the &quot;render&quot; phase.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">doesFiberContain</span>(deletion, focusedInstanceHandle)) &#123;</span><br><span class="line">    shouldFireAfterActiveInstanceBlur = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">beforeActiveInstanceBlur</span>(deletion)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="commitMutationEffects"><a href="#commitMutationEffects" class="headerlink" title="commitMutationEffects"></a><code>commitMutationEffects</code></h5><p>构建 dom 节点，在离开节点时开始 dom 构建<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle,inProgressLanes,inProgressRoot 全局变量</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffects</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">root</span>: <span class="title class_">FiberRoot</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">firstChild</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">committedLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  inProgressLanes = committedLanes</span><br><span class="line">  inProgressRoot = root</span><br><span class="line">  nextEffect = firstChild</span><br><span class="line"></span><br><span class="line">  <span class="title function_">commitMutationEffects_begin</span>(root)</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span></span><br><span class="line">  inProgressRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffects_begin</span>(<span class="params"><span class="attr">root</span>: <span class="title class_">FiberRoot</span></span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should wrap this in flags check, too, as optimization</span></span><br><span class="line">    <span class="keyword">const</span> deletions = fiber.<span class="property">deletions</span></span><br><span class="line">    <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> childToDelete = deletions[i]</span><br><span class="line">        <span class="title function_">commitDeletion</span>(root, childToDelete, fiber)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.<span class="property">child</span></span><br><span class="line">    <span class="keyword">if</span> ((fiber.<span class="property">subtreeFlags</span> &amp; <span class="title class_">MutationMask</span>) !== <span class="title class_">NoFlags</span> &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">commitMutationEffects_complete</span>(root)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffects_complete</span>(<span class="params"><span class="attr">root</span>: <span class="title class_">FiberRoot</span></span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="title function_">commitMutationEffectsOnFiber</span>(fiber, root)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.<span class="property">sibling</span></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(sibling, fiber.<span class="property">return</span>)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.<span class="property">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffectsOnFiber</span>(<span class="params"><span class="attr">finishedWork</span>: <span class="title class_">Fiber</span>, <span class="attr">root</span>: <span class="title class_">FiberRoot</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.<span class="property">flags</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; <span class="title class_">ContentReset</span>) &#123;</span><br><span class="line">    <span class="title function_">commitResetTextContent</span>(finishedWork)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span></span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">commitDetachRef</span>(current)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> This is a temporary solution that allowed us to transition away</span></span><br><span class="line">      <span class="comment">// from React Flare on www.</span></span><br><span class="line">      <span class="keyword">if</span> (finishedWork.<span class="property">tag</span> === <span class="title class_">ScopeComponent</span>) &#123;</span><br><span class="line">        <span class="title function_">commitAttachRef</span>(finishedWork)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The following switch statement is only concerned about placement,</span></span><br><span class="line">  <span class="comment">// updates, and deletions. To avoid needing to add a case for every possible</span></span><br><span class="line">  <span class="comment">// bitmap value, we remove the secondary effects from the effect tag and</span></span><br><span class="line">  <span class="comment">// switch on that value.</span></span><br><span class="line">  <span class="keyword">const</span> primaryFlags = flags &amp; (<span class="title class_">Placement</span> | <span class="title class_">Update</span> | <span class="title class_">Hydrating</span>)</span><br><span class="line">  <span class="keyword">switch</span> (primaryFlags) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Placement</span>: &#123;</span><br><span class="line">      <span class="title function_">commitPlacement</span>(finishedWork)</span><br><span class="line">      <span class="comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is</span></span><br><span class="line">      <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> findDOMNode doesn&#x27;t rely on this any more but isMounted does</span></span><br><span class="line">      <span class="comment">// and isMounted is deprecated anyway so we should be able to kill this.</span></span><br><span class="line">      finishedWork.<span class="property">flags</span> &amp;= ~<span class="title class_">Placement</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">PlacementAndUpdate</span>: &#123;</span><br><span class="line">      <span class="comment">// Placement</span></span><br><span class="line">      <span class="title function_">commitPlacement</span>(finishedWork)</span><br><span class="line">      <span class="comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is</span></span><br><span class="line">      <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">      finishedWork.<span class="property">flags</span> &amp;= ~<span class="title class_">Placement</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span></span><br><span class="line">      <span class="title function_">commitWork</span>(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Hydrating</span>: &#123;</span><br><span class="line">      finishedWork.<span class="property">flags</span> &amp;= ~<span class="title class_">Hydrating</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HydratingAndUpdate</span>: &#123;</span><br><span class="line">      finishedWork.<span class="property">flags</span> &amp;= ~<span class="title class_">Hydrating</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span></span><br><span class="line">      <span class="title function_">commitWork</span>(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Update</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span></span><br><span class="line">      <span class="title function_">commitWork</span>(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitWork</span>(<span class="params"><span class="attr">current</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>, <span class="attr">finishedWork</span>: <span class="title class_">Fiber</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">MemoComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">        <span class="comment">// Layout effects are destroyed during the mutation phase so that all</span></span><br><span class="line">        <span class="comment">// destroy functions for all fibers are called before any create functions.</span></span><br><span class="line">        <span class="comment">// This prevents sibling component effects from interfering with each other,</span></span><br><span class="line">        <span class="comment">// e.g. a destroy function in one component should never override a ref set</span></span><br><span class="line">        <span class="comment">// by a create function in another component during the same commit.</span></span><br><span class="line"></span><br><span class="line">          <span class="title function_">commitHookEffectListUnmount</span>(</span><br><span class="line">            <span class="title class_">HookLayout</span> | <span class="title class_">HookHasEffect</span>,</span><br><span class="line">            finishedWork,</span><br><span class="line">            finishedWork.<span class="property">return</span>,</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">Profiler</span>: &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">SuspenseComponent</span>: &#123;</span><br><span class="line">        <span class="title function_">commitSuspenseComponent</span>(finishedWork);</span><br><span class="line">        <span class="title function_">attachSuspenseRetryListeners</span>(finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">SuspenseListComponent</span>: &#123;</span><br><span class="line">        <span class="title function_">attachSuspenseRetryListeners</span>(finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostRoot</span>: &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsHydration) &#123;</span><br><span class="line">          <span class="keyword">const</span> <span class="attr">root</span>: <span class="title class_">FiberRoot</span> = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">          <span class="keyword">if</span> (root.<span class="property">hydrate</span>) &#123;</span><br><span class="line">            <span class="comment">// We&#x27;ve just hydrated. No need to hydrate again.</span></span><br><span class="line">            root.<span class="property">hydrate</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="title function_">commitHydratedContainer</span>(root.<span class="property">containerInfo</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">OffscreenComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">LegacyHiddenComponent</span>: &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">commitContainer</span>(finishedWork);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">MemoComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">      <span class="comment">// Layout effects are destroyed during the mutation phase so that all</span></span><br><span class="line">      <span class="comment">// destroy functions for all fibers are called before any create functions.</span></span><br><span class="line">      <span class="comment">// This prevents sibling component effects from interfering with each other,</span></span><br><span class="line">      <span class="comment">// e.g. a destroy function in one component should never override a ref set</span></span><br><span class="line">      <span class="comment">// by a create function in another component during the same commit.</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_">commitHookEffectListUnmount</span>(</span><br><span class="line">          <span class="title class_">HookLayout</span> | <span class="title class_">HookHasEffect</span>,</span><br><span class="line">          finishedWork,</span><br><span class="line">          finishedWork.<span class="property">return</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">instance</span>: <span class="title class_">Instance</span> = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">      <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Commit the work prepared earlier.</span></span><br><span class="line">        <span class="keyword">const</span> newProps = finishedWork.<span class="property">memoizedProps</span>;</span><br><span class="line">        <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">        <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">        <span class="comment">// this case.</span></span><br><span class="line">        <span class="keyword">const</span> oldProps = current !== <span class="literal">null</span> ? current.<span class="property">memoizedProps</span> : newProps;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">type</span> = finishedWork.<span class="property">type</span>;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Type the updateQueue to be specific to host components.</span></span><br><span class="line">        <span class="keyword">const</span> <span class="attr">updatePayload</span>: <span class="literal">null</span> | <span class="title class_">UpdatePayload</span> = (finishedWork.<span class="property">updateQueue</span>: <span class="built_in">any</span>);</span><br><span class="line">        finishedWork.<span class="property">updateQueue</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (updatePayload !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="title function_">commitUpdate</span>(</span><br><span class="line">            instance,</span><br><span class="line">            updatePayload,</span><br><span class="line">            <span class="keyword">type</span>,</span><br><span class="line">            oldProps,</span><br><span class="line">            newProps,</span><br><span class="line">            finishedWork,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostText</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">textInstance</span>: <span class="title class_">TextInstance</span> = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">newText</span>: <span class="built_in">string</span> = finishedWork.<span class="property">memoizedProps</span>;</span><br><span class="line">      <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">      <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">      <span class="comment">// this case.</span></span><br><span class="line">      <span class="keyword">const</span> <span class="attr">oldText</span>: <span class="built_in">string</span> =</span><br><span class="line">        current !== <span class="literal">null</span> ? current.<span class="property">memoizedProps</span> : newText;</span><br><span class="line">      <span class="title function_">commitTextUpdate</span>(textInstance, oldText, newText);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostRoot</span>: &#123;</span><br><span class="line">      <span class="keyword">if</span> (supportsHydration) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">root</span>: <span class="title class_">FiberRoot</span> = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">        <span class="keyword">if</span> (root.<span class="property">hydrate</span>) &#123;</span><br><span class="line">          <span class="comment">// We&#x27;ve just hydrated. No need to hydrate again.</span></span><br><span class="line">          root.<span class="property">hydrate</span> = <span class="literal">false</span>;</span><br><span class="line">          <span class="title function_">commitHydratedContainer</span>(root.<span class="property">containerInfo</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Profiler</span>: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SuspenseComponent</span>: &#123;</span><br><span class="line">      <span class="title function_">commitSuspenseComponent</span>(finishedWork);</span><br><span class="line">      <span class="title function_">attachSuspenseRetryListeners</span>(finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SuspenseListComponent</span>: &#123;</span><br><span class="line">      <span class="title function_">attachSuspenseRetryListeners</span>(finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">IncompleteClassComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ScopeComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">        <span class="keyword">const</span> scopeInstance = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">        <span class="title function_">prepareScopeUpdate</span>(scopeInstance, finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">OffscreenComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">LegacyHiddenComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">newState</span>: <span class="title class_">OffscreenState</span> | <span class="literal">null</span> = finishedWork.<span class="property">memoizedState</span>;</span><br><span class="line">      <span class="keyword">const</span> isHidden = newState !== <span class="literal">null</span>;</span><br><span class="line">      <span class="title function_">hideOrUnhideAllChildren</span>(finishedWork, isHidden);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPlacement</span>(<span class="params"><span class="attr">finishedWork</span>: <span class="title class_">Fiber</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Recursively insert all host nodes into the parent.</span></span><br><span class="line">  <span class="keyword">const</span> parentFiber = <span class="title function_">getHostParentFiber</span>(finishedWork);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: these two variables *must* always be updated together.</span></span><br><span class="line">  <span class="keyword">let</span> parent;</span><br><span class="line">  <span class="keyword">let</span> isContainer;</span><br><span class="line">  <span class="keyword">const</span> parentStateNode = parentFiber.<span class="property">stateNode</span>;</span><br><span class="line">  <span class="keyword">switch</span> (parentFiber.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">      parent = parentStateNode;</span><br><span class="line">      isContainer = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostRoot</span>:</span><br><span class="line">      parent = parentStateNode.<span class="property">containerInfo</span>;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostPortal</span>:</span><br><span class="line">      parent = parentStateNode.<span class="property">containerInfo</span>;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// eslint-disable-next-line-no-fallthrough</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (parentFiber.<span class="property">flags</span> &amp; <span class="title class_">ContentReset</span>) &#123;</span><br><span class="line">    <span class="comment">// Reset the text content of the parent before doing any insertions</span></span><br><span class="line">    <span class="title function_">resetTextContent</span>(parent);</span><br><span class="line">    <span class="comment">// Clear ContentReset from the effect tag</span></span><br><span class="line">    parentFiber.<span class="property">flags</span> &amp;= ~<span class="title class_">ContentReset</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> before = <span class="title function_">getHostSibling</span>(finishedWork);</span><br><span class="line">  <span class="comment">// 插入 dom 元素</span></span><br><span class="line">  <span class="keyword">if</span> (isContainer) &#123;</span><br><span class="line">    <span class="title function_">insertOrAppendPlacementNodeIntoContainer</span>(finishedWork, before, parent);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">insertOrAppendPlacementNode</span>(finishedWork, before, parent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isHostParent</span>(<span class="params"><span class="attr">fiber</span>: <span class="title class_">Fiber</span></span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    fiber.<span class="property">tag</span> === <span class="title class_">HostComponent</span> ||</span><br><span class="line">    fiber.<span class="property">tag</span> === <span class="title class_">HostRoot</span> ||</span><br><span class="line">    fiber.<span class="property">tag</span> === <span class="title class_">HostPortal</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getHostSibling</span>(<span class="params"><span class="attr">fiber</span>: <span class="title class_">Fiber</span></span>): ?<span class="title class_">Instance</span> &#123;</span><br><span class="line">  <span class="comment">// We&#x27;re going to search forward into the tree until we find a sibling host</span></span><br><span class="line">  <span class="comment">// node. Unfortunately, if multiple insertions are done in a row we have to</span></span><br><span class="line">  <span class="comment">// search past them. This leads to exponential search for the next sibling.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Find a more efficient way to do this.</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">node</span>: <span class="title class_">Fiber</span> = fiber;</span><br><span class="line">  <span class="attr">siblings</span>: <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// If we didn&#x27;t find anything, let&#x27;s try the next sibling.</span></span><br><span class="line">    <span class="keyword">while</span> (node.<span class="property">sibling</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.<span class="property">return</span> === <span class="literal">null</span> || <span class="title function_">isHostParent</span>(node.<span class="property">return</span>)) &#123;</span><br><span class="line">        <span class="comment">// If we pop out of the root or hit the parent the fiber we are the</span></span><br><span class="line">        <span class="comment">// last sibling.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.<span class="property">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    node.<span class="property">sibling</span>.<span class="property">return</span> = node.<span class="property">return</span>;</span><br><span class="line">    node = node.<span class="property">sibling</span>;</span><br><span class="line">    <span class="keyword">while</span> (</span><br><span class="line">      node.<span class="property">tag</span> !== <span class="title class_">HostComponent</span> &amp;&amp;</span><br><span class="line">      node.<span class="property">tag</span> !== <span class="title class_">HostText</span> &amp;&amp;</span><br><span class="line">      node.<span class="property">tag</span> !== <span class="title class_">DehydratedFragment</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// If it is not host node and, we might have a host node inside it.</span></span><br><span class="line">      <span class="comment">// Try to search down until we find one.</span></span><br><span class="line">      <span class="keyword">if</span> (node.<span class="property">flags</span> &amp; <span class="title class_">Placement</span>) &#123;</span><br><span class="line">        <span class="comment">// If we don&#x27;t have a child, try the siblings instead.</span></span><br><span class="line">        <span class="keyword">continue</span> siblings;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// If we don&#x27;t have a child, try the siblings instead.</span></span><br><span class="line">      <span class="comment">// We also skip portals because they are not part of this host tree.</span></span><br><span class="line">      <span class="keyword">if</span> (node.<span class="property">child</span> === <span class="literal">null</span> || node.<span class="property">tag</span> === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span> siblings;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node.<span class="property">child</span>.<span class="property">return</span> = node;</span><br><span class="line">        node = node.<span class="property">child</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check if this host node is stable or about to be placed.</span></span><br><span class="line">    <span class="keyword">if</span> (!(node.<span class="property">flags</span> &amp; <span class="title class_">Placement</span>)) &#123;</span><br><span class="line">      <span class="comment">// Found it!</span></span><br><span class="line">      <span class="keyword">return</span> node.<span class="property">stateNode</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">insertOrAppendPlacementNodeIntoContainer</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">node</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">before</span>: ?<span class="title class_">Instance</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">parent</span>: <span class="title class_">Container</span>,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;tag&#125; = node;</span><br><span class="line">  <span class="keyword">const</span> isHost = tag === <span class="title class_">HostComponent</span> || tag === <span class="title class_">HostText</span>;</span><br><span class="line">  <span class="keyword">if</span> (isHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = node.<span class="property">stateNode</span>;</span><br><span class="line">    <span class="keyword">if</span> (before) &#123;</span><br><span class="line">      <span class="title function_">insertInContainerBefore</span>(parent, stateNode, before);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">appendChildToContainer</span>(parent, stateNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">    <span class="comment">// If the insertion itself is a portal, then we don&#x27;t want to traverse</span></span><br><span class="line">    <span class="comment">// down its children. Instead, we&#x27;ll get insertions from each child in</span></span><br><span class="line">    <span class="comment">// the portal directly.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> child = node.<span class="property">child</span>;</span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">insertOrAppendPlacementNodeIntoContainer</span>(child, before, parent);</span><br><span class="line">      <span class="keyword">let</span> sibling = child.<span class="property">sibling</span>;</span><br><span class="line">      <span class="keyword">while</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title function_">insertOrAppendPlacementNodeIntoContainer</span>(sibling, before, parent);</span><br><span class="line">        sibling = sibling.<span class="property">sibling</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">insertOrAppendPlacementNode</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">node</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">before</span>: ?<span class="title class_">Instance</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">parent</span>: <span class="title class_">Instance</span>,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;tag&#125; = node;</span><br><span class="line">  <span class="keyword">const</span> isHost = tag === <span class="title class_">HostComponent</span> || tag === <span class="title class_">HostText</span>;</span><br><span class="line">  <span class="keyword">if</span> (isHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = node.<span class="property">stateNode</span>;</span><br><span class="line">    <span class="keyword">if</span> (before) &#123;</span><br><span class="line">      <span class="title function_">insertBefore</span>(parent, stateNode, before);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">appendChild</span>(parent, stateNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">    <span class="comment">// If the insertion itself is a portal, then we don&#x27;t want to traverse</span></span><br><span class="line">    <span class="comment">// down its children. Instead, we&#x27;ll get insertions from each child in</span></span><br><span class="line">    <span class="comment">// the portal directly.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> child = node.<span class="property">child</span>;</span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">insertOrAppendPlacementNode</span>(child, before, parent);</span><br><span class="line">      <span class="keyword">let</span> sibling = child.<span class="property">sibling</span>;</span><br><span class="line">      <span class="keyword">while</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title function_">insertOrAppendPlacementNode</span>(sibling, before, parent);</span><br><span class="line">        sibling = sibling.<span class="property">sibling</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="commitLayoutEffects"><a href="#commitLayoutEffects" class="headerlink" title="commitLayoutEffects"></a><code>commitLayoutEffects</code></h5><p>执行生命周期钩子，在离开当前节点时调用钩子函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle,inProgressLanes,inProgressRoot 全局变量</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutEffects</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">finishedWork</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">root</span>: <span class="title class_">FiberRoot</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">committedLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  inProgressLanes = committedLanes</span><br><span class="line">  inProgressRoot = root</span><br><span class="line">  nextEffect = finishedWork</span><br><span class="line"></span><br><span class="line">  <span class="title function_">commitLayoutEffects_begin</span>(finishedWork, root, committedLanes)</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span></span><br><span class="line">  inProgressRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutEffects_begin</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">subtreeRoot</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">root</span>: <span class="title class_">FiberRoot</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">committedLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Suspense layout effects semantics don&#x27;t change for legacy roots.</span></span><br><span class="line">  <span class="keyword">const</span> isModernRoot = (subtreeRoot.<span class="property">mode</span> &amp; <span class="title class_">ConcurrentMode</span>) !== <span class="title class_">NoMode</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> firstChild = fiber.<span class="property">child</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics &amp;&amp; isModernRoot) &#123;</span><br><span class="line">      <span class="comment">// Keep track of the current Offscreen stack&#x27;s state.</span></span><br><span class="line">      <span class="keyword">if</span> (fiber.<span class="property">tag</span> === <span class="title class_">OffscreenComponent</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> current = fiber.<span class="property">alternate</span></span><br><span class="line">        <span class="keyword">const</span> wasHidden = current !== <span class="literal">null</span> &amp;&amp; current.<span class="property">memoizedState</span> !== <span class="literal">null</span></span><br><span class="line">        <span class="keyword">const</span> isHidden = fiber.<span class="property">memoizedState</span> !== <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> newOffscreenSubtreeIsHidden = isHidden || offscreenSubtreeIsHidden</span><br><span class="line">        <span class="keyword">const</span> newOffscreenSubtreeWasHidden =</span><br><span class="line">          wasHidden || offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          newOffscreenSubtreeIsHidden !== offscreenSubtreeIsHidden ||</span><br><span class="line">          newOffscreenSubtreeWasHidden !== offscreenSubtreeWasHidden</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevOffscreenSubtreeIsHidden = offscreenSubtreeIsHidden</span><br><span class="line">          <span class="keyword">const</span> prevOffscreenSubtreeWasHidden = offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Traverse the Offscreen subtree with the current Offscreen as the root.</span></span><br><span class="line">          offscreenSubtreeIsHidden = newOffscreenSubtreeIsHidden</span><br><span class="line">          offscreenSubtreeWasHidden = newOffscreenSubtreeWasHidden</span><br><span class="line">          <span class="title function_">commitLayoutEffects_begin</span>(</span><br><span class="line">            fiber, <span class="comment">// New root; bubble back up to here and stop.</span></span><br><span class="line">            root,</span><br><span class="line">            committedLanes</span><br><span class="line">          )</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Restore Offscreen state and resume in our-progress traversal.</span></span><br><span class="line">          nextEffect = fiber</span><br><span class="line">          offscreenSubtreeIsHidden = prevOffscreenSubtreeIsHidden</span><br><span class="line">          offscreenSubtreeWasHidden = prevOffscreenSubtreeWasHidden</span><br><span class="line">          <span class="title function_">commitLayoutMountEffects_complete</span>(subtreeRoot, root, committedLanes)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fiber.<span class="property">subtreeFlags</span> &amp; <span class="title class_">LayoutMask</span>) !== <span class="title class_">NoFlags</span> &amp;&amp; firstChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(firstChild, fiber)</span><br><span class="line">      nextEffect = firstChild</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics &amp;&amp; isModernRoot) &#123;</span><br><span class="line">        <span class="keyword">const</span> visibilityChanged =</span><br><span class="line">          !offscreenSubtreeIsHidden &amp;&amp; offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO (Offscreen) Also check: subtreeFlags &amp; LayoutStatic</span></span><br><span class="line">        <span class="keyword">if</span> (visibilityChanged &amp;&amp; firstChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// We&#x27;ve just shown or hidden a Offscreen tree that contains layout effects.</span></span><br><span class="line">          <span class="comment">// We only enter this code path for subtrees that are updated,</span></span><br><span class="line">          <span class="comment">// because newly mounted ones would pass the LayoutMask check above.</span></span><br><span class="line">          <span class="title function_">ensureCorrectReturnPointer</span>(firstChild, fiber)</span><br><span class="line">          nextEffect = firstChild</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="title function_">commitLayoutMountEffects_complete</span>(subtreeRoot, root, committedLanes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutMountEffects_complete</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">subtreeRoot</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">root</span>: <span class="title class_">FiberRoot</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">committedLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Suspense layout effects semantics don&#x27;t change for legacy roots.</span></span><br><span class="line">  <span class="keyword">const</span> isModernRoot = (subtreeRoot.<span class="property">mode</span> &amp; <span class="title class_">ConcurrentMode</span>) !== <span class="title class_">NoMode</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      enableSuspenseLayoutEffectSemantics &amp;&amp;</span><br><span class="line">      isModernRoot &amp;&amp;</span><br><span class="line">      offscreenSubtreeWasHidden &amp;&amp;</span><br><span class="line">      !offscreenSubtreeIsHidden</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// Inside of an Offscreen subtree that changed visibility during this commit.</span></span><br><span class="line">      <span class="comment">// If this subtree was hidden, layout effects will have already been destroyed (during mutation phase)</span></span><br><span class="line">      <span class="comment">// but if it was just shown, we need to (re)create the effects now.</span></span><br><span class="line">      <span class="comment">// TODO (Offscreen) Check: flags &amp; LayoutStatic</span></span><br><span class="line">      <span class="keyword">switch</span> (fiber.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">          <span class="title function_">safelyCallCommitHookLayoutEffectListMount</span>(fiber, fiber.<span class="property">return</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">          <span class="keyword">const</span> instance = fiber.<span class="property">stateNode</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.<span class="property">componentDidMount</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="title function_">safelyCallComponentDidMount</span>(fiber, fiber.<span class="property">return</span>, instance)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// TODO (Offscreen) Check flags &amp; RefStatic</span></span><br><span class="line">      <span class="keyword">switch</span> (fiber.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ClassComponent</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">          <span class="title function_">safelyAttachRef</span>(fiber, fiber.<span class="property">return</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((fiber.<span class="property">flags</span> &amp; <span class="title class_">LayoutMask</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = fiber.<span class="property">alternate</span></span><br><span class="line">      <span class="title function_">commitLayoutEffectOnFiber</span>(root, current, fiber, committedLanes)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fiber === subtreeRoot) &#123;</span><br><span class="line">      nextEffect = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.<span class="property">sibling</span></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(sibling, fiber.<span class="property">return</span>)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.<span class="property">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/14/react%E7%9A%84%E5%90%8C%E6%AD%A5%E6%9B%B4%E6%96%B0/" data-id="cm1ghkbn9003qzodz7jnc34zi" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/" rel="tag">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react中的事件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/12/react%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6/" class="article-date">
  <time datetime="2021-06-12T12:34:30.000Z" itemprop="datePublished">2021-06-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/12/react%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6/">react中的事件</a>
    </h1>
  


        <div style="color: #999; margin-top: 0.3rem" class="post-meta-item"> 共计
    2.5k 字，约需阅读
    9.09
    分钟
</div>
      </header>
    
    
   

    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/react/react-event.jpg" alt="react 中的事件"></p>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p><img src="/images/react/react-event-init.jpg" alt="react 事件初始化"></p>
<ol>
<li><p>在 <code>react-dom</code> 模块的 <code>src/client/ReactDOM</code> 中引入 <code>ReactDOMEventHandle</code> 文件，把该文件中的 <code>createEventHandle</code> 函数导出为 <code>unstable_createEventHandle</code> 以供第三方使用</p>
</li>
<li><p>在 <code>ReactDOMEventHandle</code> 文件中引入 <code>events/DOMPluginEventSystem</code> 文件，在模块中注册了顶级事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="title class_">SimpleEventPlugin</span>.<span class="title function_">registerEvents</span>()</span><br><span class="line"><span class="title class_">EnterLeaveEventPlugin</span>.<span class="title function_">registerEvents</span>()</span><br><span class="line"><span class="title class_">ChangeEventPlugin</span>.<span class="title function_">registerEvents</span>()</span><br><span class="line"><span class="title class_">SelectEventPlugin</span>.<span class="title function_">registerEvents</span>()</span><br><span class="line"><span class="title class_">BeforeInputEventPlugin</span>.<span class="title function_">registerEvents</span>()</span><br></pre></td></tr></table></figure></li>
<li><p>记录 <code>dom</code> 事件和 <code>react</code> 事件的映射关系</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMEventProperties.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> topLevelEventsToReactNames = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录 dom event 和 react event 的映射</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">registerSimpleEvent</span>(<span class="params">domEventName, reactName</span>) &#123;</span><br><span class="line">  topLevelEventsToReactNames.<span class="title function_">set</span>(domEventName, reactName)</span><br><span class="line">  <span class="title function_">registerTwoPhaseEvent</span>(reactName, [domEventName])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">registerSimpleEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; simpleEventPluginEvents.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> eventName = ((simpleEventPluginEvents[i]: any): string)</span><br><span class="line">    <span class="keyword">const</span> domEventName = ((eventName.<span class="title function_">toLowerCase</span>(): any): <span class="title class_">DOMEventName</span>)</span><br><span class="line">    <span class="keyword">const</span> capitalizedEvent = eventName[<span class="number">0</span>].<span class="title function_">toUpperCase</span>() + eventName.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="title function_">registerSimpleEvent</span>(domEventName, <span class="string">&#x27;on&#x27;</span> + capitalizedEvent)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Special cases where event names don&#x27;t match.</span></span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="variable constant_">ANIMATION_END</span>, <span class="string">&#x27;onAnimationEnd&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="variable constant_">ANIMATION_ITERATION</span>, <span class="string">&#x27;onAnimationIteration&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="variable constant_">ANIMATION_START</span>, <span class="string">&#x27;onAnimationStart&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="string">&#x27;dblclick&#x27;</span>, <span class="string">&#x27;onDoubleClick&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="string">&#x27;focusin&#x27;</span>, <span class="string">&#x27;onFocus&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="string">&#x27;focusout&#x27;</span>, <span class="string">&#x27;onBlur&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="variable constant_">TRANSITION_END</span>, <span class="string">&#x27;onTransitionEnd&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>events/EventRegistry</code> 模块中调用方法把注册的事件放入存储的 <code>Set</code> 和对象中，<code>allNativeEvents Set</code> 负责存储所有注册过的 <code>dom</code> 事件名称，<code>registrationNameDependencies</code> 以 <code>&#123;[reactEventName]: [nativeEventName] &#125;</code>负责存储注册的事件依赖，同时注册了冒泡事件和捕获事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/EventRegistry.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">allNativeEvents</span>: <span class="title class_">Set</span>&lt;<span class="title class_">DOMEventName</span>&gt; = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mapping from registration name to event name</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> registrationNameDependencies = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">registerTwoPhaseEvent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  registrationName: string,</span></span><br><span class="line"><span class="params">  dependencies: <span class="built_in">Array</span>&lt;DOMEventName&gt;</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="title function_">registerDirectEvent</span>(registrationName, dependencies)</span><br><span class="line">  <span class="title function_">registerDirectEvent</span>(registrationName + <span class="string">&#x27;Capture&#x27;</span>, dependencies)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">registerDirectEvent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  registrationName: string,</span></span><br><span class="line"><span class="params">  dependencies: <span class="built_in">Array</span>&lt;DOMEventName&gt;</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  registrationNameDependencies[registrationName] = dependencies</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dependencies.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    allNativeEvents.<span class="title function_">add</span>(dependencies[i])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>合成事件的初始化完毕</p>
</li>
</ol>
<h4 id="注册原生事件"><a href="#注册原生事件" class="headerlink" title="注册原生事件"></a>注册原生事件</h4><p><img src="/images/react/react-event-init.jpg" alt="react 注册原生事件"></p>
<ol>
<li><p>调用 <code>react-dom</code> 模块中的 <code>render</code> 时，若第一次挂载则递归依次调用 <code>legacyCreateRootFromDOMContainer</code>、<code>createLegacyRoot</code> 创建容器对象 <code>ReactDOMLegacyRoot</code> 的实例</p>
</li>
<li><p><code>ReactDOMLegacyRoot</code> 递归依次调用 <code>createRootImpl</code>、<code>createContainer</code> 创建了组件挂载的根元素，并表及为根元素</p>
</li>
<li><p>调用 <code>listenToAllSupportedEvents</code> 在根元素上挂载事件，若当前容器为注释元素，则取当前元素的父元素为事件挂载的节点</p>
</li>
<li><p>在 <code>listenToAllSupportedEvents</code> 中遍历初始化时注册的 <code>allNativeEvents</code> 事件列表注册事件，判断根元素是否为 <code>documet</code> 节点，不是则获取 <code>document</code> 节点，在 <code>document</code> 节点节点上注册 <code>selectionchange</code> 事件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">const</span> listeningMarker = <span class="string">&#x27;_reactListening&#x27;</span> +<span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">slice</span>(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">listenToAllSupportedEvents</span>(<span class="params"><span class="attr">rootContainerElement</span>: <span class="title class_">EventTarget</span></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="attr">rootContainerElement</span>: <span class="built_in">any</span>)[listeningMarker]) &#123;</span><br><span class="line">    rootContainerElement[listeningMarker] = <span class="literal">true</span></span><br><span class="line">    allNativeEvents.<span class="title function_">forEach</span>(<span class="function">(<span class="params">domEventName</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// We handle selectionchange separately because it</span></span><br><span class="line">      <span class="comment">// doesn&#x27;t bubble and needs to be on the document.</span></span><br><span class="line">      <span class="keyword">if</span> (domEventName !== <span class="string">&#x27;selectionchange&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!nonDelegatedEvents.<span class="title function_">has</span>(domEventName)) &#123;</span><br><span class="line">          <span class="title function_">listenToNativeEvent</span>(domEventName, <span class="literal">false</span>, rootContainerElement)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">listenToNativeEvent</span>(domEventName, <span class="literal">true</span>, rootContainerElement)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> ownerDocument =</span><br><span class="line">      rootContainerElement.<span class="property">nodeType</span> === <span class="variable constant_">DOCUMENT_NODE</span></span><br><span class="line">        ? rootContainerElement</span><br><span class="line">        : (rootContainerElement).<span class="property">ownerDocument</span></span><br><span class="line">    <span class="keyword">if</span> (ownerDocument !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// The selectionchange event also needs deduplication</span></span><br><span class="line">      <span class="comment">// but it is attached to the document.</span></span><br><span class="line">      <span class="keyword">if</span> (!(ownerDocument)[listeningMarker]) &#123;</span><br><span class="line">        ownerDocument[listeningMarker] = <span class="literal">true</span></span><br><span class="line">        <span class="title function_">listenToNativeEvent</span>(<span class="string">&#x27;selectionchange&#x27;</span>, <span class="literal">false</span>, ownerDocument)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>createEventListenerWrapperWithPriority</code> 函数先获取事件优先级，再根据优先级确定构造监听器的函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/ReactDOMEventListener.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createEventListenerWrapperWithPriority</span>(<span class="params"></span></span><br><span class="line"><span class="params">  targetContainer: EventTarget,</span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> eventPriority = <span class="title function_">getEventPriority</span>(domEventName)</span><br><span class="line">  <span class="keyword">let</span> listenerWrapper</span><br><span class="line">  <span class="keyword">switch</span> (eventPriority) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">DiscreteEventPriority</span>:</span><br><span class="line">      listenerWrapper = dispatchDiscreteEvent</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ContinuousEventPriority</span>:</span><br><span class="line">      listenerWrapper = dispatchContinuousEvent</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">DefaultEventPriority</span>:</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      listenerWrapper = dispatchEvent</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> listenerWrapper.<span class="title function_">bind</span>(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用 <code>createEventListenerWrapperWithPriority</code> 创建监听函数，根据 <code>passive</code> 属性的支持和 <code>capture</code> 情况分别调用不同的事件监听方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">listenToNativeEvent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  isCapturePhaseListener: boolean,</span></span><br><span class="line"><span class="params">  target: EventTarget</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> eventSystemFlags = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (isCapturePhaseListener) &#123;</span><br><span class="line">    eventSystemFlags |= <span class="variable constant_">IS_CAPTURE_PHASE</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">addTrappedEventListener</span>(</span><br><span class="line">    target,</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    isCapturePhaseListener</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addTrappedEventListener</span>(<span class="params"></span></span><br><span class="line"><span class="params">  targetContainer: EventTarget,</span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  isCapturePhaseListener: boolean,</span></span><br><span class="line"><span class="params">  isDeferredListenerForLegacyFBSupport?: boolean</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> listener = <span class="title function_">createEventListenerWrapperWithPriority</span>(</span><br><span class="line">    targetContainer,</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// If passive option is not supported, then the event will be</span></span><br><span class="line">  <span class="comment">// active and not passive.</span></span><br><span class="line">  <span class="keyword">let</span> isPassiveListener = <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">if</span> (passiveBrowserEventsSupported) &#123;</span><br><span class="line">    <span class="comment">// 是否支持 passive 属性， https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      domEventName === <span class="string">&#x27;touchstart&#x27;</span> ||</span><br><span class="line">      domEventName === <span class="string">&#x27;touchmove&#x27;</span> ||</span><br><span class="line">      domEventName === <span class="string">&#x27;wheel&#x27;</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      isPassiveListener = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  targetContainer =</span><br><span class="line">    enableLegacyFBSupport &amp;&amp; isDeferredListenerForLegacyFBSupport</span><br><span class="line">      ? (<span class="attr">targetContainer</span>: any).<span class="property">ownerDocument</span></span><br><span class="line">      : targetContainer</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> unsubscribeListener</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> There are too many combinations here. Consolidate them.</span></span><br><span class="line">  <span class="keyword">if</span> (isCapturePhaseListener) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isPassiveListener !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      unsubscribeListener = <span class="title function_">addEventCaptureListenerWithPassiveFlag</span>(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener,</span><br><span class="line">        isPassiveListener</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      unsubscribeListener = <span class="title function_">addEventCaptureListener</span>(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isPassiveListener !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      unsubscribeListener = <span class="title function_">addEventBubbleListenerWithPassiveFlag</span>(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener,</span><br><span class="line">        isPassiveListener</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      unsubscribeListener = <span class="title function_">addEventBubbleListener</span>(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="事件触发"><a href="#事件触发" class="headerlink" title="事件触发"></a>事件触发</h4><p><img src="/images/react/react-event-dispatch.jpg" alt="react 事件触发"></p>
<ol>
<li><p>有事件触发时，调用 <code>events/ReactDOMEventListener</code> 下的 <code>dispatchEvent</code> 触发事件</p>
</li>
<li><p>当事件不可重新触发时直接调用 <code>attemptToDispatchEvent</code> 进行事件的触发，否则事件放入队列等待调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/ReactDOMEventListener.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">dispatchEvent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  targetContainer: EventTarget,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> allowReplay = (eventSystemFlags &amp; <span class="variable constant_">IS_CAPTURE_PHASE</span>) === <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    allowReplay &amp;&amp;</span><br><span class="line">    <span class="title function_">hasQueuedDiscreteEvents</span>() &amp;&amp;</span><br><span class="line">    <span class="title function_">isReplayableDiscreteEvent</span>(domEventName)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">//更新队列中就把事件放入更新队列</span></span><br><span class="line">    <span class="title function_">queueDiscreteEvent</span>(</span><br><span class="line">      <span class="literal">null</span>, <span class="comment">// Flags that we&#x27;re not actually blocked on anything as far as we know.</span></span><br><span class="line">      domEventName,</span><br><span class="line">      eventSystemFlags,</span><br><span class="line">      targetContainer,</span><br><span class="line">      nativeEvent</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> blockedOn = <span class="title function_">attemptToDispatchEvent</span>(</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer,</span><br><span class="line">    nativeEvent</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (blockedOn === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 触发事件成功</span></span><br><span class="line">    <span class="keyword">if</span> (allowReplay) &#123;</span><br><span class="line">      <span class="title function_">clearIfContinuousEvent</span>(domEventName, nativeEvent)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 其它逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取触发事件的元素，然后获取最近的虚拟 <code>dom</code> 节点的实例（向上查找，注：<code>dom</code> 上存储了虚拟 <code>dom</code> 的引用，快速查找），通过虚拟 <code>dom</code> 节点获取最近挂载的 <code>fiber</code> 节点（向上查找）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/ReactDOMEventListener.js</span></span><br><span class="line"><span class="comment">// Attempt dispatching an event. Returns a SuspenseInstance or Container if it&#x27;s blocked.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">attemptToDispatchEvent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  targetContainer: EventTarget,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent</span></span><br><span class="line"><span class="params"></span>): <span class="literal">null</span> | <span class="title class_">Container</span> | <span class="title class_">SuspenseInstance</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> nativeEventTarget = <span class="title function_">getEventTarget</span>(nativeEvent)</span><br><span class="line">  <span class="keyword">let</span> targetInst = <span class="title function_">getClosestInstanceFromNode</span>(nativeEventTarget)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (targetInst !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> nearestMounted = <span class="title function_">getNearestMountedFiber</span>(targetInst)</span><br><span class="line">    <span class="keyword">if</span> (nearestMounted === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 树已经被销毁，触发对象置空</span></span><br><span class="line">      targetInst = <span class="literal">null</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 其它逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">dispatchEventForPluginEventSystem</span>(</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    targetInst,</span><br><span class="line">    targetContainer</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// We&#x27;re not blocked on anything.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>attemptToDispatchEvent</code> 调用 <code>dispatchEventForPluginEventSystem</code>，找出触发事件元素的根节点实例，然后通过 <code>dispatchEventsForPlugins</code> 批量更新</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">dispatchEventForPluginEventSystem</span>(<span class="params"></span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent,</span></span><br><span class="line"><span class="params">  targetInst: <span class="literal">null</span> | Fiber,</span></span><br><span class="line"><span class="params">  targetContainer: EventTarget</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> ancestorInst = targetInst</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (eventSystemFlags &amp; <span class="variable constant_">IS_EVENT_HANDLE_NON_MANAGED_NODE</span>) === <span class="number">0</span> &amp;&amp;</span><br><span class="line">    (eventSystemFlags &amp; <span class="variable constant_">IS_NON_DELEGATED</span>) === <span class="number">0</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> targetContainerNode = ((<span class="attr">targetContainer</span>: any): <span class="title class_">Node</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetInst !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// The below logic attempts to work out if we need to change</span></span><br><span class="line">      <span class="comment">// the target fiber to a different ancestor. We had similar logic</span></span><br><span class="line">      <span class="comment">// in the legacy event system, except the big difference between</span></span><br><span class="line">      <span class="comment">// systems is that the modern event system now has an event listener</span></span><br><span class="line">      <span class="comment">// attached to each React Root and React Portal Root. Together,</span></span><br><span class="line">      <span class="comment">// the DOM nodes representing these roots are the &quot;rootContainer&quot;.</span></span><br><span class="line">      <span class="comment">// To figure out which ancestor instance we should use, we traverse</span></span><br><span class="line">      <span class="comment">// up the fiber tree from the target instance and attempt to find</span></span><br><span class="line">      <span class="comment">// root boundaries that match that of our current &quot;rootContainer&quot;.</span></span><br><span class="line">      <span class="comment">// If we find that &quot;rootContainer&quot;, we find the parent fiber</span></span><br><span class="line">      <span class="comment">// sub-tree for that root and make that our ancestor instance.</span></span><br><span class="line">      <span class="keyword">let</span> node = targetInst</span><br><span class="line"></span><br><span class="line">      <span class="attr">mainLoop</span>: <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (node === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> nodeTag = node.<span class="property">tag</span></span><br><span class="line">        <span class="keyword">if</span> (nodeTag === <span class="title class_">HostRoot</span> || nodeTag === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">          <span class="keyword">let</span> container = node.<span class="property">stateNode</span>.<span class="property">containerInfo</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">isMatchingRootContainer</span>(container, targetContainerNode)) &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (nodeTag === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">            <span class="comment">// The target is a portal, but it&#x27;s not the rootContainer we&#x27;re looking for.</span></span><br><span class="line">            <span class="comment">// Normally portals handle their own events all the way down to the root.</span></span><br><span class="line">            <span class="comment">// So we should be able to stop now. However, we don&#x27;t know if this portal</span></span><br><span class="line">            <span class="comment">// was part of *our* root.</span></span><br><span class="line">            <span class="keyword">let</span> grandNode = node.<span class="property">return</span></span><br><span class="line">            <span class="keyword">while</span> (grandNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">const</span> grandTag = grandNode.<span class="property">tag</span></span><br><span class="line">              <span class="keyword">if</span> (grandTag === <span class="title class_">HostRoot</span> || grandTag === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> grandContainer = grandNode.<span class="property">stateNode</span>.<span class="property">containerInfo</span></span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                  <span class="title function_">isMatchingRootContainer</span>(</span><br><span class="line">                    grandContainer,</span><br><span class="line">                    targetContainerNode</span><br><span class="line">                  )</span><br><span class="line">                ) &#123;</span><br><span class="line">                  <span class="comment">// This is the rootContainer we&#x27;re looking for and we found it as</span></span><br><span class="line">                  <span class="comment">// a parent of the Portal. That means we can ignore it because the</span></span><br><span class="line">                  <span class="comment">// Portal will bubble through to us.</span></span><br><span class="line">                  <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              grandNode = grandNode.<span class="property">return</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Now we need to find it&#x27;s corresponding host fiber in the other</span></span><br><span class="line">          <span class="comment">// tree. To do this we can use getClosestInstanceFromNode, but we</span></span><br><span class="line">          <span class="comment">// need to validate that the fiber is a host instance, otherwise</span></span><br><span class="line">          <span class="comment">// we need to traverse up through the DOM till we find the correct</span></span><br><span class="line">          <span class="comment">// node that is from the other tree.</span></span><br><span class="line">          <span class="keyword">while</span> (container !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> parentNode = <span class="title function_">getClosestInstanceFromNode</span>(container)</span><br><span class="line">            <span class="keyword">if</span> (parentNode === <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">const</span> parentTag = parentNode.<span class="property">tag</span></span><br><span class="line">            <span class="keyword">if</span> (parentTag === <span class="title class_">HostComponent</span> || parentTag === <span class="title class_">HostText</span>) &#123;</span><br><span class="line">              node = ancestorInst = parentNode</span><br><span class="line">              <span class="keyword">continue</span> mainLoop</span><br><span class="line">            &#125;</span><br><span class="line">            container = container.<span class="property">parentNode</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        node = node.<span class="property">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">batchedEventUpdates</span>(<span class="function">() =&gt;</span></span><br><span class="line">    <span class="title function_">dispatchEventsForPlugins</span>(</span><br><span class="line">      domEventName,</span><br><span class="line">      eventSystemFlags,</span><br><span class="line">      nativeEvent,</span><br><span class="line">      ancestorInst,</span><br><span class="line">      targetContainer</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>dispatchEventsForPlugins</code> 先获取当前 <code>Fiber</code> 上绑定的对应事件，然后 <code>processDispatchQueue</code> 通过按照顺序 <code>processDispatchQueueItemsInOrder</code> 处理各个事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dispatchEventsForPlugins</span>(<span class="params"></span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent,</span></span><br><span class="line"><span class="params">  targetInst: <span class="literal">null</span> | Fiber,</span></span><br><span class="line"><span class="params">  targetContainer: EventTarget</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> nativeEventTarget = <span class="title function_">getEventTarget</span>(nativeEvent)</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">dispatchQueue</span>: <span class="title class_">DispatchQueue</span> = []</span><br><span class="line">  <span class="title function_">extractEvents</span>(</span><br><span class="line">    dispatchQueue,</span><br><span class="line">    domEventName,</span><br><span class="line">    targetInst,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    nativeEventTarget,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer</span><br><span class="line">  )</span><br><span class="line">  <span class="title function_">processDispatchQueue</span>(dispatchQueue, eventSystemFlags)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">extractEvents</span>(<span class="params"></span></span><br><span class="line"><span class="params">  dispatchQueue: DispatchQueue,</span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  targetInst: <span class="literal">null</span> | Fiber,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent,</span></span><br><span class="line"><span class="params">  nativeEventTarget: <span class="literal">null</span> | EventTarget,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  targetContainer: EventTarget</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="title class_">SimpleEventPlugin</span>.<span class="title function_">extractEvents</span>(</span><br><span class="line">    dispatchQueue,</span><br><span class="line">    domEventName,</span><br><span class="line">    targetInst,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    nativeEventTarget,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// 其它逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">processDispatchQueue</span>(<span class="params"></span></span><br><span class="line"><span class="params">  dispatchQueue: DispatchQueue,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> inCapturePhase = (eventSystemFlags &amp; <span class="variable constant_">IS_CAPTURE_PHASE</span>) !== <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dispatchQueue.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// 取出事件监听函数执行</span></span><br><span class="line">    <span class="keyword">const</span> &#123; event, listeners &#125; = dispatchQueue[i]</span><br><span class="line">    <span class="title function_">processDispatchQueueItemsInOrder</span>(event, listeners, inCapturePhase)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">processDispatchQueueItemsInOrder</span>(<span class="params"></span></span><br><span class="line"><span class="params">  event: ReactSyntheticEvent,</span></span><br><span class="line"><span class="params">  dispatchListeners: <span class="built_in">Array</span>&lt;DispatchListener&gt;,</span></span><br><span class="line"><span class="params">  inCapturePhase: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> previousInstance</span><br><span class="line">  <span class="keyword">if</span> (inCapturePhase) &#123;</span><br><span class="line">    <span class="comment">// 捕获事件从后往前执行</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = dispatchListeners.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; instance, currentTarget, listener &#125; = dispatchListeners[i]</span><br><span class="line">      <span class="keyword">if</span> (instance !== previousInstance &amp;&amp; event.<span class="title function_">isPropagationStopped</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">executeDispatch</span>(event, listener, currentTarget)</span><br><span class="line">      previousInstance = instance</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 冒泡事件从前往后执行</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dispatchListeners.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; instance, currentTarget, listener &#125; = dispatchListeners[i]</span><br><span class="line">      <span class="keyword">if</span> (instance !== previousInstance &amp;&amp; event.<span class="title function_">isPropagationStopped</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">executeDispatch</span>(event, listener, currentTarget)</span><br><span class="line">      previousInstance = instance</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>extractEvents</code> 提取事件监听函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/plugins/SimpleEventPlugin.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">extractEvents</span>(<span class="params"></span></span><br><span class="line"><span class="params">  dispatchQueue: DispatchQueue,</span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  targetInst: <span class="literal">null</span> | Fiber,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent,</span></span><br><span class="line"><span class="params">  nativeEventTarget: <span class="literal">null</span> | EventTarget,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  targetContainer: EventTarget</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> reactName = topLevelEventsToReactNames.<span class="title function_">get</span>(domEventName)</span><br><span class="line">  <span class="keyword">if</span> (reactName === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> <span class="title class_">SyntheticEventCtor</span> = <span class="title class_">SyntheticEvent</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">reactEventType</span>: string = domEventName</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据事件类型获取对应的构造函数</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> inCapturePhase = (eventSystemFlags &amp; <span class="variable constant_">IS_CAPTURE_PHASE</span>) !== <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    enableCreateEventHandleAPI &amp;&amp;</span><br><span class="line">    eventSystemFlags &amp; <span class="variable constant_">IS_EVENT_HANDLE_NON_MANAGED_NODE</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> listeners = <span class="title function_">accumulateEventHandleNonManagedNodeListeners</span>(</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> this cast may not make sense for events like</span></span><br><span class="line">      <span class="comment">// &quot;focus&quot; where React listens to e.g. &quot;focusin&quot;.</span></span><br><span class="line">      ((<span class="attr">reactEventType</span>: any): <span class="title class_">DOMEventName</span>),</span><br><span class="line">      targetContainer,</span><br><span class="line">      inCapturePhase</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (listeners.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Intentionally create event lazily.</span></span><br><span class="line">      <span class="keyword">const</span> event = <span class="keyword">new</span> <span class="title class_">SyntheticEventCtor</span>(</span><br><span class="line">        reactName,</span><br><span class="line">        reactEventType,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        nativeEvent,</span><br><span class="line">        nativeEventTarget</span><br><span class="line">      )</span><br><span class="line">      dispatchQueue.<span class="title function_">push</span>(&#123; event, listeners &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Some events don&#x27;t bubble in the browser.</span></span><br><span class="line">    <span class="comment">// In the past, React has always bubbled them, but this can be surprising.</span></span><br><span class="line">    <span class="comment">// We&#x27;re going to try aligning closer to the browser behavior by not bubbling</span></span><br><span class="line">    <span class="comment">// them in React either. We&#x27;ll start by not bubbling onScroll, and then expand.</span></span><br><span class="line">    <span class="keyword">const</span> accumulateTargetOnly =</span><br><span class="line">      !inCapturePhase &amp;&amp;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> ideally, we&#x27;d eventually add all events from</span></span><br><span class="line">      <span class="comment">// nonDelegatedEvents list in DOMPluginEventSystem.</span></span><br><span class="line">      <span class="comment">// Then we can remove this special list.</span></span><br><span class="line">      <span class="comment">// This is a breaking change that can wait until React 18.</span></span><br><span class="line">      domEventName === <span class="string">&#x27;scroll&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> listeners = <span class="title function_">accumulateSinglePhaseListeners</span>(</span><br><span class="line">      targetInst,</span><br><span class="line">      reactName,</span><br><span class="line">      nativeEvent.<span class="property">type</span>,</span><br><span class="line">      inCapturePhase,</span><br><span class="line">      accumulateTargetOnly,</span><br><span class="line">      nativeEvent</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (listeners.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Intentionally create event lazily.</span></span><br><span class="line">      <span class="keyword">const</span> event = <span class="keyword">new</span> <span class="title class_">SyntheticEventCtor</span>(</span><br><span class="line">        reactName,</span><br><span class="line">        reactEventType,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        nativeEvent,</span><br><span class="line">        nativeEventTarget</span><br><span class="line">      )</span><br><span class="line">      dispatchQueue.<span class="title function_">push</span>(&#123; event, listeners &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用 <code>accumulateSinglePhaseListeners</code> 获取事件监听列表，从触发元素递归向上查询注册的事件然后放入监听器列表中返回</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">accumulateSinglePhaseListeners</span>(<span class="params"></span></span><br><span class="line"><span class="params">  targetFiber: Fiber | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  reactName: string | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  nativeEventType: string,</span></span><br><span class="line"><span class="params">  inCapturePhase: boolean,</span></span><br><span class="line"><span class="params">  accumulateTargetOnly: boolean,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Array</span>&lt;<span class="title class_">DispatchListener</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> captureName = reactName !== <span class="literal">null</span> ? reactName + <span class="string">&#x27;Capture&#x27;</span> : <span class="literal">null</span></span><br><span class="line">  <span class="keyword">const</span> reactEventName = inCapturePhase ? captureName : reactName</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">listeners</span>: <span class="title class_">Array</span>&lt;<span class="title class_">DispatchListener</span>&gt; = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> instance = targetFiber</span><br><span class="line">  <span class="keyword">let</span> lastHostComponent = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Accumulate all instances and listeners via the target -&gt; root path.</span></span><br><span class="line">  <span class="keyword">while</span> (instance !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; stateNode, tag &#125; = instance</span><br><span class="line">    <span class="comment">// Handle listeners that are on HostComponents (i.e. &lt;div&gt;)</span></span><br><span class="line">    <span class="keyword">if</span> (tag === <span class="title class_">HostComponent</span> &amp;&amp; stateNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">      lastHostComponent = stateNode</span><br><span class="line"></span><br><span class="line">      <span class="comment">// createEventHandle listeners</span></span><br><span class="line">      <span class="keyword">if</span> (enableCreateEventHandleAPI) &#123;</span><br><span class="line">        <span class="keyword">const</span> eventHandlerListeners =</span><br><span class="line">          <span class="title function_">getEventHandlerListeners</span>(lastHostComponent)</span><br><span class="line">        <span class="keyword">if</span> (eventHandlerListeners !== <span class="literal">null</span>) &#123;</span><br><span class="line">          eventHandlerListeners.<span class="title function_">forEach</span>(<span class="function">(<span class="params">entry</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">              entry.<span class="property">type</span> === nativeEventType &amp;&amp;</span><br><span class="line">              entry.<span class="property">capture</span> === inCapturePhase</span><br><span class="line">            ) &#123;</span><br><span class="line">              listeners.<span class="title function_">push</span>(</span><br><span class="line">                <span class="title function_">createDispatchListener</span>(</span><br><span class="line">                  instance,</span><br><span class="line">                  entry.<span class="property">callback</span>,</span><br><span class="line">                  (<span class="attr">lastHostComponent</span>: any)</span><br><span class="line">                )</span><br><span class="line">              )</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Standard React on* listeners, i.e. onClick or onClickCapture</span></span><br><span class="line">      <span class="keyword">if</span> (reactEventName !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> listener = <span class="title function_">getListener</span>(instance, reactEventName)</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="literal">null</span>) &#123;</span><br><span class="line">          listeners.<span class="title function_">push</span>(</span><br><span class="line">            <span class="title function_">createDispatchListener</span>(instance, listener, lastHostComponent)</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    instance = instance.<span class="property">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> listeners</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/12/react%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6/" data-id="cm1ghkbn6003czodzecubcfzf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/" rel="tag">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react中的jsx语法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/06/react%E4%B8%AD%E7%9A%84jsx%E8%AF%AD%E6%B3%95/" class="article-date">
  <time datetime="2021-06-06T14:30:07.000Z" itemprop="datePublished">2021-06-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/06/react%E4%B8%AD%E7%9A%84jsx%E8%AF%AD%E6%B3%95/">react中的jsx语法</a>
    </h1>
  


        <div style="color: #999; margin-top: 0.3rem" class="post-meta-item"> 共计
    671 字，约需阅读
    2.44
    分钟
</div>
      </header>
    
    
   

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a><code>JSX</code></h2><p><code>JSX</code> 是一种嵌入式的类似 <code>XML</code> 的语法。 它可以被转换成合法的 <code>JavaScript</code>，尽管转换的语义是依据不同的实现而定的。 <code>JSX</code> 因 <code>React</code> 框架而流行，但也存在其它的实现。</p>
<h3 id="React-中的-JSX"><a href="#React-中的-JSX" class="headerlink" title="React 中的 JSX"></a><code>React</code> 中的 <code>JSX</code></h3><p><code>JSX</code> 为我们提供了创建 <code>React</code> 元素方法（<code>React.createElement(component, props, ...children)</code>）的语法糖（<code>syntactic sugar</code>）</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="comment">// 编译后会被转化为</span></span><br><span class="line"><span class="keyword">var</span> element = <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;Hello, world!&#x27;</span>) <span class="comment">// 返回一个对象</span></span><br></pre></td></tr></table></figure>

<h4 id="JSX-代表-JS-对象"><a href="#JSX-代表-JS-对象" class="headerlink" title="JSX 代表 JS 对象"></a><code>JSX</code> 代表 <code>JS</code> 对象</h4><p><code>JSX</code> 本身也是一个表达式，在编译后，<code>JSX</code> 表达式会变成普通的 <code>JavaScript</code> 对象。执行 <code>React.createElement</code> 之后最终会执行一下代码生成一个普通的 <code>JavaScript</code> 对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ReactElement</span> = <span class="keyword">function</span> (<span class="params">type, key, ref, self, source, owner, props</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> element = &#123;</span><br><span class="line">    <span class="comment">// This tag allows us to uniquely identify this as a React Element</span></span><br><span class="line">    <span class="attr">$$typeof</span>: <span class="variable constant_">REACT_ELEMENT_TYPE</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Built-in properties that belong on the element</span></span><br><span class="line">    <span class="attr">type</span>: type,</span><br><span class="line">    <span class="attr">key</span>: key,</span><br><span class="line">    <span class="attr">ref</span>: ref,</span><br><span class="line">    <span class="attr">props</span>: props,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record the component responsible for creating this element.</span></span><br><span class="line">    <span class="attr">_owner</span>: owner,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> element</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上可以看出，执行 <code>React.createElement</code> 时只支持表达式，同时可以在以下情况中使用</p>
<ul>
<li>可以在 <code>if</code> 语句或 <code>for</code> 循环中使用 <code>JSX</code></li>
<li>可以将它赋值给变量</li>
<li>可以将它作为参数接收</li>
<li>可以在函数中返回 <code>JSX</code>。</li>
</ul>
<h5 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h5><p>在 <code>JavaScript</code> 中，表达式就是一个短语，<code>Javascript</code> 解释器会将其计算出一个结果，常量就是最简单的一类表达式。常用的表达式有：</p>
<ul>
<li>变量名</li>
<li>函数定义表达式</li>
<li>属性访问表达式</li>
<li>函数调用表达式</li>
<li>算数表达式</li>
<li>关系表达式</li>
<li>逻辑表达式</li>
</ul>
<p>注意: <code>if</code> 语句以及 <code>for</code> 循环不是 <code>JavaScript</code> 表达式</p>
<h4 id="JSX-可自动防范注入攻击"><a href="#JSX-可自动防范注入攻击" class="headerlink" title="JSX 可自动防范注入攻击"></a><code>JSX</code> 可自动防范注入攻击</h4><p>在默认情况下，React DOM 会将所有嵌入 JSX 的值进行编码，利用 <code>createTextNode</code> 进行 <code>HTML</code> 转义</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createTextNode</span>(<span class="params">text, rootContainerElement</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getOwnerDocumentFromRootContainer</span>(rootContainerElement).<span class="title function_">createTextNode</span>(</span><br><span class="line">    text</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若希望直接将字符串不经转义编码直接插入到 <code>HTML</code> 文档流，可以使用 <code>dangerouslySetInnerHTML</code> 属性，这是一个 <code>React</code> 版的 <code>innerHTML</code>，该属性接收一个 <code>key</code> 为 <code>__html</code> 的对象</p>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><ul>
<li><code>JSX</code> 会自动删除一行中开头和结尾处的空白符；</li>
<li><code>JSX</code> 会自动删除空行；</li>
<li><code>JSX</code> 会删除紧邻标签的换行；</li>
<li><code>JSX</code> 会删除字符串中的换行；</li>
<li>字符串中的换行会被转换成一个空格。</li>
</ul>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>允许使用熟悉的语法来定义 <code>HTML</code> 元素树</li>
<li>提供了更加语义化且易懂的标签</li>
<li>程序结构更容易被直观化</li>
<li>抽象了 <code>React Element</code> 的创建过程</li>
<li>可以随时掌控 <code>HTML</code> 标签以及生成这些标签的代码</li>
<li>原生 <code>Javascript</code></li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.tslang.cn/docs/handbook/jsx.html">JSX</a></li>
<li><a href="https://www.cnblogs.com/candlia/p/11920070.html">JSX 语法使用详解</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/06/react%E4%B8%AD%E7%9A%84jsx%E8%AF%AD%E6%B3%95/" data-id="cm1ghkbn6003ezodz7k1d20bh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/" rel="tag">react</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; 上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/5/">下一页 &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-language/" rel="tag">C&#x2F;C++语言</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a><span class="tag-list-count">63</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeORM/" rel="tag">TypeORM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/antd/" rel="tag">antd</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/express/" rel="tag">express</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/form/" rel="tag">form</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/" rel="tag">node</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/other/" rel="tag">other</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8F%92%E4%BB%B6/" rel="tag">插件</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" rel="tag">浏览器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solution/" rel="tag">算法</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/" rel="tag">计算机网络</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/read-book/" rel="tag">读书</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/source/" rel="tag">资源</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/c-language/" style="font-size: 12.5px;">C/C++语言</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/TypeORM/" style="font-size: 10px;">TypeORM</a> <a href="/tags/TypeScript/" style="font-size: 11.25px;">TypeScript</a> <a href="/tags/antd/" style="font-size: 10px;">antd</a> <a href="/tags/express/" style="font-size: 11.25px;">express</a> <a href="/tags/form/" style="font-size: 10px;">form</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/mysql/" style="font-size: 12.5px;">mysql</a> <a href="/tags/node/" style="font-size: 18.75px;">node</a> <a href="/tags/other/" style="font-size: 16.25px;">other</a> <a href="/tags/react/" style="font-size: 17.5px;">react</a> <a href="/tags/webpack/" style="font-size: 12.5px;">webpack</a> <a href="/tags/%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">插件</a> <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 10px;">浏览器</a> <a href="/tags/solution/" style="font-size: 13.75px;">算法</a> <a href="/tags/network/" style="font-size: 15px;">计算机网络</a> <a href="/tags/read-book/" style="font-size: 10px;">读书</a> <a href="/tags/source/" style="font-size: 12.5px;">资源</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">十一月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">九月 2024</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">七月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">三月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/11/24/%E8%AE%B0%E4%B8%80%E6%AC%A1safari%E7%99%BD%E5%B1%8F%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/">记一次safari白屏问题排查</a>
          </li>
        
          <li>
            <a href="/2024/09/25/%E6%AD%A3%E5%88%99/">正则</a>
          </li>
        
          <li>
            <a href="/2024/09/25/AI/">AI</a>
          </li>
        
          <li>
            <a href="/2024/09/24/zustand/">zustand</a>
          </li>
        
          <li>
            <a href="/2024/09/22/typescript%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0/">typescript自定义实现</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 奔跑的蜗牛<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">分类</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>