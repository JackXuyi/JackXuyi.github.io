<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>奔跑的蜗牛</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前端开发工程师">
<meta property="og:type" content="website">
<meta property="og:title" content="奔跑的蜗牛">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="奔跑的蜗牛">
<meta property="og:description" content="前端开发工程师">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="奔跑的蜗牛">
<meta property="article:tag" content="React、node、webpack">
<meta name="twitter:card" content="summary">
  
  
    <link rel="icon" href="0001.jpg#/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="奔跑的蜗牛" type="application/atom+xml">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">奔跑的蜗牛</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">分类</a>
        
      </nav>
      <nav id="sub-nav">
        
        
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-webpack源码阅读（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/15/webpack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time datetime="2021-06-15T12:52:53.000Z" itemprop="datePublished">2021-06-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/15/webpack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/">webpack源码阅读（一）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="webpack-compile-执行过程"><a href="#webpack-compile-执行过程" class="headerlink" title="webpack compile 执行过程"></a>webpack compile 执行过程</h3><ol>
<li>获取默认基础参数</li>
<li>构建 <code>Compiler</code> 实例</li>
<li>通过插件 <code>NodeEnvironmentPlugin</code> 插入日志输出，构建缓存，监听文件变化，监听 <code>NodeEnvironmentPlugin</code> 事件</li>
<li>注入自定义的插件</li>
<li>设置默认配置</li>
<li>同步执行 <code>environment</code> 钩子函数</li>
<li>同步执行 <code>afterEnvironment</code> 钩子函数</li>
<li>注入预设的插件系统</li>
<li>同步执行 <code>initialize</code> 钩子函数</li>
<li>执行 <code>run</code> ，开始构建</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: lib/webpack.js</span></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">WebpackFunctionSingle &amp; WebpackFunctionMulti</span>&#125; */</span> <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  options,</span></span></span><br><span class="line"><span class="params"><span class="function">  callback,</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">create</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> compiler</span><br><span class="line">    <span class="keyword">let</span> watch = <span class="literal">false</span></span><br><span class="line">    <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">WatchOptions|WatchOptions[]</span>&#125; */</span></span><br><span class="line">    <span class="keyword">let</span> watchOptions</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(options)) &#123;</span><br><span class="line">      <span class="comment">// 多个 compiler</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">Compiler</span>&#125; */</span></span><br><span class="line">      compiler = <span class="title function_">createCompiler</span>(options)</span><br><span class="line">      <span class="comment">// watch 配置</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123; compiler, watch, watchOptions &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; compiler, watch, watchOptions &#125; = <span class="title function_">create</span>()</span><br><span class="line">  <span class="comment">// 执行 run ，开始构建</span></span><br><span class="line">  compiler.<span class="title function_">run</span>(<span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">    compiler.<span class="title function_">close</span>(<span class="function">(<span class="params">err2</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">callback</span>(err || err2, stats)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> compiler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">createCompiler</span> = (<span class="params">rawOptions</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> options = <span class="title function_">getNormalizedWebpackOptions</span>(rawOptions)</span><br><span class="line">  <span class="title function_">applyWebpackOptionsBaseDefaults</span>(options) <span class="comment">// 构建默认基础选项</span></span><br><span class="line">  <span class="keyword">const</span> compiler = <span class="keyword">new</span> <span class="title class_">Compiler</span>(options.<span class="property">context</span>) <span class="comment">// 构建 compiler 实例</span></span><br><span class="line">  compiler.<span class="property">options</span> = options</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">NodeEnvironmentPlugin</span>(&#123;</span><br><span class="line">    <span class="attr">infrastructureLogging</span>: options.<span class="property">infrastructureLogging</span>,</span><br><span class="line">  &#125;).<span class="title function_">apply</span>(compiler) <span class="comment">// 插入日志输出，构建缓存系统，监听文件变化，监听 NodeEnvironmentPlugin 事件</span></span><br><span class="line">  <span class="comment">// 注入插件</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(options.<span class="property">plugins</span>)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> options.<span class="property">plugins</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        plugin.<span class="title function_">call</span>(compiler, compiler)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        plugin.<span class="title function_">apply</span>(compiler)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">applyWebpackOptionsDefaults</span>(options) <span class="comment">// 设置默认配置</span></span><br><span class="line">  compiler.<span class="property">hooks</span>.<span class="property">environment</span>.<span class="title function_">call</span>() <span class="comment">// 执行 environment 绑定的事件</span></span><br><span class="line">  compiler.<span class="property">hooks</span>.<span class="property">afterEnvironment</span>.<span class="title function_">call</span>() <span class="comment">// 执行 afterEnvironment 绑定的事件</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">WebpackOptionsApply</span>().<span class="title function_">process</span>(options, compiler) <span class="comment">// 注入预设的插件系统</span></span><br><span class="line">  compiler.<span class="property">hooks</span>.<span class="property">initialize</span>.<span class="title function_">call</span>() <span class="comment">// 执行 initialize 绑定的事件</span></span><br><span class="line">  <span class="keyword">return</span> compiler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="run-执行过程"><a href="#run-执行过程" class="headerlink" title="run 执行过程"></a><code>run</code> 执行过程</h4><ol>
<li>异步调用 <code>beforeRun</code> 钩子函数</li>
<li>异步调用 <code>run</code> 钩子函数</li>
<li>异步读取构建记录</li>
<li>实例化 <code>NormalModuleFactory</code> 对象，同步调用 <code>NormalModuleFactory</code> 钩子函数</li>
<li>实例化 <code>ContextModuleFactory</code> 对象，同步调用 <code>ContextModuleFactory</code> 钩子函数</li>
<li>构建 <code>Compilation</code> 需要的实例参数</li>
<li>异步调用 <code>beforeCompile</code> 钩子函数</li>
<li>同步调用 <code>compile</code> 钩子函数</li>
<li>构建 <code>Compilation</code> 实例</li>
<li>注入 <code>name</code> 和 <code>records</code> 属性</li>
<li>同步调用 <code>thisCompilation</code> 钩子函数</li>
<li>同步调用 <code>compilation</code> 钩子函数</li>
<li>异步调用 <code>make</code> 钩子函数</li>
<li>异步调用 <code>finishMake</code> 钩子函数</li>
<li>在 <code>nextTick</code> 中依次调用 <code>compilation.finish</code> 和 <code>compilation.seal</code></li>
<li>异步调用 <code>afterCompile</code> 钩子函数</li>
<li>同步调用 <code>shouldEmit</code> 钩子判断是否需要输出资源</li>
<li>输出资源文件，异步调用 <code>emit</code> 钩子函数</li>
<li>同步调用 <code>needAdditionalPass</code> 钩子函数</li>
<li>把构建记录 <code>records</code> 写入文件</li>
<li>异步调用 <code>done</code> 钩子函数</li>
<li>回调 <code>callback</code> 完成构建</li>
<li>同步调用 <code>afterDone</code> 钩子函数</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: lib/Compiler.js</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line">  <span class="title function_">run</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">finalCallback</span> = (<span class="params">err, stats</span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">idle</span> = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">beginIdle</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">idle</span> = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">running</span> = <span class="literal">false</span></span><br><span class="line">      <span class="comment">// 回调，然后调用 afterDone 钩子函数，结束构建</span></span><br><span class="line">      <span class="keyword">if</span> (callback !== <span class="literal">undefined</span>) <span class="title function_">callback</span>(err, stats)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">afterDone</span>.<span class="title function_">call</span>(stats)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">running</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">onCompiled</span> = (<span class="params">err, compilation</span>) =&gt; &#123;</span><br><span class="line">      <span class="comment">// 不需要输出资源直接结束此次构建</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">shouldEmit</span>.<span class="title function_">call</span>(compilation) === <span class="literal">false</span>) &#123;</span><br><span class="line">        compilation.<span class="property">startTime</span> = startTime</span><br><span class="line">        compilation.<span class="property">endTime</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        <span class="keyword">const</span> stats = <span class="keyword">new</span> <span class="title class_">Stats</span>(compilation)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">done</span>.<span class="title function_">callAsync</span>(stats, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">finalCallback</span>(<span class="literal">null</span>, stats)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emitAssets</span>(compilation, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 判断是否需要新增资源，如果需要新增则结束此次编译流程，然后重新启动一个新的编译流程</span></span><br><span class="line">          <span class="keyword">if</span> (compilation.<span class="property">hooks</span>.<span class="property">needAdditionalPass</span>.<span class="title function_">call</span>()) &#123;</span><br><span class="line">            compilation.<span class="property">needAdditionalPass</span> = <span class="literal">true</span></span><br><span class="line">            compilation.<span class="property">startTime</span> = startTime</span><br><span class="line">            compilation.<span class="property">endTime</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">            <span class="keyword">const</span> stats = <span class="keyword">new</span> <span class="title class_">Stats</span>(compilation)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">done</span>.<span class="title function_">callAsync</span>(stats, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">additionalPass</span>.<span class="title function_">callAsync</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">compile</span>(onCompiled)</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 输出构建的记录，结束编译流程</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">emitRecords</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            compilation.<span class="property">startTime</span> = startTime</span><br><span class="line">            compilation.<span class="property">endTime</span> = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">            <span class="keyword">const</span> stats = <span class="keyword">new</span> <span class="title class_">Stats</span>(compilation)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">done</span>.<span class="title function_">callAsync</span>(stats, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">cache</span>.<span class="title function_">storeBuildDependencies</span>(</span><br><span class="line">                compilation.<span class="property">buildDependencies</span>,</span><br><span class="line">                <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="title function_">finalCallback</span>(<span class="literal">null</span>, stats)</span><br><span class="line">                &#125;,</span><br><span class="line">              )</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">run</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">beforeRun</span>.<span class="title function_">callAsync</span>(<span class="variable language_">this</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">run</span>.<span class="title function_">callAsync</span>(<span class="variable language_">this</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 读取编译记录</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">readRecords</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 开始执行编译</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">compile</span>(onCompiled)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">run</span>() <span class="comment">// 开始执行编译进程</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">compile</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> params = <span class="variable language_">this</span>.<span class="title function_">newCompilationParams</span>() <span class="comment">// 构建 Compilation 参数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">beforeCompile</span>.<span class="title function_">callAsync</span>(params, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">compile</span>.<span class="title function_">call</span>(params)</span><br><span class="line">      <span class="keyword">const</span> compilation = <span class="variable language_">this</span>.<span class="title function_">newCompilation</span>(params) <span class="comment">// 构建 Compilation 实例，开始一次编译</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">make</span>.<span class="title function_">callAsync</span>(compilation, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">finishMake</span>.<span class="title function_">callAsync</span>(compilation, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">          process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 执行 Compilation 内的钩子</span></span><br><span class="line">            compilation.<span class="title function_">finish</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">              compilation.<span class="title function_">seal</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 一次编译完成</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">hooks</span>.<span class="property">afterCompile</span>.<span class="title function_">callAsync</span>(compilation, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="title function_">callback</span>(<span class="literal">null</span>, compilation)</span><br><span class="line">                &#125;)</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="代码执行流程图"><a href="#代码执行流程图" class="headerlink" title="代码执行流程图"></a>代码执行流程图</h4><p><img src="/images/webpack-compile.png" alt="webpack compile 代码执行流程"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/15/webpack%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="cm19b6rza004hgkdz84ny15uw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/" rel="tag">webpack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Performance" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/15/Performance/" class="article-date">
  <time datetime="2021-06-14T22:48:44.000Z" itemprop="datePublished">2021-06-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/15/Performance/">Performance</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><h5 id="navigation"><a href="#navigation" class="headerlink" title="navigation"></a><code>navigation</code></h5><p>只读属性 Performance.navigation 会返回一个 PerformanceNavigation 对象。</p>
<ul>
<li>type: 一个无符号短整型，表示是如何导航到这个页面的。<ul>
<li>TYPE_NAVIGATE (0): 当前页面是通过点击链接，书签和表单提交，或者脚本操作，或者在 url 中直接输入地址;</li>
<li>TYPE_RELOAD (1): 点击刷新页面按钮或者通过 Location.reload()方法显示的页面;</li>
<li>TYPE_BACK_FORWARD (2): 页面通过历史记录和前进后退访问时;</li>
<li>TYPE_RESERVED (255): 任何其他方式。</li>
</ul>
</li>
<li>redirectCount: 无符号短整型，表示在到达这个页面之前重定向了多少次。</li>
</ul>
<h5 id="timing"><a href="#timing" class="headerlink" title="timing"></a><code>timing</code></h5><p>只读属性返回一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceTiming">PerformanceTiming</a> 对象，这个对象包括了页面相关的性能信息。</p>
<h5 id="timeOrigin"><a href="#timeOrigin" class="headerlink" title="timeOrigin"></a><code>timeOrigin</code></h5><p>只读属性 timeOrigin 返回一个表示 the performance measurement 开始时间的高精度 timestamp</p>
<h5 id="onresourcetimingbufferfull"><a href="#onresourcetimingbufferfull" class="headerlink" title="onresourcetimingbufferfull"></a><code>onresourcetimingbufferfull</code></h5><p>在 resourcetimingbufferfull 事件触发时会被调用的事件处理器，参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/onresourcetimingbufferfull">Performance.onresourcetimingbufferfull</a></p>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><h5 id="Performance-now"><a href="#Performance-now" class="headerlink" title="Performance.now()"></a><code>Performance.now()</code></h5><p>方法返回一个精确到毫秒的事件戳 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DOMHighResTimeStamp">DOMHighResTimeStamp</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">performance.<span class="title function_">now</span>() <span class="comment">// 38544.5</span></span><br><span class="line"><span class="title class_">Date</span>.<span class="title function_">now</span>() <span class="comment">// 1623685111685</span></span><br></pre></td></tr></table></figure>

<h6 id="tips：-测量程序性能时可以使用"><a href="#tips：-测量程序性能时可以使用" class="headerlink" title="tips： 测量程序性能时可以使用"></a>tips： 测量程序性能时可以使用</h6><h5 id="performance-setResourceTimingBufferSize"><a href="#performance-setResourceTimingBufferSize" class="headerlink" title="performance.setResourceTimingBufferSize()"></a><a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/setResourceTimingBufferSize"><code>performance.setResourceTimingBufferSize()</code></a></h5><p>设置浏览器记录资源加载情况的缓冲区大小，单位是对象个数，最小为 150</p>
<h5 id="Performance-mark"><a href="#Performance-mark" class="headerlink" title="Performance.mark()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/mark"><code>Performance.mark()</code></a></h5><p>在浏览器的性能缓冲区中使用给定名称添加一个 timestamp</p>
<h5 id="Performance-measure"><a href="#Performance-measure" class="headerlink" title="Performance.measure()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/measure"><code>Performance.measure()</code></a></h5><p>在浏览器性能记录缓存中创建了一个名为时间戳的记录来记录两个特殊标志位（通常称为开始标志和结束标志）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">performance.<span class="title function_">mark</span>(<span class="string">&#x27;test1&#x27;</span>)</span><br><span class="line">performance.<span class="title function_">mark</span>(<span class="string">&#x27;test2&#x27;</span>)</span><br><span class="line">performance.<span class="title function_">measure</span>(<span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;test1&#x27;</span>, <span class="string">&#x27;test2&#x27;</span>) <span class="comment">// &#123; detail: null, duration: 0.09999999403953552, entryType: &quot;measure&quot;, name: &quot;test&quot;, startTime: 33062.60000000894 &#125;</span></span><br></pre></td></tr></table></figure>

<h6 id="tips：-与-Performance-mark-结合可以测量指定项目的时间"><a href="#tips：-与-Performance-mark-结合可以测量指定项目的时间" class="headerlink" title="tips： 与 Performance.mark() 结合可以测量指定项目的时间"></a>tips： 与 <code>Performance.mark()</code> 结合可以测量指定项目的时间</h6><h5 id="Performance-clearResourceTimings"><a href="#Performance-clearResourceTimings" class="headerlink" title="Performance.clearResourceTimings()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearResourceTimings"><code>Performance.clearResourceTimings()</code></a></h5><p>移除所有的记录</p>
<h5 id="Performance-clearMarks"><a href="#Performance-clearMarks" class="headerlink" title="Performance.clearMarks()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearMarks"><code>Performance.clearMarks()</code></a></h5><p>从浏览器的 performance entry 缓存中移除声明的标记。</p>
<h5 id="Performance-clearMeasures"><a href="#Performance-clearMeasures" class="headerlink" title="Performance.clearMeasures()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearMeasures"><code>Performance.clearMeasures()</code></a></h5><p>从浏览器的性能入口缓存区中移除声明的度量衡。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/15/Performance/" data-id="cm19b6rya0007gkdzbdvi90d4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react的同步更新" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/14/react%E7%9A%84%E5%90%8C%E6%AD%A5%E6%9B%B4%E6%96%B0/" class="article-date">
  <time datetime="2021-06-13T18:10:34.000Z" itemprop="datePublished">2021-06-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/14/react%E7%9A%84%E5%90%8C%E6%AD%A5%E6%9B%B4%E6%96%B0/">react的同步更新</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="react-同步更新"><a href="#react-同步更新" class="headerlink" title="react 同步更新"></a>react 同步更新</h3><h4 id="class-组件"><a href="#class-组件" class="headerlink" title="class 组件"></a>class 组件</h4><p>每个 <code>class</code> 组件初始化时都会注入 <code>updater</code> 的属性</p>
<h5 id="更新过程"><a href="#更新过程" class="headerlink" title="更新过程"></a>更新过程</h5><ol>
<li>构建更新节点</li>
<li>把节点放入更新队列</li>
<li>调度更新节点</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">const</span> classComponentUpdater = &#123;</span><br><span class="line">  isMounted,</span><br><span class="line">  <span class="title function_">enqueueSetState</span>(<span class="params">inst, payload, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = <span class="title function_">getInstance</span>(inst)</span><br><span class="line">    <span class="keyword">const</span> eventTime = <span class="title function_">requestEventTime</span>()</span><br><span class="line">    <span class="keyword">const</span> lane = <span class="title function_">requestUpdateLane</span>(fiber) <span class="comment">// 获取更新方式，包括同步更新</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> update = <span class="title function_">createUpdate</span>(eventTime, lane) <span class="comment">// 构建更新</span></span><br><span class="line">    update.<span class="property">payload</span> = payload</span><br><span class="line">    <span class="keyword">if</span> (callback !== <span class="literal">undefined</span> &amp;&amp; callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      update.<span class="property">callback</span> = callback</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">enqueueUpdate</span>(fiber, update, lane) <span class="comment">// 更新放入队列</span></span><br><span class="line">    <span class="keyword">const</span> root = <span class="title function_">scheduleUpdateOnFiber</span>(fiber, lane, eventTime) <span class="comment">// 调度更新节点</span></span><br><span class="line">    <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">entangleTransitions</span>(root, fiber, lane)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">      <span class="title function_">markStateUpdateScheduled</span>(fiber, lane)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">enqueueReplaceState</span>(<span class="params">inst, payload, callback</span>) &#123;</span><br><span class="line">    <span class="comment">// 类似与 enqueueSetState</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">enqueueForceUpdate</span>(<span class="params">inst, callback</span>) &#123;</span><br><span class="line">    <span class="comment">// 类似与 enqueueSetState</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="把节点放入更新队列"><a href="#把节点放入更新队列" class="headerlink" title="把节点放入更新队列"></a>把节点放入更新队列</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> enqueueUpdate&lt;<span class="title class_">State</span>&gt;(</span><br><span class="line">  <span class="attr">fiber</span>: <span class="title class_">Fiber</span>,</span><br><span class="line">  <span class="attr">update</span>: <span class="title class_">Update</span>&lt;<span class="title class_">State</span>&gt;,</span><br><span class="line">  <span class="attr">lane</span>: <span class="title class_">Lane</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue = fiber.<span class="property">updateQueue</span></span><br><span class="line">  <span class="keyword">if</span> (updateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 组件卸载</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sharedQueue = updateQueue.<span class="property">shared</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isInterleavedUpdate</span>(fiber, lane)) &#123;</span><br><span class="line">    <span class="keyword">const</span> interleaved = sharedQueue.<span class="property">interleaved</span></span><br><span class="line">    <span class="keyword">if</span> (interleaved === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 挂载时构成一个循环链表</span></span><br><span class="line">      update.<span class="property">next</span> = update</span><br><span class="line">      <span class="comment">// At the end of the current render, this queue&#x27;s interleaved updates will</span></span><br><span class="line">      <span class="comment">// be transfered to the pending queue.</span></span><br><span class="line">      <span class="title function_">pushInterleavedQueue</span>(sharedQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.<span class="property">next</span> = interleaved.<span class="property">next</span></span><br><span class="line">      interleaved.<span class="property">next</span> = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.<span class="property">interleaved</span> = update</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pending = sharedQueue.<span class="property">pending</span></span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 挂载时构成一个循环链表</span></span><br><span class="line">      update.<span class="property">next</span> = update</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.<span class="property">next</span> = pending.<span class="property">next</span></span><br><span class="line">      pending.<span class="property">next</span> = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.<span class="property">pending</span> = update</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="调度更新节点"><a href="#调度更新节点" class="headerlink" title="调度更新节点"></a>调度更新节点</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">scheduleUpdateOnFiber</span>(<span class="params"></span></span><br><span class="line"><span class="params">  fiber: Fiber,</span></span><br><span class="line"><span class="params">  lane: Lane,</span></span><br><span class="line"><span class="params">  eventTime: number</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">FiberRoot</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="title function_">checkForNestedUpdates</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = <span class="title function_">markUpdateLaneFromFiberToRoot</span>(fiber, lane) <span class="comment">// 更新从当前 fiber 标记到根节点并返回根节点</span></span><br><span class="line">  <span class="keyword">if</span> (root === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 标记当前节点进入更新队列</span></span><br><span class="line">  <span class="title function_">markRootUpdated</span>(root, lane, eventTime)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (executionContext &amp; <span class="title class_">CommitContext</span>) !== <span class="title class_">NoContext</span> &amp;&amp;</span><br><span class="line">      root === rootCommittingMutationOrLayoutEffects</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (fiber.<span class="property">mode</span> &amp; <span class="title class_">ProfileMode</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> current = fiber</span><br><span class="line">        <span class="keyword">while</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (current.<span class="property">tag</span> === <span class="title class_">Profiler</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; id, onNestedUpdateScheduled &#125; = current.<span class="property">memoizedProps</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> onNestedUpdateScheduled === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">              <span class="title function_">onNestedUpdateScheduled</span>(id)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          current = current.<span class="property">return</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Consolidate with `isInterleavedUpdate` check</span></span><br><span class="line">  <span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">    <span class="comment">// Received an update to a tree that&#x27;s in the middle of rendering. Mark</span></span><br><span class="line">    <span class="comment">// that there was an interleaved update work on this root. Unless the</span></span><br><span class="line">    <span class="comment">// `deferRenderPhaseUpdateToNextBatch` flag is off and this is a render</span></span><br><span class="line">    <span class="comment">// phase update. In that case, we don&#x27;t treat render phase updates as if</span></span><br><span class="line">    <span class="comment">// they were interleaved, for backwards compat reasons.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      deferRenderPhaseUpdateToNextBatch ||</span><br><span class="line">      (executionContext &amp; <span class="title class_">RenderContext</span>) === <span class="title class_">NoContext</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      workInProgressRootUpdatedLanes = <span class="title function_">mergeLanes</span>(</span><br><span class="line">        workInProgressRootUpdatedLanes,</span><br><span class="line">        lane</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (workInProgressRootExitStatus === <span class="title class_">RootSuspendedWithDelay</span>) &#123;</span><br><span class="line">      <span class="comment">// The root already suspended with a delay, which means this render</span></span><br><span class="line">      <span class="comment">// definitely won&#x27;t finish. Since we have a new update, let&#x27;s mark it as</span></span><br><span class="line">      <span class="comment">// suspended now, right before marking the incoming update. This has the</span></span><br><span class="line">      <span class="comment">// effect of interrupting the current render and switching to the update.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Make sure this doesn&#x27;t override pings that happen while we&#x27;ve</span></span><br><span class="line">      <span class="comment">// already started rendering.</span></span><br><span class="line">      <span class="title function_">markRootSuspended</span>(root, workInProgressRootRenderLanes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lane === <span class="title class_">SyncLane</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// Check if we&#x27;re inside unbatchedUpdates</span></span><br><span class="line">      (executionContext &amp; <span class="title class_">LegacyUnbatchedContext</span>) !== <span class="title class_">NoContext</span> &amp;&amp;</span><br><span class="line">      <span class="comment">// Check if we&#x27;re not already rendering</span></span><br><span class="line">      (executionContext &amp; (<span class="title class_">RenderContext</span> | <span class="title class_">CommitContext</span>)) === <span class="title class_">NoContext</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="title function_">performSyncWorkOnRoot</span>(root) <span class="comment">// 开始同步更新</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">ensureRootIsScheduled</span>(root, eventTime)</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        executionContext === <span class="title class_">NoContext</span> &amp;&amp;</span><br><span class="line">        (fiber.<span class="property">mode</span> &amp; <span class="title class_">ConcurrentMode</span>) === <span class="title class_">NoMode</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Flush the synchronous work now, unless we&#x27;re already working or inside</span></span><br><span class="line">        <span class="comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span></span><br><span class="line">        <span class="comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span></span><br><span class="line">        <span class="comment">// without immediately flushing it. We only do this for user-initiated</span></span><br><span class="line">        <span class="comment">// updates, to preserve historical behavior of legacy mode.</span></span><br><span class="line">        <span class="title function_">resetRenderTimer</span>()</span><br><span class="line">        <span class="title function_">flushSyncCallbacksOnlyInLegacyMode</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Schedule other updates after in case the callback is sync.</span></span><br><span class="line">    <span class="title function_">ensureRootIsScheduled</span>(root, eventTime)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="performSyncWorkOnRoot"><a href="#performSyncWorkOnRoot" class="headerlink" title="performSyncWorkOnRoot"></a><code>performSyncWorkOnRoot</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="comment">// This is the entry point for synchronous tasks that don&#x27;t go</span></span><br><span class="line"><span class="comment">// through Scheduler</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">performSyncWorkOnRoot</span>(<span class="params">root</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdatePhase) &#123;</span><br><span class="line">    <span class="title function_">syncNestedUpdateFlag</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">flushPassiveEffects</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> lanes = <span class="title function_">getNextLanes</span>(root, <span class="title class_">NoLanes</span>)</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">includesSomeLane</span>(lanes, <span class="title class_">SyncLane</span>)) &#123;</span><br><span class="line">    <span class="comment">// 同步任务执行完毕</span></span><br><span class="line">    <span class="title function_">ensureRootIsScheduled</span>(root, <span class="title function_">now</span>())</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> exitStatus = <span class="title function_">renderRootSync</span>(root, lanes)</span><br><span class="line">  <span class="comment">// 错误补偿逻辑</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We now have a consistent tree. Because this is a sync render, we</span></span><br><span class="line">  <span class="comment">// will commit it even if something suspended.</span></span><br><span class="line">  <span class="keyword">const</span> finishedWork = root.<span class="property">current</span>.<span class="property">alternate</span></span><br><span class="line">  root.<span class="property">finishedWork</span> = finishedWork</span><br><span class="line">  root.<span class="property">finishedLanes</span> = lanes</span><br><span class="line">  <span class="title function_">commitRoot</span>(root)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before exiting, make sure there&#x27;s a callback scheduled for the next</span></span><br><span class="line">  <span class="comment">// pending level.</span></span><br><span class="line">  <span class="title function_">ensureRootIsScheduled</span>(root, <span class="title function_">now</span>())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="renderRootSync"><a href="#renderRootSync" class="headerlink" title="renderRootSync"></a><code>renderRootSync</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// workInProgressRoot 全局变量</span></span><br><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">renderRootSync</span>(<span class="params">root: FiberRoot, lanes: Lanes</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext</span><br><span class="line">  executionContext |= <span class="title class_">RenderContext</span></span><br><span class="line">  <span class="keyword">const</span> prevDispatcher = <span class="title function_">pushDispatcher</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the root or lanes have changed, throw out the existing stack</span></span><br><span class="line">  <span class="comment">// and prepare a fresh one. Otherwise we&#x27;ll continue where we left off.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) &#123;</span><br><span class="line">    <span class="title function_">prepareFreshStack</span>(root, lanes) <span class="comment">// 更新 context</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    <span class="title function_">markRenderStarted</span>(lanes)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="title function_">workLoopSync</span>()</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">      <span class="title function_">handleError</span>(root, thrownValue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">  <span class="title function_">resetContextDependencies</span>()</span><br><span class="line">  executionContext = prevExecutionContext</span><br><span class="line">  <span class="title function_">popDispatcher</span>(prevDispatcher)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    <span class="title function_">markRenderStopped</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set this to null to indicate there&#x27;s no in-progress render.</span></span><br><span class="line">  workInProgressRoot = <span class="literal">null</span></span><br><span class="line">  workInProgressRootRenderLanes = <span class="title class_">NoLanes</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgressRootExitStatus</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="workLoopSync"><a href="#workLoopSync" class="headerlink" title="workLoopSync"></a><code>workLoopSync</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="comment">// workInProgress 全局变量</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">workLoopSync</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Already timed out, so perform work without checking if we need to yield.</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">performUnitOfWork</span>(workInProgress)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="performUnitOfWork"><a href="#performUnitOfWork" class="headerlink" title="performUnitOfWork"></a><code>performUnitOfWork</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// 执行更新任务</span></span><br><span class="line">  <span class="keyword">const</span> current = unitOfWork.<span class="property">alternate</span></span><br><span class="line">  <span class="keyword">let</span> next = <span class="title function_">beginWork</span>(current, unitOfWork, subtreeRenderLanes) <span class="comment">// child</span></span><br><span class="line">  unitOfWork.<span class="property">memoizedProps</span> = unitOfWork.<span class="property">pendingProps</span></span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 没有下一个任务时表示任务已经做完</span></span><br><span class="line">    <span class="title function_">completeUnitOfWork</span>(unitOfWork)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress = next</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">ReactCurrentOwner</span>.<span class="property">current</span> = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a><code>beginWork</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberBeginWork.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">beginWork</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">current</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">renderLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Fiber</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> updateLanes = workInProgress.<span class="property">lanes</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldProps = current.<span class="property">memoizedProps</span></span><br><span class="line">    <span class="keyword">const</span> newProps = workInProgress.<span class="property">pendingProps</span></span><br><span class="line">    <span class="keyword">if</span> (oldProps !== newProps || <span class="title function_">hasLegacyContextChanged</span>()) &#123;</span><br><span class="line">      <span class="comment">// props 更新或 context 更新</span></span><br><span class="line">      didReceiveUpdate = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title function_">includesSomeLane</span>(renderLanes, updateLanes)) &#123;</span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">      <span class="comment">// 此次渲染的更新和等待的更新没有任何交集，新增等待的更新等待下次执行</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 其它更新逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清空</span></span><br><span class="line">  workInProgress.<span class="property">lanes</span> = <span class="title class_">NoLanes</span></span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="title class_">Component</span> = workInProgress.<span class="property">type</span></span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.<span class="property">pendingProps</span></span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.<span class="property">elementType</span> === <span class="title class_">Component</span></span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : <span class="title function_">resolveDefaultProps</span>(<span class="title class_">Component</span>, unresolvedProps)</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">updateClassComponent</span>(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        <span class="title class_">Component</span>,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderLanes</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其它类型组件更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="updateClassComponent"><a href="#updateClassComponent" class="headerlink" title="updateClassComponent"></a>updateClassComponent</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberBeginWork.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateClassComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  workInProgress: Fiber,</span></span><br><span class="line"><span class="params">  Component: any,</span></span><br><span class="line"><span class="params">  nextProps: any,</span></span><br><span class="line"><span class="params">  renderLanes: Lanes</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 提取 context</span></span><br><span class="line">  <span class="keyword">let</span> hasContext</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isLegacyContextProvider</span>(<span class="title class_">Component</span>)) &#123;</span><br><span class="line">    hasContext = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">pushLegacyContextProvider</span>(workInProgress)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    hasContext = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">prepareToReadContext</span>(workInProgress, renderLanes)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span></span><br><span class="line">  <span class="keyword">let</span> shouldUpdate</span><br><span class="line">  <span class="keyword">if</span> (instance === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 挂载</span></span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// A class component without an instance only mounts if it suspended</span></span><br><span class="line">      <span class="comment">// inside a non-concurrent tree, in an inconsistent state. We want to</span></span><br><span class="line">      <span class="comment">// treat it like a new mount, even though an empty version of it already</span></span><br><span class="line">      <span class="comment">// committed. Disconnect the alternate pointers.</span></span><br><span class="line">      current.<span class="property">alternate</span> = <span class="literal">null</span></span><br><span class="line">      workInProgress.<span class="property">alternate</span> = <span class="literal">null</span></span><br><span class="line">      <span class="comment">// Since this is conceptually a new fiber, schedule a Placement effect</span></span><br><span class="line">      workInProgress.<span class="property">flags</span> |= <span class="title class_">Placement</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// In the initial pass we might need to construct the instance.</span></span><br><span class="line">    <span class="title function_">constructClassInstance</span>(workInProgress, <span class="title class_">Component</span>, nextProps)</span><br><span class="line">    <span class="title function_">mountClassInstance</span>(workInProgress, <span class="title class_">Component</span>, nextProps, renderLanes)</span><br><span class="line">    shouldUpdate = <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// In a resume, we&#x27;ll already have an instance we can reuse.</span></span><br><span class="line">    shouldUpdate = <span class="title function_">resumeMountClassInstance</span>(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="title class_">Component</span>,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//   更新</span></span><br><span class="line">    shouldUpdate = <span class="title function_">updateClassInstance</span>(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="title class_">Component</span>,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> nextUnitOfWork = <span class="title function_">finishClassComponent</span>(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    <span class="title class_">Component</span>,</span><br><span class="line">    shouldUpdate,</span><br><span class="line">    hasContext,</span><br><span class="line">    renderLanes</span><br><span class="line">  ) <span class="comment">// child</span></span><br><span class="line">  <span class="keyword">return</span> nextUnitOfWork</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="constructClassInstance"><a href="#constructClassInstance" class="headerlink" title="constructClassInstance"></a><code>constructClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">constructClassInstance</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">ctor</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">props</span>: <span class="built_in">any</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">any</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> isLegacyContextConsumer = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> unmaskedContext = emptyContextObject</span><br><span class="line">  <span class="keyword">let</span> context = emptyContextObject</span><br><span class="line">  <span class="keyword">const</span> contextType = ctor.<span class="property">contextType</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提取 context</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">&#x27;object&#x27;</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">    context = <span class="title function_">readContext</span>(contextType)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!disableLegacyContext) &#123;</span><br><span class="line">    unmaskedContext = <span class="title function_">getUnmaskedContext</span>(workInProgress, ctor, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> contextTypes = ctor.<span class="property">contextTypes</span></span><br><span class="line">    isLegacyContextConsumer =</span><br><span class="line">      contextTypes !== <span class="literal">null</span> &amp;&amp; contextTypes !== <span class="literal">undefined</span></span><br><span class="line">    context = isLegacyContextConsumer</span><br><span class="line">      ? <span class="title function_">getMaskedContext</span>(workInProgress, unmaskedContext)</span><br><span class="line">      : emptyContextObject</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建组件实例</span></span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">new</span> <span class="title function_">ctor</span>(props, context)</span><br><span class="line">  <span class="keyword">const</span> state = (workInProgress.<span class="property">memoizedState</span> =</span><br><span class="line">    instance.<span class="property">state</span> !== <span class="literal">null</span> &amp;&amp; instance.<span class="property">state</span> !== <span class="literal">undefined</span></span><br><span class="line">      ? instance.<span class="property">state</span></span><br><span class="line">      : <span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// fiber 注入更新队列和实例信息，存储实例和 fiber 映射</span></span><br><span class="line">  <span class="title function_">adoptClassInstance</span>(workInProgress, instance)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓存 context</span></span><br><span class="line">  <span class="keyword">if</span> (isLegacyContextConsumer) &#123;</span><br><span class="line">    <span class="title function_">cacheContext</span>(workInProgress, unmaskedContext, context)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> instance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="adoptClassInstance"><a href="#adoptClassInstance" class="headerlink" title="adoptClassInstance"></a><code>adoptClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">adoptClassInstance</span>(<span class="params"><span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>, <span class="attr">instance</span>: <span class="built_in">any</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  instance.<span class="property">updater</span> = classComponentUpdater <span class="comment">// 更新队列</span></span><br><span class="line">  workInProgress.<span class="property">stateNode</span> = instance <span class="comment">// 存储组件实例</span></span><br><span class="line">  <span class="comment">//构建 fiber 和组件实例的映射</span></span><br><span class="line">  <span class="title function_">setInstance</span>(instance, workInProgress)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="mountClassInstance"><a href="#mountClassInstance" class="headerlink" title="mountClassInstance"></a><code>mountClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mountClassInstance</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">ctor</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">newProps</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">renderLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span></span><br><span class="line">  instance.<span class="property">props</span> = newProps</span><br><span class="line">  instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span></span><br><span class="line">  instance.<span class="property">refs</span> = emptyRefsObject</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化队列</span></span><br><span class="line">  <span class="title function_">initializeUpdateQueue</span>(workInProgress)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 context</span></span><br><span class="line">  <span class="keyword">const</span> contextType = ctor.<span class="property">contextType</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">&#x27;object&#x27;</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">    instance.<span class="property">context</span> = <span class="title function_">readContext</span>(contextType)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (disableLegacyContext) &#123;</span><br><span class="line">    instance.<span class="property">context</span> = emptyContextObject</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> unmaskedContext = <span class="title function_">getUnmaskedContext</span>(workInProgress, ctor, <span class="literal">true</span>)</span><br><span class="line">    instance.<span class="property">context</span> = <span class="title function_">getMaskedContext</span>(workInProgress, unmaskedContext)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新 state</span></span><br><span class="line">  instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 getDerivedStateFromProps 更新 state</span></span><br><span class="line">  <span class="keyword">const</span> getDerivedStateFromProps = ctor.<span class="property">getDerivedStateFromProps</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">applyDerivedStateFromProps</span>(</span><br><span class="line">      workInProgress,</span><br><span class="line">      ctor,</span><br><span class="line">      getDerivedStateFromProps,</span><br><span class="line">      newProps</span><br><span class="line">    )</span><br><span class="line">    instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 componentWillMount 生命周期</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> ctor.<span class="property">getDerivedStateFromProps</span> !== <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> instance.<span class="property">getSnapshotBeforeUpdate</span> !== <span class="string">&#x27;function&#x27;</span> &amp;&amp;</span><br><span class="line">    (<span class="keyword">typeof</span> instance.<span class="property">UNSAFE_componentWillMount</span> === <span class="string">&#x27;function&#x27;</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> instance.<span class="property">componentWillMount</span> === <span class="string">&#x27;function&#x27;</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">callComponentWillMount</span>(workInProgress, instance)</span><br><span class="line">    <span class="comment">// componentWillMount 执行 setState 时立即更新 state</span></span><br><span class="line">    <span class="title function_">processUpdateQueue</span>(workInProgress, newProps, instance, renderLanes)</span><br><span class="line">    instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.<span class="property">componentDidMount</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">fiberFlags</span>: <span class="title class_">Flags</span> = <span class="title class_">Update</span></span><br><span class="line">    <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics) &#123;</span><br><span class="line">      fiberFlags |= <span class="title class_">LayoutStatic</span></span><br><span class="line">    &#125;</span><br><span class="line">    workInProgress.<span class="property">flags</span> |= fiberFlags</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="finishClassComponent"><a href="#finishClassComponent" class="headerlink" title="finishClassComponent"></a><code>finishClassComponent</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">finishClassComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">current</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="title class_">Component</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">shouldUpdate</span>: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">hasContext</span>: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">renderLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Refs should update even if shouldComponentUpdate returns false</span></span><br><span class="line">  <span class="title function_">markRef</span>(current, workInProgress)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> didCaptureError = (workInProgress.<span class="property">flags</span> &amp; <span class="title class_">DidCapture</span>) !== <span class="title class_">NoFlags</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!shouldUpdate &amp;&amp; !didCaptureError) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">bailoutOnAlreadyFinishedWork</span>(current, workInProgress, renderLanes)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Rerender</span></span><br><span class="line">  <span class="title class_">ReactCurrentOwner</span>.<span class="property">current</span> = workInProgress</span><br><span class="line">  <span class="keyword">let</span> nextChildren</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    didCaptureError &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> <span class="title class_">Component</span>.<span class="property">getDerivedStateFromError</span> !== <span class="string">&#x27;function&#x27;</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 错误处理</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nextChildren = instance.<span class="title function_">render</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">reconcileChildren</span>(current, workInProgress, nextChildren, renderLanes)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 记录 state</span></span><br><span class="line">  workInProgress.<span class="property">memoizedState</span> = instance.<span class="property">state</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgress.<span class="property">child</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="reconcileChildren"><a href="#reconcileChildren" class="headerlink" title="reconcileChildren"></a><code>reconcileChildren</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildren</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">current</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">workInProgress</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">nextChildren</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">renderLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 挂载</span></span><br><span class="line">    workInProgress.<span class="property">child</span> = <span class="title function_">mountChildFibers</span>(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="ChildReconciler"><a href="#ChildReconciler" class="headerlink" title="ChildReconciler"></a><code>ChildReconciler</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactChildFiber.old.js</span></span><br><span class="line"><span class="keyword">const</span> mountChildFibers = <span class="title class_">ChildReconciler</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ChildReconciler</span>(<span class="params">shouldTrackSideEffects</span>) &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">deleteChild</span>(<span class="params"><span class="attr">returnFiber</span>: <span class="title class_">Fiber</span>, <span class="attr">childToDelete</span>: <span class="title class_">Fiber</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">deleteRemainingChildren</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">returnFiber</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">currentFirstChild</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params">  </span>): <span class="literal">null</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">useFiber</span>(<span class="params"><span class="attr">fiber</span>: <span class="title class_">Fiber</span>, <span class="attr">pendingProps</span>: mixed</span>): <span class="title class_">Fiber</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> clone = <span class="title function_">createWorkInProgress</span>(fiber, pendingProps) <span class="comment">// 构建一个新的 fiber 节点</span></span><br><span class="line">    clone.<span class="property">index</span> = <span class="number">0</span></span><br><span class="line">    clone.<span class="property">sibling</span> = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">return</span> clone</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">placeChild</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">newFiber</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lastPlacedIndex</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">newIndex</span>: <span class="built_in">number</span></span></span><br><span class="line"><span class="params">  </span>): <span class="built_in">number</span> &#123;</span><br><span class="line">    newFiber.<span class="property">index</span> = newIndex</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span> lastPlacedIndex</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回 fiber</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">placeSingleChild</span>(<span class="params"><span class="attr">newFiber</span>: <span class="title class_">Fiber</span></span>): <span class="title class_">Fiber</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> newFiber</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">reconcileSingleTextNode</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">returnFiber</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">currentFirstChild</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">textContent</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Fiber</span> &#123;</span><br><span class="line">    <span class="comment">// There&#x27;s no need to check for keys on text nodes since we don&#x27;t have a</span></span><br><span class="line">    <span class="comment">// way to define them.</span></span><br><span class="line">    <span class="keyword">if</span> (currentFirstChild !== <span class="literal">null</span> &amp;&amp; currentFirstChild.<span class="property">tag</span> === <span class="title class_">HostText</span>) &#123;</span><br><span class="line">      <span class="comment">// We already have an existing node so let&#x27;s just update it and delete</span></span><br><span class="line">      <span class="comment">// the rest.</span></span><br><span class="line">      <span class="title function_">deleteRemainingChildren</span>(returnFiber, currentFirstChild.<span class="property">sibling</span>)</span><br><span class="line">      <span class="keyword">const</span> existing = <span class="title function_">useFiber</span>(currentFirstChild, textContent)</span><br><span class="line">      existing.<span class="property">return</span> = returnFiber</span><br><span class="line">      <span class="keyword">return</span> existing</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The existing first child is not a text node so we need to create one</span></span><br><span class="line">    <span class="comment">// and delete the existing ones.</span></span><br><span class="line">    <span class="title function_">deleteRemainingChildren</span>(returnFiber, currentFirstChild)</span><br><span class="line">    <span class="keyword">const</span> created = <span class="title function_">createFiberFromText</span>(textContent, returnFiber.<span class="property">mode</span>, lanes)</span><br><span class="line">    created.<span class="property">return</span> = returnFiber</span><br><span class="line">    <span class="keyword">return</span> created</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 fiber</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">reconcileSingleElement</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">returnFiber</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">currentFirstChild</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">element</span>: <span class="title class_">ReactElement</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Fiber</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = element.<span class="property">key</span></span><br><span class="line">    <span class="keyword">let</span> child = currentFirstChild</span><br><span class="line">    <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> If key === null and child.key === null, then this only applies to</span></span><br><span class="line">      <span class="comment">// the first item in the list.</span></span><br><span class="line">      <span class="keyword">if</span> (child.<span class="property">key</span> === key) &#123;</span><br><span class="line">        <span class="keyword">const</span> elementType = element.<span class="property">type</span></span><br><span class="line">        <span class="keyword">if</span> (elementType === <span class="variable constant_">REACT_FRAGMENT_TYPE</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (child.<span class="property">tag</span> === <span class="title class_">Fragment</span>) &#123;</span><br><span class="line">            <span class="title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="property">sibling</span>)</span><br><span class="line">            <span class="keyword">const</span> existing = <span class="title function_">useFiber</span>(child, element.<span class="property">props</span>.<span class="property">children</span>)</span><br><span class="line">            existing.<span class="property">return</span> = returnFiber</span><br><span class="line">            <span class="keyword">return</span> existing</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            child.<span class="property">elementType</span> === elementType ||</span><br><span class="line">            (enableLazyElements &amp;&amp;</span><br><span class="line">              <span class="keyword">typeof</span> elementType === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">              elementType !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">              elementType.<span class="property">$$typeof</span> === <span class="variable constant_">REACT_LAZY_TYPE</span> &amp;&amp;</span><br><span class="line">              <span class="title function_">resolveLazy</span>(elementType) === child.<span class="property">type</span>)</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="title function_">deleteRemainingChildren</span>(returnFiber, child.<span class="property">sibling</span>)</span><br><span class="line">            <span class="keyword">const</span> existing = <span class="title function_">useFiber</span>(child, element.<span class="property">props</span>)</span><br><span class="line">            existing.<span class="property">ref</span> = <span class="title function_">coerceRef</span>(returnFiber, child, element)</span><br><span class="line">            existing.<span class="property">return</span> = returnFiber</span><br><span class="line">            <span class="keyword">return</span> existing</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Didn&#x27;t match.</span></span><br><span class="line">        <span class="title function_">deleteRemainingChildren</span>(returnFiber, child)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">deleteChild</span>(returnFiber, child)</span><br><span class="line">      &#125;</span><br><span class="line">      child = child.<span class="property">sibling</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (element.<span class="property">type</span> === <span class="variable constant_">REACT_FRAGMENT_TYPE</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> created = <span class="title function_">createFiberFromFragment</span>(</span><br><span class="line">        element.<span class="property">props</span>.<span class="property">children</span>,</span><br><span class="line">        returnFiber.<span class="property">mode</span>,</span><br><span class="line">        lanes,</span><br><span class="line">        element.<span class="property">key</span></span><br><span class="line">      )</span><br><span class="line">      created.<span class="property">return</span> = returnFiber</span><br><span class="line">      <span class="keyword">return</span> created</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> created = <span class="title function_">createFiberFromElement</span>(element, returnFiber.<span class="property">mode</span>, lanes)</span><br><span class="line">      created.<span class="property">ref</span> = <span class="title function_">coerceRef</span>(returnFiber, currentFirstChild, element)</span><br><span class="line">      created.<span class="property">return</span> = returnFiber</span><br><span class="line">      <span class="keyword">return</span> created</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 children fiber</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">reconcileChildFibers</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">returnFiber</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">currentFirstChild</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">newChild</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">lanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params">  </span>): <span class="title class_">Fiber</span> | <span class="literal">null</span> &#123;</span><br><span class="line">    <span class="comment">// 处理 &lt;&gt;&#123;[...]&#125;&lt;/&gt; 和 &lt;&gt;...&lt;/&gt; 组件，从其中提取 children</span></span><br><span class="line">    <span class="keyword">const</span> isUnkeyedTopLevelFragment =</span><br><span class="line">      <span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp;</span><br><span class="line">      newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      newChild.<span class="property">type</span> === <span class="variable constant_">REACT_FRAGMENT_TYPE</span> &amp;&amp;</span><br><span class="line">      newChild.<span class="property">key</span> === <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">      newChild = newChild.<span class="property">props</span>.<span class="property">children</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对象类型，为 react 组件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&#x27;object&#x27;</span> &amp;&amp; newChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (newChild.<span class="property">$$typeof</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="attr">REACT_ELEMENT_TYPE</span>:</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">placeSingleChild</span>(</span><br><span class="line">            <span class="title function_">reconcileSingleElement</span>(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              lanes</span><br><span class="line">            )</span><br><span class="line">          )</span><br><span class="line">        <span class="comment">// 其它 react 组件类型</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 数组、迭代器，支持 promise 或者 generate</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">&#x27;string&#x27;</span> || <span class="keyword">typeof</span> newChild === <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// 处理字符串或数字类型</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">placeSingleChild</span>(</span><br><span class="line">        <span class="title function_">reconcileSingleTextNode</span>(</span><br><span class="line">          returnFiber,</span><br><span class="line">          currentFirstChild,</span><br><span class="line">          <span class="string">&#x27;&#x27;</span> + newChild,</span><br><span class="line">          lanes</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remaining cases are all treated as empty.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">deleteRemainingChildren</span>(returnFiber, currentFirstChild)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> reconcileChildFibers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="completeUnitOfWork"><a href="#completeUnitOfWork" class="headerlink" title="completeUnitOfWork"></a><code>completeUnitOfWork</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">completeUnitOfWork</span>(<span class="params"><span class="attr">unitOfWork</span>: <span class="title class_">Fiber</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> completedWork = unitOfWork</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> current = completedWork.<span class="property">alternate</span> <span class="comment">// 更新后的 fiber</span></span><br><span class="line">    <span class="keyword">const</span> returnFiber = completedWork.<span class="property">return</span> <span class="comment">// 父节点 fiber</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((completedWork.<span class="property">flags</span> &amp; <span class="title class_">Incomplete</span>) === <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">      <span class="comment">// 任务未完成</span></span><br><span class="line">      <span class="keyword">let</span> next = <span class="title function_">completeWork</span>(current, completedWork, subtreeRenderLanes)</span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Completing this fiber spawned new work. Work on that next.</span></span><br><span class="line">        workInProgress = next</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This fiber did not complete because something threw. Pop values off</span></span><br><span class="line">      <span class="comment">// the stack without entering the complete phase. If this is a boundary,</span></span><br><span class="line">      <span class="comment">// capture values if possible.</span></span><br><span class="line">      <span class="keyword">const</span> next = <span class="title function_">unwindWork</span>(completedWork, subtreeRenderLanes)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Because this fiber did not complete, don&#x27;t reset its expiration time.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If completing this work spawned new work, do that next. We&#x27;ll come</span></span><br><span class="line">        <span class="comment">// back here again.</span></span><br><span class="line">        <span class="comment">// Since we&#x27;re restarting, remove anything that is not a host effect</span></span><br><span class="line">        <span class="comment">// from the effect tag.</span></span><br><span class="line">        next.<span class="property">flags</span> &amp;= <span class="title class_">HostEffectMask</span></span><br><span class="line">        workInProgress = next</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Mark the parent fiber as incomplete and clear its subtree flags.</span></span><br><span class="line">        returnFiber.<span class="property">flags</span> |= <span class="title class_">Incomplete</span></span><br><span class="line">        returnFiber.<span class="property">subtreeFlags</span> = <span class="title class_">NoFlags</span></span><br><span class="line">        returnFiber.<span class="property">deletions</span> = <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> siblingFiber = completedWork.<span class="property">sibling</span></span><br><span class="line">    <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">      workInProgress = siblingFiber</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise, return to the parent</span></span><br><span class="line">    completedWork = returnFiber</span><br><span class="line">    <span class="comment">// Update the next thing we&#x27;re working on in case something throws.</span></span><br><span class="line">    workInProgress = completedWork</span><br><span class="line">  &#125; <span class="keyword">while</span> (completedWork !== <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We&#x27;ve reached the root.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRootExitStatus === <span class="title class_">RootIncomplete</span>) &#123;</span><br><span class="line">    workInProgressRootExitStatus = <span class="title class_">RootCompleted</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="commitRoot"><a href="#commitRoot" class="headerlink" title="commitRoot"></a><code>commitRoot</code></h5><p>调用 <code>commitRootImpl</code> 提交更新</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitRootImpl</span>(<span class="params">root, renderPriorityLevel</span>) &#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// `flushPassiveEffects` will call `flushSyncUpdateQueue` at the end, which</span></span><br><span class="line">    <span class="comment">// means `flushPassiveEffects` will sometimes result in additional</span></span><br><span class="line">    <span class="comment">// passive effects. So we need to keep flushing in a loop until there are</span></span><br><span class="line">    <span class="comment">// no more pending effects.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Might be better if `flushPassiveEffects` did not automatically</span></span><br><span class="line">    <span class="comment">// flush synchronous work at the end, to avoid factoring hazards like this.</span></span><br><span class="line">    <span class="title function_">flushPassiveEffects</span>();</span><br><span class="line">  &#125; <span class="keyword">while</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> finishedWork = root.<span class="property">finishedWork</span>;</span><br><span class="line">  <span class="keyword">const</span> lanes = root.<span class="property">finishedLanes</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (finishedWork === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  root.<span class="property">finishedWork</span> = <span class="literal">null</span>;</span><br><span class="line">  root.<span class="property">finishedLanes</span> = <span class="title class_">NoLanes</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// commitRoot never returns a continuation; it always finishes synchronously.</span></span><br><span class="line">  <span class="comment">// So we can clear these now to allow a new callback to be scheduled.</span></span><br><span class="line">  root.<span class="property">callbackNode</span> = <span class="literal">null</span>;</span><br><span class="line">  root.<span class="property">callbackPriority</span> = <span class="title class_">NoLane</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update the first and last pending times on this root. The new first</span></span><br><span class="line">  <span class="comment">// pending time is whatever is left on the root fiber.</span></span><br><span class="line">  <span class="keyword">let</span> remainingLanes = <span class="title function_">mergeLanes</span>(finishedWork.<span class="property">lanes</span>, finishedWork.<span class="property">childLanes</span>);</span><br><span class="line">  <span class="title function_">markRootFinished</span>(root, remainingLanes);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">    <span class="comment">// We can reset these now that they are finished.</span></span><br><span class="line">    workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line">    workInProgress = <span class="literal">null</span>;</span><br><span class="line">    workInProgressRootRenderLanes = <span class="title class_">NoLanes</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If there are pending passive effects, schedule a callback to process them.</span></span><br><span class="line">  <span class="comment">// Do this as early as possible, so it is queued before anything else that</span></span><br><span class="line">  <span class="comment">// might get scheduled in the commit phase. (See #16714.)</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Delete all other places that schedule the passive effect callback</span></span><br><span class="line">  <span class="comment">// They&#x27;re redundant.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (finishedWork.<span class="property">subtreeFlags</span> &amp; <span class="title class_">PassiveMask</span>) !== <span class="title class_">NoFlags</span> ||</span><br><span class="line">    (finishedWork.<span class="property">flags</span> &amp; <span class="title class_">PassiveMask</span>) !== <span class="title class_">NoFlags</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rootDoesHavePassiveEffects) &#123;</span><br><span class="line">      rootDoesHavePassiveEffects = <span class="literal">true</span>;</span><br><span class="line">      <span class="title function_">scheduleCallback</span>(<span class="title class_">NormalSchedulerPriority</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">flushPassiveEffects</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there are any effects in the whole tree.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This is left over from the effect list implementation, where we had</span></span><br><span class="line">  <span class="comment">// to check for the existence of `firstEffect` to satsify Flow. I think the</span></span><br><span class="line">  <span class="comment">// only other reason this optimization exists is because it affects profiling.</span></span><br><span class="line">  <span class="comment">// Reconsider whether this is necessary.</span></span><br><span class="line">  <span class="keyword">const</span> subtreeHasEffects =</span><br><span class="line">    (finishedWork.<span class="property">subtreeFlags</span> &amp;</span><br><span class="line">      (<span class="title class_">BeforeMutationMask</span> | <span class="title class_">MutationMask</span> | <span class="title class_">LayoutMask</span> | <span class="title class_">PassiveMask</span>)) !==</span><br><span class="line">    <span class="title class_">NoFlags</span>;</span><br><span class="line">  <span class="keyword">const</span> rootHasEffect =</span><br><span class="line">    (finishedWork.<span class="property">flags</span> &amp;</span><br><span class="line">      (<span class="title class_">BeforeMutationMask</span> | <span class="title class_">MutationMask</span> | <span class="title class_">LayoutMask</span> | <span class="title class_">PassiveMask</span>)) !==</span><br><span class="line">    <span class="title class_">NoFlags</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (subtreeHasEffects || rootHasEffect) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevTransition = <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span>;</span><br><span class="line">    <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> previousPriority = <span class="title function_">getCurrentUpdatePriority</span>();</span><br><span class="line">    <span class="title function_">setCurrentUpdatePriority</span>(<span class="title class_">DiscreteEventPriority</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">    executionContext |= <span class="title class_">CommitContext</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset this to null before calling lifecycles</span></span><br><span class="line">    <span class="title class_">ReactCurrentOwner</span>.<span class="property">current</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The commit phase is broken into several sub-phases. We do a separate pass</span></span><br><span class="line">    <span class="comment">// of the effect list for each phase: all mutation effects come before all</span></span><br><span class="line">    <span class="comment">// layout effects, and so on.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The first phase a &quot;before mutation&quot; phase. We use this phase to read the</span></span><br><span class="line">    <span class="comment">// state of the host tree right before we mutate it. This is where</span></span><br><span class="line">    <span class="comment">// getSnapshotBeforeUpdate is called.</span></span><br><span class="line">    <span class="keyword">const</span> shouldFireAfterActiveInstanceBlur = <span class="title function_">commitBeforeMutationEffects</span>(</span><br><span class="line">      root,</span><br><span class="line">      finishedWork,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      <span class="comment">// Mark the current commit time to be shared by all Profilers in this</span></span><br><span class="line">      <span class="comment">// batch. This enables them to be grouped later.</span></span><br><span class="line">      <span class="title function_">recordCommitTime</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">      <span class="comment">// Track the root here, rather than in commitLayoutEffects(), because of ref setters.</span></span><br><span class="line">      <span class="comment">// Updates scheduled during ref detachment should also be flagged.</span></span><br><span class="line">      rootCommittingMutationOrLayoutEffects = root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The next phase is the mutation phase, where we mutate the host tree.</span></span><br><span class="line">    <span class="title function_">commitMutationEffects</span>(root, finishedWork, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldFireAfterActiveInstanceBlur) &#123;</span><br><span class="line">      <span class="title function_">afterActiveInstanceBlur</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">resetAfterCommit</span>(root.<span class="property">containerInfo</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The work-in-progress tree is now the current tree. This must come after</span></span><br><span class="line">    <span class="comment">// the mutation phase, so that the previous tree is still current during</span></span><br><span class="line">    <span class="comment">// componentWillUnmount, but before the layout phase, so that the finished</span></span><br><span class="line">    <span class="comment">// work is current during componentDidMount/Update.</span></span><br><span class="line">    root.<span class="property">current</span> = finishedWork;</span><br><span class="line">    <span class="title function_">commitLayoutEffects</span>(finishedWork, root, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">      rootCommittingMutationOrLayoutEffects = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell Scheduler to yield at the end of the frame, so the browser has an</span></span><br><span class="line">    <span class="comment">// opportunity to paint.</span></span><br><span class="line">    <span class="title function_">requestPaint</span>();</span><br><span class="line"></span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the priority to the previous non-sync value.</span></span><br><span class="line">    <span class="title function_">setCurrentUpdatePriority</span>(previousPriority);</span><br><span class="line">    <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span> = prevTransition;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No effects.</span></span><br><span class="line">    root.<span class="property">current</span> = finishedWork;</span><br><span class="line">    <span class="comment">// Measure these anyway so the flamegraph explicitly shows that there were</span></span><br><span class="line">    <span class="comment">// no effects.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Maybe there&#x27;s a better way to report this.</span></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      <span class="title function_">recordCommitTime</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> rootDidHavePassiveEffects = rootDoesHavePassiveEffects;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rootDoesHavePassiveEffects) &#123;</span><br><span class="line">    <span class="comment">// This commit has passive effects. Stash a reference to them. But don&#x27;t</span></span><br><span class="line">    <span class="comment">// schedule a callback until after flushing layout work.</span></span><br><span class="line">    rootDoesHavePassiveEffects = <span class="literal">false</span>;</span><br><span class="line">    rootWithPendingPassiveEffects = root;</span><br><span class="line">    pendingPassiveEffectsLanes = lanes;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read this again, since an effect might have updated it</span></span><br><span class="line">  remainingLanes = root.<span class="property">pendingLanes</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there&#x27;s remaining work on this root</span></span><br><span class="line">  <span class="keyword">if</span> (remainingLanes === <span class="title class_">NoLanes</span>) &#123;</span><br><span class="line">    <span class="comment">// If there&#x27;s no remaining work, we can clear the set of already failed</span></span><br><span class="line">    <span class="comment">// error boundaries.</span></span><br><span class="line">    legacyErrorBoundariesThatAlreadyFailed = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">includesSomeLane</span>(remainingLanes, (<span class="title class_">SyncLane</span>: <span class="title class_">Lane</span>))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdatePhase) &#123;</span><br><span class="line">      <span class="title function_">markNestedUpdateScheduled</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Count the number of times the root synchronously re-renders without</span></span><br><span class="line">    <span class="comment">// finishing. If there are too many, it indicates an infinite update loop.</span></span><br><span class="line">    <span class="keyword">if</span> (root === rootWithNestedUpdates) &#123;</span><br><span class="line">      nestedUpdateCount++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">      rootWithNestedUpdates = root;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Always call this before exiting `commitRoot`, to ensure that any</span></span><br><span class="line">  <span class="comment">// additional work on this root is scheduled.</span></span><br><span class="line">  <span class="title function_">ensureRootIsScheduled</span>(root, <span class="title function_">now</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasUncaughtError) &#123;</span><br><span class="line">    hasUncaughtError = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> error = firstUncaughtError;</span><br><span class="line">    firstUncaughtError = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((executionContext &amp; <span class="title class_">LegacyUnbatchedContext</span>) !== <span class="title class_">NoContext</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">      <span class="title function_">markCommitStopped</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is a legacy edge case. We just committed the initial mount of</span></span><br><span class="line">    <span class="comment">// a ReactDOM.render-ed root inside of batchedUpdates. The commit fired</span></span><br><span class="line">    <span class="comment">// synchronously, but layout updates should be deferred until the end</span></span><br><span class="line">    <span class="comment">// of the batch.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the passive effects are the result of a discrete render, flush them</span></span><br><span class="line">  <span class="comment">// synchronously at the end of the current task so that the result is</span></span><br><span class="line">  <span class="comment">// immediately observable. Otherwise, we assume that they are not</span></span><br><span class="line">  <span class="comment">// order-dependent and do not need to be observed by external systems, so we</span></span><br><span class="line">  <span class="comment">// can wait until after paint.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> We can optimize this by not scheduling the callback earlier. Since we</span></span><br><span class="line">  <span class="comment">// currently schedule the callback in multiple places, will wait until those</span></span><br><span class="line">  <span class="comment">// are consolidated.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="title function_">includesSomeLane</span>(pendingPassiveEffectsLanes, <span class="title class_">SyncLane</span>) &amp;&amp;</span><br><span class="line">    root.<span class="property">tag</span> !== <span class="title class_">LegacyRoot</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">flushPassiveEffects</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If layout work was scheduled, flush it now.</span></span><br><span class="line">  <span class="title function_">flushSyncCallbacks</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    <span class="title function_">markCommitStopped</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="flushPassiveEffects"><a href="#flushPassiveEffects" class="headerlink" title="flushPassiveEffects"></a><code>flushPassiveEffects</code></h5><p>调用 <code>flushPassiveEffectsImpl</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">flushPassiveEffectsImpl</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (rootWithPendingPassiveEffects === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = rootWithPendingPassiveEffects;</span><br><span class="line">  <span class="keyword">const</span> lanes = pendingPassiveEffectsLanes;</span><br><span class="line">  rootWithPendingPassiveEffects = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This is sometimes out of sync with rootWithPendingPassiveEffects.</span></span><br><span class="line">  <span class="comment">// Figure out why and fix it. It&#x27;s not causing any known issues (probably</span></span><br><span class="line">  <span class="comment">// because it&#x27;s only used for profiling), but it&#x27;s a refactor hazard.</span></span><br><span class="line">  pendingPassiveEffectsLanes = <span class="title class_">NoLanes</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">  executionContext |= <span class="title class_">CommitContext</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">commitPassiveUnmountEffects</span>(root.<span class="property">current</span>);</span><br><span class="line">  <span class="title function_">commitPassiveMountEffects</span>(root, root.<span class="property">current</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Move to commitPassiveMountEffects</span></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) &#123;</span><br><span class="line">    <span class="keyword">const</span> profilerEffects = pendingPassiveProfilerEffects;</span><br><span class="line">    pendingPassiveProfilerEffects = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; profilerEffects.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> fiber = ((profilerEffects[i]: <span class="built_in">any</span>): <span class="title class_">Fiber</span>);</span><br><span class="line">      <span class="title function_">commitPassiveEffectDurations</span>(root, fiber);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  executionContext = prevExecutionContext;</span><br><span class="line">  <span class="title function_">flushSyncCallbacks</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If additional passive effects were scheduled, increment a counter. If this</span></span><br><span class="line">  <span class="comment">// exceeds the limit, we&#x27;ll fire a warning.</span></span><br><span class="line">  nestedPassiveUpdateCount =</span><br><span class="line">    rootWithPendingPassiveEffects === <span class="literal">null</span> ? <span class="number">0</span> : nestedPassiveUpdateCount + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = root.<span class="property">current</span>.<span class="property">stateNode</span>;</span><br><span class="line">    stateNode.<span class="property">effectDuration</span> = <span class="number">0</span>;</span><br><span class="line">    stateNode.<span class="property">passiveEffectDuration</span> = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="commitPassiveUnmountEffects"><a href="#commitPassiveUnmountEffects" class="headerlink" title="commitPassiveUnmountEffects"></a><code>commitPassiveUnmountEffects</code></h5><p>执行生命周期钩子，当进入节点时立即执行生命周期函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<p>调用 <code>commitPassiveUnmountEffects_begin</code> 开启操作，<code>commitPassiveUnmountEffects_complete</code> 完成操作</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect 全局变量</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountEffects_begin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// curr -&gt; child -&gt; child</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> child = fiber.<span class="property">child</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((nextEffect.<span class="property">flags</span> &amp; <span class="title class_">ChildDeletion</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> deletions = fiber.<span class="property">deletions</span></span><br><span class="line">      <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.<span class="property">length</span>; i++) &#123;</span><br><span class="line">          <span class="keyword">const</span> fiberToDelete = deletions[i]</span><br><span class="line">          nextEffect = fiberToDelete</span><br><span class="line">          <span class="title function_">commitPassiveUnmountEffectsInsideOfDeletedTree_begin</span>(</span><br><span class="line">            fiberToDelete,</span><br><span class="line">            fiber</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="comment">// A fiber was deleted from this parent fiber, but it&#x27;s still part of</span></span><br><span class="line">          <span class="comment">// the previous (alternate) parent fiber&#x27;s list of children. Because</span></span><br><span class="line">          <span class="comment">// children are a linked list, an earlier sibling that&#x27;s still alive</span></span><br><span class="line">          <span class="comment">// will be connected to the deleted fiber via its `alternate`:</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          <span class="comment">//   live fiber</span></span><br><span class="line">          <span class="comment">//   --alternate--&gt; previous live fiber</span></span><br><span class="line">          <span class="comment">//   --sibling--&gt; deleted fiber</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          <span class="comment">// We can&#x27;t disconnect `alternate` on nodes that haven&#x27;t been deleted</span></span><br><span class="line">          <span class="comment">// yet, but we can disconnect the `sibling` and `child` pointers.</span></span><br><span class="line">          <span class="keyword">const</span> previousFiber = fiber.<span class="property">alternate</span></span><br><span class="line">          <span class="keyword">if</span> (previousFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> detachedChild = previousFiber.<span class="property">child</span></span><br><span class="line">            <span class="keyword">if</span> (detachedChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">              previousFiber.<span class="property">child</span> = <span class="literal">null</span></span><br><span class="line">              <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> detachedSibling = detachedChild.<span class="property">sibling</span></span><br><span class="line">                detachedChild.<span class="property">sibling</span> = <span class="literal">null</span></span><br><span class="line">                detachedChild = detachedSibling</span><br><span class="line">              &#125; <span class="keyword">while</span> (detachedChild !== <span class="literal">null</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nextEffect = fiber</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fiber.<span class="property">subtreeFlags</span> &amp; <span class="title class_">PassiveMask</span>) !== <span class="title class_">NoFlags</span> &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(child, fiber) <span class="comment">// 确保父节点指向 fiber</span></span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">commitPassiveUnmountEffects_complete</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountEffects_complete</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 若存在兄弟节点则遍历下一个兄弟节点，否则返回父节点</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">if</span> ((fiber.<span class="property">flags</span> &amp; <span class="title class_">Passive</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">      <span class="title function_">commitPassiveUnmountOnFiber</span>(fiber)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.<span class="property">sibling</span></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(sibling, fiber.<span class="property">return</span>)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect = fiber.<span class="property">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountOnFiber</span>(<span class="params"><span class="attr">finishedWork</span>: <span class="title class_">Fiber</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">        <span class="title function_">commitHookEffectListUnmount</span>(</span><br><span class="line">          <span class="title class_">HookPassive</span> | <span class="title class_">HookHasEffect</span>,</span><br><span class="line">          finishedWork,</span><br><span class="line">          finishedWork.<span class="property">return</span>,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountEffectsInsideOfDeletedTree_begin</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">deletedSubtreeRoot</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">nearestMountedAncestor</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// p-&gt; child -&gt; child</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="comment">// Deletion effects fire in parent -&gt; child order</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Check if fiber has a PassiveStatic flag</span></span><br><span class="line">    <span class="title function_">commitPassiveUnmountInsideDeletedTreeOnFiber</span>(fiber, nearestMountedAncestor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.<span class="property">child</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Only traverse subtree if it has a PassiveStatic flag. (But, if we</span></span><br><span class="line">    <span class="comment">// do this, still need to handle `deletedTreeCleanUpLevel` correctly.)</span></span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">commitPassiveUnmountEffectsInsideOfDeletedTree_complete</span>(</span><br><span class="line">        deletedSubtreeRoot</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountInsideDeletedTreeOnFiber</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">current</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">nearestMountedAncestor</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (current.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">      <span class="title function_">commitHookEffectListUnmount</span>(<span class="title class_">HookPassive</span>, current, nearestMountedAncestor)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁组件，要销毁的组件存在 updateQueue 中</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitHookEffectListUnmount</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">flags</span>: <span class="title class_">HookFlags</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">finishedWork</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">nearestMountedAncestor</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">updateQueue</span>: <span class="title class_">FunctionComponentUpdateQueue</span> | <span class="literal">null</span> = (finishedWork.<span class="property">updateQueue</span>: <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">const</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.<span class="property">lastEffect</span> : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstEffect = lastEffect.<span class="property">next</span>;</span><br><span class="line">    <span class="keyword">let</span> effect = firstEffect;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((effect.<span class="property">tag</span> &amp; flags) === flags) &#123;</span><br><span class="line">        <span class="comment">// Unmount</span></span><br><span class="line">        <span class="keyword">const</span> destroy = effect.<span class="property">destroy</span>;</span><br><span class="line">        effect.<span class="property">destroy</span> = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          <span class="title function_">safelyCallDestroy</span>(finishedWork, nearestMountedAncestor, destroy); <span class="comment">// 调用 destroy 销毁组件</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      effect = effect.<span class="property">next</span>;</span><br><span class="line">    &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveUnmountEffectsInsideOfDeletedTree_complete</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">deletedSubtreeRoot</span>: <span class="title class_">Fiber</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.<span class="property">sibling</span></span><br><span class="line">    <span class="keyword">const</span> returnFiber = fiber.<span class="property">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="comment">// Recursively traverse the entire deleted tree and clean up fiber fields.</span></span><br><span class="line">      <span class="comment">// This is more aggressive than ideal, and the long term goal is to only</span></span><br><span class="line">      <span class="comment">// have to detach the deleted tree at the root.</span></span><br><span class="line">      <span class="title function_">detachFiberAfterEffects</span>(fiber)</span><br><span class="line">      <span class="keyword">if</span> (fiber === deletedSubtreeRoot) &#123;</span><br><span class="line">        nextEffect = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This is the default branch (level 0). We do not recursively clear all</span></span><br><span class="line">      <span class="comment">// the fiber fields. Only the root of the deleted subtree.</span></span><br><span class="line">      <span class="keyword">if</span> (fiber === deletedSubtreeRoot) &#123;</span><br><span class="line">        <span class="title function_">detachFiberAfterEffects</span>(fiber)</span><br><span class="line">        nextEffect = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(sibling, returnFiber)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = returnFiber</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">detachFiberAfterEffects</span>(<span class="params"><span class="attr">fiber</span>: <span class="title class_">Fiber</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> alternate = fiber.<span class="property">alternate</span></span><br><span class="line">  <span class="keyword">if</span> (alternate !== <span class="literal">null</span>) &#123;</span><br><span class="line">    fiber.<span class="property">alternate</span> = <span class="literal">null</span></span><br><span class="line">    <span class="title function_">detachFiberAfterEffects</span>(alternate)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: Defensively using negation instead of &lt; in case</span></span><br><span class="line">  <span class="comment">// `deletedTreeCleanUpLevel` is undefined.</span></span><br><span class="line">  <span class="keyword">if</span> (!(deletedTreeCleanUpLevel &gt;= <span class="number">2</span>)) &#123;</span><br><span class="line">    <span class="comment">// This is the default branch (level 0).</span></span><br><span class="line">    fiber.<span class="property">child</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">deletions</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">dependencies</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">memoizedProps</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">memoizedState</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">pendingProps</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">sibling</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">stateNode</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">updateQueue</span> = <span class="literal">null</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Clear cyclical Fiber fields. This level alone is designed to roughly</span></span><br><span class="line">    <span class="comment">// approximate the planned Fiber refactor. In that world, `setState` will be</span></span><br><span class="line">    <span class="comment">// bound to a special &quot;instance&quot; object instead of a Fiber. The Instance</span></span><br><span class="line">    <span class="comment">// object will not have any of these fields. It will only be connected to</span></span><br><span class="line">    <span class="comment">// the fiber tree via a single link at the root. So if this level alone is</span></span><br><span class="line">    <span class="comment">// sufficient to fix memory issues, that bodes well for our plans.</span></span><br><span class="line">    fiber.<span class="property">child</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">deletions</span> = <span class="literal">null</span></span><br><span class="line">    fiber.<span class="property">sibling</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The `stateNode` is cyclical because on host nodes it points to the host</span></span><br><span class="line">    <span class="comment">// tree, which has its own pointers to children, parents, and siblings.</span></span><br><span class="line">    <span class="comment">// The other host nodes also point back to fibers, so we should detach that</span></span><br><span class="line">    <span class="comment">// one, too.</span></span><br><span class="line">    <span class="keyword">if</span> (fiber.<span class="property">tag</span> === <span class="title class_">HostComponent</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">hostInstance</span>: <span class="title class_">Instance</span> = fiber.<span class="property">stateNode</span></span><br><span class="line">      <span class="keyword">if</span> (hostInstance !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title function_">detachDeletedInstance</span>(hostInstance) <span class="comment">// 删除 react 相关属性，包括事件、容器等</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fiber.<span class="property">stateNode</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="comment">// Theoretically, nothing in here should be necessary, because we already</span></span><br><span class="line">      <span class="comment">// disconnected the fiber from the tree. So even if something leaks this</span></span><br><span class="line">      <span class="comment">// particular fiber, it won&#x27;t leak anything else</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// The purpose of this branch is to be super aggressive so we can measure</span></span><br><span class="line">      <span class="comment">// if there&#x27;s any difference in memory impact. If there is, that could</span></span><br><span class="line">      <span class="comment">// indicate a React leak we don&#x27;t know about.</span></span><br><span class="line">      fiber.<span class="property">return</span> = <span class="literal">null</span></span><br><span class="line">      fiber.<span class="property">dependencies</span> = <span class="literal">null</span></span><br><span class="line">      fiber.<span class="property">memoizedProps</span> = <span class="literal">null</span></span><br><span class="line">      fiber.<span class="property">memoizedState</span> = <span class="literal">null</span></span><br><span class="line">      fiber.<span class="property">pendingProps</span> = <span class="literal">null</span></span><br><span class="line">      fiber.<span class="property">stateNode</span> = <span class="literal">null</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Move to `commitPassiveUnmountInsideDeletedTreeOnFiber` instead.</span></span><br><span class="line">      fiber.<span class="property">updateQueue</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="commitBeforeMutationEffects"><a href="#commitBeforeMutationEffects" class="headerlink" title="commitBeforeMutationEffects"></a><code>commitBeforeMutationEffects</code></h5><p>执行生命周期钩子，当进入节点时立即执行生命周期函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle 全局变量</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">root</span>: <span class="title class_">FiberRoot</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">firstChild</span>: <span class="title class_">Fiber</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  focusedInstanceHandle = <span class="title function_">prepareForCommit</span>(root.<span class="property">containerInfo</span>) <span class="comment">// 查找活跃的的节点</span></span><br><span class="line"></span><br><span class="line">  nextEffect = firstChild</span><br><span class="line">  <span class="title function_">commitBeforeMutationEffects_begin</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We no longer need to track the active instance fiber</span></span><br><span class="line">  <span class="keyword">const</span> shouldFire = shouldFireAfterActiveInstanceBlur</span><br><span class="line">  shouldFireAfterActiveInstanceBlur = <span class="literal">false</span></span><br><span class="line">  focusedInstanceHandle = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> shouldFire</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects_begin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should wrap this in flags check, too, as optimization</span></span><br><span class="line">    <span class="keyword">const</span> deletions = fiber.<span class="property">deletions</span></span><br><span class="line">    <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> deletion = deletions[i]</span><br><span class="line">        <span class="title function_">commitBeforeMutationEffectsDeletion</span>(deletion)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.<span class="property">child</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (fiber.<span class="property">subtreeFlags</span> &amp; <span class="title class_">BeforeMutationMask</span>) !== <span class="title class_">NoFlags</span> &amp;&amp;</span><br><span class="line">      child !== <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">commitBeforeMutationEffects_complete</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects_complete</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 先兄弟节点再父节点</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="title function_">commitBeforeMutationEffectsOnFiber</span>(fiber)</span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.<span class="property">sibling</span></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(sibling, fiber.<span class="property">return</span>)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.<span class="property">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffectsOnFiber</span>(<span class="params"><span class="attr">finishedWork</span>: <span class="title class_">Fiber</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span></span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.<span class="property">flags</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!shouldFireAfterActiveInstanceBlur &amp;&amp; focusedInstanceHandle !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Check to see if the focused element was inside of a hidden (Suspense) subtree.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Move this out of the hot path using a dedicated effect tag.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      finishedWork.<span class="property">tag</span> === <span class="title class_">SuspenseComponent</span> &amp;&amp;</span><br><span class="line">      <span class="title function_">isSuspenseBoundaryBeingHidden</span>(current, finishedWork) &amp;&amp;</span><br><span class="line">      <span class="title function_">doesFiberContain</span>(finishedWork, focusedInstanceHandle)</span><br><span class="line">    ) &#123;</span><br><span class="line">      shouldFireAfterActiveInstanceBlur = <span class="literal">true</span></span><br><span class="line">      <span class="title function_">beforeActiveInstanceBlur</span>(finishedWork)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((flags &amp; <span class="title class_">Snapshot</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevProps = current.<span class="property">memoizedProps</span></span><br><span class="line">          <span class="keyword">const</span> prevState = current.<span class="property">memoizedState</span></span><br><span class="line">          <span class="keyword">const</span> instance = finishedWork.<span class="property">stateNode</span></span><br><span class="line">          <span class="keyword">const</span> snapshot = instance.<span class="title function_">getSnapshotBeforeUpdate</span>(</span><br><span class="line">            finishedWork.<span class="property">elementType</span> === finishedWork.<span class="property">type</span></span><br><span class="line">              ? prevProps</span><br><span class="line">              : <span class="title function_">resolveDefaultProps</span>(finishedWork.<span class="property">type</span>, prevProps),</span><br><span class="line">            prevState</span><br><span class="line">          )</span><br><span class="line">          instance.<span class="property">__reactInternalSnapshotBeforeUpdate</span> = snapshot</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostRoot</span>: &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsMutation) &#123;</span><br><span class="line">          <span class="keyword">const</span> root = finishedWork.<span class="property">stateNode</span></span><br><span class="line">          <span class="title function_">clearContainer</span>(root.<span class="property">containerInfo</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostText</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostPortal</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">IncompleteClassComponent</span>:</span><br><span class="line">        <span class="comment">// Nothing to do for these component types</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="attr">default</span>: &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffectsDeletion</span>(<span class="params"><span class="attr">deletion</span>: <span class="title class_">Fiber</span></span>) &#123;</span><br><span class="line">  <span class="comment">// TODO (effects) It would be nice to avoid calling doesFiberContain()</span></span><br><span class="line">  <span class="comment">// Maybe we can repurpose one of the subtreeFlags positions for this instead?</span></span><br><span class="line">  <span class="comment">// Use it to store which part of the tree the focused instance is in?</span></span><br><span class="line">  <span class="comment">// This assumes we can safely determine that instance during the &quot;render&quot; phase.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">doesFiberContain</span>(deletion, focusedInstanceHandle)) &#123;</span><br><span class="line">    shouldFireAfterActiveInstanceBlur = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">beforeActiveInstanceBlur</span>(deletion)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="commitMutationEffects"><a href="#commitMutationEffects" class="headerlink" title="commitMutationEffects"></a><code>commitMutationEffects</code></h5><p>构建 dom 节点，在离开节点时开始 dom 构建<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle,inProgressLanes,inProgressRoot 全局变量</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffects</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">root</span>: <span class="title class_">FiberRoot</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">firstChild</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">committedLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  inProgressLanes = committedLanes</span><br><span class="line">  inProgressRoot = root</span><br><span class="line">  nextEffect = firstChild</span><br><span class="line"></span><br><span class="line">  <span class="title function_">commitMutationEffects_begin</span>(root)</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span></span><br><span class="line">  inProgressRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffects_begin</span>(<span class="params"><span class="attr">root</span>: <span class="title class_">FiberRoot</span></span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should wrap this in flags check, too, as optimization</span></span><br><span class="line">    <span class="keyword">const</span> deletions = fiber.<span class="property">deletions</span></span><br><span class="line">    <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> childToDelete = deletions[i]</span><br><span class="line">        <span class="title function_">commitDeletion</span>(root, childToDelete, fiber)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.<span class="property">child</span></span><br><span class="line">    <span class="keyword">if</span> ((fiber.<span class="property">subtreeFlags</span> &amp; <span class="title class_">MutationMask</span>) !== <span class="title class_">NoFlags</span> &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">commitMutationEffects_complete</span>(root)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffects_complete</span>(<span class="params"><span class="attr">root</span>: <span class="title class_">FiberRoot</span></span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="title function_">commitMutationEffectsOnFiber</span>(fiber, root)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.<span class="property">sibling</span></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(sibling, fiber.<span class="property">return</span>)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.<span class="property">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffectsOnFiber</span>(<span class="params"><span class="attr">finishedWork</span>: <span class="title class_">Fiber</span>, <span class="attr">root</span>: <span class="title class_">FiberRoot</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.<span class="property">flags</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; <span class="title class_">ContentReset</span>) &#123;</span><br><span class="line">    <span class="title function_">commitResetTextContent</span>(finishedWork)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span></span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">commitDetachRef</span>(current)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> This is a temporary solution that allowed us to transition away</span></span><br><span class="line">      <span class="comment">// from React Flare on www.</span></span><br><span class="line">      <span class="keyword">if</span> (finishedWork.<span class="property">tag</span> === <span class="title class_">ScopeComponent</span>) &#123;</span><br><span class="line">        <span class="title function_">commitAttachRef</span>(finishedWork)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The following switch statement is only concerned about placement,</span></span><br><span class="line">  <span class="comment">// updates, and deletions. To avoid needing to add a case for every possible</span></span><br><span class="line">  <span class="comment">// bitmap value, we remove the secondary effects from the effect tag and</span></span><br><span class="line">  <span class="comment">// switch on that value.</span></span><br><span class="line">  <span class="keyword">const</span> primaryFlags = flags &amp; (<span class="title class_">Placement</span> | <span class="title class_">Update</span> | <span class="title class_">Hydrating</span>)</span><br><span class="line">  <span class="keyword">switch</span> (primaryFlags) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Placement</span>: &#123;</span><br><span class="line">      <span class="title function_">commitPlacement</span>(finishedWork)</span><br><span class="line">      <span class="comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is</span></span><br><span class="line">      <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> findDOMNode doesn&#x27;t rely on this any more but isMounted does</span></span><br><span class="line">      <span class="comment">// and isMounted is deprecated anyway so we should be able to kill this.</span></span><br><span class="line">      finishedWork.<span class="property">flags</span> &amp;= ~<span class="title class_">Placement</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">PlacementAndUpdate</span>: &#123;</span><br><span class="line">      <span class="comment">// Placement</span></span><br><span class="line">      <span class="title function_">commitPlacement</span>(finishedWork)</span><br><span class="line">      <span class="comment">// Clear the &quot;placement&quot; from effect tag so that we know that this is</span></span><br><span class="line">      <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">      finishedWork.<span class="property">flags</span> &amp;= ~<span class="title class_">Placement</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span></span><br><span class="line">      <span class="title function_">commitWork</span>(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Hydrating</span>: &#123;</span><br><span class="line">      finishedWork.<span class="property">flags</span> &amp;= ~<span class="title class_">Hydrating</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HydratingAndUpdate</span>: &#123;</span><br><span class="line">      finishedWork.<span class="property">flags</span> &amp;= ~<span class="title class_">Hydrating</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span></span><br><span class="line">      <span class="title function_">commitWork</span>(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Update</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.<span class="property">alternate</span></span><br><span class="line">      <span class="title function_">commitWork</span>(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitWork</span>(<span class="params"><span class="attr">current</span>: <span class="title class_">Fiber</span> | <span class="literal">null</span>, <span class="attr">finishedWork</span>: <span class="title class_">Fiber</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">MemoComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">        <span class="comment">// Layout effects are destroyed during the mutation phase so that all</span></span><br><span class="line">        <span class="comment">// destroy functions for all fibers are called before any create functions.</span></span><br><span class="line">        <span class="comment">// This prevents sibling component effects from interfering with each other,</span></span><br><span class="line">        <span class="comment">// e.g. a destroy function in one component should never override a ref set</span></span><br><span class="line">        <span class="comment">// by a create function in another component during the same commit.</span></span><br><span class="line"></span><br><span class="line">          <span class="title function_">commitHookEffectListUnmount</span>(</span><br><span class="line">            <span class="title class_">HookLayout</span> | <span class="title class_">HookHasEffect</span>,</span><br><span class="line">            finishedWork,</span><br><span class="line">            finishedWork.<span class="property">return</span>,</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">Profiler</span>: &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">SuspenseComponent</span>: &#123;</span><br><span class="line">        <span class="title function_">commitSuspenseComponent</span>(finishedWork);</span><br><span class="line">        <span class="title function_">attachSuspenseRetryListeners</span>(finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">SuspenseListComponent</span>: &#123;</span><br><span class="line">        <span class="title function_">attachSuspenseRetryListeners</span>(finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostRoot</span>: &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsHydration) &#123;</span><br><span class="line">          <span class="keyword">const</span> <span class="attr">root</span>: <span class="title class_">FiberRoot</span> = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">          <span class="keyword">if</span> (root.<span class="property">hydrate</span>) &#123;</span><br><span class="line">            <span class="comment">// We&#x27;ve just hydrated. No need to hydrate again.</span></span><br><span class="line">            root.<span class="property">hydrate</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="title function_">commitHydratedContainer</span>(root.<span class="property">containerInfo</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">OffscreenComponent</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">LegacyHiddenComponent</span>: &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">commitContainer</span>(finishedWork);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">MemoComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">      <span class="comment">// Layout effects are destroyed during the mutation phase so that all</span></span><br><span class="line">      <span class="comment">// destroy functions for all fibers are called before any create functions.</span></span><br><span class="line">      <span class="comment">// This prevents sibling component effects from interfering with each other,</span></span><br><span class="line">      <span class="comment">// e.g. a destroy function in one component should never override a ref set</span></span><br><span class="line">      <span class="comment">// by a create function in another component during the same commit.</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_">commitHookEffectListUnmount</span>(</span><br><span class="line">          <span class="title class_">HookLayout</span> | <span class="title class_">HookHasEffect</span>,</span><br><span class="line">          finishedWork,</span><br><span class="line">          finishedWork.<span class="property">return</span>,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">instance</span>: <span class="title class_">Instance</span> = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">      <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Commit the work prepared earlier.</span></span><br><span class="line">        <span class="keyword">const</span> newProps = finishedWork.<span class="property">memoizedProps</span>;</span><br><span class="line">        <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">        <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">        <span class="comment">// this case.</span></span><br><span class="line">        <span class="keyword">const</span> oldProps = current !== <span class="literal">null</span> ? current.<span class="property">memoizedProps</span> : newProps;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">type</span> = finishedWork.<span class="property">type</span>;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Type the updateQueue to be specific to host components.</span></span><br><span class="line">        <span class="keyword">const</span> <span class="attr">updatePayload</span>: <span class="literal">null</span> | <span class="title class_">UpdatePayload</span> = (finishedWork.<span class="property">updateQueue</span>: <span class="built_in">any</span>);</span><br><span class="line">        finishedWork.<span class="property">updateQueue</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (updatePayload !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="title function_">commitUpdate</span>(</span><br><span class="line">            instance,</span><br><span class="line">            updatePayload,</span><br><span class="line">            <span class="keyword">type</span>,</span><br><span class="line">            oldProps,</span><br><span class="line">            newProps,</span><br><span class="line">            finishedWork,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostText</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">textInstance</span>: <span class="title class_">TextInstance</span> = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">newText</span>: <span class="built_in">string</span> = finishedWork.<span class="property">memoizedProps</span>;</span><br><span class="line">      <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">      <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">      <span class="comment">// this case.</span></span><br><span class="line">      <span class="keyword">const</span> <span class="attr">oldText</span>: <span class="built_in">string</span> =</span><br><span class="line">        current !== <span class="literal">null</span> ? current.<span class="property">memoizedProps</span> : newText;</span><br><span class="line">      <span class="title function_">commitTextUpdate</span>(textInstance, oldText, newText);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostRoot</span>: &#123;</span><br><span class="line">      <span class="keyword">if</span> (supportsHydration) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="attr">root</span>: <span class="title class_">FiberRoot</span> = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">        <span class="keyword">if</span> (root.<span class="property">hydrate</span>) &#123;</span><br><span class="line">          <span class="comment">// We&#x27;ve just hydrated. No need to hydrate again.</span></span><br><span class="line">          root.<span class="property">hydrate</span> = <span class="literal">false</span>;</span><br><span class="line">          <span class="title function_">commitHydratedContainer</span>(root.<span class="property">containerInfo</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Profiler</span>: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SuspenseComponent</span>: &#123;</span><br><span class="line">      <span class="title function_">commitSuspenseComponent</span>(finishedWork);</span><br><span class="line">      <span class="title function_">attachSuspenseRetryListeners</span>(finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SuspenseListComponent</span>: &#123;</span><br><span class="line">      <span class="title function_">attachSuspenseRetryListeners</span>(finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">IncompleteClassComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ScopeComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">        <span class="keyword">const</span> scopeInstance = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">        <span class="title function_">prepareScopeUpdate</span>(scopeInstance, finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">OffscreenComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">LegacyHiddenComponent</span>: &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">newState</span>: <span class="title class_">OffscreenState</span> | <span class="literal">null</span> = finishedWork.<span class="property">memoizedState</span>;</span><br><span class="line">      <span class="keyword">const</span> isHidden = newState !== <span class="literal">null</span>;</span><br><span class="line">      <span class="title function_">hideOrUnhideAllChildren</span>(finishedWork, isHidden);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitPlacement</span>(<span class="params"><span class="attr">finishedWork</span>: <span class="title class_">Fiber</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Recursively insert all host nodes into the parent.</span></span><br><span class="line">  <span class="keyword">const</span> parentFiber = <span class="title function_">getHostParentFiber</span>(finishedWork);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: these two variables *must* always be updated together.</span></span><br><span class="line">  <span class="keyword">let</span> parent;</span><br><span class="line">  <span class="keyword">let</span> isContainer;</span><br><span class="line">  <span class="keyword">const</span> parentStateNode = parentFiber.<span class="property">stateNode</span>;</span><br><span class="line">  <span class="keyword">switch</span> (parentFiber.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">      parent = parentStateNode;</span><br><span class="line">      isContainer = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostRoot</span>:</span><br><span class="line">      parent = parentStateNode.<span class="property">containerInfo</span>;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">HostPortal</span>:</span><br><span class="line">      parent = parentStateNode.<span class="property">containerInfo</span>;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// eslint-disable-next-line-no-fallthrough</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (parentFiber.<span class="property">flags</span> &amp; <span class="title class_">ContentReset</span>) &#123;</span><br><span class="line">    <span class="comment">// Reset the text content of the parent before doing any insertions</span></span><br><span class="line">    <span class="title function_">resetTextContent</span>(parent);</span><br><span class="line">    <span class="comment">// Clear ContentReset from the effect tag</span></span><br><span class="line">    parentFiber.<span class="property">flags</span> &amp;= ~<span class="title class_">ContentReset</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> before = <span class="title function_">getHostSibling</span>(finishedWork);</span><br><span class="line">  <span class="comment">// 插入 dom 元素</span></span><br><span class="line">  <span class="keyword">if</span> (isContainer) &#123;</span><br><span class="line">    <span class="title function_">insertOrAppendPlacementNodeIntoContainer</span>(finishedWork, before, parent);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">insertOrAppendPlacementNode</span>(finishedWork, before, parent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">isHostParent</span>(<span class="params"><span class="attr">fiber</span>: <span class="title class_">Fiber</span></span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    fiber.<span class="property">tag</span> === <span class="title class_">HostComponent</span> ||</span><br><span class="line">    fiber.<span class="property">tag</span> === <span class="title class_">HostRoot</span> ||</span><br><span class="line">    fiber.<span class="property">tag</span> === <span class="title class_">HostPortal</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getHostSibling</span>(<span class="params"><span class="attr">fiber</span>: <span class="title class_">Fiber</span></span>): ?<span class="title class_">Instance</span> &#123;</span><br><span class="line">  <span class="comment">// We&#x27;re going to search forward into the tree until we find a sibling host</span></span><br><span class="line">  <span class="comment">// node. Unfortunately, if multiple insertions are done in a row we have to</span></span><br><span class="line">  <span class="comment">// search past them. This leads to exponential search for the next sibling.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Find a more efficient way to do this.</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">node</span>: <span class="title class_">Fiber</span> = fiber;</span><br><span class="line">  <span class="attr">siblings</span>: <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// If we didn&#x27;t find anything, let&#x27;s try the next sibling.</span></span><br><span class="line">    <span class="keyword">while</span> (node.<span class="property">sibling</span> === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.<span class="property">return</span> === <span class="literal">null</span> || <span class="title function_">isHostParent</span>(node.<span class="property">return</span>)) &#123;</span><br><span class="line">        <span class="comment">// If we pop out of the root or hit the parent the fiber we are the</span></span><br><span class="line">        <span class="comment">// last sibling.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.<span class="property">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    node.<span class="property">sibling</span>.<span class="property">return</span> = node.<span class="property">return</span>;</span><br><span class="line">    node = node.<span class="property">sibling</span>;</span><br><span class="line">    <span class="keyword">while</span> (</span><br><span class="line">      node.<span class="property">tag</span> !== <span class="title class_">HostComponent</span> &amp;&amp;</span><br><span class="line">      node.<span class="property">tag</span> !== <span class="title class_">HostText</span> &amp;&amp;</span><br><span class="line">      node.<span class="property">tag</span> !== <span class="title class_">DehydratedFragment</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// If it is not host node and, we might have a host node inside it.</span></span><br><span class="line">      <span class="comment">// Try to search down until we find one.</span></span><br><span class="line">      <span class="keyword">if</span> (node.<span class="property">flags</span> &amp; <span class="title class_">Placement</span>) &#123;</span><br><span class="line">        <span class="comment">// If we don&#x27;t have a child, try the siblings instead.</span></span><br><span class="line">        <span class="keyword">continue</span> siblings;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// If we don&#x27;t have a child, try the siblings instead.</span></span><br><span class="line">      <span class="comment">// We also skip portals because they are not part of this host tree.</span></span><br><span class="line">      <span class="keyword">if</span> (node.<span class="property">child</span> === <span class="literal">null</span> || node.<span class="property">tag</span> === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span> siblings;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node.<span class="property">child</span>.<span class="property">return</span> = node;</span><br><span class="line">        node = node.<span class="property">child</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check if this host node is stable or about to be placed.</span></span><br><span class="line">    <span class="keyword">if</span> (!(node.<span class="property">flags</span> &amp; <span class="title class_">Placement</span>)) &#123;</span><br><span class="line">      <span class="comment">// Found it!</span></span><br><span class="line">      <span class="keyword">return</span> node.<span class="property">stateNode</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">insertOrAppendPlacementNodeIntoContainer</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">node</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">before</span>: ?<span class="title class_">Instance</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">parent</span>: <span class="title class_">Container</span>,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;tag&#125; = node;</span><br><span class="line">  <span class="keyword">const</span> isHost = tag === <span class="title class_">HostComponent</span> || tag === <span class="title class_">HostText</span>;</span><br><span class="line">  <span class="keyword">if</span> (isHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = node.<span class="property">stateNode</span>;</span><br><span class="line">    <span class="keyword">if</span> (before) &#123;</span><br><span class="line">      <span class="title function_">insertInContainerBefore</span>(parent, stateNode, before);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">appendChildToContainer</span>(parent, stateNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">    <span class="comment">// If the insertion itself is a portal, then we don&#x27;t want to traverse</span></span><br><span class="line">    <span class="comment">// down its children. Instead, we&#x27;ll get insertions from each child in</span></span><br><span class="line">    <span class="comment">// the portal directly.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> child = node.<span class="property">child</span>;</span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">insertOrAppendPlacementNodeIntoContainer</span>(child, before, parent);</span><br><span class="line">      <span class="keyword">let</span> sibling = child.<span class="property">sibling</span>;</span><br><span class="line">      <span class="keyword">while</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title function_">insertOrAppendPlacementNodeIntoContainer</span>(sibling, before, parent);</span><br><span class="line">        sibling = sibling.<span class="property">sibling</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">insertOrAppendPlacementNode</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">node</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">before</span>: ?<span class="title class_">Instance</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">parent</span>: <span class="title class_">Instance</span>,</span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;tag&#125; = node;</span><br><span class="line">  <span class="keyword">const</span> isHost = tag === <span class="title class_">HostComponent</span> || tag === <span class="title class_">HostText</span>;</span><br><span class="line">  <span class="keyword">if</span> (isHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = node.<span class="property">stateNode</span>;</span><br><span class="line">    <span class="keyword">if</span> (before) &#123;</span><br><span class="line">      <span class="title function_">insertBefore</span>(parent, stateNode, before);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">appendChild</span>(parent, stateNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">    <span class="comment">// If the insertion itself is a portal, then we don&#x27;t want to traverse</span></span><br><span class="line">    <span class="comment">// down its children. Instead, we&#x27;ll get insertions from each child in</span></span><br><span class="line">    <span class="comment">// the portal directly.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> child = node.<span class="property">child</span>;</span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">insertOrAppendPlacementNode</span>(child, before, parent);</span><br><span class="line">      <span class="keyword">let</span> sibling = child.<span class="property">sibling</span>;</span><br><span class="line">      <span class="keyword">while</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title function_">insertOrAppendPlacementNode</span>(sibling, before, parent);</span><br><span class="line">        sibling = sibling.<span class="property">sibling</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="commitLayoutEffects"><a href="#commitLayoutEffects" class="headerlink" title="commitLayoutEffects"></a><code>commitLayoutEffects</code></h5><p>执行生命周期钩子，在离开当前节点时调用钩子函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle,inProgressLanes,inProgressRoot 全局变量</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutEffects</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">finishedWork</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">root</span>: <span class="title class_">FiberRoot</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">committedLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  inProgressLanes = committedLanes</span><br><span class="line">  inProgressRoot = root</span><br><span class="line">  nextEffect = finishedWork</span><br><span class="line"></span><br><span class="line">  <span class="title function_">commitLayoutEffects_begin</span>(finishedWork, root, committedLanes)</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span></span><br><span class="line">  inProgressRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutEffects_begin</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">subtreeRoot</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">root</span>: <span class="title class_">FiberRoot</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">committedLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Suspense layout effects semantics don&#x27;t change for legacy roots.</span></span><br><span class="line">  <span class="keyword">const</span> isModernRoot = (subtreeRoot.<span class="property">mode</span> &amp; <span class="title class_">ConcurrentMode</span>) !== <span class="title class_">NoMode</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> firstChild = fiber.<span class="property">child</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics &amp;&amp; isModernRoot) &#123;</span><br><span class="line">      <span class="comment">// Keep track of the current Offscreen stack&#x27;s state.</span></span><br><span class="line">      <span class="keyword">if</span> (fiber.<span class="property">tag</span> === <span class="title class_">OffscreenComponent</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> current = fiber.<span class="property">alternate</span></span><br><span class="line">        <span class="keyword">const</span> wasHidden = current !== <span class="literal">null</span> &amp;&amp; current.<span class="property">memoizedState</span> !== <span class="literal">null</span></span><br><span class="line">        <span class="keyword">const</span> isHidden = fiber.<span class="property">memoizedState</span> !== <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> newOffscreenSubtreeIsHidden = isHidden || offscreenSubtreeIsHidden</span><br><span class="line">        <span class="keyword">const</span> newOffscreenSubtreeWasHidden =</span><br><span class="line">          wasHidden || offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          newOffscreenSubtreeIsHidden !== offscreenSubtreeIsHidden ||</span><br><span class="line">          newOffscreenSubtreeWasHidden !== offscreenSubtreeWasHidden</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevOffscreenSubtreeIsHidden = offscreenSubtreeIsHidden</span><br><span class="line">          <span class="keyword">const</span> prevOffscreenSubtreeWasHidden = offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Traverse the Offscreen subtree with the current Offscreen as the root.</span></span><br><span class="line">          offscreenSubtreeIsHidden = newOffscreenSubtreeIsHidden</span><br><span class="line">          offscreenSubtreeWasHidden = newOffscreenSubtreeWasHidden</span><br><span class="line">          <span class="title function_">commitLayoutEffects_begin</span>(</span><br><span class="line">            fiber, <span class="comment">// New root; bubble back up to here and stop.</span></span><br><span class="line">            root,</span><br><span class="line">            committedLanes</span><br><span class="line">          )</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Restore Offscreen state and resume in our-progress traversal.</span></span><br><span class="line">          nextEffect = fiber</span><br><span class="line">          offscreenSubtreeIsHidden = prevOffscreenSubtreeIsHidden</span><br><span class="line">          offscreenSubtreeWasHidden = prevOffscreenSubtreeWasHidden</span><br><span class="line">          <span class="title function_">commitLayoutMountEffects_complete</span>(subtreeRoot, root, committedLanes)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fiber.<span class="property">subtreeFlags</span> &amp; <span class="title class_">LayoutMask</span>) !== <span class="title class_">NoFlags</span> &amp;&amp; firstChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(firstChild, fiber)</span><br><span class="line">      nextEffect = firstChild</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics &amp;&amp; isModernRoot) &#123;</span><br><span class="line">        <span class="keyword">const</span> visibilityChanged =</span><br><span class="line">          !offscreenSubtreeIsHidden &amp;&amp; offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO (Offscreen) Also check: subtreeFlags &amp; LayoutStatic</span></span><br><span class="line">        <span class="keyword">if</span> (visibilityChanged &amp;&amp; firstChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// We&#x27;ve just shown or hidden a Offscreen tree that contains layout effects.</span></span><br><span class="line">          <span class="comment">// We only enter this code path for subtrees that are updated,</span></span><br><span class="line">          <span class="comment">// because newly mounted ones would pass the LayoutMask check above.</span></span><br><span class="line">          <span class="title function_">ensureCorrectReturnPointer</span>(firstChild, fiber)</span><br><span class="line">          nextEffect = firstChild</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="title function_">commitLayoutMountEffects_complete</span>(subtreeRoot, root, committedLanes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutMountEffects_complete</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">subtreeRoot</span>: <span class="title class_">Fiber</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">root</span>: <span class="title class_">FiberRoot</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">committedLanes</span>: <span class="title class_">Lanes</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Suspense layout effects semantics don&#x27;t change for legacy roots.</span></span><br><span class="line">  <span class="keyword">const</span> isModernRoot = (subtreeRoot.<span class="property">mode</span> &amp; <span class="title class_">ConcurrentMode</span>) !== <span class="title class_">NoMode</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      enableSuspenseLayoutEffectSemantics &amp;&amp;</span><br><span class="line">      isModernRoot &amp;&amp;</span><br><span class="line">      offscreenSubtreeWasHidden &amp;&amp;</span><br><span class="line">      !offscreenSubtreeIsHidden</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// Inside of an Offscreen subtree that changed visibility during this commit.</span></span><br><span class="line">      <span class="comment">// If this subtree was hidden, layout effects will have already been destroyed (during mutation phase)</span></span><br><span class="line">      <span class="comment">// but if it was just shown, we need to (re)create the effects now.</span></span><br><span class="line">      <span class="comment">// TODO (Offscreen) Check: flags &amp; LayoutStatic</span></span><br><span class="line">      <span class="keyword">switch</span> (fiber.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>: &#123;</span><br><span class="line">          <span class="title function_">safelyCallCommitHookLayoutEffectListMount</span>(fiber, fiber.<span class="property">return</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;</span><br><span class="line">          <span class="keyword">const</span> instance = fiber.<span class="property">stateNode</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.<span class="property">componentDidMount</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            <span class="title function_">safelyCallComponentDidMount</span>(fiber, fiber.<span class="property">return</span>, instance)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// TODO (Offscreen) Check flags &amp; RefStatic</span></span><br><span class="line">      <span class="keyword">switch</span> (fiber.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ClassComponent</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">          <span class="title function_">safelyAttachRef</span>(fiber, fiber.<span class="property">return</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((fiber.<span class="property">flags</span> &amp; <span class="title class_">LayoutMask</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = fiber.<span class="property">alternate</span></span><br><span class="line">      <span class="title function_">commitLayoutEffectOnFiber</span>(root, current, fiber, committedLanes)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fiber === subtreeRoot) &#123;</span><br><span class="line">      nextEffect = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.<span class="property">sibling</span></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">ensureCorrectReturnPointer</span>(sibling, fiber.<span class="property">return</span>)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.<span class="property">return</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/14/react%E7%9A%84%E5%90%8C%E6%AD%A5%E6%9B%B4%E6%96%B0/" data-id="cm19b6rz3003jgkdz0qsb91bn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/" rel="tag">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react中的事件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/12/react%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6/" class="article-date">
  <time datetime="2021-06-12T12:34:30.000Z" itemprop="datePublished">2021-06-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/12/react%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6/">react中的事件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/images/react/react-event.jpg" alt="react 中的事件"></p>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p><img src="/images/react/react-event-init.jpg" alt="react 事件初始化"></p>
<ol>
<li><p>在 <code>react-dom</code> 模块的 <code>src/client/ReactDOM</code> 中引入 <code>ReactDOMEventHandle</code> 文件，把该文件中的 <code>createEventHandle</code> 函数导出为 <code>unstable_createEventHandle</code> 以供第三方使用</p>
</li>
<li><p>在 <code>ReactDOMEventHandle</code> 文件中引入 <code>events/DOMPluginEventSystem</code> 文件，在模块中注册了顶级事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="title class_">SimpleEventPlugin</span>.<span class="title function_">registerEvents</span>()</span><br><span class="line"><span class="title class_">EnterLeaveEventPlugin</span>.<span class="title function_">registerEvents</span>()</span><br><span class="line"><span class="title class_">ChangeEventPlugin</span>.<span class="title function_">registerEvents</span>()</span><br><span class="line"><span class="title class_">SelectEventPlugin</span>.<span class="title function_">registerEvents</span>()</span><br><span class="line"><span class="title class_">BeforeInputEventPlugin</span>.<span class="title function_">registerEvents</span>()</span><br></pre></td></tr></table></figure></li>
<li><p>记录 <code>dom</code> 事件和 <code>react</code> 事件的映射关系</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMEventProperties.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> topLevelEventsToReactNames = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录 dom event 和 react event 的映射</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">registerSimpleEvent</span>(<span class="params">domEventName, reactName</span>) &#123;</span><br><span class="line">  topLevelEventsToReactNames.<span class="title function_">set</span>(domEventName, reactName)</span><br><span class="line">  <span class="title function_">registerTwoPhaseEvent</span>(reactName, [domEventName])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">registerSimpleEvents</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; simpleEventPluginEvents.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> eventName = ((simpleEventPluginEvents[i]: any): string)</span><br><span class="line">    <span class="keyword">const</span> domEventName = ((eventName.<span class="title function_">toLowerCase</span>(): any): <span class="title class_">DOMEventName</span>)</span><br><span class="line">    <span class="keyword">const</span> capitalizedEvent = eventName[<span class="number">0</span>].<span class="title function_">toUpperCase</span>() + eventName.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="title function_">registerSimpleEvent</span>(domEventName, <span class="string">&#x27;on&#x27;</span> + capitalizedEvent)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Special cases where event names don&#x27;t match.</span></span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="variable constant_">ANIMATION_END</span>, <span class="string">&#x27;onAnimationEnd&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="variable constant_">ANIMATION_ITERATION</span>, <span class="string">&#x27;onAnimationIteration&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="variable constant_">ANIMATION_START</span>, <span class="string">&#x27;onAnimationStart&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="string">&#x27;dblclick&#x27;</span>, <span class="string">&#x27;onDoubleClick&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="string">&#x27;focusin&#x27;</span>, <span class="string">&#x27;onFocus&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="string">&#x27;focusout&#x27;</span>, <span class="string">&#x27;onBlur&#x27;</span>)</span><br><span class="line">  <span class="title function_">registerSimpleEvent</span>(<span class="variable constant_">TRANSITION_END</span>, <span class="string">&#x27;onTransitionEnd&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>events/EventRegistry</code> 模块中调用方法把注册的事件放入存储的 <code>Set</code> 和对象中，<code>allNativeEvents Set</code> 负责存储所有注册过的 <code>dom</code> 事件名称，<code>registrationNameDependencies</code> 以 <code>&#123;[reactEventName]: [nativeEventName] &#125;</code>负责存储注册的事件依赖，同时注册了冒泡事件和捕获事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/EventRegistry.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">allNativeEvents</span>: <span class="title class_">Set</span>&lt;<span class="title class_">DOMEventName</span>&gt; = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mapping from registration name to event name</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> registrationNameDependencies = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">registerTwoPhaseEvent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  registrationName: string,</span></span><br><span class="line"><span class="params">  dependencies: <span class="built_in">Array</span>&lt;DOMEventName&gt;</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="title function_">registerDirectEvent</span>(registrationName, dependencies)</span><br><span class="line">  <span class="title function_">registerDirectEvent</span>(registrationName + <span class="string">&#x27;Capture&#x27;</span>, dependencies)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">registerDirectEvent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  registrationName: string,</span></span><br><span class="line"><span class="params">  dependencies: <span class="built_in">Array</span>&lt;DOMEventName&gt;</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  registrationNameDependencies[registrationName] = dependencies</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dependencies.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    allNativeEvents.<span class="title function_">add</span>(dependencies[i])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>合成事件的初始化完毕</p>
</li>
</ol>
<h4 id="注册原生事件"><a href="#注册原生事件" class="headerlink" title="注册原生事件"></a>注册原生事件</h4><p><img src="/images/react/react-event-init.jpg" alt="react 注册原生事件"></p>
<ol>
<li><p>调用 <code>react-dom</code> 模块中的 <code>render</code> 时，若第一次挂载则递归依次调用 <code>legacyCreateRootFromDOMContainer</code>、<code>createLegacyRoot</code> 创建容器对象 <code>ReactDOMLegacyRoot</code> 的实例</p>
</li>
<li><p><code>ReactDOMLegacyRoot</code> 递归依次调用 <code>createRootImpl</code>、<code>createContainer</code> 创建了组件挂载的根元素，并表及为根元素</p>
</li>
<li><p>调用 <code>listenToAllSupportedEvents</code> 在根元素上挂载事件，若当前容器为注释元素，则取当前元素的父元素为事件挂载的节点</p>
</li>
<li><p>在 <code>listenToAllSupportedEvents</code> 中遍历初始化时注册的 <code>allNativeEvents</code> 事件列表注册事件，判断根元素是否为 <code>documet</code> 节点，不是则获取 <code>document</code> 节点，在 <code>document</code> 节点节点上注册 <code>selectionchange</code> 事件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">const</span> listeningMarker = <span class="string">&#x27;_reactListening&#x27;</span> +<span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">slice</span>(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">listenToAllSupportedEvents</span>(<span class="params"><span class="attr">rootContainerElement</span>: <span class="title class_">EventTarget</span></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="attr">rootContainerElement</span>: <span class="built_in">any</span>)[listeningMarker]) &#123;</span><br><span class="line">    rootContainerElement[listeningMarker] = <span class="literal">true</span></span><br><span class="line">    allNativeEvents.<span class="title function_">forEach</span>(<span class="function">(<span class="params">domEventName</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// We handle selectionchange separately because it</span></span><br><span class="line">      <span class="comment">// doesn&#x27;t bubble and needs to be on the document.</span></span><br><span class="line">      <span class="keyword">if</span> (domEventName !== <span class="string">&#x27;selectionchange&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!nonDelegatedEvents.<span class="title function_">has</span>(domEventName)) &#123;</span><br><span class="line">          <span class="title function_">listenToNativeEvent</span>(domEventName, <span class="literal">false</span>, rootContainerElement)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">listenToNativeEvent</span>(domEventName, <span class="literal">true</span>, rootContainerElement)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> ownerDocument =</span><br><span class="line">      rootContainerElement.<span class="property">nodeType</span> === <span class="variable constant_">DOCUMENT_NODE</span></span><br><span class="line">        ? rootContainerElement</span><br><span class="line">        : (rootContainerElement).<span class="property">ownerDocument</span></span><br><span class="line">    <span class="keyword">if</span> (ownerDocument !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// The selectionchange event also needs deduplication</span></span><br><span class="line">      <span class="comment">// but it is attached to the document.</span></span><br><span class="line">      <span class="keyword">if</span> (!(ownerDocument)[listeningMarker]) &#123;</span><br><span class="line">        ownerDocument[listeningMarker] = <span class="literal">true</span></span><br><span class="line">        <span class="title function_">listenToNativeEvent</span>(<span class="string">&#x27;selectionchange&#x27;</span>, <span class="literal">false</span>, ownerDocument)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>createEventListenerWrapperWithPriority</code> 函数先获取事件优先级，再根据优先级确定构造监听器的函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/ReactDOMEventListener.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createEventListenerWrapperWithPriority</span>(<span class="params"></span></span><br><span class="line"><span class="params">  targetContainer: EventTarget,</span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Function</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> eventPriority = <span class="title function_">getEventPriority</span>(domEventName)</span><br><span class="line">  <span class="keyword">let</span> listenerWrapper</span><br><span class="line">  <span class="keyword">switch</span> (eventPriority) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">DiscreteEventPriority</span>:</span><br><span class="line">      listenerWrapper = dispatchDiscreteEvent</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ContinuousEventPriority</span>:</span><br><span class="line">      listenerWrapper = dispatchContinuousEvent</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">DefaultEventPriority</span>:</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      listenerWrapper = dispatchEvent</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> listenerWrapper.<span class="title function_">bind</span>(</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用 <code>createEventListenerWrapperWithPriority</code> 创建监听函数，根据 <code>passive</code> 属性的支持和 <code>capture</code> 情况分别调用不同的事件监听方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">listenToNativeEvent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  isCapturePhaseListener: boolean,</span></span><br><span class="line"><span class="params">  target: EventTarget</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> eventSystemFlags = <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (isCapturePhaseListener) &#123;</span><br><span class="line">    eventSystemFlags |= <span class="variable constant_">IS_CAPTURE_PHASE</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">addTrappedEventListener</span>(</span><br><span class="line">    target,</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    isCapturePhaseListener</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addTrappedEventListener</span>(<span class="params"></span></span><br><span class="line"><span class="params">  targetContainer: EventTarget,</span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  isCapturePhaseListener: boolean,</span></span><br><span class="line"><span class="params">  isDeferredListenerForLegacyFBSupport?: boolean</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> listener = <span class="title function_">createEventListenerWrapperWithPriority</span>(</span><br><span class="line">    targetContainer,</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// If passive option is not supported, then the event will be</span></span><br><span class="line">  <span class="comment">// active and not passive.</span></span><br><span class="line">  <span class="keyword">let</span> isPassiveListener = <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">if</span> (passiveBrowserEventsSupported) &#123;</span><br><span class="line">    <span class="comment">// 是否支持 passive 属性， https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      domEventName === <span class="string">&#x27;touchstart&#x27;</span> ||</span><br><span class="line">      domEventName === <span class="string">&#x27;touchmove&#x27;</span> ||</span><br><span class="line">      domEventName === <span class="string">&#x27;wheel&#x27;</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      isPassiveListener = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  targetContainer =</span><br><span class="line">    enableLegacyFBSupport &amp;&amp; isDeferredListenerForLegacyFBSupport</span><br><span class="line">      ? (<span class="attr">targetContainer</span>: any).<span class="property">ownerDocument</span></span><br><span class="line">      : targetContainer</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> unsubscribeListener</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> There are too many combinations here. Consolidate them.</span></span><br><span class="line">  <span class="keyword">if</span> (isCapturePhaseListener) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isPassiveListener !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      unsubscribeListener = <span class="title function_">addEventCaptureListenerWithPassiveFlag</span>(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener,</span><br><span class="line">        isPassiveListener</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      unsubscribeListener = <span class="title function_">addEventCaptureListener</span>(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isPassiveListener !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      unsubscribeListener = <span class="title function_">addEventBubbleListenerWithPassiveFlag</span>(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener,</span><br><span class="line">        isPassiveListener</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      unsubscribeListener = <span class="title function_">addEventBubbleListener</span>(</span><br><span class="line">        targetContainer,</span><br><span class="line">        domEventName,</span><br><span class="line">        listener</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="事件触发"><a href="#事件触发" class="headerlink" title="事件触发"></a>事件触发</h4><p><img src="/images/react/react-event-dispatch.jpg" alt="react 事件触发"></p>
<ol>
<li><p>有事件触发时，调用 <code>events/ReactDOMEventListener</code> 下的 <code>dispatchEvent</code> 触发事件</p>
</li>
<li><p>当事件不可重新触发时直接调用 <code>attemptToDispatchEvent</code> 进行事件的触发，否则事件放入队列等待调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/ReactDOMEventListener.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">dispatchEvent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  targetContainer: EventTarget,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> allowReplay = (eventSystemFlags &amp; <span class="variable constant_">IS_CAPTURE_PHASE</span>) === <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    allowReplay &amp;&amp;</span><br><span class="line">    <span class="title function_">hasQueuedDiscreteEvents</span>() &amp;&amp;</span><br><span class="line">    <span class="title function_">isReplayableDiscreteEvent</span>(domEventName)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">//更新队列中就把事件放入更新队列</span></span><br><span class="line">    <span class="title function_">queueDiscreteEvent</span>(</span><br><span class="line">      <span class="literal">null</span>, <span class="comment">// Flags that we&#x27;re not actually blocked on anything as far as we know.</span></span><br><span class="line">      domEventName,</span><br><span class="line">      eventSystemFlags,</span><br><span class="line">      targetContainer,</span><br><span class="line">      nativeEvent</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> blockedOn = <span class="title function_">attemptToDispatchEvent</span>(</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer,</span><br><span class="line">    nativeEvent</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (blockedOn === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 触发事件成功</span></span><br><span class="line">    <span class="keyword">if</span> (allowReplay) &#123;</span><br><span class="line">      <span class="title function_">clearIfContinuousEvent</span>(domEventName, nativeEvent)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 其它逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取触发事件的元素，然后获取最近的虚拟 <code>dom</code> 节点的实例（向上查找，注：<code>dom</code> 上存储了虚拟 <code>dom</code> 的引用，快速查找），通过虚拟 <code>dom</code> 节点获取最近挂载的 <code>fiber</code> 节点（向上查找）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/ReactDOMEventListener.js</span></span><br><span class="line"><span class="comment">// Attempt dispatching an event. Returns a SuspenseInstance or Container if it&#x27;s blocked.</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">attemptToDispatchEvent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  targetContainer: EventTarget,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent</span></span><br><span class="line"><span class="params"></span>): <span class="literal">null</span> | <span class="title class_">Container</span> | <span class="title class_">SuspenseInstance</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> nativeEventTarget = <span class="title function_">getEventTarget</span>(nativeEvent)</span><br><span class="line">  <span class="keyword">let</span> targetInst = <span class="title function_">getClosestInstanceFromNode</span>(nativeEventTarget)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (targetInst !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> nearestMounted = <span class="title function_">getNearestMountedFiber</span>(targetInst)</span><br><span class="line">    <span class="keyword">if</span> (nearestMounted === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 树已经被销毁，触发对象置空</span></span><br><span class="line">      targetInst = <span class="literal">null</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 其它逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">dispatchEventForPluginEventSystem</span>(</span><br><span class="line">    domEventName,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    targetInst,</span><br><span class="line">    targetContainer</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// We&#x27;re not blocked on anything.</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>attemptToDispatchEvent</code> 调用 <code>dispatchEventForPluginEventSystem</code>，找出触发事件元素的根节点实例，然后通过 <code>dispatchEventsForPlugins</code> 批量更新</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">dispatchEventForPluginEventSystem</span>(<span class="params"></span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent,</span></span><br><span class="line"><span class="params">  targetInst: <span class="literal">null</span> | Fiber,</span></span><br><span class="line"><span class="params">  targetContainer: EventTarget</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> ancestorInst = targetInst</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (eventSystemFlags &amp; <span class="variable constant_">IS_EVENT_HANDLE_NON_MANAGED_NODE</span>) === <span class="number">0</span> &amp;&amp;</span><br><span class="line">    (eventSystemFlags &amp; <span class="variable constant_">IS_NON_DELEGATED</span>) === <span class="number">0</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> targetContainerNode = ((<span class="attr">targetContainer</span>: any): <span class="title class_">Node</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetInst !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// The below logic attempts to work out if we need to change</span></span><br><span class="line">      <span class="comment">// the target fiber to a different ancestor. We had similar logic</span></span><br><span class="line">      <span class="comment">// in the legacy event system, except the big difference between</span></span><br><span class="line">      <span class="comment">// systems is that the modern event system now has an event listener</span></span><br><span class="line">      <span class="comment">// attached to each React Root and React Portal Root. Together,</span></span><br><span class="line">      <span class="comment">// the DOM nodes representing these roots are the &quot;rootContainer&quot;.</span></span><br><span class="line">      <span class="comment">// To figure out which ancestor instance we should use, we traverse</span></span><br><span class="line">      <span class="comment">// up the fiber tree from the target instance and attempt to find</span></span><br><span class="line">      <span class="comment">// root boundaries that match that of our current &quot;rootContainer&quot;.</span></span><br><span class="line">      <span class="comment">// If we find that &quot;rootContainer&quot;, we find the parent fiber</span></span><br><span class="line">      <span class="comment">// sub-tree for that root and make that our ancestor instance.</span></span><br><span class="line">      <span class="keyword">let</span> node = targetInst</span><br><span class="line"></span><br><span class="line">      <span class="attr">mainLoop</span>: <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (node === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> nodeTag = node.<span class="property">tag</span></span><br><span class="line">        <span class="keyword">if</span> (nodeTag === <span class="title class_">HostRoot</span> || nodeTag === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">          <span class="keyword">let</span> container = node.<span class="property">stateNode</span>.<span class="property">containerInfo</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">isMatchingRootContainer</span>(container, targetContainerNode)) &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (nodeTag === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">            <span class="comment">// The target is a portal, but it&#x27;s not the rootContainer we&#x27;re looking for.</span></span><br><span class="line">            <span class="comment">// Normally portals handle their own events all the way down to the root.</span></span><br><span class="line">            <span class="comment">// So we should be able to stop now. However, we don&#x27;t know if this portal</span></span><br><span class="line">            <span class="comment">// was part of *our* root.</span></span><br><span class="line">            <span class="keyword">let</span> grandNode = node.<span class="property">return</span></span><br><span class="line">            <span class="keyword">while</span> (grandNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">const</span> grandTag = grandNode.<span class="property">tag</span></span><br><span class="line">              <span class="keyword">if</span> (grandTag === <span class="title class_">HostRoot</span> || grandTag === <span class="title class_">HostPortal</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> grandContainer = grandNode.<span class="property">stateNode</span>.<span class="property">containerInfo</span></span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                  <span class="title function_">isMatchingRootContainer</span>(</span><br><span class="line">                    grandContainer,</span><br><span class="line">                    targetContainerNode</span><br><span class="line">                  )</span><br><span class="line">                ) &#123;</span><br><span class="line">                  <span class="comment">// This is the rootContainer we&#x27;re looking for and we found it as</span></span><br><span class="line">                  <span class="comment">// a parent of the Portal. That means we can ignore it because the</span></span><br><span class="line">                  <span class="comment">// Portal will bubble through to us.</span></span><br><span class="line">                  <span class="keyword">return</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              grandNode = grandNode.<span class="property">return</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Now we need to find it&#x27;s corresponding host fiber in the other</span></span><br><span class="line">          <span class="comment">// tree. To do this we can use getClosestInstanceFromNode, but we</span></span><br><span class="line">          <span class="comment">// need to validate that the fiber is a host instance, otherwise</span></span><br><span class="line">          <span class="comment">// we need to traverse up through the DOM till we find the correct</span></span><br><span class="line">          <span class="comment">// node that is from the other tree.</span></span><br><span class="line">          <span class="keyword">while</span> (container !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> parentNode = <span class="title function_">getClosestInstanceFromNode</span>(container)</span><br><span class="line">            <span class="keyword">if</span> (parentNode === <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">const</span> parentTag = parentNode.<span class="property">tag</span></span><br><span class="line">            <span class="keyword">if</span> (parentTag === <span class="title class_">HostComponent</span> || parentTag === <span class="title class_">HostText</span>) &#123;</span><br><span class="line">              node = ancestorInst = parentNode</span><br><span class="line">              <span class="keyword">continue</span> mainLoop</span><br><span class="line">            &#125;</span><br><span class="line">            container = container.<span class="property">parentNode</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        node = node.<span class="property">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">batchedEventUpdates</span>(<span class="function">() =&gt;</span></span><br><span class="line">    <span class="title function_">dispatchEventsForPlugins</span>(</span><br><span class="line">      domEventName,</span><br><span class="line">      eventSystemFlags,</span><br><span class="line">      nativeEvent,</span><br><span class="line">      ancestorInst,</span><br><span class="line">      targetContainer</span><br><span class="line">    )</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>dispatchEventsForPlugins</code> 先获取当前 <code>Fiber</code> 上绑定的对应事件，然后 <code>processDispatchQueue</code> 通过按照顺序 <code>processDispatchQueueItemsInOrder</code> 处理各个事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dispatchEventsForPlugins</span>(<span class="params"></span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent,</span></span><br><span class="line"><span class="params">  targetInst: <span class="literal">null</span> | Fiber,</span></span><br><span class="line"><span class="params">  targetContainer: EventTarget</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> nativeEventTarget = <span class="title function_">getEventTarget</span>(nativeEvent)</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">dispatchQueue</span>: <span class="title class_">DispatchQueue</span> = []</span><br><span class="line">  <span class="title function_">extractEvents</span>(</span><br><span class="line">    dispatchQueue,</span><br><span class="line">    domEventName,</span><br><span class="line">    targetInst,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    nativeEventTarget,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer</span><br><span class="line">  )</span><br><span class="line">  <span class="title function_">processDispatchQueue</span>(dispatchQueue, eventSystemFlags)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">extractEvents</span>(<span class="params"></span></span><br><span class="line"><span class="params">  dispatchQueue: DispatchQueue,</span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  targetInst: <span class="literal">null</span> | Fiber,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent,</span></span><br><span class="line"><span class="params">  nativeEventTarget: <span class="literal">null</span> | EventTarget,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  targetContainer: EventTarget</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="title class_">SimpleEventPlugin</span>.<span class="title function_">extractEvents</span>(</span><br><span class="line">    dispatchQueue,</span><br><span class="line">    domEventName,</span><br><span class="line">    targetInst,</span><br><span class="line">    nativeEvent,</span><br><span class="line">    nativeEventTarget,</span><br><span class="line">    eventSystemFlags,</span><br><span class="line">    targetContainer</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// 其它逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">processDispatchQueue</span>(<span class="params"></span></span><br><span class="line"><span class="params">  dispatchQueue: DispatchQueue,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> inCapturePhase = (eventSystemFlags &amp; <span class="variable constant_">IS_CAPTURE_PHASE</span>) !== <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dispatchQueue.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="comment">// 取出事件监听函数执行</span></span><br><span class="line">    <span class="keyword">const</span> &#123; event, listeners &#125; = dispatchQueue[i]</span><br><span class="line">    <span class="title function_">processDispatchQueueItemsInOrder</span>(event, listeners, inCapturePhase)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">processDispatchQueueItemsInOrder</span>(<span class="params"></span></span><br><span class="line"><span class="params">  event: ReactSyntheticEvent,</span></span><br><span class="line"><span class="params">  dispatchListeners: <span class="built_in">Array</span>&lt;DispatchListener&gt;,</span></span><br><span class="line"><span class="params">  inCapturePhase: boolean</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> previousInstance</span><br><span class="line">  <span class="keyword">if</span> (inCapturePhase) &#123;</span><br><span class="line">    <span class="comment">// 捕获事件从后往前执行</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = dispatchListeners.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; instance, currentTarget, listener &#125; = dispatchListeners[i]</span><br><span class="line">      <span class="keyword">if</span> (instance !== previousInstance &amp;&amp; event.<span class="title function_">isPropagationStopped</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">executeDispatch</span>(event, listener, currentTarget)</span><br><span class="line">      previousInstance = instance</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 冒泡事件从前往后执行</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dispatchListeners.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; instance, currentTarget, listener &#125; = dispatchListeners[i]</span><br><span class="line">      <span class="keyword">if</span> (instance !== previousInstance &amp;&amp; event.<span class="title function_">isPropagationStopped</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">executeDispatch</span>(event, listener, currentTarget)</span><br><span class="line">      previousInstance = instance</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>extractEvents</code> 提取事件监听函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/plugins/SimpleEventPlugin.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">extractEvents</span>(<span class="params"></span></span><br><span class="line"><span class="params">  dispatchQueue: DispatchQueue,</span></span><br><span class="line"><span class="params">  domEventName: DOMEventName,</span></span><br><span class="line"><span class="params">  targetInst: <span class="literal">null</span> | Fiber,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent,</span></span><br><span class="line"><span class="params">  nativeEventTarget: <span class="literal">null</span> | EventTarget,</span></span><br><span class="line"><span class="params">  eventSystemFlags: EventSystemFlags,</span></span><br><span class="line"><span class="params">  targetContainer: EventTarget</span></span><br><span class="line"><span class="params"></span>): <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> reactName = topLevelEventsToReactNames.<span class="title function_">get</span>(domEventName)</span><br><span class="line">  <span class="keyword">if</span> (reactName === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> <span class="title class_">SyntheticEventCtor</span> = <span class="title class_">SyntheticEvent</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">reactEventType</span>: string = domEventName</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据事件类型获取对应的构造函数</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> inCapturePhase = (eventSystemFlags &amp; <span class="variable constant_">IS_CAPTURE_PHASE</span>) !== <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    enableCreateEventHandleAPI &amp;&amp;</span><br><span class="line">    eventSystemFlags &amp; <span class="variable constant_">IS_EVENT_HANDLE_NON_MANAGED_NODE</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> listeners = <span class="title function_">accumulateEventHandleNonManagedNodeListeners</span>(</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> this cast may not make sense for events like</span></span><br><span class="line">      <span class="comment">// &quot;focus&quot; where React listens to e.g. &quot;focusin&quot;.</span></span><br><span class="line">      ((<span class="attr">reactEventType</span>: any): <span class="title class_">DOMEventName</span>),</span><br><span class="line">      targetContainer,</span><br><span class="line">      inCapturePhase</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (listeners.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Intentionally create event lazily.</span></span><br><span class="line">      <span class="keyword">const</span> event = <span class="keyword">new</span> <span class="title class_">SyntheticEventCtor</span>(</span><br><span class="line">        reactName,</span><br><span class="line">        reactEventType,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        nativeEvent,</span><br><span class="line">        nativeEventTarget</span><br><span class="line">      )</span><br><span class="line">      dispatchQueue.<span class="title function_">push</span>(&#123; event, listeners &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Some events don&#x27;t bubble in the browser.</span></span><br><span class="line">    <span class="comment">// In the past, React has always bubbled them, but this can be surprising.</span></span><br><span class="line">    <span class="comment">// We&#x27;re going to try aligning closer to the browser behavior by not bubbling</span></span><br><span class="line">    <span class="comment">// them in React either. We&#x27;ll start by not bubbling onScroll, and then expand.</span></span><br><span class="line">    <span class="keyword">const</span> accumulateTargetOnly =</span><br><span class="line">      !inCapturePhase &amp;&amp;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> ideally, we&#x27;d eventually add all events from</span></span><br><span class="line">      <span class="comment">// nonDelegatedEvents list in DOMPluginEventSystem.</span></span><br><span class="line">      <span class="comment">// Then we can remove this special list.</span></span><br><span class="line">      <span class="comment">// This is a breaking change that can wait until React 18.</span></span><br><span class="line">      domEventName === <span class="string">&#x27;scroll&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> listeners = <span class="title function_">accumulateSinglePhaseListeners</span>(</span><br><span class="line">      targetInst,</span><br><span class="line">      reactName,</span><br><span class="line">      nativeEvent.<span class="property">type</span>,</span><br><span class="line">      inCapturePhase,</span><br><span class="line">      accumulateTargetOnly,</span><br><span class="line">      nativeEvent</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> (listeners.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Intentionally create event lazily.</span></span><br><span class="line">      <span class="keyword">const</span> event = <span class="keyword">new</span> <span class="title class_">SyntheticEventCtor</span>(</span><br><span class="line">        reactName,</span><br><span class="line">        reactEventType,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        nativeEvent,</span><br><span class="line">        nativeEventTarget</span><br><span class="line">      )</span><br><span class="line">      dispatchQueue.<span class="title function_">push</span>(&#123; event, listeners &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用 <code>accumulateSinglePhaseListeners</code> 获取事件监听列表，从触发元素递归向上查询注册的事件然后放入监听器列表中返回</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/events/DOMPluginEventSystem.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">accumulateSinglePhaseListeners</span>(<span class="params"></span></span><br><span class="line"><span class="params">  targetFiber: Fiber | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  reactName: string | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  nativeEventType: string,</span></span><br><span class="line"><span class="params">  inCapturePhase: boolean,</span></span><br><span class="line"><span class="params">  accumulateTargetOnly: boolean,</span></span><br><span class="line"><span class="params">  nativeEvent: AnyNativeEvent</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Array</span>&lt;<span class="title class_">DispatchListener</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> captureName = reactName !== <span class="literal">null</span> ? reactName + <span class="string">&#x27;Capture&#x27;</span> : <span class="literal">null</span></span><br><span class="line">  <span class="keyword">const</span> reactEventName = inCapturePhase ? captureName : reactName</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">listeners</span>: <span class="title class_">Array</span>&lt;<span class="title class_">DispatchListener</span>&gt; = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> instance = targetFiber</span><br><span class="line">  <span class="keyword">let</span> lastHostComponent = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Accumulate all instances and listeners via the target -&gt; root path.</span></span><br><span class="line">  <span class="keyword">while</span> (instance !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; stateNode, tag &#125; = instance</span><br><span class="line">    <span class="comment">// Handle listeners that are on HostComponents (i.e. &lt;div&gt;)</span></span><br><span class="line">    <span class="keyword">if</span> (tag === <span class="title class_">HostComponent</span> &amp;&amp; stateNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">      lastHostComponent = stateNode</span><br><span class="line"></span><br><span class="line">      <span class="comment">// createEventHandle listeners</span></span><br><span class="line">      <span class="keyword">if</span> (enableCreateEventHandleAPI) &#123;</span><br><span class="line">        <span class="keyword">const</span> eventHandlerListeners =</span><br><span class="line">          <span class="title function_">getEventHandlerListeners</span>(lastHostComponent)</span><br><span class="line">        <span class="keyword">if</span> (eventHandlerListeners !== <span class="literal">null</span>) &#123;</span><br><span class="line">          eventHandlerListeners.<span class="title function_">forEach</span>(<span class="function">(<span class="params">entry</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">              entry.<span class="property">type</span> === nativeEventType &amp;&amp;</span><br><span class="line">              entry.<span class="property">capture</span> === inCapturePhase</span><br><span class="line">            ) &#123;</span><br><span class="line">              listeners.<span class="title function_">push</span>(</span><br><span class="line">                <span class="title function_">createDispatchListener</span>(</span><br><span class="line">                  instance,</span><br><span class="line">                  entry.<span class="property">callback</span>,</span><br><span class="line">                  (<span class="attr">lastHostComponent</span>: any)</span><br><span class="line">                )</span><br><span class="line">              )</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Standard React on* listeners, i.e. onClick or onClickCapture</span></span><br><span class="line">      <span class="keyword">if</span> (reactEventName !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> listener = <span class="title function_">getListener</span>(instance, reactEventName)</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="literal">null</span>) &#123;</span><br><span class="line">          listeners.<span class="title function_">push</span>(</span><br><span class="line">            <span class="title function_">createDispatchListener</span>(instance, listener, lastHostComponent)</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    instance = instance.<span class="property">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> listeners</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/12/react%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6/" data-id="cm19b6ryz0036gkdzh47i895k" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/" rel="tag">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react中的jsx语法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/06/react%E4%B8%AD%E7%9A%84jsx%E8%AF%AD%E6%B3%95/" class="article-date">
  <time datetime="2021-06-06T14:30:07.000Z" itemprop="datePublished">2021-06-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/06/react%E4%B8%AD%E7%9A%84jsx%E8%AF%AD%E6%B3%95/">react中的jsx语法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a><code>JSX</code></h2><p><code>JSX</code> 是一种嵌入式的类似 <code>XML</code> 的语法。 它可以被转换成合法的 <code>JavaScript</code>，尽管转换的语义是依据不同的实现而定的。 <code>JSX</code> 因 <code>React</code> 框架而流行，但也存在其它的实现。</p>
<h3 id="React-中的-JSX"><a href="#React-中的-JSX" class="headerlink" title="React 中的 JSX"></a><code>React</code> 中的 <code>JSX</code></h3><p><code>JSX</code> 为我们提供了创建 <code>React</code> 元素方法（<code>React.createElement(component, props, ...children)</code>）的语法糖（<code>syntactic sugar</code>）</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Hello, world!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="comment">// 编译后会被转化为</span></span><br><span class="line"><span class="keyword">var</span> element = <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;Hello, world!&#x27;</span>) <span class="comment">// 返回一个对象</span></span><br></pre></td></tr></table></figure>

<h4 id="JSX-代表-JS-对象"><a href="#JSX-代表-JS-对象" class="headerlink" title="JSX 代表 JS 对象"></a><code>JSX</code> 代表 <code>JS</code> 对象</h4><p><code>JSX</code> 本身也是一个表达式，在编译后，<code>JSX</code> 表达式会变成普通的 <code>JavaScript</code> 对象。执行 <code>React.createElement</code> 之后最终会执行一下代码生成一个普通的 <code>JavaScript</code> 对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ReactElement</span> = <span class="keyword">function</span> (<span class="params">type, key, ref, self, source, owner, props</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> element = &#123;</span><br><span class="line">    <span class="comment">// This tag allows us to uniquely identify this as a React Element</span></span><br><span class="line">    <span class="attr">$$typeof</span>: <span class="variable constant_">REACT_ELEMENT_TYPE</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Built-in properties that belong on the element</span></span><br><span class="line">    <span class="attr">type</span>: type,</span><br><span class="line">    <span class="attr">key</span>: key,</span><br><span class="line">    <span class="attr">ref</span>: ref,</span><br><span class="line">    <span class="attr">props</span>: props,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record the component responsible for creating this element.</span></span><br><span class="line">    <span class="attr">_owner</span>: owner,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> element</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上可以看出，执行 <code>React.createElement</code> 时只支持表达式，同时可以在以下情况中使用</p>
<ul>
<li>可以在 <code>if</code> 语句或 <code>for</code> 循环中使用 <code>JSX</code></li>
<li>可以将它赋值给变量</li>
<li>可以将它作为参数接收</li>
<li>可以在函数中返回 <code>JSX</code>。</li>
</ul>
<h5 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h5><p>在 <code>JavaScript</code> 中，表达式就是一个短语，<code>Javascript</code> 解释器会将其计算出一个结果，常量就是最简单的一类表达式。常用的表达式有：</p>
<ul>
<li>变量名</li>
<li>函数定义表达式</li>
<li>属性访问表达式</li>
<li>函数调用表达式</li>
<li>算数表达式</li>
<li>关系表达式</li>
<li>逻辑表达式</li>
</ul>
<p>注意: <code>if</code> 语句以及 <code>for</code> 循环不是 <code>JavaScript</code> 表达式</p>
<h4 id="JSX-可自动防范注入攻击"><a href="#JSX-可自动防范注入攻击" class="headerlink" title="JSX 可自动防范注入攻击"></a><code>JSX</code> 可自动防范注入攻击</h4><p>在默认情况下，React DOM 会将所有嵌入 JSX 的值进行编码，利用 <code>createTextNode</code> 进行 <code>HTML</code> 转义</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createTextNode</span>(<span class="params">text, rootContainerElement</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getOwnerDocumentFromRootContainer</span>(rootContainerElement).<span class="title function_">createTextNode</span>(</span><br><span class="line">    text</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若希望直接将字符串不经转义编码直接插入到 <code>HTML</code> 文档流，可以使用 <code>dangerouslySetInnerHTML</code> 属性，这是一个 <code>React</code> 版的 <code>innerHTML</code>，该属性接收一个 <code>key</code> 为 <code>__html</code> 的对象</p>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><ul>
<li><code>JSX</code> 会自动删除一行中开头和结尾处的空白符；</li>
<li><code>JSX</code> 会自动删除空行；</li>
<li><code>JSX</code> 会删除紧邻标签的换行；</li>
<li><code>JSX</code> 会删除字符串中的换行；</li>
<li>字符串中的换行会被转换成一个空格。</li>
</ul>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>允许使用熟悉的语法来定义 <code>HTML</code> 元素树</li>
<li>提供了更加语义化且易懂的标签</li>
<li>程序结构更容易被直观化</li>
<li>抽象了 <code>React Element</code> 的创建过程</li>
<li>可以随时掌控 <code>HTML</code> 标签以及生成这些标签的代码</li>
<li>原生 <code>Javascript</code></li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.tslang.cn/docs/handbook/jsx.html">JSX</a></li>
<li><a href="https://www.cnblogs.com/candlia/p/11920070.html">JSX 语法使用详解</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/06/react%E4%B8%AD%E7%9A%84jsx%E8%AF%AD%E6%B3%95/" data-id="cm19b6ryz0034gkdzdrf3bzad" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/" rel="tag">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react中的异步实现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/05/30/react%E4%B8%AD%E7%9A%84%E5%BC%82%E6%AD%A5%E5%AE%9E%E7%8E%B0/" class="article-date">
  <time datetime="2021-05-30T13:37:54.000Z" itemprop="datePublished">2021-05-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/05/30/react%E4%B8%AD%E7%9A%84%E5%BC%82%E6%AD%A5%E5%AE%9E%E7%8E%B0/">react中的异步实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h3><p>由于 <code>JS</code> 是单线程非阻塞的，所有的任务都需要在这个线程中来处理。当需要执行异步任务时主线程会先挂起这个任务，当异步任务执行完毕之后主线程会根据规则执行回调。当任务处理完毕之后， <code>JS</code> 会将这个事件加入队列中，这个队列即被称为事件队列。</p>
<h4 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h4><ul>
<li>进程： <code>CPU</code> 在运行指令及加载和保存上下文所需的时间，放在应用上来说就代表了一个程序。</li>
<li>线程： 进程中的更小单位，描述了执行一段指令所需的时间。</li>
</ul>
<p>在浏览器中，当你打开一个 <code>Tab</code> 页时，其实就是创建了一个进程，一个进程中可以有多个线程，比如渲染线程、<code>JS</code> 引擎线程、<code>HTTP</code> 请求线程等等。当你发起一个请求时，其实就是创建了一个线程，当请求结束后，该线程可能就会被销毁。</p>
<p>在 <code>JS</code> 运行的时候会阻止 <code>UI</code> 渲染，这是因为 <code>JS</code> 可以修改 <code>DOM</code>，如果在 <code>JS</code> 执行的时候 <code>UI</code> 线程还在工作，就可能导致不能安全的渲染 <code>UI</code>。这其实也是一个单线程的好处，得益于 <code>JS</code> 是单线程运行的，可以达到节省内存，节约上下文切换时间，没有锁的问题的好处。</p>
<p>对于锁的问题，形象的来说就是当我读取一个数字 <code>15</code> 的时候，同时有两个操作对数字进行了加减，这时候结果就出现了错误。解决这个问题也不难，只需要在读取的时候加锁，直到读取完毕之前都不能进行写入操作。</p>
<h4 id="执行栈"><a href="#执行栈" class="headerlink" title="执行栈"></a>执行栈</h4><p>所有的 <code>JS</code> 代码在运行时都是在执行上下文中进行的。<code>JS</code> 中有三种执行上下文：</p>
<ul>
<li>全局执行上下文，默认的，浏览器中是 <code>window</code> 对象，<code>nodejs</code> 中是 <code>global</code>，并且 <code>this</code> 在非严格模式下指向它们。</li>
<li>函数执行上下文，<code>JS</code> 的函数每当被调用时会创建一个上下文。</li>
<li><code>Eval</code> 执行上下文，<code>eval</code> 函数会产生自己的上下文。</li>
</ul>
<p>栈是一种数据结构，具有先进后出的原则。<code>JS</code> 中的执行栈就具有这样的结构，当引擎第一次遇到 <code>JS</code> 代码时，会产生一个全局执行上下文并压入执行栈，每遇到一个函数调用，就会往栈中压入一个新的上下文。引擎执行栈顶的函数，执行完毕，弹出当前执行上下文。</p>
<h4 id="微任务和宏任务"><a href="#微任务和宏任务" class="headerlink" title="微任务和宏任务"></a>微任务和宏任务</h4><p>异步任务被分为两种类型，微任务和宏任务</p>
<h5 id="微任务"><a href="#微任务" class="headerlink" title="微任务"></a>微任务</h5><ul>
<li><code>Promise.then</code></li>
<li><code>MutationObserver</code></li>
<li><code>process.nextTick</code></li>
</ul>
<h5 id="宏任务"><a href="#宏任务" class="headerlink" title="宏任务"></a>宏任务</h5><ul>
<li><code>script</code>(整体代码)</li>
<li><code>setTimout</code></li>
<li><code>setInterval</code></li>
<li><code>setImmediate</code></li>
<li><code>MessageChannel</code></li>
<li><code>requestAnimationFrame</code></li>
<li><code>postMessage</code></li>
<li><code>I/O</code></li>
<li><code>UI</code> 交互事件</li>
</ul>
<h4 id="事件循环-1"><a href="#事件循环-1" class="headerlink" title="事件循环"></a>事件循环</h4><p><code>Event Loop</code>(事件循环)中，每一次循环称为 <code>tick</code>, 每一次 <code>tick</code> 的任务如下：</p>
<ol>
<li>执行栈选择最先进入队列的宏任务(通常是 <code>script</code> 整体代码)，如果有则执行</li>
<li>检查是否存在 <code>Microtask</code>，如果存在则不停的执行，直至清空 <code>microtask</code> 队列</li>
<li>更新 <code>render</code>(每一次事件循环，浏览器都可能会去更新渲染)</li>
<li>重复以上步骤</li>
</ol>
<p>宏任务 &gt; 所有微任务 &gt; 宏任务，如下图所示：</p>
<p><img src="/images/js/eventLoop.jpg" alt="事件循环"></p>
<ol>
<li>将所有任务看成两个队列：执行队列与事件队列。</li>
<li>执行队列是同步的，事件队列是异步的，宏任务放入事件列表，微任务放入执行队列之后，事件队列之前。</li>
<li>当执行完同步代码之后，就会执行位于执行列表之后的微任务，然后再执行事件列表中的宏任务</li>
</ol>
<h3 id="react-中的异步实现"><a href="#react-中的异步实现" class="headerlink" title="react 中的异步实现"></a>react 中的异步实现</h3><p><code>react</code> 中的异步是通过宏任务来实现的，优先使用 <code>setImmediate</code> ，然后使用 <code>MessageChannel</code>，若都不支持则使用 <code>setTimeout</code> 实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> schedulePerformWorkUntilDeadline</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> localSetImmediate === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">  <span class="comment">// Node.js and old IE.</span></span><br><span class="line">  <span class="comment">// There&#x27;s a few reasons for why we prefer setImmediate.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Unlike MessageChannel, it doesn&#x27;t prevent a Node.js process from exiting.</span></span><br><span class="line">  <span class="comment">// (Even though this is a DOM fork of the Scheduler, you could get here</span></span><br><span class="line">  <span class="comment">// with a mix of Node.js 15+, which has a MessageChannel, and jsdom.)</span></span><br><span class="line">  <span class="comment">// https://github.com/facebook/react/issues/20756</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// But also, it runs earlier which is the semantic we want.</span></span><br><span class="line">  <span class="comment">// If other browsers ever implement it, it&#x27;s better to use it.</span></span><br><span class="line">  <span class="comment">// Although both of these would be inferior to native scheduling.</span></span><br><span class="line">  schedulePerformWorkUntilDeadline = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">localSetImmediate</span>(performWorkUntilDeadline)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">MessageChannel</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">  <span class="comment">// DOM and Worker environments.</span></span><br><span class="line">  <span class="comment">// We prefer MessageChannel because of the 4ms setTimeout clamping.</span></span><br><span class="line">  <span class="keyword">const</span> channel = <span class="keyword">new</span> <span class="title class_">MessageChannel</span>()</span><br><span class="line">  <span class="keyword">const</span> port = channel.<span class="property">port2</span></span><br><span class="line">  channel.<span class="property">port1</span>.<span class="property">onmessage</span> = performWorkUntilDeadline</span><br><span class="line">  schedulePerformWorkUntilDeadline = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    port.<span class="title function_">postMessage</span>(<span class="literal">null</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// We should only fallback here in non-browser environments.</span></span><br><span class="line">  schedulePerformWorkUntilDeadline = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">localSetTimeout</span>(performWorkUntilDeadline, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>判断是否存在 <code>setImmediate</code>，如果存在则使用 <code>setImmediate</code>，不存在下一步</li>
<li>判断是否支持 <code>MessageChannel</code>，如果支持则创建一个消息通道，通过消息通道实现宏任务，否则进行下一步</li>
<li>回落到 <code>setTimeout</code> 实现异步</li>
</ol>
<h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><ol>
<li>优先选择 <code>MessageChannel</code> 而不是 <code>setTimeout</code> 的原因是由于 <code>setTimeout</code> 有一个最小 <code>4ms</code> 的等待时间，在无宏任务执行时，这个时间会浪费掉</li>
<li>不选择微任务的原因是，使用微任务的方式时，当前任务任然占据了主线程而没有释放出来，达不到把主线程还给渲染线程的目的</li>
</ol>
<h5 id="edge-浏览器测试参考"><a href="#edge-浏览器测试参考" class="headerlink" title="edge 浏览器测试参考"></a><code>edge</code> 浏览器测试参考</h5><p><img src="/images/js/macroTask.png" alt="事件循环"></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://zhuanlan.zhihu.com/p/59784952">深入理解 JavaScript 执行上下文和执行栈</a></li>
<li><a href="https://segmentfault.com/a/1190000015317434">Js 的事件循环(Event Loop)机制以及实例讲解</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel">MessageChannel</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/05/30/react%E4%B8%AD%E7%9A%84%E5%BC%82%E6%AD%A5%E5%AE%9E%E7%8E%B0/" data-id="cm19b6rz0003bgkdz6n1b1yzg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/" rel="tag">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-前端框架" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/18/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/" class="article-date">
  <time datetime="2021-04-17T22:48:43.000Z" itemprop="datePublished">2021-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/18/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/">前端框架</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="DOM-操作时代"><a href="#DOM-操作时代" class="headerlink" title="DOM 操作时代"></a>DOM 操作时代</h3><p>代表库 <a href="https://jquery.com/"><code>jQuery</code></a> 和 <a href="https://zeptojs.com/"><code>zepto</code></a></p>
<ul>
<li>简化选择器</li>
<li>简化 <code>DOM</code> 操作</li>
<li>简化 <code>AJAX</code> 操作</li>
<li>统一事件绑定</li>
<li>兼容性实现</li>
<li>延时对象（<code>$.Deferred</code>）</li>
</ul>
<h4 id="DOM-操作的一般流程"><a href="#DOM-操作的一般流程" class="headerlink" title="DOM 操作的一般流程"></a>DOM 操作的一般流程</h4><ol>
<li><code>DOM</code> 加载</li>
<li><code>js</code> 脚本加载</li>
<li><code>js</code>脚本执行，发送异步请求获取数据</li>
<li>操作 <code>DOM</code> 进行数据渲染</li>
<li>对 <code>DOM</code> 节点进行事件绑定</li>
</ol>
<p><img src="/images/domprocess.png" alt="DOM 操作流程"></p>
<h3 id="MV-交互模式"><a href="#MV-交互模式" class="headerlink" title="MV* 交互模式"></a>MV* 交互模式</h3><h4 id="MVC-模式"><a href="#MVC-模式" class="headerlink" title="MVC 模式"></a>MVC 模式</h4><p>将 <code>DOM</code> 交互部分的内容分为数据模型、视图和事件控制三部分</p>
<ul>
<li><code>Model</code>：存放请求的数据结果和数据对象</li>
<li><code>View</code>: 页面 <code>DOM</code> 的更新与修改</li>
<li><code>Controller</code>: 根据前端路由条件调用不同的 <code>Model</code> 和 <code>View</code>渲染不同的数据内容</li>
</ul>
<p>用户的操作直接通过 <code>Controller</code> 控制</p>
<h4 id="MVP-模式"><a href="#MVP-模式" class="headerlink" title="MVP 模式"></a>MVP 模式</h4><p><code>Model-View-Presenter</code>，将 <code>DOM</code> 交互部分的内容分为数据模型、视图和 <code>Presenter</code> 三部分</p>
<ul>
<li><code>Model</code>：存放请求的数据结果和数据对象（仅提供数据）</li>
<li><code>View</code>: 页面 <code>DOM</code> 的更新与修改（仅提供视图模板）</li>
<li><code>Presenter</code>: 根据前端路由条件调用不同的 <code>Model</code> 和 <code>View</code>渲染不同的数据内容（主要的逻辑处理）</li>
</ul>
<p><code>Presenter</code> 与 <code>View</code> 的绑定是双向的，<code>Presenter</code> 的改变会改变 <code>View</code>，<code>View</code> 的改变也会触发 <code>Presenter</code>，所有的逻辑调用数据和渲染视图 <code>View</code> 模板都在 <code>Presenter</code> 中完成，同时用户在 <code>View</code> 层操作的改变反馈到 <code>Presenter</code> 改变 <code>Model</code>并渲染新的 <code>View</code> 视图。</p>
<ul>
<li>优点：只需关注 <code>Presenter</code> 的逻辑</li>
<li>缺点：内容较重</li>
</ul>
<h4 id="MVVM-模式"><a href="#MVVM-模式" class="headerlink" title="MVVM 模式"></a>MVVM 模式</h4><p>自动化的 <code>MVP</code> 框架，用 <code>ViewModel</code> 代替 <code>Presenter</code>，<code>Model</code> 的调用和 <code>View</code> 由 <code>ViewModel</code> 自动触发完成<br>用户操作时， <code>ViewModel</code> 捕获数据变化，将变化反应到 <code>View</code> 上。 <code>ViewModel</code> 的数据操作最终在页面上以 <code>Directive</code> 的形式体现，通过对 <code>Directive</code> 的识别来渲染数据或绑定事件。</p>
<h5 id="通用基本设计"><a href="#通用基本设计" class="headerlink" title="通用基本设计"></a>通用基本设计</h5><ul>
<li><code>Directive</code>: 指令，即自定义执行函数</li>
<li><code>Filter</code>: 过滤器，对传入的初始数据信进行处理，然后把处理结果交给下一步（<code>Directive</code> 或 <code>Filter</code>）。</li>
<li>表达式：控制页面内容按照具体条件展示</li>
<li><code>ViewModel</code>: 实现传入的 <code>Model</code> 数据在内存中存放，也提供一些基本的读取或修改数据的 <code>API</code></li>
<li>数据变更检查： 即数据变化自动触发其它操作，通过手动触发、脏检测、对象劫持、<code>Proxy</code> 等</li>
</ul>
<h6 id="数据变更检查"><a href="#数据变更检查" class="headerlink" title="数据变更检查"></a>数据变更检查</h6><ul>
<li>手动触发: 通过在数据对象上定义 <code>get</code> 和 <code>set</code> 方法，调用时手动触发 <code>get</code> 和 <code>set</code> 来获取和修改数据，改变后主动触发 <code>get</code> 和 <code>set</code> 中 <code>View</code> 层的重新渲染功能</li>
<li>脏检测: 在 <code>ViewModel</code> 对象的某个属性值发生变化时找到与这个属性值相关的所有元素，然后比较数据变化，如果有变化则进行 <code>Directive</code> 指令调用，对这个元素进行重新扫描渲染</li>
<li>前端数据对象劫持： 使用 <code>Object.defineProperty</code> 和 <code>Object.defineProperties</code> 对 <code>ViewModel</code> 数据对象进行属性 <code>get</code> 和 <code>set</code> 的监听，当有数据读取和赋值时则扫描节点元素，运行指定对应节点的 <code>Directive</code> 指令。</li>
<li><code>ES6 Proxy</code>:类似与 <code>Object.defineProperty</code> 和 <code>Object.defineProperties</code></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/18/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/" data-id="cm19b6rz70040gkdzc1vj358p" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/other/" rel="tag">other</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-与native交互" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/04/%E4%B8%8Enative%E4%BA%A4%E4%BA%92/" class="article-date">
  <time datetime="2021-04-03T20:06:35.000Z" itemprop="datePublished">2021-04-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/04/%E4%B8%8Enative%E4%BA%A4%E4%BA%92/">与native交互</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Hybird-App"><a href="#Hybird-App" class="headerlink" title="Hybird App"></a><code>Hybird App</code></h3><p>在 <code>Native App</code> 引用基础上结合了 <code>Web App</code> 应用所形成的模式，一般通过 <code>webview</code> 的模式引入</p>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>系统资源较少，包括 <code>CPU</code> 、内存、网卡、网络链接等。</li>
<li>支持更新的浏览器特性，不用考虑 <code>IE</code> 的兼容性问题</li>
<li>可以实现离线应用，通过新的浏览器特性或 <code>Native</code> 的文件读取机制进行文件级的文件缓存和离线更新</li>
<li>不同机型设备的兼容问题</li>
<li>可以调用客户端 <code>Native</code> 的能力，例如摄像头、定位、传感器、本地文件访问等。</li>
</ul>
<h3 id="Web-到-Native-的协议调用"><a href="#Web-到-Native-的协议调用" class="headerlink" title="Web 到 Native 的协议调用"></a><code>Web</code> 到 <code>Native</code> 的协议调用</h3><h4 id="通过-URI-请求"><a href="#通过-URI-请求" class="headerlink" title="通过 URI 请求"></a>通过 <code>URI</code> 请求</h4><p>在系统中注册一个 <code>Schema</code> 协议的 <code>URI</code> ，这个 <code>URI</code> 可以在系统的任意地方调起一段原生方法或一个原生的界面</p>
<p><img src="/images/webtonative.svg" alt="`web` 通过 `URI` 请求 `Native` 流程"></p>
<h4 id="通过-addJavascriptInterface-注入方法到页面中调用"><a href="#通过-addJavascriptInterface-注入方法到页面中调用" class="headerlink" title="通过 addJavascriptInterface 注入方法到页面中调用"></a>通过 <code>addJavascriptInterface</code> 注入方法到页面中调用</h4><p>通过 <code>addJavascriptInterface</code> 方法向页面中注入一个全局对象以供调用</p>
<h4 id="注入对象"><a href="#注入对象" class="headerlink" title="注入对象"></a>注入对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明 ws 实例</span></span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">ws</span> <span class="operator">=</span> webView.getSetting();</span><br><span class="line"><span class="comment">// 开启执行 JavaScript 脚本</span></span><br><span class="line">ws.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 加载页面</span></span><br><span class="line">ws.loadUrl(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line"><span class="comment">// 注入全局对象</span></span><br><span class="line">ws.addJavascriptInterface(<span class="keyword">new</span> <span class="title class_">Object</span>(), <span class="string">&quot;native&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 调用注入的 native 方法</span></span></span><br><span class="line"><span class="language-javascript">    native.<span class="title function_">method</span>()</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Native-到-Web-的调用"><a href="#Native-到-Web-的调用" class="headerlink" title="Native 到 Web 的调用"></a><code>Native</code> 到 <code>Web</code> 的调用</h3><ul>
<li>安卓：通过 <code>webView.loadUrl</code> 方法实现</li>
<li>iOS ：通过 <code>stringByEvaluatingJavaScriptFromString</code> 方法实现</li>
</ul>
<h4 id="html-定义方法"><a href="#html-定义方法" class="headerlink" title="html 定义方法"></a>html 定义方法</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">log</span>(<span class="params">msg</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(msg)</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="原生调用"><a href="#原生调用" class="headerlink" title="原生调用"></a>原生调用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明 ws 实例</span></span><br><span class="line"><span class="type">WebSettings</span> <span class="variable">ws</span> <span class="operator">=</span> webView.getSetting();</span><br><span class="line"><span class="comment">// 开启执行 JavaScript 脚本</span></span><br><span class="line">ws.setJavaScriptEnabled(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 加载页面</span></span><br><span class="line">ws.loadUrl(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line"><span class="comment">// 调用 js 方法</span></span><br><span class="line">webView.loadUr(<span class="string">&quot;javascript: log(&#x27;hello world&#x27;)&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="JSBridge"><a href="#JSBridge" class="headerlink" title="JSBridge"></a><code>JSBridge</code></h3><p>通信规则： <code>jsBridge://className:callbackMethod/methodName?jsonObj</code></p>
<h4 id="安卓实现"><a href="#安卓实现" class="headerlink" title="安卓实现"></a>安卓实现</h4><p>通过 <code>prompt</code> 方式调用。 <code>addJavascriptInterface</code> 存在安全漏洞，可以通过 <code>JavascriptInterface</code> 来解决，但是其存在兼容性问题。所以通过 <code>webView.setWebChromeClient</code> 来实现： <code>JavaScript</code> 在执行 <code>alert</code> 和 <code>prompt</code> 时， <code>Native</code> 端会自动触发 <code>onJsAlert</code> 和 <code>onJsPrompt</code> 的方法回调函数，由于 <code>alert</code> 比较常用，所以可以通过重写 <code>onJsPrompt</code> 的方法实现对 <code>Native</code> 端方法的调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置 prompt 监听</span></span><br><span class="line">webView.setWebChromeClient(<span class="keyword">new</span> <span class="title class_">WebChromeClient</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onJsPrompt</span><span class="params">(WebView wv, String url, String msg, String defaultValue, JsPromptResult res)</span> &#123;</span><br><span class="line">        res.confirm(JSBridge.callJsPrompt(MainActivity.<span class="built_in">this</span>, wv, msg));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="iOS-实现"><a href="#iOS-实现" class="headerlink" title="iOS 实现"></a><code>iOS</code> 实现</h4><p>通过 <code>iframe</code> 的方式调用</p>
<h4 id="调用流程"><a href="#调用流程" class="headerlink" title="调用流程"></a>调用流程</h4><ol>
<li>安卓通过 <code>prompt(jsBridge://className:callbackMethod/methodName?jsonObj)</code> 调用，<code>iOS</code> 通过 <code>iframe</code> 方式调用</li>
<li><code>Native</code> 解析协议，调用对应的 <code>className</code> 对象中的 <code>methodName</code> 方法，并把对应的参数 <code>jsonObj</code> 序列化后作为方法的参数</li>
<li>执行完成后调用 <code>JavaScript</code> 回调函数返回结果</li>
</ol>
<p><img src="/images/jsbridge.svg" alt="调用流程"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/04/%E4%B8%8Enative%E4%BA%A4%E4%BA%92/" data-id="cm19b6rzl005dgkdz3xseebdx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/other/" rel="tag">other</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-实时协议" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/02/%E5%AE%9E%E6%97%B6%E5%8D%8F%E8%AE%AE/" class="article-date">
  <time datetime="2021-04-01T23:38:14.000Z" itemprop="datePublished">2021-04-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/02/%E5%AE%9E%E6%97%B6%E5%8D%8F%E8%AE%AE/">实时协议</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="websocket"><a href="#websocket" class="headerlink" title="websocket"></a>websocket</h3><p><code>WebSocket</code> 是一种在单个 <code>TCP</code> 连接上进行全双工通信的协议，允许服务端主动向客户端推送数据。在 <code>WebSocket API</code> 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。</p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p><a href="/2021/01/06/nodejs%E4%B8%AD%E5%AE%9E%E7%8E%B0websocket%E6%9C%8D%E5%8A%A1/">nodejs 中实现 websocket 服务</a></p>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>较少的控制开销。在连接创建后，服务器和客户端之间交换数据时，用于协议控制的数据包头部相对较小。在不包含扩展的情况下，对于服务器到客户端的内容，此头部大小只有 2 至 10 字节（和数据包长度有关）；对于客户端到服务器的内容，此头部还需要加上额外的 4 字节的掩码。相对于 HTTP 请求每次都要携带完整的头部，此项开销显著减少了。</li>
<li>更强的实时性。由于协议是全双工的，所以服务器可以随时主动给客户端下发数据。相对于 HTTP 请求需要等待客户端发起请求服务端才能响应，延迟明显更少；即使是和 Comet 等类似的长轮询比较，其也能在短时间内更多次地传递数据。</li>
<li>保持连接状态。与 HTTP 不同的是，Websocket 需要先创建连接，这就使得其成为一种有状态的协议，之后通信时可以省略部分状态信息。而 HTTP 请求可能需要在每个请求都携带状态信息（如身份认证等）。</li>
<li>更好的二进制支持。Websocket 定义了二进制帧，相对 HTTP，可以更轻松地处理二进制内容。</li>
<li>可以支持扩展。Websocket 定义了扩展，用户可以扩展协议、实现部分自定义的子协议。如部分浏览器支持压缩等。</li>
<li>更好的压缩效果。相对于 HTTP 压缩，Websocket 在适当的扩展支持下，可以沿用之前内容的上下文，在传递类似的数据时，可以显著地提高压缩率。</li>
</ul>
<h3 id="长轮询"><a href="#长轮询" class="headerlink" title="长轮询"></a>长轮询</h3><p><code>HTTP</code> 请求设置一个较长的超时等待时间，网络请求可以维持一个较长的时间来等待返回结果，如果在等待的时间内有结果会立即返回结果，如果没有结果就会超时自动断开链接，等待下一次请求。</p>
<p><img src="/images/long-poll.svg" alt="长轮询流程"></p>
<h3 id="短轮询"><a href="#短轮询" class="headerlink" title="短轮询"></a>短轮询</h3><p>每隔一段时间定时向服务端发起一次请求拉取数据。</p>
<p><img src="/images/poll.svg" alt="短轮询流程"></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://baike.baidu.com/item/WebSocket/1953845?fr=aladdin">WebSocket</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/02/%E5%AE%9E%E6%97%B6%E5%8D%8F%E8%AE%AE/" data-id="cm19b6rz70044gkdz5ux95f76" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/" rel="tag">node</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/" rel="tag">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-计算机网络-HTTPS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-HTTPS/" class="article-date">
  <time datetime="2021-03-27T20:13:54.000Z" itemprop="datePublished">2021-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-HTTPS/">计算机网络-HTTPS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>HTTPS</code> 协议是通过加入 <code>SSL</code> 层来加密 <code>HTTP</code> 数据进行安全通信的</p>
<h3 id="HTTPS-建立链接的过程"><a href="#HTTPS-建立链接的过程" class="headerlink" title="HTTPS 建立链接的过程"></a><code>HTTPS</code> 建立链接的过程</h3><ol>
<li>客户端发起请求，携带客户端支持加密算法，同时携带随机串 1</li>
<li>服务端收到请求后与自己支持的加密算法进行比对，从双方都支持的加密算法中选择一个返回，同时返回域名相关的公钥和证书签名信息（包括证书时间、日期、颁发机构）及随机串 2</li>
<li>客户端收到响应后验证证书的合法性和公钥的正确性（通过请求证书颁发机构来验证证书的合法性）</li>
<li>证书验证通过后，利用公钥加密一个随机字符串作为后续传输数据的密钥，同时加入利用公钥加密随机串 1 和随机串 2 组成的握手信息，然后发送给服务端</li>
<li>服务端获取到信息后利用私钥进行解密得到客户端生成的随机字符串把它作为后续传输的密钥，利用密钥对传输的随机串 1 和随机串 2 进行加密，然后返回</li>
<li>客户端利用上述生成的随机串对返回的信息进行解密，然后验证其合法性，后续传输就是堆成加密传输</li>
</ol>
<p><img src="/images/https.svg" alt="HTTPS 获取密钥过程"></p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li><a href="https://www.jianshu.com/p/33d0f8631f90">https 建立连接过程</a></li>
<li><a href="https://blog.csdn.net/xiaoming100001/article/details/81109617">HTTP 和 HTTPS 协议，看一篇就够了
</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-HTTPS/" data-id="cm19b6rzk0059gkdzc5iodjle" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/" rel="tag">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-网络安全" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/28/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" class="article-date">
  <time datetime="2021-03-27T19:34:30.000Z" itemprop="datePublished">2021-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/28/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前端攻击"><a href="#前端攻击" class="headerlink" title="前端攻击"></a>前端攻击</h3><h4 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a><code>XSS</code></h4><p>跨站脚本攻击，由插入页面处理的数据未经处理导致。</p>
<ul>
<li>存储型 <code>XSS</code> ：提交的数据未经处理存储到数据库中，然后从数据库中获取数据插入页面导致的</li>
<li>反射型 <code>XSS</code> ：通过 <code>URL</code> 提取参数未经处理直接插入到页面导致</li>
<li><code>MXSS</code> ：渲染 <code>DOM</code> 时插入了攻击脚本（模板渲染）</li>
</ul>
<p>通过字符转义的方式把特殊的符号转化为安全的 <code>HTML</code> 字符（如 &lt;、&gt;等）</p>
<h4 id="SQL-注入攻击"><a href="#SQL-注入攻击" class="headerlink" title="SQL 注入攻击"></a><code>SQL</code> 注入攻击</h4><p>结构性查询语言注入攻击，页面提交的数据直接拼接到 <code>SQL</code> 语句进行操作导致，通过对查询数据进行合法性校验即可避免</p>
<h4 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a><code>CSRF</code></h4><p>跨站请求伪造，非源站点按照源站点数据格式提交非法数据给源站点的一种攻击方式。大部分网站是通过 <code>COOKIE</code> 的方式来验证登录的用户信息，由于浏览器的策略导致请求时会自动携带相关 <code>COOKIE</code>，当非源站点请求源站点数据时也会携带相关 <code>COOKIE</code>，此时构造一个非法的请求也会请求成功。解决办法就是通过在页面中预先植入 <code>TOKEN</code> ，在接口请求时再手动携带上相关的值，由于浏览器的安全策略限制非源站点无法读取相关数据进而导致请求失败</p>
<h3 id="网络劫持"><a href="#网络劫持" class="headerlink" title="网络劫持"></a>网络劫持</h3><p>网络资源请求在请求过程中因为人为的攻击导致没有加载到预期的资源内容。</p>
<h4 id="DNS-劫持"><a href="#DNS-劫持" class="headerlink" title="DNS 劫持"></a><code>DNS</code> 劫持</h4><p>攻击者通过篡改 <code>DNS</code> 服务器的域名解析记录，导致用户无法访问正确的网络 <code>IP</code> ，而是访问篡改后的错误 <code>IP</code> 地址。</p>
<h4 id="HTTP-劫持"><a href="#HTTP-劫持" class="headerlink" title="HTTP 劫持"></a><code>HTTP</code> 劫持</h4><p>在用户浏览器和访问的目的服务器之间建立的网络数据传输通道中从网关或防火墙层上监视特定的数据信息，当满足特定条件时，就会在正常的数据包中插入或篡改网络数据包（如 <code>ISP</code> 在部分第三方网站页面中植入广告）。可以通过 <code>HTTPS</code> 协议来预防</p>
<h3 id="浏览器-WEB-安全控制"><a href="#浏览器-WEB-安全控制" class="headerlink" title="浏览器 WEB 安全控制"></a>浏览器 <code>WEB</code> 安全控制</h3><h4 id="X-XSS-Protection"><a href="#X-XSS-Protection" class="headerlink" title="X-XSS-Protection"></a><code>X-XSS-Protection</code></h4><p>防止反射型 <code>XSS</code> 问题的发生，浏览器层面增强前端网页的安全性。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">X-XSS-Protection:</span> <span class="number">0</span> <span class="comment"># 禁止XSS过滤。</span></span><br><span class="line"><span class="attr">X-XSS-Protection:</span> <span class="number">1</span> <span class="comment"># 启用XSS过滤（通常浏览器是默认的）。 如果检测到跨站脚本攻击，浏览器将清除页面（删除不安全的部分）。</span></span><br><span class="line"><span class="attr">X-XSS-Protection:</span> <span class="number">1</span><span class="string">;</span> <span class="string">mode=block</span> <span class="comment"># 启用XSS过滤。 如果检测到攻击，浏览器将不会清除页面，而是阻止页面加载。</span></span><br><span class="line"><span class="attr">X-XSS-Protection:</span> <span class="number">1</span><span class="string">;</span> <span class="string">report=&lt;reporting-uri&gt;</span> <span class="comment"># 启用XSS过滤。 如果检测到跨站脚本攻击，浏览器将清除页面并使用CSP report-uri (en-US)指令的功能发送违规报告。</span></span><br></pre></td></tr></table></figure>

<h4 id="Strict-Transport-Security"><a href="#Strict-Transport-Security" class="headerlink" title="Strict-Transport-Security"></a><code>Strict-Transport-Security</code></h4><p>配置浏览器和服务器之间安全通信的机制，防止中间者攻击（强制使用 <code>HTTPS</code> 协议，普通协议无效）</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Strict-Transport-Security:</span> <span class="string">max-age=&lt;expire-time&gt;</span> <span class="comment"># 设置在浏览器收到这个请求后的&lt;expire-time&gt;秒的时间内凡是访问这个域名下的请求都使用HTTPS请求。</span></span><br><span class="line"><span class="attr">Strict-Transport-Security:</span> <span class="string">max-age=&lt;expire-time&gt;;</span> <span class="string">includeSubDomains</span> <span class="comment"># 如果这个可选的参数被指定，那么说明此规则也适用于该网站的所有子域名。</span></span><br><span class="line"><span class="attr">Strict-Transport-Security:</span> <span class="string">max-age=&lt;expire-time&gt;;</span> <span class="string">preload</span> <span class="comment"># 查看 预加载 HSTS 获得详情。不是标准的一部分。</span></span><br></pre></td></tr></table></figure>

<h4 id="Content-Security-Policy"><a href="#Content-Security-Policy" class="headerlink" title="Content-Security-Policy"></a><code>Content-Security-Policy</code></h4><p>开发者定义的安全策略性声明，浏览器只可以加载指定可信域名来源的内容（包括脚本、图片、<code>iframe</code>、<code>font</code>、<code>style</code> 等）</p>
<h4 id="Access-Control-Allow-Origin"><a href="#Access-Control-Allow-Origin" class="headerlink" title="Access-Control-Allow-Origin"></a><code>Access-Control-Allow-Origin</code></h4><p>决定哪些网站可以访问当前服务器资源，通过定义通配符可以让所有网站来访问当前网站的所有资源。若 <code>Access-Control-Allow-Origin</code> 为 <code>*</code>，则 <code>Access-Control-Allow-Credentials</code> 无效。若想 <code>Access-Control-Allow-Credentials</code> 有效（即请求携带 <code>Cookie</code>），则必须明确配置来源。</p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/X-XSS-Protection"><code>X-XSS-Protection</code></a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Strict-Transport-Security"><code>Strict-Transport-Security</code></a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP"><code>Content-Security-Policy</code></a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Origin"><code>Access-Control-Allow-Origin</code></a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/28/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" data-id="cm19b6rzf0053gkdzd8kpcmcj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/" rel="tag">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-计算机网络-http协议" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-http%E5%8D%8F%E8%AE%AE/" class="article-date">
  <time datetime="2021-03-21T16:41:21.000Z" itemprop="datePublished">2021-03-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-http%E5%8D%8F%E8%AE%AE/">计算机网络-http协议</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><p>无状态、无连接的应用层协议</p>
<h3 id="HTTP-1-0"><a href="#HTTP-1-0" class="headerlink" title="HTTP 1.0"></a>HTTP 1.0</h3><p>浏览器和服务器保持短暂的连接，浏览器的每次请求都需要与服务器建立一个 TCP 连接，服务器处理完成后立即断开 TCP 连接（无连接），服务器不跟踪每个客户端也不记录过去的请求（无状态）。</p>
<h3 id="HTTP-1-1"><a href="#HTTP-1-1" class="headerlink" title="HTTP 1.1"></a>HTTP 1.1</h3><p>发布于 1999 年，默认使用文本格式传输数据</p>
<h4 id="长链接"><a href="#长链接" class="headerlink" title="长链接"></a>长链接</h4><p>默认包含 <code>Connection: keep-alive</code> 头，可以让客户端和服务端在一段时间内可以复用这个链接，无需再次建立链接。链接复用发生在应用层，且复用是串行的</p>
<h4 id="支持请求管道化"><a href="#支持请求管道化" class="headerlink" title="支持请求管道化"></a>支持请求管道化</h4><p>基于 HTTP1.1 的长连接，使得请求管线化成为可能。管线化使得请求能够“并行”传输。虽然 HTTP1.1 支持管道化，但是服务器必须按照客户端请求的先后顺序依次回送相应的结果，以保证客户端能够区分出每次请求的响应内容。</p>
<p><img src="/images/brower/http_pipe.png" alt="HTTP1.1 支持管道化链接图"></p>
<p>由于“管道化”技术存在各种各样的问题，所以很多浏览器要么根本不支持它，要么就直接默认关闭。</p>
<h4 id="协议扩展切换"><a href="#协议扩展切换" class="headerlink" title="协议扩展切换"></a>协议扩展切换</h4><p>支持在请求头部域消息中包含 <code>Upgrade</code> 头并让客户端通过头部标识令服务器知道它能够支持其它备用通信协议的一种机制，服务器根据客户端请求的其它协议进行切换，切换后使用备用协议与客户端进行通信</p>
<h4 id="缓存控制"><a href="#缓存控制" class="headerlink" title="缓存控制"></a>缓存控制</h4><p>新增 <code>Cache-Control</code> 字段，支持 <code>max-age</code> 用来表示相对过期时间；服务器也可以通过 <code>Etag</code> 和 <code>Last-Modified</code> 来判断是否从浏览器中加载文件，此时缓存的控制和判断将决定响应状态码是 200 还是 304。参考<a href="/2020/08/31/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98/">浏览器缓存</a>章节</p>
<h4 id="部分内容传输优化"><a href="#部分内容传输优化" class="headerlink" title="部分内容传输优化"></a>部分内容传输优化</h4><p>引入了 <code>range</code> 头域支持超文本文件的部分传输。如允许请求一个文件的起始位置和偏移长度来进行文件内容的部分传输</p>
<h4 id="Host-头处理"><a href="#Host-头处理" class="headerlink" title="Host 头处理"></a>Host 头处理</h4><p>请求消息和响应消息都支持 <code>Host</code> 头域，且请求消息中如果没有 <code>Host</code> 头域会报告一个错误（<code>400 Bad Request</code>）</p>
<h4 id="错误通知的管理"><a href="#错误通知的管理" class="headerlink" title="错误通知的管理"></a>错误通知的管理</h4><p>新增了 <code>24</code> 个错误状态响应码，如 <code>409（Conflict）</code>表示请求的资源与资源的当前状态发生冲突；<code>410（Gone）</code>表示服务器上的某个资源被永久性的删除。</p>
<h3 id="HTTP-2-0"><a href="#HTTP-2-0" class="headerlink" title="HTTP 2.0"></a>HTTP 2.0</h3><ul>
<li>采用完全的二进制格式来传输数据，其在网络中以帧的形式传播，多个帧在网络中形成了帧的传输网络流，即流式传播的。</li>
<li>使用 <code>TCP</code> 复用的方式来降低网络请求链接的建立和关闭的开销，多个请求可以通过一个链接来进行并发完成。复用发生在传输层，是帧的多路复用，不同文件的传输可以在一个 <code>TCP</code> 连接中一起同时进行流式传播</li>
<li>支持传输流的优先级和流量控制机制</li>
<li>支持服务端推送</li>
</ul>
<h4 id="二进制分帧"><a href="#二进制分帧" class="headerlink" title="二进制分帧"></a>二进制分帧</h4><p>通过在应用层和传输层之间增加一个二进制分帧层，突破了 HTTP1.1 的性能限制、改进传输性能。</p>
<p><img src="/images/brower/http_bf.jpg" alt="二进制分帧结构图"></p>
<h4 id="多路复用（连接共享）"><a href="#多路复用（连接共享）" class="headerlink" title="多路复用（连接共享）"></a>多路复用（连接共享）</h4><ul>
<li>流（stream）：已建立连接上的双向字节流。</li>
<li>消息：与逻辑消息对应的完整的一系列数据帧。</li>
<li>帧（frame）：HTTP2.0 通信的最小单位，每个帧包含帧头部，至少也会标识出当前帧所属的流（stream id）。</li>
</ul>
<p><img src="/images/brower/http_stream.jpg" alt="多路复用（连接共享）"></p>
<p>所有的 HTTP2.0 通信都在一个 TCP 连接上完成，这个连接可以承载任意数量的双向数据流。每个数据流以消息的形式发送，而消息由一或多个帧组成。这些帧可以乱序发送，然后再根据每个帧头部的流标识符（stream id）重新组装。</p>
<h4 id="头部压缩"><a href="#头部压缩" class="headerlink" title="头部压缩"></a>头部压缩</h4><p>使用 encoder 来减少需要传输的 header 大小，通讯双方各自 cache 一份 header fields 表，既避免了重复 header 的传输，又减小了需要传输的大小。高效的压缩算法可以很大的压缩 header，减少发送包的数量从而降低延迟。</p>
<p>在头部压缩技术中，客户端和服务器均会维护两份相同的静态字典和动态字典。在静态字典中，包含了常见的头部名称以及头部名称与值的组合。静态字典在首次请求时就可以使用。那么现在头部的字段就可以被简写成静态字典中相应字段对应的 index。而动态字典跟连接的上下文相关，每个 HTTP&#x2F;2 连接维护的动态字典是不尽相同的。动态字典可以在连接中不听的进行更新。原本完整的 HTTP 报文头部的键值对或字段，由于字典的存在，现在可以转换成索引 index，在相应的端再进行查找还原，也就起到了压缩的作用。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.jianshu.com/p/be29d679cbff">HTTP1.0、HTTP1.1 和 HTTP2.0 的区别</a></li>
<li><a href="https://segmentfault.com/a/1190000013028798?utm_source=tag-newest">HTTP1.0 HTTP1.1 HTTP2.0 主要特性对比</a></li>
<li><a href="https://www.jianshu.com/p/52d86558ca57">如何优雅的谈论 HTTP／1.0／1.1／2.0</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-http%E5%8D%8F%E8%AE%AE/" data-id="cm19b6rzm005fgkdz9h62gbj3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/" rel="tag">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-commonjs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/03/commonjs/" class="article-date">
  <time datetime="2021-03-02T23:44:49.000Z" itemprop="datePublished">2021-03-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/03/commonjs/">commonjs</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="commonjs-规范"><a href="#commonjs-规范" class="headerlink" title="commonjs 规范"></a>commonjs 规范</h3><ul>
<li>模块引用：通过 <code>require</code> 方法把模块引入上下文</li>
<li>模块定义：模块中通过 <code>exports</code> 属性导出模块的方法和变量，<code>module</code> 代表模块自身</li>
<li>模块标识：传递给 <code>require</code> 方法的参数</li>
</ul>
<h3 id="node-实现"><a href="#node-实现" class="headerlink" title="node 实现"></a>node 实现</h3><h5 id="引入模块的流程"><a href="#引入模块的流程" class="headerlink" title="引入模块的流程"></a>引入模块的流程</h5><ol>
<li>路径分析</li>
<li>文件定位</li>
<li>编译执行</li>
</ol>
<h5 id="模块分类"><a href="#模块分类" class="headerlink" title="模块分类"></a>模块分类</h5><ol>
<li>核心模块：<code>Node</code> 源代码的编译过程中，编译进了二进制执行文件。<code>Node</code> 启动时已经被加载入内存中</li>
<li>文件模块：运行时动态加载</li>
</ol>
<h4 id="模块缓存"><a href="#模块缓存" class="headerlink" title="模块缓存"></a>模块缓存</h4><ol>
<li>引入过的模块都会进行缓存</li>
<li>缓存优先</li>
</ol>
<h4 id="路径分析和文件定位"><a href="#路径分析和文件定位" class="headerlink" title="路径分析和文件定位"></a>路径分析和文件定位</h4><h5 id="模块路径"><a href="#模块路径" class="headerlink" title="模块路径"></a>模块路径</h5><p><code>Node</code> 中在定位文件模块的具体文件时制定的查找策略，根据查找规则生成查找路径数组，查找规则如下</p>
<ol>
<li>查找当前目录下的 <code>node_modules</code> 目录</li>
<li>父目录下的 <code>node_modules</code> 目录</li>
<li>沿着路径向上逐级递归直到找到根目录的 <code>node_modules</code> 目录</li>
</ol>
<h5 id="模块标志符分析"><a href="#模块标志符分析" class="headerlink" title="模块标志符分析"></a>模块标志符分析</h5><ul>
<li>核心模块</li>
<li>相对路径模块和绝对路径模块：转化为真实路径作为索引来查找和缓存模块</li>
<li>非路径形式的文件模块</li>
</ul>
<h5 id="文件定位"><a href="#文件定位" class="headerlink" title="文件定位"></a>文件定位</h5><ul>
<li>文件扩展名分析：<code>Node</code> 会按照 <code>.js</code>、<code>.json</code>、<code>.node</code>的次序依次尝试扩展名，尝试过程中会阻塞式的判断文件是否存在</li>
<li>目录分析与包：分析标识符得到一个文件夹时，<code>Node</code> 会按照 <code>package.json</code>、<code>index.js</code>、<code>index.json</code>、<code>index.node</code>来查找文件，若查找到 <code>package.json</code> 会提取 <code>main</code> 指定的文件来进行定位</li>
</ul>
<h4 id="模块编译"><a href="#模块编译" class="headerlink" title="模块编译"></a>模块编译</h4><p>定位到具体的文件之后，<code>Node</code> 会构建一个模块对象，然后根据路径载入并编译</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Module</span>(<span class="params">id, parent</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">id</span> = id</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">parent</span> = parent</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">exports</span> = &#123;&#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">filename</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">loaded</span> = <span class="literal">false</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">children</span> = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (parent &amp;&amp; parent.<span class="property">children</span>) &#123;</span><br><span class="line">    parent.<span class="property">children</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="不同扩展名的载入方式"><a href="#不同扩展名的载入方式" class="headerlink" title="不同扩展名的载入方式"></a>不同扩展名的载入方式</h5><ul>
<li><code>.js</code> 文件：通过 <code>fs</code> 模块同步读取文件后编译执行</li>
<li><code>.node</code> 文件：<code>c/c++</code> 写的扩展文件，通过 <code>dlopen()</code> 方法加载编译生成的文件</li>
<li><code>.json</code> 文件：通过 <code>fs</code> 模块同步读取文件后返回 <code>JSON.parse</code> 的结果</li>
<li>其它类型的文件：当作 <code>.js</code> 文件来处理</li>
</ul>
<h6 id="注：-可以通过-require-extensions-ext-的方式来扩展方式，但是已不推荐"><a href="#注：-可以通过-require-extensions-ext-的方式来扩展方式，但是已不推荐" class="headerlink" title="注： 可以通过 require.extensions[&quot;.ext&quot;] 的方式来扩展方式，但是已不推荐"></a>注： 可以通过 <code>require.extensions[&quot;.ext&quot;]</code> 的方式来扩展方式，但是已不推荐</h6><h5 id="JavaScript-模块的编译"><a href="#JavaScript-模块的编译" class="headerlink" title="JavaScript 模块的编译"></a><code>JavaScript</code> 模块的编译</h5><p><code>Node</code> 对获取的 <code>JavaScript</code> 文件内容做了包装，在头部添加了 <code>(function(exports, require, module, __filename, __dirname)&#123;\n</code>，在尾部添加了 <code>\n&#125;)</code>，包装之后的代码会通过 <code>vm</code> 原生的 <code>runInThisContext()</code> 方法执行，返回一个 <code>function</code> 对象，然后将当前模块对象的 <code>exports</code> 属性、<code>require</code> 方法、 <code>module</code>（模块对象自身）、模块定位中的完整文件路径和目录作为参数传递给这个函数执行，执行之后模块的 <code>exports</code> 属性被返回给了调用方</p>
<h6 id="注：-exports-属性是作为形参传入的，直接赋值会改变形参的引用，通过-module-exports-赋值采用迂回的方案不改变形参的引用"><a href="#注：-exports-属性是作为形参传入的，直接赋值会改变形参的引用，通过-module-exports-赋值采用迂回的方案不改变形参的引用" class="headerlink" title="注： exports 属性是作为形参传入的，直接赋值会改变形参的引用，通过 module.exports 赋值采用迂回的方案不改变形参的引用"></a>注： <code>exports</code> 属性是作为形参传入的，直接赋值会改变形参的引用，通过 <code>module.exports</code> 赋值采用迂回的方案不改变形参的引用</h6><h5 id="c-c-模块的编译"><a href="#c-c-模块的编译" class="headerlink" title="c/c++ 模块的编译"></a><code>c/c++</code> 模块的编译</h5><p><code>Node</code> 调用 <code>process.dlopen</code> 方法进行加载和执行，模块的 <code>exports</code> 对象和 <code>.node</code> 模块产生联系并返回给调用者</p>
<ul>
<li>优点： 执行效率高</li>
<li>缺点：门槛高</li>
</ul>
<h5 id="JSON-文件的编译"><a href="#JSON-文件的编译" class="headerlink" title="JSON 文件的编译"></a><code>JSON</code> 文件的编译</h5><p><code>Node</code> 利用 <code>fs</code> 模块同步读取 <code>JSON</code> 文件内容之后，调用 <code>JSON.parse</code> 方法得到对象，然后赋值给对象的 <code>exports</code> 属性供外部调用</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/03/commonjs/" data-id="cm19b6ryq001xgkdzbljt3n82" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/" rel="tag">node</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-浏览器基础" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/02/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%9F%BA%E7%A1%80/" class="article-date">
  <time datetime="2021-03-01T23:06:23.000Z" itemprop="datePublished">2021-03-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/02/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%9F%BA%E7%A1%80/">浏览器基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="浏览器组成"><a href="#浏览器组成" class="headerlink" title="浏览器组成"></a>浏览器组成</h3><h4 id="用户界面"><a href="#用户界面" class="headerlink" title="用户界面"></a>用户界面</h4><p>包括浏览器中可见的地址输入框、浏览器前进返回按钮、打开书签、打开历史记录等用户可操作的功能选项</p>
<h4 id="浏览器引擎"><a href="#浏览器引擎" class="headerlink" title="浏览器引擎"></a>浏览器引擎</h4><p>可以在用户界面和渲染引擎之间传送指令或在客户端本地缓存中读写数据等，是浏览器各个部分通信的核心。</p>
<h4 id="渲染引擎（内核）"><a href="#渲染引擎（内核）" class="headerlink" title="渲染引擎（内核）"></a>渲染引擎（内核）</h4><p>解析 <code>DOM</code> 文档和 <code>CSS</code> 规则并将内容排版到浏览器中显示有样式的界面</p>
<h4 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h4><p>开启网络线程发送请求或下载资源文件</p>
<h4 id="UI-后端"><a href="#UI-后端" class="headerlink" title="UI 后端"></a>UI 后端</h4><p>绘制基本的浏览器窗口内的控件，比如组合选择框、按钮、输入框等</p>
<h4 id="JavaScript-引擎"><a href="#JavaScript-引擎" class="headerlink" title="JavaScript 引擎"></a><code>JavaScript</code> 引擎</h4><p>解析和执行 <code>JavaScript</code> 脚本，比如 <code>V8</code> 引擎</p>
<h4 id="持久化数据存储"><a href="#持久化数据存储" class="headerlink" title="持久化数据存储"></a>持久化数据存储</h4><p>数据持久化存储，涉及 <code>cookie</code> 、 <code>localStorage</code> 等客户端存储技术</p>
<h3 id="渲染引擎"><a href="#渲染引擎" class="headerlink" title="渲染引擎"></a>渲染引擎</h3><ol>
<li>解析 <code>HTML</code> 构建 <code>DOM</code>树：将 HTML 元素标签解析成由多个 DOM 元素对象节点组成的具有节点父子关系的 DOM 树结构</li>
<li>构建渲染树：按顺序提取 DOM 元素对象的样式数据，构建带样式描述的 DOM 渲染树对象</li>
<li>渲染布局阶段：根据节点的大小和位置把元素绘制在页面上，主要是布局属性（例如： postion、float、margin、padding 等）生效</li>
<li>绘制渲染树：将节点的背景、颜色、文本等样式信息应用到节点上，主要是元素的内部显示样式（例如： color、background、text-shadow 等）生效</li>
</ol>
<h4 id="gecko-内核渲染流程"><a href="#gecko-内核渲染流程" class="headerlink" title="gecko 内核渲染流程"></a>gecko 内核渲染流程</h4><p>先解析 HTM，生成内容 Sink （Content Sink 可以认为是构建 DOM 结构树的工厂方法），再开始解析 CSS</p>
<p><img src="/images/brower/gecko.svg" alt="gecko内核渲染流程"></p>
<h4 id="webkit-内核渲染流程"><a href="#webkit-内核渲染流程" class="headerlink" title="webkit 内核渲染流程"></a>webkit 内核渲染流程</h4><p>HTML 和 CSS 的解析是并行的</p>
<p><img src="/images/brower/webkit.svg" alt="webkit内核渲染流程"></p>
<h3 id="持久化技术"><a href="#持久化技术" class="headerlink" title="持久化技术"></a>持久化技术</h3><ul>
<li><a href="/2020/08/31/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98/">HTTP 文件缓存</a></li>
<li><code>localStorage</code></li>
<li><code>sessionStorage</code></li>
<li><code>cookie</code></li>
<li><code>webSQL</code></li>
<li><code>Application cache</code></li>
<li><code>cacheStorage</code></li>
<li><code>flash</code> 缓存</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/03/02/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%9F%BA%E7%A1%80/" data-id="cm19b6rzr0079gkdzf0sjh1ly" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-简单代码热更新" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/28/%E7%AE%80%E5%8D%95%E4%BB%A3%E7%A0%81%E7%83%AD%E6%9B%B4%E6%96%B0/" class="article-date">
  <time datetime="2021-02-28T15:19:45.000Z" itemprop="datePublished">2021-02-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/28/%E7%AE%80%E5%8D%95%E4%BB%A3%E7%A0%81%E7%83%AD%E6%9B%B4%E6%96%B0/">简单代码热更新</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><ol>
<li>开发静态页面修改样式时需要手动刷新页面才会在页面上看到效果比较麻烦</li>
<li>了解了热更新原理需要实践下</li>
<li>手动实现了<a href="/2021/01/06/nodejs%E4%B8%AD%E5%AE%9E%E7%8E%B0websocket%E6%9C%8D%E5%8A%A1/">对 <code>websocket</code> 的解析</a>，趁热打铁把 <code>websocket</code> 应用在实际项目中</li>
</ol>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><ol>
<li>服务端监听文件改动</li>
<li>当文件有改动之后服务端发送事件通知客户端</li>
<li>客户端接收到事件之后做出对应的处理</li>
</ol>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="服务端监听文件改动"><a href="#服务端监听文件改动" class="headerlink" title="服务端监听文件改动"></a>服务端监听文件改动</h4><p>nodejs 在 <code>fs</code> 模块中提供了两个监听文件改动的方法 <code>fs.watch</code> 和 <code>fs.watchFile</code> 两个方法。</p>
<h5 id="fs-watch-参考"><a href="#fs-watch-参考" class="headerlink" title="fs.watch 参考"></a><a href="http://nodejs.cn/api/fs.html#fs_fs_watch_filename_options_listener"><code>fs.watch</code> 参考</a></h5><p>监听文件及文件夹下的改动，通过如下方式调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">watch</span>(filename[, options], listener)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>filename</code>: 文件或目录</li>
<li><code>options</code>: 可选的，如果 options 传入字符串，则它指定 encoding。 否则，options 应传入对象，属性如下：<ul>
<li><code>persistent</code>: &lt;<code>boolean</code>&gt; 指示如果文件已正被监视，进程是否应继续运行。默认值: <code>true</code></li>
<li><code>recursive</code>: &lt;<code>boolean</code>&gt; 指示应该监视所有子目录，还是仅监视当前目录。这适用于监视目录时，并且仅适用于受支持的平台（参见注意事项）。默认值: <code>false。</code></li>
<li><code>encoding</code>: &lt;<code>string</code>&gt; 指定用于传给监听器的文件名的字符编码。默认值: <code>utf8</code>。</li>
</ul>
</li>
<li><code>listener</code>: 监听器回调有两个参数 <code>(eventType, filename)</code>。 <code>eventType</code> 是 <code>rename</code> 或 <code>change</code>， <code>filename</code> 是触发事件的文件的名称。</li>
</ul>
<h5 id="fs-watchFile-参考"><a href="#fs-watchFile-参考" class="headerlink" title="fs.watchFile 参考"></a><a href="http://nodejs.cn/api/fs.html#fs_fs_watchfile_filename_options_listener"><code>fs.watchFile</code> 参考</a></h5><p>监听特定文件的改动，通过如下方式调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fs.<span class="title function_">watchFile</span>(filename[, options], listener)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>filename</code>: 文件</li>
<li><code>options</code>: 可选的，options 应传入对象，属性如下：<ul>
<li><code>persistent</code>: &lt;<code>boolean</code>&gt; 指示如果文件已正被监视，进程是否应继续运行。默认值: <code>true</code>。</li>
<li><code>interval </code>: 指示轮询目标的频率（以毫秒为单位）。</li>
<li><code>bigint</code>: 回调函数的参数对象是否为<code>BigInts</code>类型。</li>
</ul>
</li>
<li><code>listener</code>: 监听器回调有两个参数 <code>(curr, prev)</code>。 <code>curr</code> 是文件修改后的 <code>fs.Stat</code> 实例， <code>prev</code> 是文件修改前的 <code>fs.Stat</code> 实例。</li>
</ul>
<h4 id="通知客户端"><a href="#通知客户端" class="headerlink" title="通知客户端"></a>通知客户端</h4><p>通过建立一个 <code>websocket</code> 服务的方式，当文件有变更的时候发送更新消息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;upgrade&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, socket, head</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> read = <span class="keyword">new</span> <span class="title class_">WebsocketRead</span>(req, socket)</span><br><span class="line">  <span class="keyword">const</span> write = <span class="keyword">new</span> <span class="title class_">WebsocketWrite</span>(socket)</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;websocket connect success&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  read.<span class="title function_">on</span>(<span class="string">&#x27;text&#x27;</span>, <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;接收到响应&#x27;</span>, data)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  read.<span class="title function_">on</span>(<span class="string">&#x27;ping&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    write.<span class="title function_">pong</span>()</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  watch.<span class="title function_">on</span>(<span class="string">&#x27;update&#x27;</span>, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    write.<span class="title function_">send</span>(data)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="客户端处理事件"><a href="#客户端处理事件" class="headerlink" title="客户端处理事件"></a>客户端处理事件</h4><p>在客户端插入建立 <code>websocket</code> 链接的代码，接收到更新之后重新刷新页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">`ws://\$&#123;location.host&#125;`</span>)</span></span><br><span class="line"><span class="language-javascript">  socket.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> data = e.<span class="property">data</span></span></span><br><span class="line"><span class="language-javascript">    location.<span class="title function_">reload</span>()</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><h4 id="自动注入建立-websocket-链接的代码"><a href="#自动注入建立-websocket-链接的代码" class="headerlink" title="自动注入建立 websocket 链接的代码"></a>自动注入建立 <code>websocket</code> 链接的代码</h4><p>返回 <code>HTML</code> 页面时通过正则的方式在页面中插入代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = fs.<span class="title function_">readFileSync</span>(filePath)</span><br><span class="line"><span class="keyword">if</span> (path.<span class="title function_">extname</span>(filePath) === <span class="string">&#x27;.html&#x27;</span>) &#123;</span><br><span class="line">  data = data</span><br><span class="line">    .<span class="title function_">toString</span>()</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/\&lt;\/\s*body&gt;/</span>, <span class="string">`<span class="subst">$&#123;websocketTemplateStr&#125;</span>&lt;/body&gt;`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="对文件修改监听的封装"><a href="#对文件修改监听的封装" class="headerlink" title="对文件修改监听的封装"></a>对文件修改监听的封装</h4><p>通过封装成对应的方式，利用事件总线的模式实现事件的派发</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">EventEmitter</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; resolveRootPath &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./utils&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Watch</span> <span class="keyword">extends</span> <span class="title class_ inherited__">EventEmitter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">dir</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">watchPath</span> = <span class="title function_">resolveRootPath</span>(dir)</span><br><span class="line">    fs.<span class="title function_">watch</span>(<span class="variable language_">this</span>.<span class="property">watchPath</span>, &#123; <span class="attr">recursive</span>: <span class="literal">true</span> &#125;, <span class="variable language_">this</span>.<span class="property">handleCallback</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleCallback = <span class="function">(<span class="params">eventType, filename</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> content = fs</span><br><span class="line">        .<span class="title function_">readFileSync</span>(path.<span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">watchPath</span>, filename), &#123;</span><br><span class="line">          <span class="attr">encoding</span>: <span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">toString</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;update&#x27;</span>, &#123;</span><br><span class="line">        filename,</span><br><span class="line">        content,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;remove&#x27;</span>, &#123;</span><br><span class="line">        filename,</span><br><span class="line">        <span class="attr">content</span>: <span class="literal">null</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Watch</span></span><br></pre></td></tr></table></figure>

<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><ol>
<li><code>fs.watch</code> 和 <code>fs.watchFile</code> 兼容性考虑，在不兼容的平台上可以通过定时检查文件的方式判断文件是否有改动</li>
<li><code>websocket</code> 兼容性考虑，不支持的平台上降级为短轮询或长轮询的方式</li>
<li>文件修改时可以在抛出的事件中提供更多的信息，事件局部文件的热更新而不用刷新整个页面</li>
</ol>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ul>
<li><a href="http://nodejs.cn/api/fs.html"><code>nodejs</code> <code>fs</code> 模块</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket/WebSocket">浏览器<code>websocket</code></a></li>
<li><a href="/2021/01/06/nodejs%E4%B8%AD%E5%AE%9E%E7%8E%B0websocket%E6%9C%8D%E5%8A%A1/">nodejs 中实现 websocket 服务</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/02/28/%E7%AE%80%E5%8D%95%E4%BB%A3%E7%A0%81%E7%83%AD%E6%9B%B4%E6%96%B0/" data-id="cm19b6rze004xgkdz06qg25x1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/" rel="tag">node</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-粘贴图片" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/24/%E7%B2%98%E8%B4%B4%E5%9B%BE%E7%89%87/" class="article-date">
  <time datetime="2021-01-23T22:16:19.000Z" itemprop="datePublished">2021-01-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/24/%E7%B2%98%E8%B4%B4%E5%9B%BE%E7%89%87/">粘贴图片</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>优化用户编辑体验，实现在编辑内容（markdown 或富文本）时通过复制的方式实现图片的插入</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ol>
<li>监听剪贴板事件中的 <code>paste</code> 事件</li>
<li>通过事件的回调对象获取粘贴内容，若为文本则执行默认操作，若为图片类型则阻止默认操作并继续处理</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">cb</span> = (<span class="params">event</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> data = event.<span class="property">clipboardData</span> <span class="comment">// 获取粘贴内容</span></span><br><span class="line">  <span class="keyword">let</span> fileContent</span><br><span class="line">  <span class="keyword">let</span> stopFlag = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// 遍历对象获取粘贴文件</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; data &amp;&amp; data.<span class="property">items</span> &amp;&amp; i &lt; data.<span class="property">items</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> item = data.<span class="property">items</span>[i]</span><br><span class="line">    <span class="keyword">if</span> (item.<span class="property">kind</span> === <span class="string">&#x27;file&#x27;</span> &amp;&amp; item.<span class="property">type</span>.<span class="title function_">match</span>(<span class="string">&#x27;^image/&#x27;</span>)) &#123;</span><br><span class="line">      stopFlag = <span class="literal">true</span></span><br><span class="line">      fileContent = item.<span class="title function_">getAsFile</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 对 fileContent 做处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><ul>
<li><code>event</code> 是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ClipboardEvent"><code>ClipboardEvent</code></a> 类型，可以通过 <code>clipboardData</code> 属性拿到数据内容</li>
<li><code>clipboardData</code> 是 [ DataTransfer<code>](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransfer)对象，在粘贴事件中可以通过 </code>items<code> 属性获取粘贴的内容和数据类型，其是一个 [</code>DataTransferItemList<code>](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItemList) 对象，通过 </code>for<code> 循环的方式遍历每一个元素，每个元素都是 [</code>DataTransferItem&#96;](<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItem)%E5%AF%B9%E8%B1%A1">https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItem)对象</a></li>
</ul>
<h4 id="DataTransferItem-对象"><a href="#DataTransferItem-对象" class="headerlink" title="DataTransferItem 对象"></a><code>DataTransferItem</code> 对象</h4><h5 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h5><ul>
<li><code>kind</code>： 拖拽项的种类，<code>string</code> 或是 <code>file</code></li>
<li><code>type</code>：拖拽项的类型，一般是一个 MIME 类型</li>
</ul>
<h5 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h5><ul>
<li><code>getAsFile()</code>：返回一个关联拖拽项的 File 对象 （当拖拽项不是一个文件时返回 null）</li>
<li><code>getAsString()</code>：使用拖拽项的字符串作为参数执行指定回调函数。</li>
<li><code>webkitGetAsEntry()</code>：返回一个基于 FileSystemEntry 的对象来表示文件系统中选中的项目。通常是返回一个 FileSystemFileEntry 或是 FileSystemDirectoryEntry 对象.</li>
</ul>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ol>
<li>在 <code>mac</code> 上复制一张图片文件时会产生两个记录，第一个记录是文件名，第二个对象是文件本身</li>
<li>在 <code>mac</code> 上复制一个非图片类型的文件时，也会产生两个记录，一个是文件名，另一个是文件的缩略图，但是这个文章的缩略图通过 <code>getAsFile</code> 方法无法获取到内容</li>
</ol>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/Events/paste">paste 事件</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/24/%E7%B2%98%E8%B4%B4%E5%9B%BE%E7%89%87/" data-id="cm19b6rze004zgkdz8fzmfd6z" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-用Hexo搭建静态博客" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/23/%E7%94%A8Hexo%E6%90%AD%E5%BB%BA%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2/" class="article-date">
  <time datetime="2021-01-23T15:02:12.774Z" itemprop="datePublished">2021-01-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/23/%E7%94%A8Hexo%E6%90%AD%E5%BB%BA%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2/">用Hexo搭建静态博客</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ul>
<li>Git 安装及使用：<a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000">廖雪峰的网站</a></li>
<li>Node.js 的安装：<a href="http://www.runoob.com/nodejs/nodejs-install-setup.html">Node.js 安装配置</a></li>
<li>Hexo 的安装及使用：<a href="https://hexo.io/zh-cn/docs/index.html">Hexo 文档</a></li>
<li>yilia 主题的安装配置：<a href="https://github.com/litten/hexo-theme-yilia">yilia 简介、安装、配置</a></li>
</ul>
<h2 id="hexo-环境配置"><a href="#hexo-环境配置" class="headerlink" title="hexo 环境配置"></a>hexo 环境配置</h2><ul>
<li>创建文件夹 blog 作为项目文件夹</li>
<li>初始化项目文件夹</li>
</ul>
<ul>
<li><p>指定文件夹初始化</p>
<pre><code>hexo init blog
</code></pre>
</li>
<li><p>或者，进入文件夹再初始化</p>
<pre><code>cd blog
hexo init
</code></pre>
</li>
</ul>
<ul>
<li><p>安装插件 deployer</p>
<pre><code>npm install hexo-deployer-git --save
</code></pre>
</li>
<li><p>修改根目录下的 _config.yml 文件</p>
<pre><code>deploy:
type: git
repo: git@github.com:JackXuyi/JackXuyi.github.io.git
branch: master
</code></pre>
</li>
<li><p>配置域名：在 source 目录下添加 CNAME 文件，并在文件里写入你的域名</p>
<pre><code>xuyi-emb.win
</code></pre>
</li>
</ul>
<h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><ul>
<li>源代码和发布的网站的存储位置不在同一个地方，使用不同分支保存数据，具体解释见 <a href="http://www.zhihu.com/question/21193762">使用 hexo，如果换了电脑怎么更新博客？</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/23/%E7%94%A8Hexo%E6%90%AD%E5%BB%BA%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2/" data-id="cm19b6rzd004rgkdz0gmj4gj9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/" rel="tag">node</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/other/" rel="tag">other</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-跨页面通信" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/17/%E8%B7%A8%E9%A1%B5%E9%9D%A2%E9%80%9A%E4%BF%A1/" class="article-date">
  <time datetime="2021-01-17T13:37:39.000Z" itemprop="datePublished">2021-01-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/17/%E8%B7%A8%E9%A1%B5%E9%9D%A2%E9%80%9A%E4%BF%A1/">跨页面通信</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在浏览器中每个页面都运行在单独的进程中，如何实现页面间的通信？</p>
<h3 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h3><h4 id="BroadCastChannel"><a href="#BroadCastChannel" class="headerlink" title="BroadCastChannel"></a>BroadCastChannel</h4><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/BroadcastChannel">BroadcastChannel</a> 接口代理了一个命名频道，可以让指定 origin 下的任意 browsing context 来订阅它。它允许同源的不同浏览器窗口，Tab 页，frame 或者 iframe 下的不同文档之间相互通信。通过触发一个 <code>message</code> 事件，消息可以广播到所有监听了该频道的 <code>BroadcastChannel</code> 对象。</p>
<ol>
<li>构建一个实例</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bc = <span class="keyword">new</span> <span class="title class_">BroadcastChannel</span>(<span class="string">&#x27;channel&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>调用 <code>postMessage</code> 发送消息</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bc.<span class="title function_">postMessage</span>(data)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>分别监听 <code>onmessage</code> 和 <code>onmessageerror</code> 事件来接收数据和错误消息</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bc.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="comment">// e.data是发送过来的数据，可以根据数据做一些事情</span></span><br><span class="line">&#125;</span><br><span class="line">bc.<span class="property">onmessageerror</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="comment">// 错误消息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>调用 <code>close</code> 关闭通道，并销毁 <code>BroadcastChannel</code> 对象</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bc.<span class="title function_">close</span>()</span><br></pre></td></tr></table></figure>

<h4 id="localStorage-实现"><a href="#localStorage-实现" class="headerlink" title="localStorage 实现"></a>localStorage 实现</h4><p>当前页面使用的 <code>storage</code> 被其他页面修改时会触发 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/StorageEvent"><code>StorageEvent</code></a> 事件</p>
<ol>
<li>在源页面设置值触发事件</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;newValue&#x27;</span>, <span class="string">&#x27;new&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在接收页面监听 <code>storage</code> 事件以实现通信</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;storage&#x27;</span>, <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">  <span class="comment">// e.newValue表示新设置的值</span></span><br><span class="line">  <span class="comment">// e.key表示新设置的值的键</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="其它方案"><a href="#其它方案" class="headerlink" title="其它方案"></a>其它方案</h4><ol>
<li><code>Service Worker</code>: 一个可以长期运行在后台的 Worker，能够实现与页面的双向通信。</li>
<li><code>Shared Worker</code>: Worker 家族的另一个成员。普通的 Worker 之间是独立运行、数据互不相通；而多个 Tab 注册的 Shared Worker 则可以实现数据共享。</li>
<li><code>IndexedDB</code>: 数据存储技术</li>
<li><code>window.open + window.opener</code>: 当我们使用 window.open 打开页面时，方法会返回一个被打开页面 window 的引用。而在未显示指定 no opener 时，被打开的页面可以通过 window.opener 获取到打开它的页面的引用 —— 通过这种方式我们就将这些页面建立起了联系（一种树形结构）。</li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/visibilitychange_event"><code>visibilitychange</code></a>: 当其选项卡的内容变得可见或被隐藏时，会在文档上触发 visibilitychange (能见度更改)事件。</li>
</ol>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://github.com/kd-cloud-web/Blog/issues/41">几种跨页面通信的方案</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/81237384">跨页面的通信解决方案</a></li>
<li><a href="https://juejin.cn/post/6844903495636615176">跨页面通信的各种姿势</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/17/%E8%B7%A8%E9%A1%B5%E9%9D%A2%E9%80%9A%E4%BF%A1/" data-id="cm19b6rzn005pgkdz9qr4fdjj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nodejs中实现websocket服务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/06/nodejs%E4%B8%AD%E5%AE%9E%E7%8E%B0websocket%E6%9C%8D%E5%8A%A1/" class="article-date">
  <time datetime="2021-01-05T22:57:14.000Z" itemprop="datePublished">2021-01-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/06/nodejs%E4%B8%AD%E5%AE%9E%E7%8E%B0websocket%E6%9C%8D%E5%8A%A1/">nodejs中实现websocket服务</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="建立链接"><a href="#建立链接" class="headerlink" title="建立链接"></a>建立链接</h3><p>若要实现 WebSocket 协议，首先需要浏览器主动发起一个 HTTP 请求。</p>
<p>这个请求头包含“Upgrade”字段，内容为“websocket”（注：upgrade 字段用于改变 HTTP 协议版本或换用其他协议，这里显然是换用了 websocket 协议），还有一个最重要的字段“Sec-WebSocket-Key”，这是一个随机的经过 base64 编码的字符串，像密钥一样用于服务器和客户端的握手过程。一旦服务器君接收到来自客户端的 upgrade 请求，便会将请求头中的“Sec-WebSocket-Key”字段提取出来，追加一个固定的“魔串”：<code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code>，并进行 SHA-1 加密，然后再次经过 base64 编码生成一个新的 key，作为响应头中的“Sec-WebSocket-Accept”字段的内容返回给浏览器。一旦浏览器接收到来自服务器的响应，便会解析响应中的“Sec-WebSocket-Accept”字段，与自己加密编码后的串进行匹配，一旦匹配成功，便有建立连接的可能了（因为还依赖许多其他因素）。</p>
<p>这是一个基本的 Client 请求头：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Upgrade:</span> <span class="string">websocket</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">Upgrade</span></span><br><span class="line"><span class="attr">Sec-WebSocket-Key:</span> <span class="string">************==</span></span><br><span class="line"><span class="attr">Sec-WebSocket-Version:</span> <span class="string">**</span></span><br></pre></td></tr></table></figure>

<p>Server 正确接收后，会返回一个响应头：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Upgrade：websocket</span></span><br><span class="line"><span class="attr">Connnection:</span> <span class="string">Upgrade</span></span><br><span class="line"><span class="attr">Sec-WebSocket-Accept:</span> <span class="string">******************</span></span><br></pre></td></tr></table></figure>

<p>这表示双方握手成功了，之后就是全双工的通信。</p>
<h4 id="js-代码实现"><a href="#js-代码实现" class="headerlink" title="js 代码实现"></a>js 代码实现</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构建响应头</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildHeaders</span>(<span class="params">secWebsocketKey</span>) &#123;</span><br><span class="line">  <span class="comment">// 计算返回的key</span></span><br><span class="line">  <span class="keyword">const</span> resKey = crypto</span><br><span class="line">    .<span class="title function_">createHash</span>(<span class="string">&#x27;sha1&#x27;</span>)</span><br><span class="line">    .<span class="title function_">update</span>(secWebsocketKey + <span class="string">&#x27;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#x27;</span>)</span><br><span class="line">    .<span class="title function_">digest</span>(<span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构造响应头</span></span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    <span class="string">&#x27;HTTP/1.1 101 Switching Protocols&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Upgrade: websocket&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Connection: Upgrade&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Sec-WebSocket-Accept: &#x27;</span> + resKey,</span><br><span class="line">  ]</span><br><span class="line">    .<span class="title function_">concat</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="解析数据"><a href="#解析数据" class="headerlink" title="解析数据"></a>解析数据</h3><h4 id="Frame（帧）"><a href="#Frame（帧）" class="headerlink" title="Frame（帧）"></a>Frame（帧）</h4><p>WebSocket 传输的数据都是以 Frame（帧）的形式实现的，就像 TCP&#x2F;UDP 协议中的报文段 Segment。下面就是一个 Frame：（以 bit 为单位表示）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment">  1               2               3               4</span></span><br><span class="line"><span class="comment">  0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7</span></span><br><span class="line"><span class="comment"> +-+-+-+-+-------+-+-------------+-------------------------------+</span></span><br><span class="line"><span class="comment"> |F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span></span><br><span class="line"><span class="comment"> |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span></span><br><span class="line"><span class="comment"> |N|V|V|V|       |S|             |   (if payload len==126/127)   |</span></span><br><span class="line"><span class="comment"> | |1|2|3|       |K|             |                               |</span></span><br><span class="line"><span class="comment"> +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span></span><br><span class="line"><span class="comment"> |     Extended payload length continued, if payload len == 127  |</span></span><br><span class="line"><span class="comment"> + - - - - - - - - - - - - - - - +-------------------------------+</span></span><br><span class="line"><span class="comment"> |                               |Masking-key, if MASK set to 1  |</span></span><br><span class="line"><span class="comment"> +-------------------------------+-------------------------------+</span></span><br><span class="line"><span class="comment"> | Masking-key (continued)       |          Payload Data         |</span></span><br><span class="line"><span class="comment"> +-------------------------------- - - - - - - - - - - - - - - - +</span></span><br><span class="line"><span class="comment"> :                     Payload Data continued ...                :</span></span><br><span class="line"><span class="comment"> + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span></span><br><span class="line"><span class="comment"> |                     Payload Data continued ...                |</span></span><br><span class="line"><span class="comment"> +---------------------------------------------------------------+</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h5 id="按照-RFC-中的描述："><a href="#按照-RFC-中的描述：" class="headerlink" title="按照 RFC 中的描述："></a>按照 RFC 中的描述：</h5><ul>
<li>FIN： 1 bit， 0 表示还有后续帧，1 表示最后一帧</li>
<li>RSV1、2、3： 没个 1 bit，除非一个扩展经过协商赋予了非零值以某种含义，否则必须为 0，如果没有定义非零值，并且收到了非零的 RSV，则 websocket 链接会失败</li>
<li>Opcode： 4 bit，如果收到了未知的 opcode，最后会断开链接, 这四位的值组合结果的含义分别如下：</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">0x0 :</span> <span class="string">代表连续的帧</span></span><br><span class="line"><span class="attr">0x1 :</span> <span class="string">text帧</span></span><br><span class="line"><span class="number">0x2</span> <span class="string">：</span> <span class="string">binary帧</span></span><br><span class="line"><span class="number">0x3</span><span class="number">-0x7</span> <span class="string">：</span> <span class="string">为非控制帧而预留的</span></span><br><span class="line"><span class="number">0x8</span> <span class="string">：</span> <span class="string">关闭握手帧</span></span><br><span class="line"><span class="number">0x9</span> <span class="string">：</span> <span class="string">ping帧</span></span><br><span class="line"><span class="attr">0xA :</span> <span class="string">pong</span> <span class="string">帧</span></span><br><span class="line"><span class="number">0xB</span><span class="number">-0xF</span> <span class="string">：</span> <span class="string">为非控制帧而预留的</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Mask： 1 bit，0 表示数据没有添加掩码，1 表示数据被添加了掩码，如果置 1， “Masking-key”就会被赋值，所有从客户端发往服务器的帧都会被置 1</li>
<li>Payload length： 7 bit | 7+16 bit | 7+64 bit，“payload data” 的长度如果在 0~125 bytes 范围内，它就是“payload length”，如果是 126 bytes， 紧随其后的被表示为 16 bits 的 2 bytes 无符号整型就是“payload length”，如果是 127 bytes， 紧随其后的被表示为 64 bits 的 8 bytes 无符号整型就是“payload length”</li>
<li>Masking-key： 0 or 4 bytes，所有从客户端发送到服务器的帧都包含一个 32 bits 的掩码（如果“mask bit”被设置成 1），否则为 0 bit。一旦掩码被设置，所有接收到的 payload data 都必须与该值以一种算法做异或运算来获取真实值。</li>
<li>Payload data: n bytes，数据内容</li>
</ul>
<h4 id="读取数据帧"><a href="#读取数据帧" class="headerlink" title="读取数据帧"></a>读取数据帧</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CustomReadSocket</span> <span class="keyword">extends</span> <span class="title class_ inherited__">EventEmitter</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="variable constant_">MAGIC_STRING</span> = <span class="string">&#x27;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">req, socket, head</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="comment">// 保存上下文信息</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">req</span> = req</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span> = socket</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">head</span> = head</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内部状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dataType</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resHeaders</span> = <span class="variable language_">this</span>.<span class="title function_">buildHeaders</span>(req.<span class="property">headers</span>[<span class="string">&#x27;sec-websocket-key&#x27;</span>])</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">buffer</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接收数据</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handleData</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应给客户端</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">write</span>(<span class="variable language_">this</span>.<span class="property">resHeaders</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建响应头</span></span><br><span class="line">  <span class="title function_">buildHeaders</span>(<span class="params">secWebsocketKey</span>) &#123;</span><br><span class="line">    <span class="comment">// 计算返回的key</span></span><br><span class="line">    <span class="keyword">const</span> resKey = crypto</span><br><span class="line">      .<span class="title function_">createHash</span>(<span class="string">&#x27;sha1&#x27;</span>)</span><br><span class="line">      .<span class="title function_">update</span>(secWebsocketKey + <span class="title class_">CustomReadSocket</span>.<span class="property">MAGIC_STRING</span>)</span><br><span class="line">      .<span class="title function_">digest</span>(<span class="string">&#x27;base64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造响应头</span></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      <span class="string">&#x27;HTTP/1.1 101 Switching Protocols&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Upgrade: websocket&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Connection: Upgrade&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;Sec-WebSocket-Accept: &#x27;</span> + resKey,</span><br><span class="line">    ]</span><br><span class="line">      .<span class="title function_">concat</span>(<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">      .<span class="title function_">join</span>(<span class="string">&#x27;\r\n&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理收到的数据</span></span><br><span class="line">  handleData = <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> type = <span class="variable language_">this</span>.<span class="title function_">getFrameType</span>(data[<span class="number">0</span>])</span><br><span class="line">      <span class="keyword">if</span> (type &amp;&amp; type !== <span class="string">&#x27;continue&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">dataType</span> = type</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (type === <span class="string">&#x27;continue&#x27;</span> || type === <span class="string">&#x27;text&#x27;</span> || type === <span class="string">&#x27;binary&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> maskLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">hasMask</span>(data[<span class="number">1</span>])) &#123;</span><br><span class="line">          maskLen = <span class="number">4</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> [start, len] = <span class="variable language_">this</span>.<span class="title function_">getFrameDataLength</span>(data)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">getDataFromFrame</span>(</span><br><span class="line">          data.<span class="title function_">slice</span>(start + maskLen),</span><br><span class="line">          data.<span class="title function_">slice</span>(start, start + maskLen),</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="variable language_">this</span>.<span class="title function_">isLastFrame</span>(data[<span class="number">0</span>]))</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">handleAllType</span>(<span class="variable language_">this</span>.<span class="property">dataType</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取当前帧类型</span></span><br><span class="line">  <span class="title function_">getFrameType</span>(<span class="params">byte</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> realType = byte &amp; <span class="number">0x7f</span></span><br><span class="line">    <span class="keyword">if</span> (!realType) &#123;</span><br><span class="line">      <span class="comment">// 代表连续的帧</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;continue&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x01</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;text&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x09</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;ping&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x0a</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;pong&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x02</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;binary&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x08</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;close&#x27;</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理所有帧类型</span></span><br><span class="line">  <span class="title function_">handleAllType</span>(<span class="params">type</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;continue&#x27;</span>: &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;continue&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;text&#x27;</span>: &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;message&#x27;</span>, <span class="variable language_">this</span>.<span class="property">buffer</span>.<span class="title function_">toString</span>())</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;binary&#x27;</span>: &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;message&#x27;</span>, <span class="variable language_">this</span>.<span class="property">buffer</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;close&#x27;</span>: &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;close&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;ping&#x27;</span>: &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;ping&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;pong&#x27;</span>: &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;pong&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="attr">default</span>: &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;others&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 释放 buffer 和重置数据类型</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">buffer</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dataType</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否是最后一个帧</span></span><br><span class="line">  <span class="title function_">isLastFrame</span>(<span class="params">byte</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> !!(byte &amp; <span class="number">0x80</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提取帧的长度</span></span><br><span class="line">  <span class="title function_">getFrameDataLength</span>(<span class="params">buffer</span>) &#123;</span><br><span class="line">    <span class="comment">// 第二个字节的底 7 位</span></span><br><span class="line">    <span class="keyword">const</span> firtLen = buffer[<span class="number">1</span>] &amp; <span class="number">0x7f</span></span><br><span class="line">    <span class="keyword">if</span> (firtLen &lt; <span class="number">125</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [<span class="number">2</span>, firtLen]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firtLen === <span class="number">126</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> len = buffer.<span class="title function_">readUInt16BE</span>(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">return</span> [<span class="number">4</span>, len]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> len = buffer.<span class="title function_">readUInt64BE</span>(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">return</span> [<span class="number">10</span>, len]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否有掩码</span></span><br><span class="line">  <span class="title function_">hasMask</span>(<span class="params">byte</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> !!(<span class="number">0x80</span> &amp; byte)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从帧里提取数据</span></span><br><span class="line">  <span class="title function_">getDataFromFrame</span>(<span class="params">buffer, maskBuffer</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (buffer &amp;&amp; buffer.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> len = buffer.<span class="property">length</span></span><br><span class="line">      <span class="keyword">if</span> (maskBuffer &amp;&amp; maskBuffer.<span class="property">length</span> === <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">          buffer[i] = buffer[i] ^ maskBuffer[i % <span class="number">4</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">buffer</span> = <span class="variable language_">this</span>.<span class="property">buffer</span> ? <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([<span class="variable language_">this</span>.<span class="property">buffer</span>, buffer]) : buffer</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="写入数据帧"><a href="#写入数据帧" class="headerlink" title="写入数据帧"></a>写入数据帧</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CustomWebsocket</span> <span class="keyword">extends</span> <span class="title class_ inherited__">CustomReadSocket</span> &#123;</span><br><span class="line">  timer = <span class="literal">null</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">req, socket, head, options</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(req, socket, head)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">timeout</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">timeout</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">send</span>(<span class="params">message</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> buffer = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(message)</span><br><span class="line">    <span class="keyword">const</span> list = <span class="variable language_">this</span>.<span class="title function_">buildDataFrameList</span>(<span class="string">&#x27;text&#x27;</span>, buffer)</span><br><span class="line">    list.<span class="title function_">forEach</span>(<span class="function">(<span class="params">frame</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">write</span>(frame)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">timeout</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">ping</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> frame = <span class="variable language_">this</span>.<span class="title function_">buildFrame</span>(<span class="string">&#x27;ping&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">write</span>(frame)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">timeout</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">pong</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> frame = <span class="variable language_">this</span>.<span class="title function_">buildFrame</span>(<span class="string">&#x27;pong&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">write</span>(frame)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">timeout</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">close</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> frame = <span class="variable language_">this</span>.<span class="title function_">buildFrame</span>(<span class="string">&#x27;close&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">write</span>(frame)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">end</span>()</span><br><span class="line">    process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">socket</span>.<span class="title function_">destroy</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">timeout</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; timeout = <span class="number">10000</span> &#125; = <span class="variable language_">this</span>.<span class="property">options</span> || &#123;&#125;</span><br><span class="line">    <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">timer</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">timer</span> = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">ping</span>()</span><br><span class="line">    &#125;, timeout)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">buildDataFrameList</span>(<span class="params">type, buffer</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> bufferList = []</span><br><span class="line">    <span class="keyword">let</span> tempBuffer = buffer</span><br><span class="line">    <span class="keyword">while</span> (tempBuffer.<span class="property">length</span>) &#123;</span><br><span class="line">      bufferList.<span class="title function_">push</span>(tempBuffer.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">MAX_FRAME_SIZE</span>))</span><br><span class="line">      tempBuffer = tempBuffer.<span class="title function_">slice</span>(<span class="variable language_">this</span>.<span class="property">MAX_FRAME_SIZE</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> len = bufferList.<span class="property">length</span></span><br><span class="line">    <span class="keyword">return</span> bufferList.<span class="title function_">map</span>(<span class="function">(<span class="params">buf, index</span>) =&gt;</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">buildFrame</span>(index ? <span class="string">&#x27;continue&#x27;</span> : type, len === index + <span class="number">1</span>, buf),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">buildFrame</span>(<span class="params">dataType, isLast = <span class="literal">true</span>, buffer = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> firstByte = isLast ? <span class="number">0x80</span> : <span class="number">0x00</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="string">`<span class="subst">$&#123;dataType || <span class="string">&#x27;&#x27;</span>&#125;</span>`</span>.<span class="title function_">toLowerCase</span>()) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;continue&#x27;</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x00</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;text&#x27;</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x01</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;binary&#x27;</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x02</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;close&#x27;</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x08</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;ping&#x27;</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x09</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;pong&#x27;</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x0a</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="attr">default</span>: &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;others&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> secondByte = <span class="number">0x00</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buffer &amp;&amp; buffer.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> lenByteList = []</span><br><span class="line">      <span class="keyword">const</span> len = buffer.<span class="property">length</span></span><br><span class="line">      <span class="keyword">if</span> (len &lt;= <span class="number">125</span>) &#123;</span><br><span class="line">        secondByte = secondByte | len</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &gt;= <span class="number">126</span> &amp;&amp; len &lt; <span class="number">65536</span>) &#123;</span><br><span class="line">        secondByte = secondByte | <span class="number">0x7e</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">          lenByteList.<span class="title function_">push</span>(<span class="number">0xff</span> &amp; (len &gt;&gt; (i * <span class="number">8</span>)))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        secondByte = secondByte | <span class="number">0x7f</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">          lenByteList.<span class="title function_">push</span>(<span class="number">0xff</span> &amp; (len &gt;&gt; (i * <span class="number">8</span>)))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      lenByteList.<span class="title function_">reverse</span>()</span><br><span class="line">      <span class="keyword">const</span> prefixBuffer = <span class="title class_">Buffer</span>.<span class="title function_">from</span>([firstByte, secondByte, ...lenByteList])</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Buffer</span>.<span class="title function_">concat</span>([prefixBuffer, buffer])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Buffer</span>.<span class="title function_">from</span>([firstByte, secondByte])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://github.com/abbshr/abbshr.github.io/issues/22">学习 WebSocket 协议—从顶层到底层的实现原理（修订版）
</a></li>
<li><a href="https://segmentfault.com/a/1190000016467409">Node.js - 200 多行代码实现 Websocket 协议</a></li>
<li><a href="https://segmentfault.com/a/1190000012709475">WebSocket：5 分钟从入门到精通</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSockets_API/Writing_WebSocket_servers">编写 WebSocket 服务器</a></li>
<li><a href="https://github.com/JackXuyi/web-exercise/blob/master/handwriting/socketServer.js">本文涉及到的页面源代码</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/06/nodejs%E4%B8%AD%E5%AE%9E%E7%8E%B0websocket%E6%9C%8D%E5%8A%A1/" data-id="cm19b6ryv002kgkdz1fdk1vaw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/" rel="tag">node</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/" rel="tag">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-记一次项目打包优化" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/12/23/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E4%BC%98%E5%8C%96/" class="article-date">
  <time datetime="2020-12-22T19:19:21.000Z" itemprop="datePublished">2020-12-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/12/23/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E4%BC%98%E5%8C%96/">记一次项目打包优化</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>由于项目功能越来复杂，打包发布的速度越来越慢，严重影响了开发速度，所以决定优化下打包发布速度</p>
<h2 id="分析打包流程及耗时"><a href="#分析打包流程及耗时" class="headerlink" title="分析打包流程及耗时"></a>分析打包流程及耗时</h2><h3 id="打包流程"><a href="#打包流程" class="headerlink" title="打包流程"></a>打包流程</h3><ul>
<li>代码 clone 到打包服务器上</li>
<li>编译代码，项目采用 nextjs 进行服务端渲染，所以编译编译时分为两个部分，分别为构建服务端 js 和客户端 js，每次编译都要先安装项目依赖，再执行打包构建命令</li>
<li>构建 docker 容器，项目运行在 docker 容器中，每次打包发布都是构建一个新的容器去替换对应环境的容器</li>
<li>部署静态资源，把客户端对应的 js 推送到 CDN 上</li>
<li>替换容器，用之前构建的容器去替换当前环境的容器</li>
</ul>
<h3 id="耗时分析"><a href="#耗时分析" class="headerlink" title="耗时分析"></a>耗时分析</h3><ul>
<li>clone 代码速度由网络和项目大小决定（网络无法控制，源代码不大，优化效果不明显）—— 通常在 10 秒左右</li>
<li>采用 webpack 进行编译，可以通过插件进行构建优化 —— 通常在 2.5 分钟左右</li>
<li>构建 docker 容器时会把 node_modules 下的依赖按照生产模式的方式放入容器中 —— 通常在 4.5 分钟左右</li>
<li>静态资源的上传由上传资源大小及网络决定，上传由基础组控制 —— 2 分钟左右</li>
<li>替换容器由集群控制，业务方无法控制 —— 通常在 1 分左右</li>
</ul>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>通过上面的分析发现，制作 docker 容器和 打包过程最耗费时间，且这两块也在业务方控制之中，所以优化从这两方面着手</p>
<h3 id="docker-容器优化"><a href="#docker-容器优化" class="headerlink" title="docker 容器优化"></a>docker 容器优化</h3><p>通过查看打包日志发现制作 docker 容器时发现制作容器时发送的上下文达 1G 多，对比其它项目明显偏大</p>
<h4 id="优化方向分析"><a href="#优化方向分析" class="headerlink" title="优化方向分析"></a>优化方向分析</h4><ul>
<li>发送的上下文是在生产模式下安装的依赖，即只会安装 <code>dependencies</code> 下的依赖 —— 考虑把所有非服务端必须的依赖安装到 <code>devDependencies</code> 中以减小上下文大小</li>
<li>由于需要 SEO 优化，优化不能减少服务端渲染时的页面内容 —— 只能优化对页面内容没有影响但是需要客户端交互及样式操作相关的库</li>
</ul>
<h4 id="优化操作"><a href="#优化操作" class="headerlink" title="优化操作"></a>优化操作</h4><ul>
<li>通过 webpack 插件提取项目中使用的依赖，结合 package.json 的配置，筛选出项目中无用的依赖</li>
<li>筛选出 <code>dependencies</code> 中的依赖是否可以只在客户端渲染时引入，例如 <code>react-copy-to-clipboard</code> 只会在客户端执行复制操作就可以放入 <code>devDependencies</code> 中以便只在客户端引入</li>
</ul>
<h4 id="优化效果"><a href="#优化效果" class="headerlink" title="优化效果"></a>优化效果</h4><p>构建 docker 容器的时间从优化前的 4.5 分钟左右下降到 2.5 分钟左右，优化了 50%</p>
<h3 id="webpack-打包优化"><a href="#webpack-打包优化" class="headerlink" title="webpack 打包优化"></a>webpack 打包优化</h3><p>此项目是基于 webpack 4.x 进行打包的，可以通过插件和 webpack 配置及 loader 的形式进行打包优化</p>
<h4 id="webpack-4-使用-v8-引擎带来的优化"><a href="#webpack-4-使用-v8-引擎带来的优化" class="headerlink" title="webpack 4 使用 v8 引擎带来的优化"></a>webpack 4 使用 v8 引擎带来的优化</h4><ul>
<li>for of 替代 forEach</li>
<li>Map 和 Set 替代 Object</li>
<li>includes 替代 indexOf()</li>
<li>默认使用更快的 md4 hash 算法 替代 md5 算法，md4 较 md5 速度更快</li>
<li>webpack AST 可以直接从 loader 传递给 AST，从而减少解析时间</li>
<li>使用字符串方法替代正则表达式</li>
</ul>
<h4 id="优化方向分析-1"><a href="#优化方向分析-1" class="headerlink" title="优化方向分析"></a>优化方向分析</h4><p>通过 <a href="https://www.npmjs.com/package/speed-measure-webpack-plugin">speed-measure-webpack-plugin</a> 插件进行打包耗时分析</p>
<ul>
<li>通过配置 <code>exclude / include</code> 和忽略第三方包指定目录及通过 externals 缩小打包文件范围</li>
<li>多进程并行打包和代码压缩</li>
<li>缓存编译结果</li>
<li>babel 配置的优化</li>
</ul>
<h4 id="优化操作-1"><a href="#优化操作-1" class="headerlink" title="优化操作"></a>优化操作</h4><p>通过研究框架 webpack 配置发现项目已经引入 <code>cache-loader</code>、<code>thread-loader</code> 等 <code>loader</code> 和插件及配置优化代码打包速度，所以未做 <code>webpack</code> 打包优化</p>
<ul>
<li>引入 <code>speed-measure-webpack-plugin</code> 查看打包耗时</li>
</ul>
<h3 id="相关知识点"><a href="#相关知识点" class="headerlink" title="相关知识点"></a>相关知识点</h3><ul>
<li><a href="https://www.webpackjs.com/concepts/">webpack</a></li>
<li><a href="https://yeasy.gitbook.io/docker_practice/">docker</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/12/23/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E4%BC%98%E5%8C%96/" data-id="cm19b6rzm005hgkdza2ccatid" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/" rel="tag">node</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/other/" rel="tag">other</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ts之type、interface和class区别" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/12/14/ts%E4%B9%8Btype%E3%80%81interface%E5%92%8Cclass%E5%8C%BA%E5%88%AB/" class="article-date">
  <time datetime="2020-12-13T22:04:08.000Z" itemprop="datePublished">2020-12-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/12/14/ts%E4%B9%8Btype%E3%80%81interface%E5%92%8Cclass%E5%8C%BA%E5%88%AB/">ts之type、interface和class区别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="type"><a href="#type" class="headerlink" title="type"></a>type</h3><p><a href="https://www.typescriptlang.org/docs/handbook/2/everyday-types.html#type-aliases">任意类型的别名</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">We’ve been using object types and union types by writing them directly in type annotations. This is convenient, but it’s common to want to use the same type more than once and refer to it by a single name.</span><br><span class="line">A type alias is exactly that - a name for any type.</span><br></pre></td></tr></table></figure>

<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> test = <span class="built_in">number</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// error: 标识符“test”重复。</span></span><br><span class="line"><span class="comment">// type test = string</span></span><br></pre></td></tr></table></figure>

<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>任意类型的别名（包含基本类型）</li>
<li>只可以定义一次（多次定义报 ’标识符“test”重复‘ 错误）</li>
</ul>
<h3 id="interface"><a href="#interface" class="headerlink" title="interface"></a>interface</h3><p><a href="https://www.typescriptlang.org/docs/handbook/interfaces.html">接口的作用就是为这些类型命名和为你的代码或第三方代码定义契约。</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">One of TypeScript’s core principles is that type checking focuses on the shape that values have. This is sometimes called “duck typing” or “structural subtyping”. In TypeScript, interfaces fill the role of naming these types, and are a powerful way of defining contracts within your code as well as contracts with code outside of your project.</span><br></pre></td></tr></table></figure>

<h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">  size?: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">PenStroke</span> &#123;</span><br><span class="line">  <span class="attr">penWidth</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Square</span> <span class="keyword">extends</span> <span class="title class_">Shape</span>, <span class="title class_">PenStroke</span> &#123;</span><br><span class="line">  <span class="attr">sideLength</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> square = &lt;<span class="title class_">Square</span>&gt;&#123;&#125;</span><br><span class="line">square.<span class="property">color</span> = <span class="string">&#x27;blue&#x27;</span></span><br><span class="line">square.<span class="property">sideLength</span> = <span class="number">10</span></span><br><span class="line">square.<span class="property">penWidth</span> = <span class="number">5.0</span></span><br><span class="line">square.<span class="property">size</span> = <span class="number">100</span></span><br></pre></td></tr></table></figure>

<h3 id="class"><a href="#class" class="headerlink" title="class"></a>class</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes">类是“特殊的函数”，就像你能够定义的函数表达式和函数声明一样，类语法有两个组成部分：类表达式和类声明。</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeScript offers full support for the class keyword introduced in ES2015. As with other JavaScript language features, TypeScript adds type annotations and other syntax to allow you to express relationships between classes and other types.</span><br></pre></td></tr></table></figure>

<h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> passcode = <span class="string">&#x27;secret passcode&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Employee</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_fullName</span>: <span class="built_in">string</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">fullName</span>(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_fullName</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">fullName</span>(<span class="params"><span class="attr">newName</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (passcode &amp;&amp; passcode == <span class="string">&#x27;secret passcode&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_fullName</span> = newName</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error: Unauthorized update of employee!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> employee = <span class="keyword">new</span> <span class="title class_">Employee</span>()</span><br><span class="line">employee.<span class="property">fullName</span> = <span class="string">&#x27;Bob Smith&#x27;</span></span><br><span class="line"><span class="keyword">if</span> (employee.<span class="property">fullName</span>) &#123;</span><br><span class="line">  <span class="title function_">alert</span>(employee.<span class="property">fullName</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="abstract-class"><a href="#abstract-class" class="headerlink" title="abstract class"></a>abstract class</h3><p><a href="https://www.tslang.cn/docs/handbook/classes.html">抽象类做为其它派生类的基类使用。 它们一般不会直接被实例化。 不同于接口，抽象类可以包含成员的实现细节。 abstract 关键字是用于定义抽象类和在抽象类内部定义抽象方法。</a></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Department</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">public</span> <span class="attr">name</span>: <span class="built_in">string</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">printName</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Department name: &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">abstract</span> <span class="title function_">printMeeting</span>(): <span class="built_in">void</span> <span class="comment">// 必须在派生类中实现</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AccountingDepartment</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Department</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(<span class="string">&#x27;Accounting and Auditing&#x27;</span>) <span class="comment">// 在派生类的构造函数中必须调用 super()</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">printMeeting</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;The Accounting Department meets each Monday at 10am.&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">generateReports</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Generating accounting reports...&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">department</span>: <span class="title class_">Department</span> <span class="comment">// 允许创建一个对抽象类型的引用</span></span><br><span class="line">department = <span class="keyword">new</span> <span class="title class_">Department</span>() <span class="comment">// 错误: 不能创建一个抽象类的实例</span></span><br><span class="line">department = <span class="keyword">new</span> <span class="title class_">AccountingDepartment</span>() <span class="comment">// 允许对一个抽象子类进行实例化和赋值</span></span><br><span class="line">department.<span class="title function_">printName</span>()</span><br><span class="line">department.<span class="title function_">printMeeting</span>()</span><br><span class="line">department.<span class="title function_">generateReports</span>() <span class="comment">// 错误: 方法在声明的抽象类中不存在</span></span><br></pre></td></tr></table></figure>

<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ul>
<li>接口创建了一个新的名字，可以在其它任何地方使用。 类型别名并不创建新名字—比如，错误信息就不会使用别名。</li>
<li>类型别名不能被 extends 和 implements（自己也不能 extends 和 implements 其它类型）。</li>
<li>接口只能用来声明对象，而不能重新命名基本数据类型。</li>
<li>接口名称将始终以原始形式出现在错误消息中，当按名称使用时才显示。</li>
<li>接口可以进行声明合并</li>
<li>抽象类和接口一样不可以被实例化，但是抽象类可以包含部分属性方法的实现</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/12/14/ts%E4%B9%8Btype%E3%80%81interface%E5%92%8Cclass%E5%8C%BA%E5%88%AB/" data-id="cm19b6rz4003lgkdzghat6lyc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-for-in和for-of的区别" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/11/22/for-in%E5%92%8Cfor-of%E7%9A%84%E5%8C%BA%E5%88%AB/" class="article-date">
  <time datetime="2020-11-21T17:09:16.000Z" itemprop="datePublished">2020-11-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/11/22/for-in%E5%92%8Cfor-of%E7%9A%84%E5%8C%BA%E5%88%AB/">for...in和for...of的区别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Iterator（遍历器）的概念"><a href="#Iterator（遍历器）的概念" class="headerlink" title="Iterator（遍历器）的概念"></a>Iterator（遍历器）的概念</h3><p>遍历器（Iterator）一种接口，为各种不同的数据结构提供统一的访问机制。任何数据结构只要部署 Iterator 接口，就可以完成遍历操作（即依次处理该数据结构的所有成员）。</p>
<h4 id="Iterator-的作用"><a href="#Iterator-的作用" class="headerlink" title="Iterator 的作用"></a>Iterator 的作用</h4><ul>
<li>为各种数据结构，提供一个统一的、简便的访问接口。</li>
<li>使得数据结构的成员能够按某种次序排列。</li>
<li>ES6 创造了一种新的遍历命令 for…of 循环，Iterator 接口主要供 for…of 消费。</li>
</ul>
<h4 id="Iterator-的遍历"><a href="#Iterator-的遍历" class="headerlink" title="Iterator 的遍历"></a>Iterator 的遍历</h4><ol>
<li>创建一个指针对象，指向当前数据结构的起始位置。也就是说，遍历器对象本质上，就是一个指针对象。</li>
<li>第一次调用指针对象的 next 方法，可以将指针指向数据结构的第一个成员。</li>
<li>第二次调用指针对象的 next 方法，指针就指向数据结构的第二个成员。</li>
<li>不断调用指针对象的 next 方法，直到它指向数据结构的结束位置。</li>
</ol>
<h4 id="Iterator-接口"><a href="#Iterator-接口" class="headerlink" title="Iterator 接口"></a>Iterator 接口</h4><p>一种数据结构只要部署了 Iterator 接口，我们就称这种数据结构是“可遍历的”（iterable）。ES6 规定，默认的 Iterator 接口部署在数据结构的 Symbol.iterator 属性，或者说，一个数据结构只要具有 Symbol.iterator 属性，就可以认为是“可遍历的”（iterable）。Symbol.iterator 属性本身是一个函数，就是当前数据结构默认的遍历器生成函数。执行这个函数，就会返回一个遍历器。</p>
<h5 id="ES6-原生具备-Iterator-接口的数据结构"><a href="#ES6-原生具备-Iterator-接口的数据结构" class="headerlink" title="ES6 原生具备 Iterator 接口的数据结构"></a>ES6 原生具备 Iterator 接口的数据结构</h5><ul>
<li>Array</li>
<li>Map</li>
<li>Set</li>
<li>String</li>
<li>TypedArray</li>
<li>函数的 arguments 对象</li>
<li>NodeList 对象</li>
</ul>
<h4 id="调用-Iterator-接口的场合"><a href="#调用-Iterator-接口的场合" class="headerlink" title="调用 Iterator 接口的场合"></a>调用 Iterator 接口的场合</h4><ul>
<li>解构赋值</li>
<li>扩展运算符</li>
<li>yield*</li>
<li>for…of</li>
<li>Array.from()</li>
<li>Map(), Set(), WeakMap(), WeakSet()</li>
<li>Promise.all()</li>
<li>Promise.race()</li>
</ul>
<h4 id="遍历器对象的-return-，throw"><a href="#遍历器对象的-return-，throw" class="headerlink" title="遍历器对象的 return()，throw()"></a>遍历器对象的 return()，throw()</h4><p>遍历器对象除了具有 next()方法，还可以具有 return()方法和 throw()方法。</p>
<ul>
<li>如果 for…of 循环提前退出（通常是因为出错，或者有 break 语句），就会调用 return()方法。</li>
<li>throw()方法主要是配合 Generator 函数使用，一般的遍历器对象用不到这个方法。</li>
</ul>
<h3 id="for…in-和-for…of-的区别"><a href="#for…in-和-for…of-的区别" class="headerlink" title="for…in 和 for…of 的区别"></a>for…in 和 for…of 的区别</h3><ul>
<li>对于普通的对象，for…in 循环可以遍历键名，for…of 循环会报错。</li>
</ul>
<h4 id="for…in-遍历数组的缺点"><a href="#for…in-遍历数组的缺点" class="headerlink" title="for…in 遍历数组的缺点"></a>for…in 遍历数组的缺点</h4><ul>
<li>数组的键名是数字，但是 for…in 循环是以字符串作为键名“0”、“1”、“2”等等。</li>
<li>for…in 循环不仅遍历数字键名，还会遍历手动添加的其他键，甚至包括原型链上的键。</li>
<li>某些情况下，for…in 循环会以任意顺序遍历键名。</li>
</ul>
<h4 id="for…of-遍历数组的优点"><a href="#for…of-遍历数组的优点" class="headerlink" title="for…of 遍历数组的优点"></a>for…of 遍历数组的优点</h4><ul>
<li>有着同 for…in 一样的简洁语法，但是没有 for…in 那些缺点</li>
<li>不同于 forEach 方法，它可以与 break、continue 和 return 配合使用。</li>
<li>提供了遍历所有数据结构的统一操作接口。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/22/for-in%E5%92%8Cfor-of%E7%9A%84%E5%8C%BA%E5%88%AB/" data-id="cm19b6ryf000lgkdzdl9mbziw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-异步任务按顺序分组执行" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/19/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E6%8C%89%E9%A1%BA%E5%BA%8F%E5%88%86%E7%BB%84%E6%89%A7%E8%A1%8C/" class="article-date">
  <time datetime="2020-10-18T16:39:31.000Z" itemprop="datePublished">2020-10-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/19/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E6%8C%89%E9%A1%BA%E5%BA%8F%E5%88%86%E7%BB%84%E6%89%A7%E8%A1%8C/">异步任务按顺序分组执行</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>有一个异步请求列表需要按照顺序分多次执行</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>任务可以放入一个队列中，每次从队列中获取若干任务异步执行</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>一次执行的任务放在 Promise.all 中执行，但是如果执行任务中有一个任务花费时间比较长，其它任务消耗时间短就浪费了大量时间，所以采用计数的方式判断是否可以把任务加入任务队列</p>
<h4 id="代码流程"><a href="#代码流程" class="headerlink" title="代码流程"></a>代码流程</h4><ol>
<li>构建任务队列</li>
<li>需要执行的任务放入队列</li>
<li>执行任务，判断是否有任务可以执行，若有任务可以执行，则正在执行的任务队列加一</li>
<li>任务执行完毕之后，再回到第 3 部，直至待执行任务队列和当前执行的任务为空时退出程序</li>
</ol>
<h4 id="具体-js-代码如下"><a href="#具体-js-代码如下" class="headerlink" title="具体 js 代码如下"></a>具体 js 代码如下</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Queue</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">maxTask</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">maxTask</span> = maxTask</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">runningTask</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">taskQueue</span> = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">push</span>(<span class="params">task</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(task)) &#123;</span><br><span class="line">      task.<span class="title function_">forEach</span>(<span class="function">(<span class="params">t</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">taskQueue</span>.<span class="title function_">push</span>(t)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">taskQueue</span>.<span class="title function_">push</span>(task)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">run</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">runTask</span>(<span class="params">task</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">runningTask</span>++</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">task</span>()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(e)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">run</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">runningTask</span>--</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">canRunTask</span>()) &#123;</span><br><span class="line">      <span class="keyword">const</span> task = <span class="variable language_">this</span>.<span class="property">taskQueue</span>.<span class="title function_">shift</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">runTask</span>(task)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">run</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">canRunTask</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="variable language_">this</span>.<span class="title function_">isEmpty</span>() &amp;&amp; <span class="variable language_">this</span>.<span class="property">runningTask</span> &lt; <span class="variable language_">this</span>.<span class="property">maxTask</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">isEmpty</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="variable language_">this</span>.<span class="property">taskQueue</span>.<span class="property">length</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> taskQueue = <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> timeList = [<span class="number">100</span>, <span class="number">300</span>, <span class="number">500</span>, <span class="number">900</span>, <span class="number">600</span>]</span><br><span class="line"><span class="keyword">const</span> taskList = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">20</span>).<span class="title function_">fill</span>(<span class="number">0</span>).<span class="title function_">map</span>(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> time = index % timeList.<span class="property">length</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;task &#x27;</span>, index, <span class="string">&#x27;time &#x27;</span>, timeList[time], <span class="string">&#x27;start&#x27;</span>)</span><br><span class="line">      <span class="keyword">const</span> timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">clearTimeout</span>(timer)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;task &#x27;</span>, index, <span class="string">&#x27;time &#x27;</span>, timeList[time], <span class="string">&#x27;finished&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> (index % <span class="number">5</span> === <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="title function_">reject</span>(<span class="string">&#x27;error&#x27;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, timeList[time])</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">taskQueue.<span class="title function_">push</span>(taskList)</span><br></pre></td></tr></table></figure>

<h3 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h3><ul>
<li><a href="https://github.com/JackXuyi/web-exercise/blob/master/algorithm/queue.js">源码参考</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/10/19/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E6%8C%89%E9%A1%BA%E5%BA%8F%E5%88%86%E7%BB%84%E6%89%A7%E8%A1%8C/" data-id="cm19b6rz80047gkdzc934bc9k" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solution/" rel="tag">算法</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-三数之和" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/23/%E4%B8%89%E6%95%B0%E4%B9%8B%E5%92%8C/" class="article-date">
  <time datetime="2020-09-22T20:52:19.000Z" itemprop="datePublished">2020-09-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/23/%E4%B8%89%E6%95%B0%E4%B9%8B%E5%92%8C/">三数之和</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://leetcode-cn.com/problems/3sum/">leetcode 算法题</a></p>
<h3 id="暴力求解"><a href="#暴力求解" class="headerlink" title="暴力求解"></a>暴力求解</h3><p>三层循环遍历数组把符合条件的数据放入数组之中，然后再去重，时间复杂度 n<em>n</em>n 再加去重时间</p>
<h3 id="优化暴力求解"><a href="#优化暴力求解" class="headerlink" title="优化暴力求解"></a>优化暴力求解</h3><p>数组排序，然后遍历数组，把数据放入对象中去重，避免最后的去重操作，时间复杂度 n<em>n</em>n</p>
<h3 id="双指针方法"><a href="#双指针方法" class="headerlink" title="双指针方法"></a>双指针方法</h3><p>数组进行排序，然后外层循环固定一个数，内层使用两个指针分别指向数组的左右两边，如果三数之和小于 0 则把左边指针右移，若果三数之和大于 0 则把右边指针左移，等于 0 时判断数组是否已经存在结果数组中，若存在则跳过，不存在放入数组并在 map 中标记</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> threeSum = <span class="keyword">function</span> (<span class="params">nums</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> sortNums = nums.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b)</span><br><span class="line">  <span class="keyword">const</span> len = sortNums.<span class="property">length</span></span><br><span class="line">  <span class="keyword">const</span> result = []</span><br><span class="line">  <span class="keyword">const</span> obj = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len - <span class="number">2</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> left = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> right = len - <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> (left &lt; right) &#123;</span><br><span class="line">      <span class="keyword">if</span> (sortNums[i] + sortNums[left] + sortNums[right] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        right = right - <span class="number">1</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sortNums[i] + sortNums[left] + sortNums[right] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        left = left + <span class="number">1</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sortNums[i] + sortNums[left] + sortNums[right] === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!obj[<span class="string">`<span class="subst">$&#123;sortNums[i]&#125;</span>,<span class="subst">$&#123;sortNums[left]&#125;</span>,<span class="subst">$&#123;sortNums[right]&#125;</span>`</span>]) &#123;</span><br><span class="line">          result.<span class="title function_">push</span>([sortNums[i], sortNums[left], sortNums[right]])</span><br><span class="line">          obj[<span class="string">`<span class="subst">$&#123;sortNums[i]&#125;</span>,<span class="subst">$&#123;sortNums[left]&#125;</span>,<span class="subst">$&#123;sortNums[right]&#125;</span>`</span>] = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        left = left + <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/23/%E4%B8%89%E6%95%B0%E4%B9%8B%E5%92%8C/" data-id="cm19b6rz6003vgkdzd4rkgvaz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solution/" rel="tag">算法</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-antd中遇到的问题（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/21/antd%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time datetime="2020-09-20T22:42:42.000Z" itemprop="datePublished">2020-09-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/21/antd%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%88%E4%B8%80%EF%BC%89/">antd中遇到的问题（一）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="antd-v4-版本中-Form-Item-子组件-value-不生效问题"><a href="#antd-v4-版本中-Form-Item-子组件-value-不生效问题" class="headerlink" title="antd v4 版本中 Form.Item 子组件 value 不生效问题"></a>antd v4 版本中 Form.Item 子组件 value 不生效问题</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>在 <code>Form.Item</code> 中使用 <code>Input</code> 输入框设置 <code>value</code> 时发现其不生效，查看使用文档也没有发现问题</p>
<h4 id="猜测"><a href="#猜测" class="headerlink" title="猜测"></a>猜测</h4><p><code>Form.Item</code> 对子组件的 <code>value</code> 属性做了劫持，导致手动设置的 <code>value</code> 被覆盖</p>
<h4 id="代码验证"><a href="#代码验证" class="headerlink" title="代码验证"></a>代码验证</h4><ol>
<li>通过查找 <code>return</code> 语句，发现执行了 <code>renderLayout</code> 这个方法</li>
<li>查看 <code>renderLayout</code> 的具体实现子组件实际渲染的是方法的实际参数 <code>baseChildren</code></li>
<li>查看 <code>renderLayout</code> 的调用发现在 <code>!hasName &amp;&amp; !isRenderProps &amp;&amp; !dependencies</code> 才会直接渲染子组件，其它情况会注入 <code>value</code> 等属性</li>
</ol>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先执行</span></span><br><span class="line"><span class="keyword">if</span> (!hasName &amp;&amp; !isRenderProps &amp;&amp; !dependencies) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">renderLayout</span>(children)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 再执行</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title class_">React</span>.<span class="title function_">isValidElement</span>(children)) &#123;</span><br><span class="line">  childNode = (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">MemoInput</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">value</span>=<span class="string">&#123;mergedControl[props.valuePropName</span> || &#x27;<span class="attr">value</span>&#x27;]&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">update</span>=<span class="string">&#123;updateRef.current&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    &gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;React.cloneElement(children, childProps)&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">MemoInput</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h4><p>去除 <code>Form.Item</code> 中的 <code>name</code> 属性，验证 <code>value</code> 属性生效</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/21/antd%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="cm19b6ryd000fgkdz7gkehjp4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/" rel="tag">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mysql数据库操作（二）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/14/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%EF%BC%88%E4%BA%8C%EF%BC%89/" class="article-date">
  <time datetime="2020-09-13T22:50:06.000Z" itemprop="datePublished">2020-09-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/14/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%EF%BC%88%E4%BA%8C%EF%BC%89/">mysql数据库操作（二）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="express-中使用-TypeORM-连接-mysql-数据库"><a href="#express-中使用-TypeORM-连接-mysql-数据库" class="headerlink" title="express 中使用 TypeORM 连接 mysql 数据库"></a>express 中使用 TypeORM 连接 mysql 数据库</h3><h4 id="TypeORM-介绍"><a href="#TypeORM-介绍" class="headerlink" title="TypeORM 介绍"></a>TypeORM 介绍</h4><p>TypeORM 是一个采用 TypeScript 编写的用于 Node.js 的优秀 ORM 框架，支持使用 TypeScript 或 Javascript(ES5, ES6, ES7)开发。</p>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1012625">Nodejs 最好的 ORM - TypeORM</a></li>
<li><a href="https://github.com/typeorm/typeorm">github 链接</a></li>
</ul>
<h4 id="express-中使用"><a href="#express-中使用" class="headerlink" title="express 中使用"></a>express 中使用</h4><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><p><code>yarn add typeorm mysql</code></p>
<h5 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> express, &#123; <span class="title class_">Request</span>, <span class="title class_">Response</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createConnection &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">createConnection</span>(config.<span class="property">db</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> app = <span class="title function_">express</span>()</span><br><span class="line">    app.<span class="title function_">listen</span>(port, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">info</span>(</span><br><span class="line">        <span class="string">`the server is start at port <span class="subst">$&#123;port&#125;</span>, listening on http://localhost:<span class="subst">$&#123;port&#125;</span>`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;connection mysql error: &#x27;</span>, e.<span class="property">message</span>)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getRepository &#125; <span class="keyword">from</span> <span class="string">&#x27;typeorm&#x27;</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getList</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [list, total] = <span class="keyword">await</span> <span class="title function_">getRepository</span>(<span class="title class_">Entity</span>).<span class="title function_">findAndCount</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/14/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%EF%BC%88%E4%BA%8C%EF%BC%89/" data-id="cm19b6ryu002igkdzb56q0u7g" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeORM/" rel="tag">TypeORM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/express/" rel="tag">express</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/" rel="tag">node</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mysql数据库操作（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/14/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time datetime="2020-09-13T22:21:24.000Z" itemprop="datePublished">2020-09-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/14/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%EF%BC%88%E4%B8%80%EF%BC%89/">mysql数据库操作</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><p><code>CREATE USER &#39;username&#39;@&#39;host&#39; IDENTIFIED BY &#39;password&#39;;</code></p>
<ul>
<li><code>host</code> 代表可以登录地址，<code>%</code> 表示任意地址</li>
<li>可选选项 <code>WITH mysql_native_password</code> 语句表示密码的存储方式</li>
</ul>
<h3 id="修改用户密码"><a href="#修改用户密码" class="headerlink" title="修改用户密码"></a>修改用户密码</h3><p><code>ALTER USER &#39;username&#39;@&#39;host&#39; IDENTIFIED WITH mysql_native_password BY &#39;password&#39;;</code></p>
<h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p><code>grant 权限 privileges on dbName.数据表 to &#39;tools&#39;;</code></p>
<ul>
<li>权限包括增删查改，<code>all</code> 代表所有权限</li>
<li>数据库和数据表可以用 <code>*</code> 表示通配</li>
</ul>
<h3 id="刷新权限"><a href="#刷新权限" class="headerlink" title="刷新权限"></a>刷新权限</h3><p><code>FLUSH PRIVILEGES;</code></p>
<ul>
<li>数据权限并不会自动更新，需要手动执行命令才会刷新</li>
</ul>
<h3 id="查看列表数据库"><a href="#查看列表数据库" class="headerlink" title="查看列表数据库"></a>查看列表数据库</h3><p><code>show databases;</code></p>
<h3 id="查看数据表的结构"><a href="#查看数据表的结构" class="headerlink" title="查看数据表的结构"></a>查看数据表的结构</h3><p><code>desc 数据库.数据表;</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/09/14/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="cm19b6ryu002fgkdz3sjz099o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/express/" rel="tag">express</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/" rel="tag">node</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-浏览器缓存" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/31/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98/" class="article-date">
  <time datetime="2020-08-30T21:35:19.000Z" itemprop="datePublished">2020-08-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/31/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98/">浏览器缓存</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="缓存分类"><a href="#缓存分类" class="headerlink" title="缓存分类"></a>缓存分类</h3><ul>
<li>共享缓存：存储的响应能够被多个用户使用。</li>
<li>私有缓存：只能用于单独用户。</li>
</ul>
<h3 id="缓存方式"><a href="#缓存方式" class="headerlink" title="缓存方式"></a>缓存方式</h3><ul>
<li>浏览器与代理缓存</li>
<li>网关缓存</li>
<li>CDN</li>
<li>反向代理缓存和负载均衡器</li>
</ul>
<h3 id="操作的目标"><a href="#操作的目标" class="headerlink" title="操作的目标"></a>操作的目标</h3><p>常见的 HTTP 缓存只能存储 GET 响应，对于其他类型的响应则无能为力。缓存的关键主要包括 request method 和目标 URI（一般只有 GET 请求才会被缓存）。</p>
<h3 id="缓存控制"><a href="#缓存控制" class="headerlink" title="缓存控制"></a>缓存控制</h3><h4 id="没有缓存"><a href="#没有缓存" class="headerlink" title="没有缓存"></a>没有缓存</h4><p>缓存中不得存储任何关于客户端请求和服务端响应的内容。每次由客户端发起的请求都会下载完整的响应内容。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Cache-Control:</span> <span class="literal">no</span><span class="string">-store</span></span><br></pre></td></tr></table></figure>

<h4 id="缓存但重新验证"><a href="#缓存但重新验证" class="headerlink" title="缓存但重新验证"></a>缓存但重新验证</h4><p>每次有请求发出时，缓存会将此请求发到服务器，服务器端会验证请求中所描述的缓存是否过期，若未过期，则缓存才使用本地缓存副本。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Cache-Control:</span> <span class="literal">no</span><span class="string">-cache</span></span><br></pre></td></tr></table></figure>

<h4 id="私有和公共缓存"><a href="#私有和公共缓存" class="headerlink" title="私有和公共缓存"></a>私有和公共缓存</h4><ul>
<li>“public” 指令表示该响应可以被任何中间人（译者注：比如中间代理、CDN 等）缓存。</li>
<li>“private” 则表示该响应是专用于某单个用户的，中间人不能缓存此响应，该响应只能应用于浏览器私有缓存中。</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Cache-Control:</span> <span class="string">private</span></span><br><span class="line"><span class="attr">Cache-Control:</span> <span class="string">public</span></span><br></pre></td></tr></table></figure>

<h4 id="过期"><a href="#过期" class="headerlink" title="过期"></a>过期</h4><p>过期机制中，最重要的指令是 <code>&quot;max-age=&lt;seconds&gt;&quot;</code>，表示资源能够被缓存（保持新鲜）的最大时间。相对 <code>Expires</code> 而言，<code>max-age</code> 是距离请求发起的时间的秒数。针对应用中那些不会改变的文件，通常可以手动设置一定的时长以保证缓存有效，例如图片、<code>css</code>、<code>js</code> 等静态资源。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Cache-Control:</span> <span class="string">max-age=31536000</span></span><br></pre></td></tr></table></figure>

<p><code>s-maxage</code>仅适用于共享缓存(<code>CDN</code>)，优先级高于 <code>max-age</code> 和 <code>Expires</code></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Cache-Control:</span> <span class="string">s-maxage=3600</span></span><br></pre></td></tr></table></figure>

<h4 id="验证方式"><a href="#验证方式" class="headerlink" title="验证方式"></a>验证方式</h4><p>当使用了 “must-revalidate” 指令，那就意味着缓存在考虑使用一个陈旧的资源时，必须先验证它的状态，已过期的缓存将不被使用。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Cache-Control:</span> <span class="string">must-revalidate</span></span><br></pre></td></tr></table></figure>

<h3 id="Pragma-头"><a href="#Pragma-头" class="headerlink" title="Pragma 头"></a>Pragma 头</h3><p>Pragma 是 HTTP&#x2F;1.0 标准中定义的一个 header 属性，请求中包含 Pragma 的效果跟在头信息中定义 Cache-Control: no-cache 相同，但是 HTTP 的响应头没有明确定义这个属性，所以它不能拿来完全替代 HTTP&#x2F;1.1 中定义的 Cache-control 头。通常定义 Pragma 以向后兼容基于 HTTP&#x2F;1.0 的客户端。</p>
<h3 id="新鲜度"><a href="#新鲜度" class="headerlink" title="新鲜度"></a>新鲜度</h3><p>理论上来讲，当一个资源被缓存存储后，该资源应该可以被永久存储在缓存中。</p>
<h4 id="缓存驱逐"><a href="#缓存驱逐" class="headerlink" title="缓存驱逐"></a>缓存驱逐</h4><p>由于缓存只有有限的空间用于存储资源副本，所以缓存会定期地将一些副本删除。当服务器上面的资源进行了更新，那么缓存中的对应资源也应该被更新，由于 HTTP 是 C&#x2F;S 模式的协议，服务器更新一个资源时，不可能直接通知客户端更新缓存，所以双方必须为该资源约定一个过期时间，在该过期时间之前，该资源（缓存副本）就是新鲜的，当过了过期时间后，该资源（缓存副本）则变为陈旧的。驱逐算法用于将陈旧的资源（缓存副本）替换为新鲜的，注意，一个陈旧的资源（缓存副本）是不会直接被清除或忽略的，当客户端发起一个请求时，缓存检索到已有一个对应的陈旧资源（缓存副本），则缓存会先将此请求附加一个 If-None-Match 头，然后发给目标服务器，以此来检查该资源副本是否是依然还是算新鲜的，若服务器返回了 304 (Not Modified)（该响应不会有带有实体信息），则表示此资源副本是新鲜的，这样一来，可以节省一些带宽。若服务器通过 If-None-Match 或 If-Modified-Since 判断后发现已过期，那么会带有该资源的实体内容返回。<br><img src="/images/js/cache.png" alt="缓存驱逐过程"></p>
<h5 id="缓存的先后顺序"><a href="#缓存的先后顺序" class="headerlink" title="缓存的先后顺序"></a>缓存的先后顺序</h5><p>对于含有特定头信息的请求，会去计算缓存寿命。</p>
<ul>
<li>max-age：Cache-control: max-age&#x3D;N 的头，相应的缓存的寿命就是 N。</li>
<li>expires：通过比较 Expires 的值和头里面 Date 属性的值来判断是否缓存还有效。</li>
<li>Last-Modified： 缓存的寿命就等于头里面 Date 的值减去 Last-Modified 的值除以 10（注：根据 rfc2626 其实也就是乘以 10%）</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">expirationTime</span> <span class="string">=</span> <span class="string">responseTime</span> <span class="string">+</span> <span class="string">freshnessLifetime</span> <span class="bullet">-</span> <span class="string">currentAge</span></span><br></pre></td></tr></table></figure>

<h6 id="注：responseTime-表示浏览器接收到此响应的那个时间点。"><a href="#注：responseTime-表示浏览器接收到此响应的那个时间点。" class="headerlink" title="注：responseTime 表示浏览器接收到此响应的那个时间点。"></a>注：responseTime 表示浏览器接收到此响应的那个时间点。</h6><h3 id="缓存验证"><a href="#缓存验证" class="headerlink" title="缓存验证"></a>缓存验证</h3><p>用户点击刷新按钮时会开始缓存验证。</p>
<ul>
<li>如果缓存的响应头信息里含有”Cache-control: must-revalidate”的定义，在浏览的过程中也会触发缓存验证。</li>
<li>在浏览器偏好设置里设置 Advanced-&gt;Cache 为强制验证缓存也能达到相同的效果。</li>
</ul>
<p>当缓存的文档过期后，需要进行缓存验证或者重新获取资源。只有在服务器返回强校验器或者弱校验器时才会进行验证。</p>
<h4 id="ETags"><a href="#ETags" class="headerlink" title="ETags"></a>ETags</h4><ul>
<li>作为缓存的一种强校验器，ETag 响应头是一个对用户代理(User Agent, 下面简称 UA)不透明（译者注：UA 无需理解，只需要按规定使用即可）的值。对于像浏览器这样的 HTTP UA，不知道 ETag 代表什么，不能预测它的值是多少。如果资源请求的响应头里含有 ETag, 客户端可以在后续的请求的头中带上 If-None-Match 头来验证缓存。</li>
<li>Last-Modified 响应头可以作为一种弱校验器。说它弱是因为它只能精确到一秒。如果响应头里含有这个信息，客户端可以在后续的请求中带上 If-Modified-Since 来验证缓存。</li>
</ul>
<p>当向服务端发起缓存校验的请求时，服务端会返回 200 ok 表示返回正常的结果或者 304 Not Modified(不返回 body)表示浏览器可以使用本地缓存文件。304 的响应头也可以同时更新缓存文档的过期时间。</p>
<h3 id="浏览器刷新"><a href="#浏览器刷新" class="headerlink" title="浏览器刷新"></a>浏览器刷新</h3><ul>
<li>地址栏输入地址回车：走正常的缓存流程</li>
<li>刷新页面：让强缓存过期，走协商缓存逻辑</li>
<li>强制刷新页面： 让强缓存和协商缓存都过期，不走缓存逻辑</li>
</ul>
<h3 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a><code>CDN</code></h3><p>内容分发网络，分为推和拉模式。</p>
<ul>
<li>推模式：有更新时会强制推送到网络的各个节点</li>
<li>拉模式：有请求时会判断当前节点是否有数据且数据是否过期，然后再向源站请求资源</li>
</ul>
<h4 id="时间计算"><a href="#时间计算" class="headerlink" title="时间计算"></a>时间计算</h4><p>拉模式下，所有节点的缓存都设置 5 分钟，浏览器可能拉到前 10 分钟到当前时间的资源（假设当前节点到源节点之间没有中间节点），原因如下</p>
<ul>
<li>浏览器到当前节点数据缓存 5 分钟</li>
<li>当前节点到源数据可能缓存 5 分钟</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/08/31/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98/" data-id="cm19b6rzc004ngkdzeqhvgs5z" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-babel编译过程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/30/babel%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B/" class="article-date">
  <time datetime="2020-08-30T15:23:25.000Z" itemprop="datePublished">2020-08-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/30/babel%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B/">babel编译过程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="编译步骤"><a href="#编译步骤" class="headerlink" title="编译步骤"></a>编译步骤</h3><p>Babel 编译文件的主要处理步骤依次是：解析（parse）、转换（transform）、生成（generate）。</p>
<ul>
<li>解析：解析步骤主要是接受源代码并输出抽象语法树（AST）。此步骤主要由@babel&#x2F;parser（原 Babylon）负责解析和理解 js 代码，输出对应的 AST。</li>
<li>转换：转换步骤主要是接受 AST，并对其进行遍历，在此过程中会进行分析和修改 AST，这也是 Babel 插件主要工作的地方。此步骤主要用到@babel&#x2F;traverse 和@babel&#x2F;types 两个包。</li>
<li>生成：生成步骤主要是将（经过一系列转换之后的）AST 再转换为正常的字符串代码。此步骤主要由@babel&#x2F;generator 深度优先遍历整个 AST，然后构建可以表示转换后代码的字符串。</li>
</ul>
<h5 id="注：AST-其实是一个每个节点包含特定属性的对象树"><a href="#注：AST-其实是一个每个节点包含特定属性的对象树" class="headerlink" title="注：AST 其实是一个每个节点包含特定属性的对象树"></a>注：AST 其实是一个每个节点包含特定属性的对象树</h5><h3 id="实现-babel-的编译过程"><a href="#实现-babel-的编译过程" class="headerlink" title="实现 babel 的编译过程"></a>实现 babel 的编译过程</h3><ul>
<li>使用 <code>@babel/parser</code> 把代码格式化为 <code>AST</code> 树</li>
<li>使用 <code>@babel/traverse</code> 和 <code>@babel/types</code> 实现 <code>AST</code> 树的遍历及对树的特定节点的操作</li>
<li>使用 <code>@babel/generator</code> 生成目标代码</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">&#x27;@babel/parser&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">&#x27;@babel/traverse&#x27;</span>).<span class="property">default</span></span><br><span class="line"><span class="keyword">const</span> type = <span class="built_in">require</span>(<span class="string">&#x27;@babel/types&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> generate = <span class="built_in">require</span>(<span class="string">&#x27;@babel/generator&#x27;</span>).<span class="property">default</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">function test(n)&#123;</span></span><br><span class="line"><span class="string">    return n + 1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">const</span> ast = parser.<span class="title function_">parse</span>(code, &#123; <span class="attr">sourceType</span>: <span class="string">&#x27;module&#x27;</span> &#125;) <span class="comment">// 把代码格式化为 AST 树</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">traverse</span>(ast, &#123;</span><br><span class="line">  <span class="comment">// 遍历 AST 树并进行操作</span></span><br><span class="line">  <span class="title function_">enter</span>(<span class="params">path</span>) &#123;</span><br><span class="line">    <span class="comment">// 从根节点到叶子节点遍历过程中</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;enter&#x27;</span>, path.<span class="property">node</span>.<span class="property">name</span>)</span><br><span class="line">    <span class="keyword">if</span> (type.<span class="title function_">isIdentifier</span>(path.<span class="property">node</span>, &#123; <span class="attr">name</span>: <span class="string">&#x27;n&#x27;</span> &#125;)) &#123;</span><br><span class="line">      <span class="comment">// 把参数 n 转化成 x</span></span><br><span class="line">      path.<span class="title function_">replaceWith</span>(type.<span class="title function_">identifier</span>(<span class="string">&#x27;x&#x27;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">exit</span>(<span class="params">path</span>) &#123;</span><br><span class="line">    <span class="comment">// 从叶子节点到根节点遍历过程中</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;exit&#x27;</span>, path.<span class="property">node</span>.<span class="property">name</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> target = <span class="title function_">generate</span>(ast) <span class="comment">// 生成代码</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(target.<span class="property">code</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">function test(x) &#123;</span></span><br><span class="line"><span class="comment">  return x + 1;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md#toc-writing-your-first-babel-plugin">Babel 插件手册</a></li>
<li><a href="https://github.com/Liaoct/blog/issues/14">Babel 7 插件开发指南</a></li>
<li><a href="https://github.com/JackXuyi/web-exercise/blob/master/babel/test.js">示例代码</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/08/30/babel%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B/" data-id="cm19b6ryd000ggkdz1c7r7abx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ES6模块与CommonJS模块" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/27/ES6%E6%A8%A1%E5%9D%97%E4%B8%8ECommonJS%E6%A8%A1%E5%9D%97/" class="article-date">
  <time datetime="2020-08-26T21:09:40.000Z" itemprop="datePublished">2020-08-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/27/ES6%E6%A8%A1%E5%9D%97%E4%B8%8ECommonJS%E6%A8%A1%E5%9D%97/">ES6模块与CommonJS模块</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="ES6-模块与-CommonJS-模块的区别"><a href="#ES6-模块与-CommonJS-模块的区别" class="headerlink" title="ES6 模块与 CommonJS 模块的区别"></a>ES6 模块与 CommonJS 模块的区别</h3><ul>
<li>CommonJS 模块输出的是一个值的拷贝，ES6 模块输出的是值的引用。</li>
<li>CommonJS 模块是运行时加载，ES6 模块是编译时输出接口。（因为 CommonJS 加载的是一个对象（即 module.exports 属性），该对象只有在脚本运行完才会生成。而 ES6 模块不是对象，它的对外接口只是一种静态定义，在代码静态解析阶段就会生成。）</li>
<li>CommonJS 模块的 require()是同步加载模块，ES6 模块的 import 命令是异步加载，有一个独立模块依赖的解析阶段。</li>
</ul>
<h4 id="ES6-模块输出的是值的引用"><a href="#ES6-模块输出的是值的引用" class="headerlink" title="ES6 模块输出的是值的引用"></a>ES6 模块输出的是值的引用</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib.mjs</span></span><br><span class="line"><span class="keyword">let</span> count = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  count = count + <span class="number">1</span></span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; count &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.mjs</span></span><br><span class="line"><span class="keyword">import</span> &#123; count &#125; <span class="keyword">from</span> <span class="string">&#x27;./lib.mjs&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;count&#x27;</span>, count) <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timeout count&#x27;</span>, count) <span class="comment">// 2</span></span><br><span class="line">&#125;, <span class="number">1100</span>)</span><br><span class="line"></span><br><span class="line">count = <span class="number">1000</span> <span class="comment">// TypeError: Assignment to constant variable.</span></span><br></pre></td></tr></table></figure>

<h4 id="CommonJS-模块输出的是一个值的拷贝"><a href="#CommonJS-模块输出的是一个值的拷贝" class="headerlink" title="CommonJS 模块输出的是一个值的拷贝"></a>CommonJS 模块输出的是一个值的拷贝</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib.cjs</span></span><br><span class="line"><span class="keyword">let</span> count = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  count = count + <span class="number">1</span></span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123; count &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.cjs</span></span><br><span class="line"><span class="keyword">let</span> &#123; count &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./lib.cjs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;count&#x27;</span>, count) <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timeout count&#x27;</span>, count) <span class="comment">// 1000</span></span><br><span class="line">&#125;, <span class="number">1100</span>)</span><br><span class="line"></span><br><span class="line">count = <span class="number">1000</span></span><br></pre></td></tr></table></figure>

<h5 id="注"><a href="#注" class="headerlink" title="注"></a>注</h5><ul>
<li>从 Node.js v13.2 版本开始，Node.js 已经默认打开了 ES6 模块支持</li>
<li>Node.js 要求 ES6 模块采用.mjs 后缀文件名</li>
<li>commonjs 模块采用.cjs 后缀文件名</li>
</ul>
<h3 id="循环引用"><a href="#循环引用" class="headerlink" title="循环引用"></a>循环引用</h3><p>“循环加载”（circular dependency）指的是，a 脚本的执行依赖 b 脚本，而 b 脚本的执行又依赖 a 脚本。</p>
<h4 id="CommonJS-模块的循环加载"><a href="#CommonJS-模块的循环加载" class="headerlink" title="CommonJS 模块的循环加载"></a>CommonJS 模块的循环加载</h4><p>CommonJS 模块的脚本代码在 require 的时候，就会全部执行，一旦出现某个模块被”循环加载”，就只输出已经执行的部分，还未执行的部分不会输出。</p>
<h4 id="ES6-模块的循环加载"><a href="#ES6-模块的循环加载" class="headerlink" title="ES6 模块的循环加载"></a>ES6 模块的循环加载</h4><p>ES6 模块遇到模块加载命令 import 时，不会去执行模块，而是只生成一个引用。等到真的需要用到时，再到模块里面去取值，不存在缓存值的问题，而且模块里面的变量，绑定其所在的模块。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://es6.ruanyifeng.com/#docs/module-loader#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8A%A0%E8%BD%BD">ES6 模块与 CommonJS 模块的差异</a></li>
<li><a href="https://juejin.cn/post/6844903747290660878">CommonJS 和 ES6 模块循环加载处理的区别</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2015/11/circular-dependency.html">JavaScript 模块的循环加载</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/322529692">JavaScript 模块加载与循环引用</a></li>
<li><a href="https://github.com/JackXuyi/web-exercise/tree/master/verification">测试代码链接</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/08/27/ES6%E6%A8%A1%E5%9D%97%E4%B8%8ECommonJS%E6%A8%A1%E5%9D%97/" data-id="cm19b6ry00000gkdzcqbf2aze" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">下一页 &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-language/" rel="tag">C&#x2F;C++语言</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a><span class="tag-list-count">63</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeORM/" rel="tag">TypeORM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/antd/" rel="tag">antd</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/express/" rel="tag">express</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/form/" rel="tag">form</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/" rel="tag">node</a><span class="tag-list-count">20</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/other/" rel="tag">other</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/" rel="tag">webpack</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8F%92%E4%BB%B6/" rel="tag">插件</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" rel="tag">浏览器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solution/" rel="tag">算法</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/" rel="tag">计算机网络</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/read-book/" rel="tag">读书</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/source/" rel="tag">资源</a><span class="tag-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/c-language/" style="font-size: 12.5px;">C/C++语言</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/TypeORM/" style="font-size: 10px;">TypeORM</a> <a href="/tags/TypeScript/" style="font-size: 11.25px;">TypeScript</a> <a href="/tags/antd/" style="font-size: 10px;">antd</a> <a href="/tags/express/" style="font-size: 11.25px;">express</a> <a href="/tags/form/" style="font-size: 10px;">form</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/mysql/" style="font-size: 12.5px;">mysql</a> <a href="/tags/node/" style="font-size: 18.75px;">node</a> <a href="/tags/other/" style="font-size: 16.25px;">other</a> <a href="/tags/react/" style="font-size: 17.5px;">react</a> <a href="/tags/webpack/" style="font-size: 12.5px;">webpack</a> <a href="/tags/%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">插件</a> <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 10px;">浏览器</a> <a href="/tags/solution/" style="font-size: 13.75px;">算法</a> <a href="/tags/network/" style="font-size: 15px;">计算机网络</a> <a href="/tags/read-book/" style="font-size: 10px;">读书</a> <a href="/tags/source/" style="font-size: 12.5px;">资源</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">九月 2024</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">七月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">三月 2024</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/09/25/%E6%AD%A3%E5%88%99/">正则</a>
          </li>
        
          <li>
            <a href="/2024/09/25/AI/">AI</a>
          </li>
        
          <li>
            <a href="/2024/09/24/zustand/">zustand</a>
          </li>
        
          <li>
            <a href="/2024/09/22/typescript%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%9E%E7%8E%B0/">typescript自定义实现</a>
          </li>
        
          <li>
            <a href="/2024/09/21/%E4%B8%9A%E5%8A%A1-%E5%A4%A7%E7%89%8C%E8%AF%95%E7%94%A8/">业务-大牌试用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2024 奔跑的蜗牛<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">分类</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>