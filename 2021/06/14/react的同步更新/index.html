<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>react的同步更新 | 奔跑的蜗牛</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="react 同步更新class 组件每个 class 组件初始化时都会注入 updater 的属性 更新过程 构建更新节点 把节点放入更新队列 调度更新节点  12345678910111213141516171819202122232425262728293031// packages/react-reconciler/src/ReactUpdateQueue.old.jsconst class">
<meta name="keywords" content="JavaScript,react">
<meta property="og:type" content="article">
<meta property="og:title" content="react的同步更新">
<meta property="og:url" content="http://yoursite.com/2021/06/14/react的同步更新/index.html">
<meta property="og:site_name" content="奔跑的蜗牛">
<meta property="og:description" content="react 同步更新class 组件每个 class 组件初始化时都会注入 updater 的属性 更新过程 构建更新节点 把节点放入更新队列 调度更新节点  12345678910111213141516171819202122232425262728293031// packages/react-reconciler/src/ReactUpdateQueue.old.jsconst class">
<meta property="og:locale" content="zh_CN">
<meta property="og:updated_time" content="2021-06-14T11:30:40.428Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="react的同步更新">
<meta name="twitter:description" content="react 同步更新class 组件每个 class 组件初始化时都会注入 updater 的属性 更新过程 构建更新节点 把节点放入更新队列 调度更新节点  12345678910111213141516171819202122232425262728293031// packages/react-reconciler/src/ReactUpdateQueue.old.jsconst class">
  
  
    <link rel="icon" href="0001.jpg#/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">奔跑的蜗牛</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">奔跑的蜗牛</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">分类</a>
        
      </nav>
      <nav id="sub-nav">
        
        
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-react的同步更新" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/14/react的同步更新/" class="article-date">
  <time datetime="2021-06-13T18:10:34.000Z" itemprop="datePublished">2021-06-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      react的同步更新
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="react-同步更新"><a href="#react-同步更新" class="headerlink" title="react 同步更新"></a>react 同步更新</h3><h4 id="class-组件"><a href="#class-组件" class="headerlink" title="class 组件"></a>class 组件</h4><p>每个 <code>class</code> 组件初始化时都会注入 <code>updater</code> 的属性</p>
<h5 id="更新过程"><a href="#更新过程" class="headerlink" title="更新过程"></a>更新过程</h5><ol>
<li>构建更新节点</li>
<li>把节点放入更新队列</li>
<li>调度更新节点</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">const</span> classComponentUpdater = &#123;</span><br><span class="line">  isMounted,</span><br><span class="line">  enqueueSetState(inst, payload, callback) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = getInstance(inst)</span><br><span class="line">    <span class="keyword">const</span> eventTime = requestEventTime()</span><br><span class="line">    <span class="keyword">const</span> lane = requestUpdateLane(fiber) <span class="comment">// 获取更新方式，包括同步更新</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> update = createUpdate(eventTime, lane) <span class="comment">// 构建更新</span></span><br><span class="line">    update.payload = payload</span><br><span class="line">    <span class="keyword">if</span> (callback !== <span class="literal">undefined</span> &amp;&amp; callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      update.callback = callback</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enqueueUpdate(fiber, update, lane) <span class="comment">// 更新放入队列</span></span><br><span class="line">    <span class="keyword">const</span> root = scheduleUpdateOnFiber(fiber, lane, eventTime) <span class="comment">// 调度更新节点</span></span><br><span class="line">    <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">      entangleTransitions(root, fiber, lane)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">      markStateUpdateScheduled(fiber, lane)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  enqueueReplaceState(inst, payload, callback) &#123;</span><br><span class="line">    <span class="comment">// 类似与 enqueueSetState</span></span><br><span class="line">  &#125;,</span><br><span class="line">  enqueueForceUpdate(inst, callback) &#123;</span><br><span class="line">    <span class="comment">// 类似与 enqueueSetState</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="把节点放入更新队列"><a href="#把节点放入更新队列" class="headerlink" title="把节点放入更新队列"></a>把节点放入更新队列</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueueUpdate</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  update: Update&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue = fiber.updateQueue</span><br><span class="line">  <span class="keyword">if</span> (updateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 组件卸载</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sharedQueue = updateQueue.shared</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isInterleavedUpdate(fiber, lane)) &#123;</span><br><span class="line">    <span class="keyword">const</span> interleaved = sharedQueue.interleaved</span><br><span class="line">    <span class="keyword">if</span> (interleaved === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 挂载时构成一个循环链表</span></span><br><span class="line">      update.next = update</span><br><span class="line">      <span class="comment">// At the end of the current render, this queue's interleaved updates will</span></span><br><span class="line">      <span class="comment">// be transfered to the pending queue.</span></span><br><span class="line">      pushInterleavedQueue(sharedQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = interleaved.next</span><br><span class="line">      interleaved.next = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.interleaved = update</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pending = sharedQueue.pending</span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 挂载时构成一个循环链表</span></span><br><span class="line">      update.next = update</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = pending.next</span><br><span class="line">      pending.next = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.pending = update</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="调度更新节点"><a href="#调度更新节点" class="headerlink" title="调度更新节点"></a>调度更新节点</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">scheduleUpdateOnFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventTime: number</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  checkForNestedUpdates()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = markUpdateLaneFromFiberToRoot(fiber, lane) <span class="comment">// 更新从当前 fiber 标记到根节点并返回根节点</span></span><br><span class="line">  <span class="keyword">if</span> (root === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 标记当前节点进入更新队列</span></span><br><span class="line">  markRootUpdated(root, lane, eventTime)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (executionContext &amp; CommitContext) !== NoContext &amp;&amp;</span><br><span class="line">      root === rootCommittingMutationOrLayoutEffects</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (fiber.mode &amp; ProfileMode) &#123;</span><br><span class="line">        <span class="keyword">let</span> current = fiber</span><br><span class="line">        <span class="keyword">while</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (current.tag === Profiler) &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; id, onNestedUpdateScheduled &#125; = current.memoizedProps</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> onNestedUpdateScheduled === <span class="string">'function'</span>) &#123;</span><br><span class="line">              onNestedUpdateScheduled(id)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          current = current.return</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Consolidate with `isInterleavedUpdate` check</span></span><br><span class="line">  <span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">    <span class="comment">// Received an update to a tree that's in the middle of rendering. Mark</span></span><br><span class="line">    <span class="comment">// that there was an interleaved update work on this root. Unless the</span></span><br><span class="line">    <span class="comment">// `deferRenderPhaseUpdateToNextBatch` flag is off and this is a render</span></span><br><span class="line">    <span class="comment">// phase update. In that case, we don't treat render phase updates as if</span></span><br><span class="line">    <span class="comment">// they were interleaved, for backwards compat reasons.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      deferRenderPhaseUpdateToNextBatch ||</span><br><span class="line">      (executionContext &amp; RenderContext) === NoContext</span><br><span class="line">    ) &#123;</span><br><span class="line">      workInProgressRootUpdatedLanes = mergeLanes(</span><br><span class="line">        workInProgressRootUpdatedLanes,</span><br><span class="line">        lane</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (workInProgressRootExitStatus === RootSuspendedWithDelay) &#123;</span><br><span class="line">      <span class="comment">// The root already suspended with a delay, which means this render</span></span><br><span class="line">      <span class="comment">// definitely won't finish. Since we have a new update, let's mark it as</span></span><br><span class="line">      <span class="comment">// suspended now, right before marking the incoming update. This has the</span></span><br><span class="line">      <span class="comment">// effect of interrupting the current render and switching to the update.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Make sure this doesn't override pings that happen while we've</span></span><br><span class="line">      <span class="comment">// already started rendering.</span></span><br><span class="line">      markRootSuspended(root, workInProgressRootRenderLanes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lane === SyncLane) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// Check if we're inside unbatchedUpdates</span></span><br><span class="line">      (executionContext &amp; LegacyUnbatchedContext) !== NoContext &amp;&amp;</span><br><span class="line">      <span class="comment">// Check if we're not already rendering</span></span><br><span class="line">      (executionContext &amp; (RenderContext | CommitContext)) === NoContext</span><br><span class="line">    ) &#123;</span><br><span class="line">      performSyncWorkOnRoot(root) <span class="comment">// 开始同步更新</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ensureRootIsScheduled(root, eventTime)</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        executionContext === NoContext &amp;&amp;</span><br><span class="line">        (fiber.mode &amp; ConcurrentMode) === NoMode</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Flush the synchronous work now, unless we're already working or inside</span></span><br><span class="line">        <span class="comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span></span><br><span class="line">        <span class="comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span></span><br><span class="line">        <span class="comment">// without immediately flushing it. We only do this for user-initiated</span></span><br><span class="line">        <span class="comment">// updates, to preserve historical behavior of legacy mode.</span></span><br><span class="line">        resetRenderTimer()</span><br><span class="line">        flushSyncCallbacksOnlyInLegacyMode()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Schedule other updates after in case the callback is sync.</span></span><br><span class="line">    ensureRootIsScheduled(root, eventTime)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="performSyncWorkOnRoot"><a href="#performSyncWorkOnRoot" class="headerlink" title="performSyncWorkOnRoot"></a><code>performSyncWorkOnRoot</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="comment">// This is the entry point for synchronous tasks that don't go</span></span><br><span class="line"><span class="comment">// through Scheduler</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performSyncWorkOnRoot</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdatePhase) &#123;</span><br><span class="line">    syncNestedUpdateFlag()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  flushPassiveEffects()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> lanes = getNextLanes(root, NoLanes)</span><br><span class="line">  <span class="keyword">if</span> (!includesSomeLane(lanes, SyncLane)) &#123;</span><br><span class="line">    <span class="comment">// 同步任务执行完毕</span></span><br><span class="line">    ensureRootIsScheduled(root, now())</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> exitStatus = renderRootSync(root, lanes)</span><br><span class="line">  <span class="comment">// 错误补偿逻辑</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We now have a consistent tree. Because this is a sync render, we</span></span><br><span class="line">  <span class="comment">// will commit it even if something suspended.</span></span><br><span class="line">  <span class="keyword">const</span> finishedWork = root.current.alternate</span><br><span class="line">  root.finishedWork = finishedWork</span><br><span class="line">  root.finishedLanes = lanes</span><br><span class="line">  commitRoot(root)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before exiting, make sure there's a callback scheduled for the next</span></span><br><span class="line">  <span class="comment">// pending level.</span></span><br><span class="line">  ensureRootIsScheduled(root, now())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="renderRootSync"><a href="#renderRootSync" class="headerlink" title="renderRootSync"></a><code>renderRootSync</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// workInProgressRoot 全局变量</span></span><br><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderRootSync</span>(<span class="params">root: FiberRoot, lanes: Lanes</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext</span><br><span class="line">  executionContext |= RenderContext</span><br><span class="line">  <span class="keyword">const</span> prevDispatcher = pushDispatcher()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the root or lanes have changed, throw out the existing stack</span></span><br><span class="line">  <span class="comment">// and prepare a fresh one. Otherwise we'll continue where we left off.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) &#123;</span><br><span class="line">    prepareFreshStack(root, lanes) <span class="comment">// 更新 context</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    markRenderStarted(lanes)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      workLoopSync()</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">      handleError(root, thrownValue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">  resetContextDependencies()</span><br><span class="line">  executionContext = prevExecutionContext</span><br><span class="line">  popDispatcher(prevDispatcher)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    markRenderStopped()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set this to null to indicate there's no in-progress render.</span></span><br><span class="line">  workInProgressRoot = <span class="literal">null</span></span><br><span class="line">  workInProgressRootRenderLanes = NoLanes</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgressRootExitStatus</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="workLoopSync"><a href="#workLoopSync" class="headerlink" title="workLoopSync"></a><code>workLoopSync</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="comment">// workInProgress 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoopSync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Already timed out, so perform work without checking if we need to yield.</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    performUnitOfWork(workInProgress)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="performUnitOfWork"><a href="#performUnitOfWork" class="headerlink" title="performUnitOfWork"></a><code>performUnitOfWork</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 执行更新任务</span></span><br><span class="line">  <span class="keyword">const</span> current = unitOfWork.alternate</span><br><span class="line">  <span class="keyword">let</span> next = beginWork(current, unitOfWork, subtreeRenderLanes) <span class="comment">// child</span></span><br><span class="line">  unitOfWork.memoizedProps = unitOfWork.pendingProps</span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 没有下一个任务时表示任务已经做完</span></span><br><span class="line">    completeUnitOfWork(unitOfWork)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress = next</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ReactCurrentOwner.current = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a><code>beginWork</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberBeginWork.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> updateLanes = workInProgress.lanes</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldProps = current.memoizedProps</span><br><span class="line">    <span class="keyword">const</span> newProps = workInProgress.pendingProps</span><br><span class="line">    <span class="keyword">if</span> (oldProps !== newProps || hasLegacyContextChanged()) &#123;</span><br><span class="line">      <span class="comment">// props 更新或 context 更新</span></span><br><span class="line">      didReceiveUpdate = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!includesSomeLane(renderLanes, updateLanes)) &#123;</span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">      <span class="comment">// 此次渲染的更新和等待的更新没有任何交集，新增等待的更新等待下次执行</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 其它更新逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清空</span></span><br><span class="line">  workInProgress.lanes = NoLanes</span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps)</span><br><span class="line">      <span class="keyword">return</span> updateClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderLanes</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其它类型组件更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="updateClassComponent"><a href="#updateClassComponent" class="headerlink" title="updateClassComponent"></a>updateClassComponent</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberBeginWork.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextProps: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 提取 context</span></span><br><span class="line">  <span class="keyword">let</span> hasContext</span><br><span class="line">  <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">    hasContext = <span class="literal">true</span></span><br><span class="line">    pushLegacyContextProvider(workInProgress)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    hasContext = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  prepareToReadContext(workInProgress, renderLanes)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.stateNode</span><br><span class="line">  <span class="keyword">let</span> shouldUpdate</span><br><span class="line">  <span class="keyword">if</span> (instance === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 挂载</span></span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// A class component without an instance only mounts if it suspended</span></span><br><span class="line">      <span class="comment">// inside a non-concurrent tree, in an inconsistent state. We want to</span></span><br><span class="line">      <span class="comment">// treat it like a new mount, even though an empty version of it already</span></span><br><span class="line">      <span class="comment">// committed. Disconnect the alternate pointers.</span></span><br><span class="line">      current.alternate = <span class="literal">null</span></span><br><span class="line">      workInProgress.alternate = <span class="literal">null</span></span><br><span class="line">      <span class="comment">// Since this is conceptually a new fiber, schedule a Placement effect</span></span><br><span class="line">      workInProgress.flags |= Placement</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// In the initial pass we might need to construct the instance.</span></span><br><span class="line">    constructClassInstance(workInProgress, Component, nextProps)</span><br><span class="line">    mountClassInstance(workInProgress, Component, nextProps, renderLanes)</span><br><span class="line">    shouldUpdate = <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// In a resume, we'll already have an instance we can reuse.</span></span><br><span class="line">    shouldUpdate = resumeMountClassInstance(</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//   更新</span></span><br><span class="line">    shouldUpdate = updateClassInstance(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> nextUnitOfWork = finishClassComponent(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    Component,</span><br><span class="line">    shouldUpdate,</span><br><span class="line">    hasContext,</span><br><span class="line">    renderLanes</span><br><span class="line">  ) <span class="comment">// child</span></span><br><span class="line">  <span class="keyword">return</span> nextUnitOfWork</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="constructClassInstance"><a href="#constructClassInstance" class="headerlink" title="constructClassInstance"></a><code>constructClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">constructClassInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  ctor: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  props: <span class="built_in">any</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> isLegacyContextConsumer = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> unmaskedContext = emptyContextObject</span><br><span class="line">  <span class="keyword">let</span> context = emptyContextObject</span><br><span class="line">  <span class="keyword">const</span> contextType = ctor.contextType</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提取 context</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">'object'</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">    context = readContext(contextType)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!disableLegacyContext) &#123;</span><br><span class="line">    unmaskedContext = getUnmaskedContext(workInProgress, ctor, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> contextTypes = ctor.contextTypes</span><br><span class="line">    isLegacyContextConsumer =</span><br><span class="line">      contextTypes !== <span class="literal">null</span> &amp;&amp; contextTypes !== <span class="literal">undefined</span></span><br><span class="line">    context = isLegacyContextConsumer</span><br><span class="line">      ? getMaskedContext(workInProgress, unmaskedContext)</span><br><span class="line">      : emptyContextObject</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建组件实例</span></span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">new</span> ctor(props, context)</span><br><span class="line">  <span class="keyword">const</span> state = (workInProgress.memoizedState =</span><br><span class="line">    instance.state !== <span class="literal">null</span> &amp;&amp; instance.state !== <span class="literal">undefined</span></span><br><span class="line">      ? instance.state</span><br><span class="line">      : <span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// fiber 注入更新队列和实例信息，存储实例和 fiber 映射</span></span><br><span class="line">  adoptClassInstance(workInProgress, instance)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓存 context</span></span><br><span class="line">  <span class="keyword">if</span> (isLegacyContextConsumer) &#123;</span><br><span class="line">    cacheContext(workInProgress, unmaskedContext, context)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> instance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="adoptClassInstance"><a href="#adoptClassInstance" class="headerlink" title="adoptClassInstance"></a><code>adoptClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">adoptClassInstance</span>(<span class="params">workInProgress: Fiber, instance: <span class="built_in">any</span></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  instance.updater = classComponentUpdater <span class="comment">// 更新队列</span></span><br><span class="line">  workInProgress.stateNode = instance <span class="comment">// 存储组件实例</span></span><br><span class="line">  <span class="comment">//构建 fiber 和组件实例的映射</span></span><br><span class="line">  setInstance(instance, workInProgress)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="mountClassInstance"><a href="#mountClassInstance" class="headerlink" title="mountClassInstance"></a><code>mountClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountClassInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  ctor: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  newProps: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.stateNode</span><br><span class="line">  instance.props = newProps</span><br><span class="line">  instance.state = workInProgress.memoizedState</span><br><span class="line">  instance.refs = emptyRefsObject</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化队列</span></span><br><span class="line">  initializeUpdateQueue(workInProgress)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 context</span></span><br><span class="line">  <span class="keyword">const</span> contextType = ctor.contextType</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">'object'</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">    instance.context = readContext(contextType)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (disableLegacyContext) &#123;</span><br><span class="line">    instance.context = emptyContextObject</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> unmaskedContext = getUnmaskedContext(workInProgress, ctor, <span class="literal">true</span>)</span><br><span class="line">    instance.context = getMaskedContext(workInProgress, unmaskedContext)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新 state</span></span><br><span class="line">  instance.state = workInProgress.memoizedState</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 getDerivedStateFromProps 更新 state</span></span><br><span class="line">  <span class="keyword">const</span> getDerivedStateFromProps = ctor.getDerivedStateFromProps</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">'function'</span>) &#123;</span><br><span class="line">    applyDerivedStateFromProps(</span><br><span class="line">      workInProgress,</span><br><span class="line">      ctor,</span><br><span class="line">      getDerivedStateFromProps,</span><br><span class="line">      newProps</span><br><span class="line">    )</span><br><span class="line">    instance.state = workInProgress.memoizedState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 componentWillMount 生命周期</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> ctor.getDerivedStateFromProps !== <span class="string">'function'</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> instance.getSnapshotBeforeUpdate !== <span class="string">'function'</span> &amp;&amp;</span><br><span class="line">    (<span class="keyword">typeof</span> instance.UNSAFE_componentWillMount === <span class="string">'function'</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> instance.componentWillMount === <span class="string">'function'</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    callComponentWillMount(workInProgress, instance)</span><br><span class="line">    <span class="comment">// componentWillMount 执行 setState 时立即更新 state</span></span><br><span class="line">    processUpdateQueue(workInProgress, newProps, instance, renderLanes)</span><br><span class="line">    instance.state = workInProgress.memoizedState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.componentDidMount === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> fiberFlags: Flags = Update</span><br><span class="line">    <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics) &#123;</span><br><span class="line">      fiberFlags |= LayoutStatic</span><br><span class="line">    &#125;</span><br><span class="line">    workInProgress.flags |= fiberFlags</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="finishClassComponent"><a href="#finishClassComponent" class="headerlink" title="finishClassComponent"></a><code>finishClassComponent</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finishClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  shouldUpdate: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  hasContext: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Refs should update even if shouldComponentUpdate returns false</span></span><br><span class="line">  markRef(current, workInProgress)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> didCaptureError = (workInProgress.flags &amp; DidCapture) !== NoFlags</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!shouldUpdate &amp;&amp; !didCaptureError) &#123;</span><br><span class="line">    <span class="keyword">return</span> bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.stateNode</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Rerender</span></span><br><span class="line">  ReactCurrentOwner.current = workInProgress</span><br><span class="line">  <span class="keyword">let</span> nextChildren</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    didCaptureError &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> Component.getDerivedStateFromError !== <span class="string">'function'</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 错误处理</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nextChildren = instance.render()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  reconcileChildren(current, workInProgress, nextChildren, renderLanes)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 记录 state</span></span><br><span class="line">  workInProgress.memoizedState = instance.state</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgress.child</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="reconcileChildren"><a href="#reconcileChildren" class="headerlink" title="reconcileChildren"></a><code>reconcileChildren</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextChildren: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 挂载</span></span><br><span class="line">    workInProgress.child = mountChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ChildReconciler"><a href="#ChildReconciler" class="headerlink" title="ChildReconciler"></a><code>ChildReconciler</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactChildFiber.old.js</span></span><br><span class="line"><span class="keyword">const</span> mountChildFibers = ChildReconciler(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ChildReconciler</span>(<span class="params">shouldTrackSideEffects</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">deleteChild</span>(<span class="params">returnFiber: Fiber, childToDelete: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">deleteRemainingChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">useFiber</span>(<span class="params">fiber: Fiber, pendingProps: mixed</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> clone = createWorkInProgress(fiber, pendingProps) <span class="comment">// 构建一个新的 fiber 节点</span></span><br><span class="line">    clone.index = <span class="number">0</span></span><br><span class="line">    clone.sibling = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">return</span> clone</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">placeChild</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    newFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    lastPlacedIndex: <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    newIndex: <span class="built_in">number</span></span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">    newFiber.index = newIndex</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span> lastPlacedIndex</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回 fiber</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">placeSingleChild</span>(<span class="params">newFiber: Fiber</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> newFiber</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleTextNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    textContent: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    lanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="comment">// There's no need to check for keys on text nodes since we don't have a</span></span><br><span class="line">    <span class="comment">// way to define them.</span></span><br><span class="line">    <span class="keyword">if</span> (currentFirstChild !== <span class="literal">null</span> &amp;&amp; currentFirstChild.tag === HostText) &#123;</span><br><span class="line">      <span class="comment">// We already have an existing node so let's just update it and delete</span></span><br><span class="line">      <span class="comment">// the rest.</span></span><br><span class="line">      deleteRemainingChildren(returnFiber, currentFirstChild.sibling)</span><br><span class="line">      <span class="keyword">const</span> existing = useFiber(currentFirstChild, textContent)</span><br><span class="line">      existing.return = returnFiber</span><br><span class="line">      <span class="keyword">return</span> existing</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The existing first child is not a text node so we need to create one</span></span><br><span class="line">    <span class="comment">// and delete the existing ones.</span></span><br><span class="line">    deleteRemainingChildren(returnFiber, currentFirstChild)</span><br><span class="line">    <span class="keyword">const</span> created = createFiberFromText(textContent, returnFiber.mode, lanes)</span><br><span class="line">    created.return = returnFiber</span><br><span class="line">    <span class="keyword">return</span> created</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 fiber</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    element: ReactElement,</span></span></span><br><span class="line"><span class="function"><span class="params">    lanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> key = element.key</span><br><span class="line">    <span class="keyword">let</span> child = currentFirstChild</span><br><span class="line">    <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> If key === null and child.key === null, then this only applies to</span></span><br><span class="line">      <span class="comment">// the first item in the list.</span></span><br><span class="line">      <span class="keyword">if</span> (child.key === key) &#123;</span><br><span class="line">        <span class="keyword">const</span> elementType = element.type</span><br><span class="line">        <span class="keyword">if</span> (elementType === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">          <span class="keyword">if</span> (child.tag === Fragment) &#123;</span><br><span class="line">            deleteRemainingChildren(returnFiber, child.sibling)</span><br><span class="line">            <span class="keyword">const</span> existing = useFiber(child, element.props.children)</span><br><span class="line">            existing.return = returnFiber</span><br><span class="line">            <span class="keyword">return</span> existing</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            child.elementType === elementType ||</span><br><span class="line">            (enableLazyElements &amp;&amp;</span><br><span class="line">              <span class="keyword">typeof</span> elementType === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">              elementType !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">              elementType.$$<span class="keyword">typeof</span> === REACT_LAZY_TYPE &amp;&amp;</span><br><span class="line">              resolveLazy(elementType) === child.type)</span><br><span class="line">          ) &#123;</span><br><span class="line">            deleteRemainingChildren(returnFiber, child.sibling)</span><br><span class="line">            <span class="keyword">const</span> existing = useFiber(child, element.props)</span><br><span class="line">            existing.ref = coerceRef(returnFiber, child, element)</span><br><span class="line">            existing.return = returnFiber</span><br><span class="line">            <span class="keyword">return</span> existing</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Didn't match.</span></span><br><span class="line">        deleteRemainingChildren(returnFiber, child)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        deleteChild(returnFiber, child)</span><br><span class="line">      &#125;</span><br><span class="line">      child = child.sibling</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (element.type === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromFragment(</span><br><span class="line">        element.props.children,</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        lanes,</span><br><span class="line">        element.key</span><br><span class="line">      )</span><br><span class="line">      created.return = returnFiber</span><br><span class="line">      <span class="keyword">return</span> created</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromElement(element, returnFiber.mode, lanes)</span><br><span class="line">      created.ref = coerceRef(returnFiber, currentFirstChild, element)</span><br><span class="line">      created.return = returnFiber</span><br><span class="line">      <span class="keyword">return</span> created</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 children fiber</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChild: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    lanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 处理 &lt;&gt;&#123;[...]&#125;&lt;/&gt; 和 &lt;&gt;...&lt;/&gt; 组件，从其中提取 children</span></span><br><span class="line">    <span class="keyword">const</span> isUnkeyedTopLevelFragment =</span><br><span class="line">      <span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">      newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">      newChild.key === <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">      newChild = newChild.props.children</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对象类型，为 react 组件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp; newChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (newChild.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">          <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">            reconcileSingleElement(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              lanes</span><br><span class="line">            )</span><br><span class="line">          )</span><br><span class="line">        <span class="comment">// 其它 react 组件类型</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 数组、迭代器，支持 promise 或者 generate</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'string'</span> || <span class="keyword">typeof</span> newChild === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="comment">// 处理字符串或数字类型</span></span><br><span class="line">      <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">        reconcileSingleTextNode(</span><br><span class="line">          returnFiber,</span><br><span class="line">          currentFirstChild,</span><br><span class="line">          <span class="string">''</span> + newChild,</span><br><span class="line">          lanes</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remaining cases are all treated as empty.</span></span><br><span class="line">    <span class="keyword">return</span> deleteRemainingChildren(returnFiber, currentFirstChild)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> reconcileChildFibers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="completeUnitOfWork"><a href="#completeUnitOfWork" class="headerlink" title="completeUnitOfWork"></a><code>completeUnitOfWork</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> completedWork = unitOfWork</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> current = completedWork.alternate <span class="comment">// 更新后的 fiber</span></span><br><span class="line">    <span class="keyword">const</span> returnFiber = completedWork.return <span class="comment">// 父节点 fiber</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((completedWork.flags &amp; Incomplete) === NoFlags) &#123;</span><br><span class="line">      <span class="comment">// 任务未完成</span></span><br><span class="line">      <span class="keyword">let</span> next = completeWork(current, completedWork, subtreeRenderLanes)</span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Completing this fiber spawned new work. Work on that next.</span></span><br><span class="line">        workInProgress = next</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This fiber did not complete because something threw. Pop values off</span></span><br><span class="line">      <span class="comment">// the stack without entering the complete phase. If this is a boundary,</span></span><br><span class="line">      <span class="comment">// capture values if possible.</span></span><br><span class="line">      <span class="keyword">const</span> next = unwindWork(completedWork, subtreeRenderLanes)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Because this fiber did not complete, don't reset its expiration time.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If completing this work spawned new work, do that next. We'll come</span></span><br><span class="line">        <span class="comment">// back here again.</span></span><br><span class="line">        <span class="comment">// Since we're restarting, remove anything that is not a host effect</span></span><br><span class="line">        <span class="comment">// from the effect tag.</span></span><br><span class="line">        next.flags &amp;= HostEffectMask</span><br><span class="line">        workInProgress = next</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Mark the parent fiber as incomplete and clear its subtree flags.</span></span><br><span class="line">        returnFiber.flags |= Incomplete</span><br><span class="line">        returnFiber.subtreeFlags = NoFlags</span><br><span class="line">        returnFiber.deletions = <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> siblingFiber = completedWork.sibling</span><br><span class="line">    <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">      workInProgress = siblingFiber</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise, return to the parent</span></span><br><span class="line">    completedWork = returnFiber</span><br><span class="line">    <span class="comment">// Update the next thing we're working on in case something throws.</span></span><br><span class="line">    workInProgress = completedWork</span><br><span class="line">  &#125; <span class="keyword">while</span> (completedWork !== <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We've reached the root.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRootExitStatus === RootIncomplete) &#123;</span><br><span class="line">    workInProgressRootExitStatus = RootCompleted</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="commitRoot"><a href="#commitRoot" class="headerlink" title="commitRoot"></a><code>commitRoot</code></h5><p>调用 <code>commitRootImpl</code> 提交更新</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRootImpl</span>(<span class="params">root, renderPriorityLevel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// `flushPassiveEffects` will call `flushSyncUpdateQueue` at the end, which</span></span><br><span class="line">    <span class="comment">// means `flushPassiveEffects` will sometimes result in additional</span></span><br><span class="line">    <span class="comment">// passive effects. So we need to keep flushing in a loop until there are</span></span><br><span class="line">    <span class="comment">// no more pending effects.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Might be better if `flushPassiveEffects` did not automatically</span></span><br><span class="line">    <span class="comment">// flush synchronous work at the end, to avoid factoring hazards like this.</span></span><br><span class="line">    flushPassiveEffects();</span><br><span class="line">  &#125; <span class="keyword">while</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> finishedWork = root.finishedWork;</span><br><span class="line">  <span class="keyword">const</span> lanes = root.finishedLanes;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (finishedWork === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  root.finishedWork = <span class="literal">null</span>;</span><br><span class="line">  root.finishedLanes = NoLanes;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// commitRoot never returns a continuation; it always finishes synchronously.</span></span><br><span class="line">  <span class="comment">// So we can clear these now to allow a new callback to be scheduled.</span></span><br><span class="line">  root.callbackNode = <span class="literal">null</span>;</span><br><span class="line">  root.callbackPriority = NoLane;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update the first and last pending times on this root. The new first</span></span><br><span class="line">  <span class="comment">// pending time is whatever is left on the root fiber.</span></span><br><span class="line">  <span class="keyword">let</span> remainingLanes = mergeLanes(finishedWork.lanes, finishedWork.childLanes);</span><br><span class="line">  markRootFinished(root, remainingLanes);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">    <span class="comment">// We can reset these now that they are finished.</span></span><br><span class="line">    workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line">    workInProgress = <span class="literal">null</span>;</span><br><span class="line">    workInProgressRootRenderLanes = NoLanes;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If there are pending passive effects, schedule a callback to process them.</span></span><br><span class="line">  <span class="comment">// Do this as early as possible, so it is queued before anything else that</span></span><br><span class="line">  <span class="comment">// might get scheduled in the commit phase. (See #16714.)</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Delete all other places that schedule the passive effect callback</span></span><br><span class="line">  <span class="comment">// They're redundant.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (finishedWork.subtreeFlags &amp; PassiveMask) !== NoFlags ||</span><br><span class="line">    (finishedWork.flags &amp; PassiveMask) !== NoFlags</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rootDoesHavePassiveEffects) &#123;</span><br><span class="line">      rootDoesHavePassiveEffects = <span class="literal">true</span>;</span><br><span class="line">      scheduleCallback(NormalSchedulerPriority, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        flushPassiveEffects();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there are any effects in the whole tree.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This is left over from the effect list implementation, where we had</span></span><br><span class="line">  <span class="comment">// to check for the existence of `firstEffect` to satsify Flow. I think the</span></span><br><span class="line">  <span class="comment">// only other reason this optimization exists is because it affects profiling.</span></span><br><span class="line">  <span class="comment">// Reconsider whether this is necessary.</span></span><br><span class="line">  <span class="keyword">const</span> subtreeHasEffects =</span><br><span class="line">    (finishedWork.subtreeFlags &amp;</span><br><span class="line">      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==</span><br><span class="line">    NoFlags;</span><br><span class="line">  <span class="keyword">const</span> rootHasEffect =</span><br><span class="line">    (finishedWork.flags &amp;</span><br><span class="line">      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==</span><br><span class="line">    NoFlags;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (subtreeHasEffects || rootHasEffect) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevTransition = ReactCurrentBatchConfig.transition;</span><br><span class="line">    ReactCurrentBatchConfig.transition = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> previousPriority = getCurrentUpdatePriority();</span><br><span class="line">    setCurrentUpdatePriority(DiscreteEventPriority);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">    executionContext |= CommitContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset this to null before calling lifecycles</span></span><br><span class="line">    ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The commit phase is broken into several sub-phases. We do a separate pass</span></span><br><span class="line">    <span class="comment">// of the effect list for each phase: all mutation effects come before all</span></span><br><span class="line">    <span class="comment">// layout effects, and so on.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The first phase a "before mutation" phase. We use this phase to read the</span></span><br><span class="line">    <span class="comment">// state of the host tree right before we mutate it. This is where</span></span><br><span class="line">    <span class="comment">// getSnapshotBeforeUpdate is called.</span></span><br><span class="line">    <span class="keyword">const</span> shouldFireAfterActiveInstanceBlur = commitBeforeMutationEffects(</span><br><span class="line">      root,</span><br><span class="line">      finishedWork,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      <span class="comment">// Mark the current commit time to be shared by all Profilers in this</span></span><br><span class="line">      <span class="comment">// batch. This enables them to be grouped later.</span></span><br><span class="line">      recordCommitTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">      <span class="comment">// Track the root here, rather than in commitLayoutEffects(), because of ref setters.</span></span><br><span class="line">      <span class="comment">// Updates scheduled during ref detachment should also be flagged.</span></span><br><span class="line">      rootCommittingMutationOrLayoutEffects = root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The next phase is the mutation phase, where we mutate the host tree.</span></span><br><span class="line">    commitMutationEffects(root, finishedWork, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldFireAfterActiveInstanceBlur) &#123;</span><br><span class="line">      afterActiveInstanceBlur();</span><br><span class="line">    &#125;</span><br><span class="line">    resetAfterCommit(root.containerInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The work-in-progress tree is now the current tree. This must come after</span></span><br><span class="line">    <span class="comment">// the mutation phase, so that the previous tree is still current during</span></span><br><span class="line">    <span class="comment">// componentWillUnmount, but before the layout phase, so that the finished</span></span><br><span class="line">    <span class="comment">// work is current during componentDidMount/Update.</span></span><br><span class="line">    root.current = finishedWork;</span><br><span class="line">    commitLayoutEffects(finishedWork, root, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">      rootCommittingMutationOrLayoutEffects = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell Scheduler to yield at the end of the frame, so the browser has an</span></span><br><span class="line">    <span class="comment">// opportunity to paint.</span></span><br><span class="line">    requestPaint();</span><br><span class="line"></span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the priority to the previous non-sync value.</span></span><br><span class="line">    setCurrentUpdatePriority(previousPriority);</span><br><span class="line">    ReactCurrentBatchConfig.transition = prevTransition;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No effects.</span></span><br><span class="line">    root.current = finishedWork;</span><br><span class="line">    <span class="comment">// Measure these anyway so the flamegraph explicitly shows that there were</span></span><br><span class="line">    <span class="comment">// no effects.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Maybe there's a better way to report this.</span></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      recordCommitTime();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> rootDidHavePassiveEffects = rootDoesHavePassiveEffects;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rootDoesHavePassiveEffects) &#123;</span><br><span class="line">    <span class="comment">// This commit has passive effects. Stash a reference to them. But don't</span></span><br><span class="line">    <span class="comment">// schedule a callback until after flushing layout work.</span></span><br><span class="line">    rootDoesHavePassiveEffects = <span class="literal">false</span>;</span><br><span class="line">    rootWithPendingPassiveEffects = root;</span><br><span class="line">    pendingPassiveEffectsLanes = lanes;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read this again, since an effect might have updated it</span></span><br><span class="line">  remainingLanes = root.pendingLanes;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there's remaining work on this root</span></span><br><span class="line">  <span class="keyword">if</span> (remainingLanes === NoLanes) &#123;</span><br><span class="line">    <span class="comment">// If there's no remaining work, we can clear the set of already failed</span></span><br><span class="line">    <span class="comment">// error boundaries.</span></span><br><span class="line">    legacyErrorBoundariesThatAlreadyFailed = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (includesSomeLane(remainingLanes, (SyncLane: Lane))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdatePhase) &#123;</span><br><span class="line">      markNestedUpdateScheduled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Count the number of times the root synchronously re-renders without</span></span><br><span class="line">    <span class="comment">// finishing. If there are too many, it indicates an infinite update loop.</span></span><br><span class="line">    <span class="keyword">if</span> (root === rootWithNestedUpdates) &#123;</span><br><span class="line">      nestedUpdateCount++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">      rootWithNestedUpdates = root;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Always call this before exiting `commitRoot`, to ensure that any</span></span><br><span class="line">  <span class="comment">// additional work on this root is scheduled.</span></span><br><span class="line">  ensureRootIsScheduled(root, now());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasUncaughtError) &#123;</span><br><span class="line">    hasUncaughtError = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> error = firstUncaughtError;</span><br><span class="line">    firstUncaughtError = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((executionContext &amp; LegacyUnbatchedContext) !== NoContext) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">      markCommitStopped();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is a legacy edge case. We just committed the initial mount of</span></span><br><span class="line">    <span class="comment">// a ReactDOM.render-ed root inside of batchedUpdates. The commit fired</span></span><br><span class="line">    <span class="comment">// synchronously, but layout updates should be deferred until the end</span></span><br><span class="line">    <span class="comment">// of the batch.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the passive effects are the result of a discrete render, flush them</span></span><br><span class="line">  <span class="comment">// synchronously at the end of the current task so that the result is</span></span><br><span class="line">  <span class="comment">// immediately observable. Otherwise, we assume that they are not</span></span><br><span class="line">  <span class="comment">// order-dependent and do not need to be observed by external systems, so we</span></span><br><span class="line">  <span class="comment">// can wait until after paint.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> We can optimize this by not scheduling the callback earlier. Since we</span></span><br><span class="line">  <span class="comment">// currently schedule the callback in multiple places, will wait until those</span></span><br><span class="line">  <span class="comment">// are consolidated.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    includesSomeLane(pendingPassiveEffectsLanes, SyncLane) &amp;&amp;</span><br><span class="line">    root.tag !== LegacyRoot</span><br><span class="line">  ) &#123;</span><br><span class="line">    flushPassiveEffects();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If layout work was scheduled, flush it now.</span></span><br><span class="line">  flushSyncCallbacks();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    markCommitStopped();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="flushPassiveEffects"><a href="#flushPassiveEffects" class="headerlink" title="flushPassiveEffects"></a><code>flushPassiveEffects</code></h5><p>调用 <code>flushPassiveEffectsImpl</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushPassiveEffectsImpl</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (rootWithPendingPassiveEffects === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = rootWithPendingPassiveEffects;</span><br><span class="line">  <span class="keyword">const</span> lanes = pendingPassiveEffectsLanes;</span><br><span class="line">  rootWithPendingPassiveEffects = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This is sometimes out of sync with rootWithPendingPassiveEffects.</span></span><br><span class="line">  <span class="comment">// Figure out why and fix it. It's not causing any known issues (probably</span></span><br><span class="line">  <span class="comment">// because it's only used for profiling), but it's a refactor hazard.</span></span><br><span class="line">  pendingPassiveEffectsLanes = NoLanes;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">  executionContext |= CommitContext;</span><br><span class="line"></span><br><span class="line">  commitPassiveUnmountEffects(root.current);</span><br><span class="line">  commitPassiveMountEffects(root, root.current);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Move to commitPassiveMountEffects</span></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) &#123;</span><br><span class="line">    <span class="keyword">const</span> profilerEffects = pendingPassiveProfilerEffects;</span><br><span class="line">    pendingPassiveProfilerEffects = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; profilerEffects.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> fiber = ((profilerEffects[i]: <span class="built_in">any</span>): Fiber);</span><br><span class="line">      commitPassiveEffectDurations(root, fiber);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  executionContext = prevExecutionContext;</span><br><span class="line">  flushSyncCallbacks();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If additional passive effects were scheduled, increment a counter. If this</span></span><br><span class="line">  <span class="comment">// exceeds the limit, we'll fire a warning.</span></span><br><span class="line">  nestedPassiveUpdateCount =</span><br><span class="line">    rootWithPendingPassiveEffects === <span class="literal">null</span> ? <span class="number">0</span> : nestedPassiveUpdateCount + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = root.current.stateNode;</span><br><span class="line">    stateNode.effectDuration = <span class="number">0</span>;</span><br><span class="line">    stateNode.passiveEffectDuration = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="commitPassiveUnmountEffects"><a href="#commitPassiveUnmountEffects" class="headerlink" title="commitPassiveUnmountEffects"></a><code>commitPassiveUnmountEffects</code></h5><p>执行生命周期钩子，当进入节点时立即执行生命周期函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<p>调用 <code>commitPassiveUnmountEffects_begin</code> 开启操作，<code>commitPassiveUnmountEffects_complete</code> 完成操作</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountEffects_begin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// curr -&gt; child -&gt; child</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> child = fiber.child</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((nextEffect.flags &amp; ChildDeletion) !== NoFlags) &#123;</span><br><span class="line">      <span class="keyword">const</span> deletions = fiber.deletions</span><br><span class="line">      <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.length; i++) &#123;</span><br><span class="line">          <span class="keyword">const</span> fiberToDelete = deletions[i]</span><br><span class="line">          nextEffect = fiberToDelete</span><br><span class="line">          commitPassiveUnmountEffectsInsideOfDeletedTree_begin(</span><br><span class="line">            fiberToDelete,</span><br><span class="line">            fiber</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="comment">// A fiber was deleted from this parent fiber, but it's still part of</span></span><br><span class="line">          <span class="comment">// the previous (alternate) parent fiber's list of children. Because</span></span><br><span class="line">          <span class="comment">// children are a linked list, an earlier sibling that's still alive</span></span><br><span class="line">          <span class="comment">// will be connected to the deleted fiber via its `alternate`:</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          <span class="comment">//   live fiber</span></span><br><span class="line">          <span class="comment">//   --alternate--&gt; previous live fiber</span></span><br><span class="line">          <span class="comment">//   --sibling--&gt; deleted fiber</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          <span class="comment">// We can't disconnect `alternate` on nodes that haven't been deleted</span></span><br><span class="line">          <span class="comment">// yet, but we can disconnect the `sibling` and `child` pointers.</span></span><br><span class="line">          <span class="keyword">const</span> previousFiber = fiber.alternate</span><br><span class="line">          <span class="keyword">if</span> (previousFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> detachedChild = previousFiber.child</span><br><span class="line">            <span class="keyword">if</span> (detachedChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">              previousFiber.child = <span class="literal">null</span></span><br><span class="line">              <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> detachedSibling = detachedChild.sibling</span><br><span class="line">                detachedChild.sibling = <span class="literal">null</span></span><br><span class="line">                detachedChild = detachedSibling</span><br><span class="line">              &#125; <span class="keyword">while</span> (detachedChild !== <span class="literal">null</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nextEffect = fiber</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fiber.subtreeFlags &amp; PassiveMask) !== NoFlags &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(child, fiber) <span class="comment">// 确保父节点指向 fiber</span></span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      commitPassiveUnmountEffects_complete()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountEffects_complete</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 若存在兄弟节点则遍历下一个兄弟节点，否则返回父节点</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">if</span> ((fiber.flags &amp; Passive) !== NoFlags) &#123;</span><br><span class="line">      commitPassiveUnmountOnFiber(fiber)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, fiber.return)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect = fiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountOnFiber</span>(<span class="params">finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">        commitHookEffectListUnmount(</span><br><span class="line">          HookPassive | HookHasEffect,</span><br><span class="line">          finishedWork,</span><br><span class="line">          finishedWork.return,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountEffectsInsideOfDeletedTree_begin</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  deletedSubtreeRoot: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nearestMountedAncestor: Fiber | <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// p-&gt; child -&gt; child</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="comment">// Deletion effects fire in parent -&gt; child order</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Check if fiber has a PassiveStatic flag</span></span><br><span class="line">    commitPassiveUnmountInsideDeletedTreeOnFiber(fiber, nearestMountedAncestor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.child</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Only traverse subtree if it has a PassiveStatic flag. (But, if we</span></span><br><span class="line">    <span class="comment">// do this, still need to handle `deletedTreeCleanUpLevel` correctly.)</span></span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      commitPassiveUnmountEffectsInsideOfDeletedTree_complete(</span><br><span class="line">        deletedSubtreeRoot</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountInsideDeletedTreeOnFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nearestMountedAncestor: Fiber | <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (current.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      commitHookEffectListUnmount(HookPassive, current, nearestMountedAncestor)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁组件，要销毁的组件存在 updateQueue 中</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitHookEffectListUnmount</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  flags: HookFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nearestMountedAncestor: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue: FunctionComponentUpdateQueue | <span class="literal">null</span> = (finishedWork.updateQueue: <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">const</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.lastEffect : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstEffect = lastEffect.next;</span><br><span class="line">    <span class="keyword">let</span> effect = firstEffect;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((effect.tag &amp; flags) === flags) &#123;</span><br><span class="line">        <span class="comment">// Unmount</span></span><br><span class="line">        <span class="keyword">const</span> destroy = effect.destroy;</span><br><span class="line">        effect.destroy = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          safelyCallDestroy(finishedWork, nearestMountedAncestor, destroy); <span class="comment">// 调用 destroy 销毁组件</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      effect = effect.next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountEffectsInsideOfDeletedTree_complete</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  deletedSubtreeRoot: Fiber</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">const</span> returnFiber = fiber.return</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="comment">// Recursively traverse the entire deleted tree and clean up fiber fields.</span></span><br><span class="line">      <span class="comment">// This is more aggressive than ideal, and the long term goal is to only</span></span><br><span class="line">      <span class="comment">// have to detach the deleted tree at the root.</span></span><br><span class="line">      detachFiberAfterEffects(fiber)</span><br><span class="line">      <span class="keyword">if</span> (fiber === deletedSubtreeRoot) &#123;</span><br><span class="line">        nextEffect = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This is the default branch (level 0). We do not recursively clear all</span></span><br><span class="line">      <span class="comment">// the fiber fields. Only the root of the deleted subtree.</span></span><br><span class="line">      <span class="keyword">if</span> (fiber === deletedSubtreeRoot) &#123;</span><br><span class="line">        detachFiberAfterEffects(fiber)</span><br><span class="line">        nextEffect = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, returnFiber)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = returnFiber</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">detachFiberAfterEffects</span>(<span class="params">fiber: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> alternate = fiber.alternate</span><br><span class="line">  <span class="keyword">if</span> (alternate !== <span class="literal">null</span>) &#123;</span><br><span class="line">    fiber.alternate = <span class="literal">null</span></span><br><span class="line">    detachFiberAfterEffects(alternate)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: Defensively using negation instead of &lt; in case</span></span><br><span class="line">  <span class="comment">// `deletedTreeCleanUpLevel` is undefined.</span></span><br><span class="line">  <span class="keyword">if</span> (!(deletedTreeCleanUpLevel &gt;= <span class="number">2</span>)) &#123;</span><br><span class="line">    <span class="comment">// This is the default branch (level 0).</span></span><br><span class="line">    fiber.child = <span class="literal">null</span></span><br><span class="line">    fiber.deletions = <span class="literal">null</span></span><br><span class="line">    fiber.dependencies = <span class="literal">null</span></span><br><span class="line">    fiber.memoizedProps = <span class="literal">null</span></span><br><span class="line">    fiber.memoizedState = <span class="literal">null</span></span><br><span class="line">    fiber.pendingProps = <span class="literal">null</span></span><br><span class="line">    fiber.sibling = <span class="literal">null</span></span><br><span class="line">    fiber.stateNode = <span class="literal">null</span></span><br><span class="line">    fiber.updateQueue = <span class="literal">null</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Clear cyclical Fiber fields. This level alone is designed to roughly</span></span><br><span class="line">    <span class="comment">// approximate the planned Fiber refactor. In that world, `setState` will be</span></span><br><span class="line">    <span class="comment">// bound to a special "instance" object instead of a Fiber. The Instance</span></span><br><span class="line">    <span class="comment">// object will not have any of these fields. It will only be connected to</span></span><br><span class="line">    <span class="comment">// the fiber tree via a single link at the root. So if this level alone is</span></span><br><span class="line">    <span class="comment">// sufficient to fix memory issues, that bodes well for our plans.</span></span><br><span class="line">    fiber.child = <span class="literal">null</span></span><br><span class="line">    fiber.deletions = <span class="literal">null</span></span><br><span class="line">    fiber.sibling = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The `stateNode` is cyclical because on host nodes it points to the host</span></span><br><span class="line">    <span class="comment">// tree, which has its own pointers to children, parents, and siblings.</span></span><br><span class="line">    <span class="comment">// The other host nodes also point back to fibers, so we should detach that</span></span><br><span class="line">    <span class="comment">// one, too.</span></span><br><span class="line">    <span class="keyword">if</span> (fiber.tag === HostComponent) &#123;</span><br><span class="line">      <span class="keyword">const</span> hostInstance: Instance = fiber.stateNode</span><br><span class="line">      <span class="keyword">if</span> (hostInstance !== <span class="literal">null</span>) &#123;</span><br><span class="line">        detachDeletedInstance(hostInstance) <span class="comment">// 删除 react 相关属性，包括事件、容器等</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fiber.stateNode = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="comment">// Theoretically, nothing in here should be necessary, because we already</span></span><br><span class="line">      <span class="comment">// disconnected the fiber from the tree. So even if something leaks this</span></span><br><span class="line">      <span class="comment">// particular fiber, it won't leak anything else</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// The purpose of this branch is to be super aggressive so we can measure</span></span><br><span class="line">      <span class="comment">// if there's any difference in memory impact. If there is, that could</span></span><br><span class="line">      <span class="comment">// indicate a React leak we don't know about.</span></span><br><span class="line">      fiber.return = <span class="literal">null</span></span><br><span class="line">      fiber.dependencies = <span class="literal">null</span></span><br><span class="line">      fiber.memoizedProps = <span class="literal">null</span></span><br><span class="line">      fiber.memoizedState = <span class="literal">null</span></span><br><span class="line">      fiber.pendingProps = <span class="literal">null</span></span><br><span class="line">      fiber.stateNode = <span class="literal">null</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Move to `commitPassiveUnmountInsideDeletedTreeOnFiber` instead.</span></span><br><span class="line">      fiber.updateQueue = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="commitBeforeMutationEffects"><a href="#commitBeforeMutationEffects" class="headerlink" title="commitBeforeMutationEffects"></a><code>commitBeforeMutationEffects</code></h5><p>执行生命周期钩子，当进入节点时立即执行生命周期函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle 全局变量</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  firstChild: Fiber</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  focusedInstanceHandle = prepareForCommit(root.containerInfo) <span class="comment">// 查找活跃的的节点</span></span><br><span class="line"></span><br><span class="line">  nextEffect = firstChild</span><br><span class="line">  commitBeforeMutationEffects_begin()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We no longer need to track the active instance fiber</span></span><br><span class="line">  <span class="keyword">const</span> shouldFire = shouldFireAfterActiveInstanceBlur</span><br><span class="line">  shouldFireAfterActiveInstanceBlur = <span class="literal">false</span></span><br><span class="line">  focusedInstanceHandle = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> shouldFire</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects_begin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should wrap this in flags check, too, as optimization</span></span><br><span class="line">    <span class="keyword">const</span> deletions = fiber.deletions</span><br><span class="line">    <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> deletion = deletions[i]</span><br><span class="line">        commitBeforeMutationEffectsDeletion(deletion)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.child</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (fiber.subtreeFlags &amp; BeforeMutationMask) !== NoFlags &amp;&amp;</span><br><span class="line">      child !== <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      commitBeforeMutationEffects_complete()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects_complete</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 先兄弟节点再父节点</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    commitBeforeMutationEffectsOnFiber(fiber)</span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, fiber.return)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffectsOnFiber</span>(<span class="params">finishedWork: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.flags</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!shouldFireAfterActiveInstanceBlur &amp;&amp; focusedInstanceHandle !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Check to see if the focused element was inside of a hidden (Suspense) subtree.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Move this out of the hot path using a dedicated effect tag.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      finishedWork.tag === SuspenseComponent &amp;&amp;</span><br><span class="line">      isSuspenseBoundaryBeingHidden(current, finishedWork) &amp;&amp;</span><br><span class="line">      doesFiberContain(finishedWork, focusedInstanceHandle)</span><br><span class="line">    ) &#123;</span><br><span class="line">      shouldFireAfterActiveInstanceBlur = <span class="literal">true</span></span><br><span class="line">      beforeActiveInstanceBlur(finishedWork)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((flags &amp; Snapshot) !== NoFlags) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">      <span class="keyword">case</span> ForwardRef:</span><br><span class="line">      <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevProps = current.memoizedProps</span><br><span class="line">          <span class="keyword">const</span> prevState = current.memoizedState</span><br><span class="line">          <span class="keyword">const</span> instance = finishedWork.stateNode</span><br><span class="line">          <span class="keyword">const</span> snapshot = instance.getSnapshotBeforeUpdate(</span><br><span class="line">            finishedWork.elementType === finishedWork.type</span><br><span class="line">              ? prevProps</span><br><span class="line">              : resolveDefaultProps(finishedWork.type, prevProps),</span><br><span class="line">            prevState</span><br><span class="line">          )</span><br><span class="line">          instance.__reactInternalSnapshotBeforeUpdate = snapshot</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsMutation) &#123;</span><br><span class="line">          <span class="keyword">const</span> root = finishedWork.stateNode</span><br><span class="line">          clearContainer(root.containerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> HostComponent:</span><br><span class="line">      <span class="keyword">case</span> HostText:</span><br><span class="line">      <span class="keyword">case</span> HostPortal:</span><br><span class="line">      <span class="keyword">case</span> IncompleteClassComponent:</span><br><span class="line">        <span class="comment">// Nothing to do for these component types</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">default</span>: &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffectsDeletion</span>(<span class="params">deletion: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// TODO (effects) It would be nice to avoid calling doesFiberContain()</span></span><br><span class="line">  <span class="comment">// Maybe we can repurpose one of the subtreeFlags positions for this instead?</span></span><br><span class="line">  <span class="comment">// Use it to store which part of the tree the focused instance is in?</span></span><br><span class="line">  <span class="comment">// This assumes we can safely determine that instance during the "render" phase.</span></span><br><span class="line">  <span class="keyword">if</span> (doesFiberContain(deletion, focusedInstanceHandle)) &#123;</span><br><span class="line">    shouldFireAfterActiveInstanceBlur = <span class="literal">true</span></span><br><span class="line">    beforeActiveInstanceBlur(deletion)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="commitMutationEffects"><a href="#commitMutationEffects" class="headerlink" title="commitMutationEffects"></a><code>commitMutationEffects</code></h5><p>构建 dom 节点，在离开节点时开始 dom 构建<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle,inProgressLanes,inProgressRoot 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  firstChild: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  inProgressLanes = committedLanes</span><br><span class="line">  inProgressRoot = root</span><br><span class="line">  nextEffect = firstChild</span><br><span class="line"></span><br><span class="line">  commitMutationEffects_begin(root)</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span></span><br><span class="line">  inProgressRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects_begin</span>(<span class="params">root: FiberRoot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should wrap this in flags check, too, as optimization</span></span><br><span class="line">    <span class="keyword">const</span> deletions = fiber.deletions</span><br><span class="line">    <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> childToDelete = deletions[i]</span><br><span class="line">        commitDeletion(root, childToDelete, fiber)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.child</span><br><span class="line">    <span class="keyword">if</span> ((fiber.subtreeFlags &amp; MutationMask) !== NoFlags &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      commitMutationEffects_complete(root)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects_complete</span>(<span class="params">root: FiberRoot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    commitMutationEffectsOnFiber(fiber, root)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, fiber.return)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffectsOnFiber</span>(<span class="params">finishedWork: Fiber, root: FiberRoot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.flags</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; ContentReset) &#123;</span><br><span class="line">    commitResetTextContent(finishedWork)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; Ref) &#123;</span><br><span class="line">    <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      commitDetachRef(current)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> This is a temporary solution that allowed us to transition away</span></span><br><span class="line">      <span class="comment">// from React Flare on www.</span></span><br><span class="line">      <span class="keyword">if</span> (finishedWork.tag === ScopeComponent) &#123;</span><br><span class="line">        commitAttachRef(finishedWork)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The following switch statement is only concerned about placement,</span></span><br><span class="line">  <span class="comment">// updates, and deletions. To avoid needing to add a case for every possible</span></span><br><span class="line">  <span class="comment">// bitmap value, we remove the secondary effects from the effect tag and</span></span><br><span class="line">  <span class="comment">// switch on that value.</span></span><br><span class="line">  <span class="keyword">const</span> primaryFlags = flags &amp; (Placement | Update | Hydrating)</span><br><span class="line">  <span class="keyword">switch</span> (primaryFlags) &#123;</span><br><span class="line">    <span class="keyword">case</span> Placement: &#123;</span><br><span class="line">      commitPlacement(finishedWork)</span><br><span class="line">      <span class="comment">// Clear the "placement" from effect tag so that we know that this is</span></span><br><span class="line">      <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> findDOMNode doesn't rely on this any more but isMounted does</span></span><br><span class="line">      <span class="comment">// and isMounted is deprecated anyway so we should be able to kill this.</span></span><br><span class="line">      finishedWork.flags &amp;= ~Placement</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> PlacementAndUpdate: &#123;</span><br><span class="line">      <span class="comment">// Placement</span></span><br><span class="line">      commitPlacement(finishedWork)</span><br><span class="line">      <span class="comment">// Clear the "placement" from effect tag so that we know that this is</span></span><br><span class="line">      <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">      finishedWork.flags &amp;= ~Placement</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">      commitWork(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Hydrating: &#123;</span><br><span class="line">      finishedWork.flags &amp;= ~Hydrating</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HydratingAndUpdate: &#123;</span><br><span class="line">      finishedWork.flags &amp;= ~Hydrating</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">      commitWork(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Update: &#123;</span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">      commitWork(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitWork</span>(<span class="params">current: Fiber | <span class="literal">null</span>, finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">      <span class="keyword">case</span> ForwardRef:</span><br><span class="line">      <span class="keyword">case</span> MemoComponent:</span><br><span class="line">      <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">        <span class="comment">// Layout effects are destroyed during the mutation phase so that all</span></span><br><span class="line">        <span class="comment">// destroy functions for all fibers are called before any create functions.</span></span><br><span class="line">        <span class="comment">// This prevents sibling component effects from interfering with each other,</span></span><br><span class="line">        <span class="comment">// e.g. a destroy function in one component should never override a ref set</span></span><br><span class="line">        <span class="comment">// by a create function in another component during the same commit.</span></span><br><span class="line"></span><br><span class="line">          commitHookEffectListUnmount(</span><br><span class="line">            HookLayout | HookHasEffect,</span><br><span class="line">            finishedWork,</span><br><span class="line">            finishedWork.return,</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> Profiler: &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">        commitSuspenseComponent(finishedWork);</span><br><span class="line">        attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">        attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsHydration) &#123;</span><br><span class="line">          <span class="keyword">const</span> root: FiberRoot = finishedWork.stateNode;</span><br><span class="line">          <span class="keyword">if</span> (root.hydrate) &#123;</span><br><span class="line">            <span class="comment">// We've just hydrated. No need to hydrate again.</span></span><br><span class="line">            root.hydrate = <span class="literal">false</span>;</span><br><span class="line">            commitHydratedContainer(root.containerInfo);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> OffscreenComponent:</span><br><span class="line">      <span class="keyword">case</span> LegacyHiddenComponent: &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    commitContainer(finishedWork);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> MemoComponent:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      <span class="comment">// Layout effects are destroyed during the mutation phase so that all</span></span><br><span class="line">      <span class="comment">// destroy functions for all fibers are called before any create functions.</span></span><br><span class="line">      <span class="comment">// This prevents sibling component effects from interfering with each other,</span></span><br><span class="line">      <span class="comment">// e.g. a destroy function in one component should never override a ref set</span></span><br><span class="line">      <span class="comment">// by a create function in another component during the same commit.</span></span><br><span class="line"></span><br><span class="line">        commitHookEffectListUnmount(</span><br><span class="line">          HookLayout | HookHasEffect,</span><br><span class="line">          finishedWork,</span><br><span class="line">          finishedWork.return,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> instance: Instance = finishedWork.stateNode;</span><br><span class="line">      <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Commit the work prepared earlier.</span></span><br><span class="line">        <span class="keyword">const</span> newProps = finishedWork.memoizedProps;</span><br><span class="line">        <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">        <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">        <span class="comment">// this case.</span></span><br><span class="line">        <span class="keyword">const</span> oldProps = current !== <span class="literal">null</span> ? current.memoizedProps : newProps;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">type</span> = finishedWork.type;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Type the updateQueue to be specific to host components.</span></span><br><span class="line">        <span class="keyword">const</span> updatePayload: <span class="literal">null</span> | UpdatePayload = (finishedWork.updateQueue: <span class="built_in">any</span>);</span><br><span class="line">        finishedWork.updateQueue = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (updatePayload !== <span class="literal">null</span>) &#123;</span><br><span class="line">          commitUpdate(</span><br><span class="line">            instance,</span><br><span class="line">            updatePayload,</span><br><span class="line">            <span class="keyword">type</span>,</span><br><span class="line">            oldProps,</span><br><span class="line">            newProps,</span><br><span class="line">            finishedWork,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostText: &#123;</span><br><span class="line">      <span class="keyword">const</span> textInstance: TextInstance = finishedWork.stateNode;</span><br><span class="line">      <span class="keyword">const</span> newText: <span class="built_in">string</span> = finishedWork.memoizedProps;</span><br><span class="line">      <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">      <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">      <span class="comment">// this case.</span></span><br><span class="line">      <span class="keyword">const</span> oldText: <span class="built_in">string</span> =</span><br><span class="line">        current !== <span class="literal">null</span> ? current.memoizedProps : newText;</span><br><span class="line">      commitTextUpdate(textInstance, oldText, newText);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">      <span class="keyword">if</span> (supportsHydration) &#123;</span><br><span class="line">        <span class="keyword">const</span> root: FiberRoot = finishedWork.stateNode;</span><br><span class="line">        <span class="keyword">if</span> (root.hydrate) &#123;</span><br><span class="line">          <span class="comment">// We've just hydrated. No need to hydrate again.</span></span><br><span class="line">          root.hydrate = <span class="literal">false</span>;</span><br><span class="line">          commitHydratedContainer(root.containerInfo);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Profiler: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">      commitSuspenseComponent(finishedWork);</span><br><span class="line">      attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">      attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> IncompleteClassComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ScopeComponent: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">        <span class="keyword">const</span> scopeInstance = finishedWork.stateNode;</span><br><span class="line">        prepareScopeUpdate(scopeInstance, finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> OffscreenComponent:</span><br><span class="line">    <span class="keyword">case</span> LegacyHiddenComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> newState: OffscreenState | <span class="literal">null</span> = finishedWork.memoizedState;</span><br><span class="line">      <span class="keyword">const</span> isHidden = newState !== <span class="literal">null</span>;</span><br><span class="line">      hideOrUnhideAllChildren(finishedWork, isHidden);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPlacement</span>(<span class="params">finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Recursively insert all host nodes into the parent.</span></span><br><span class="line">  <span class="keyword">const</span> parentFiber = getHostParentFiber(finishedWork);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: these two variables *must* always be updated together.</span></span><br><span class="line">  <span class="keyword">let</span> parent;</span><br><span class="line">  <span class="keyword">let</span> isContainer;</span><br><span class="line">  <span class="keyword">const</span> parentStateNode = parentFiber.stateNode;</span><br><span class="line">  <span class="keyword">switch</span> (parentFiber.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">      parent = parentStateNode;</span><br><span class="line">      isContainer = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HostRoot:</span><br><span class="line">      parent = parentStateNode.containerInfo;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HostPortal:</span><br><span class="line">      parent = parentStateNode.containerInfo;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// eslint-disable-next-line-no-fallthrough</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (parentFiber.flags &amp; ContentReset) &#123;</span><br><span class="line">    <span class="comment">// Reset the text content of the parent before doing any insertions</span></span><br><span class="line">    resetTextContent(parent);</span><br><span class="line">    <span class="comment">// Clear ContentReset from the effect tag</span></span><br><span class="line">    parentFiber.flags &amp;= ~ContentReset;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> before = getHostSibling(finishedWork);</span><br><span class="line">  <span class="comment">// 插入 dom 元素</span></span><br><span class="line">  <span class="keyword">if</span> (isContainer) &#123;</span><br><span class="line">    insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    insertOrAppendPlacementNode(finishedWork, before, parent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isHostParent</span>(<span class="params">fiber: Fiber</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    fiber.tag === HostComponent ||</span><br><span class="line">    fiber.tag === HostRoot ||</span><br><span class="line">    fiber.tag === HostPortal</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getHostSibling</span>(<span class="params">fiber: Fiber</span>): ?<span class="title">Instance</span> </span>&#123;</span><br><span class="line">  <span class="comment">// We're going to search forward into the tree until we find a sibling host</span></span><br><span class="line">  <span class="comment">// node. Unfortunately, if multiple insertions are done in a row we have to</span></span><br><span class="line">  <span class="comment">// search past them. This leads to exponential search for the next sibling.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Find a more efficient way to do this.</span></span><br><span class="line">  <span class="keyword">let</span> node: Fiber = fiber;</span><br><span class="line">  siblings: <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// If we didn't find anything, let's try the next sibling.</span></span><br><span class="line">    <span class="keyword">while</span> (node.sibling === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.return === <span class="literal">null</span> || isHostParent(node.return)) &#123;</span><br><span class="line">        <span class="comment">// If we pop out of the root or hit the parent the fiber we are the</span></span><br><span class="line">        <span class="comment">// last sibling.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.return;</span><br><span class="line">    &#125;</span><br><span class="line">    node.sibling.return = node.return;</span><br><span class="line">    node = node.sibling;</span><br><span class="line">    <span class="keyword">while</span> (</span><br><span class="line">      node.tag !== HostComponent &amp;&amp;</span><br><span class="line">      node.tag !== HostText &amp;&amp;</span><br><span class="line">      node.tag !== DehydratedFragment</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// If it is not host node and, we might have a host node inside it.</span></span><br><span class="line">      <span class="comment">// Try to search down until we find one.</span></span><br><span class="line">      <span class="keyword">if</span> (node.flags &amp; Placement) &#123;</span><br><span class="line">        <span class="comment">// If we don't have a child, try the siblings instead.</span></span><br><span class="line">        <span class="keyword">continue</span> siblings;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// If we don't have a child, try the siblings instead.</span></span><br><span class="line">      <span class="comment">// We also skip portals because they are not part of this host tree.</span></span><br><span class="line">      <span class="keyword">if</span> (node.child === <span class="literal">null</span> || node.tag === HostPortal) &#123;</span><br><span class="line">        <span class="keyword">continue</span> siblings;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node.child.return = node;</span><br><span class="line">        node = node.child;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check if this host node is stable or about to be placed.</span></span><br><span class="line">    <span class="keyword">if</span> (!(node.flags &amp; Placement)) &#123;</span><br><span class="line">      <span class="comment">// Found it!</span></span><br><span class="line">      <span class="keyword">return</span> node.stateNode;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertOrAppendPlacementNodeIntoContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  node: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  before: ?Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">  parent: Container,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;tag&#125; = node;</span><br><span class="line">  <span class="keyword">const</span> isHost = tag === HostComponent || tag === HostText;</span><br><span class="line">  <span class="keyword">if</span> (isHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = node.stateNode;</span><br><span class="line">    <span class="keyword">if</span> (before) &#123;</span><br><span class="line">      insertInContainerBefore(parent, stateNode, before);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      appendChildToContainer(parent, stateNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === HostPortal) &#123;</span><br><span class="line">    <span class="comment">// If the insertion itself is a portal, then we don't want to traverse</span></span><br><span class="line">    <span class="comment">// down its children. Instead, we'll get insertions from each child in</span></span><br><span class="line">    <span class="comment">// the portal directly.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> child = node.child;</span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      insertOrAppendPlacementNodeIntoContainer(child, before, parent);</span><br><span class="line">      <span class="keyword">let</span> sibling = child.sibling;</span><br><span class="line">      <span class="keyword">while</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">        insertOrAppendPlacementNodeIntoContainer(sibling, before, parent);</span><br><span class="line">        sibling = sibling.sibling;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertOrAppendPlacementNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  node: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  before: ?Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">  parent: Instance,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;tag&#125; = node;</span><br><span class="line">  <span class="keyword">const</span> isHost = tag === HostComponent || tag === HostText;</span><br><span class="line">  <span class="keyword">if</span> (isHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = node.stateNode;</span><br><span class="line">    <span class="keyword">if</span> (before) &#123;</span><br><span class="line">      insertBefore(parent, stateNode, before);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      appendChild(parent, stateNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === HostPortal) &#123;</span><br><span class="line">    <span class="comment">// If the insertion itself is a portal, then we don't want to traverse</span></span><br><span class="line">    <span class="comment">// down its children. Instead, we'll get insertions from each child in</span></span><br><span class="line">    <span class="comment">// the portal directly.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> child = node.child;</span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      insertOrAppendPlacementNode(child, before, parent);</span><br><span class="line">      <span class="keyword">let</span> sibling = child.sibling;</span><br><span class="line">      <span class="keyword">while</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">        insertOrAppendPlacementNode(sibling, before, parent);</span><br><span class="line">        sibling = sibling.sibling;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="commitLayoutEffects"><a href="#commitLayoutEffects" class="headerlink" title="commitLayoutEffects"></a><code>commitLayoutEffects</code></h5><p>执行生命周期钩子，在离开当前节点时调用钩子函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle,inProgressLanes,inProgressRoot 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  inProgressLanes = committedLanes</span><br><span class="line">  inProgressRoot = root</span><br><span class="line">  nextEffect = finishedWork</span><br><span class="line"></span><br><span class="line">  commitLayoutEffects_begin(finishedWork, root, committedLanes)</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span></span><br><span class="line">  inProgressRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutEffects_begin</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  subtreeRoot: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Suspense layout effects semantics don't change for legacy roots.</span></span><br><span class="line">  <span class="keyword">const</span> isModernRoot = (subtreeRoot.mode &amp; ConcurrentMode) !== NoMode</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> firstChild = fiber.child</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics &amp;&amp; isModernRoot) &#123;</span><br><span class="line">      <span class="comment">// Keep track of the current Offscreen stack's state.</span></span><br><span class="line">      <span class="keyword">if</span> (fiber.tag === OffscreenComponent) &#123;</span><br><span class="line">        <span class="keyword">const</span> current = fiber.alternate</span><br><span class="line">        <span class="keyword">const</span> wasHidden = current !== <span class="literal">null</span> &amp;&amp; current.memoizedState !== <span class="literal">null</span></span><br><span class="line">        <span class="keyword">const</span> isHidden = fiber.memoizedState !== <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> newOffscreenSubtreeIsHidden = isHidden || offscreenSubtreeIsHidden</span><br><span class="line">        <span class="keyword">const</span> newOffscreenSubtreeWasHidden =</span><br><span class="line">          wasHidden || offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          newOffscreenSubtreeIsHidden !== offscreenSubtreeIsHidden ||</span><br><span class="line">          newOffscreenSubtreeWasHidden !== offscreenSubtreeWasHidden</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevOffscreenSubtreeIsHidden = offscreenSubtreeIsHidden</span><br><span class="line">          <span class="keyword">const</span> prevOffscreenSubtreeWasHidden = offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Traverse the Offscreen subtree with the current Offscreen as the root.</span></span><br><span class="line">          offscreenSubtreeIsHidden = newOffscreenSubtreeIsHidden</span><br><span class="line">          offscreenSubtreeWasHidden = newOffscreenSubtreeWasHidden</span><br><span class="line">          commitLayoutEffects_begin(</span><br><span class="line">            fiber, <span class="comment">// New root; bubble back up to here and stop.</span></span><br><span class="line">            root,</span><br><span class="line">            committedLanes</span><br><span class="line">          )</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Restore Offscreen state and resume in our-progress traversal.</span></span><br><span class="line">          nextEffect = fiber</span><br><span class="line">          offscreenSubtreeIsHidden = prevOffscreenSubtreeIsHidden</span><br><span class="line">          offscreenSubtreeWasHidden = prevOffscreenSubtreeWasHidden</span><br><span class="line">          commitLayoutMountEffects_complete(subtreeRoot, root, committedLanes)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fiber.subtreeFlags &amp; LayoutMask) !== NoFlags &amp;&amp; firstChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(firstChild, fiber)</span><br><span class="line">      nextEffect = firstChild</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics &amp;&amp; isModernRoot) &#123;</span><br><span class="line">        <span class="keyword">const</span> visibilityChanged =</span><br><span class="line">          !offscreenSubtreeIsHidden &amp;&amp; offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO (Offscreen) Also check: subtreeFlags &amp; LayoutStatic</span></span><br><span class="line">        <span class="keyword">if</span> (visibilityChanged &amp;&amp; firstChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// We've just shown or hidden a Offscreen tree that contains layout effects.</span></span><br><span class="line">          <span class="comment">// We only enter this code path for subtrees that are updated,</span></span><br><span class="line">          <span class="comment">// because newly mounted ones would pass the LayoutMask check above.</span></span><br><span class="line">          ensureCorrectReturnPointer(firstChild, fiber)</span><br><span class="line">          nextEffect = firstChild</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      commitLayoutMountEffects_complete(subtreeRoot, root, committedLanes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutMountEffects_complete</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  subtreeRoot: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Suspense layout effects semantics don't change for legacy roots.</span></span><br><span class="line">  <span class="keyword">const</span> isModernRoot = (subtreeRoot.mode &amp; ConcurrentMode) !== NoMode</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      enableSuspenseLayoutEffectSemantics &amp;&amp;</span><br><span class="line">      isModernRoot &amp;&amp;</span><br><span class="line">      offscreenSubtreeWasHidden &amp;&amp;</span><br><span class="line">      !offscreenSubtreeIsHidden</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// Inside of an Offscreen subtree that changed visibility during this commit.</span></span><br><span class="line">      <span class="comment">// If this subtree was hidden, layout effects will have already been destroyed (during mutation phase)</span></span><br><span class="line">      <span class="comment">// but if it was just shown, we need to (re)create the effects now.</span></span><br><span class="line">      <span class="comment">// TODO (Offscreen) Check: flags &amp; LayoutStatic</span></span><br><span class="line">      <span class="keyword">switch</span> (fiber.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">        <span class="keyword">case</span> ForwardRef:</span><br><span class="line">        <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">          safelyCallCommitHookLayoutEffectListMount(fiber, fiber.return)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> instance = fiber.stateNode</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.componentDidMount === <span class="string">'function'</span>) &#123;</span><br><span class="line">            safelyCallComponentDidMount(fiber, fiber.return, instance)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// TODO (Offscreen) Check flags &amp; RefStatic</span></span><br><span class="line">      <span class="keyword">switch</span> (fiber.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent:</span><br><span class="line">        <span class="keyword">case</span> HostComponent:</span><br><span class="line">          safelyAttachRef(fiber, fiber.return)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((fiber.flags &amp; LayoutMask) !== NoFlags) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = fiber.alternate</span><br><span class="line">      commitLayoutEffectOnFiber(root, current, fiber, committedLanes)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fiber === subtreeRoot) &#123;</span><br><span class="line">      nextEffect = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, fiber.return)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/06/14/react的同步更新/" data-id="clnpxkbwd0073lwdz39plipu0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/">react</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/06/15/Performance/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Performance
        
      </div>
    </a>
  
  
    <a href="/2021/06/12/react中的事件/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">react中的事件</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-language/">C/C++语言</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">62</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeORM/">TypeORM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/">TypeScript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/antd/">antd</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/express/">express</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/form/">form</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/other/">other</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/">react</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/">webpack</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/插件/">插件</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/浏览器/">浏览器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solution/">算法</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">计算机网络</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/source/">资源</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/c-language/" style="font-size: 12.86px;">C/C++语言</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/TypeORM/" style="font-size: 10px;">TypeORM</a> <a href="/tags/TypeScript/" style="font-size: 10px;">TypeScript</a> <a href="/tags/antd/" style="font-size: 10px;">antd</a> <a href="/tags/express/" style="font-size: 11.43px;">express</a> <a href="/tags/form/" style="font-size: 10px;">form</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/mysql/" style="font-size: 11.43px;">mysql</a> <a href="/tags/node/" style="font-size: 18.57px;">node</a> <a href="/tags/other/" style="font-size: 15.71px;">other</a> <a href="/tags/react/" style="font-size: 17.14px;">react</a> <a href="/tags/webpack/" style="font-size: 12.86px;">webpack</a> <a href="/tags/插件/" style="font-size: 10px;">插件</a> <a href="/tags/浏览器/" style="font-size: 10px;">浏览器</a> <a href="/tags/solution/" style="font-size: 14.29px;">算法</a> <a href="/tags/network/" style="font-size: 15.71px;">计算机网络</a> <a href="/tags/source/" style="font-size: 11.43px;">资源</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/10/">十月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/10/15/js打印分页/">js打印分页</a>
          </li>
        
          <li>
            <a href="/2022/11/28/高德地图/">高德地图</a>
          </li>
        
          <li>
            <a href="/2022/11/28/pixi-js/">pixi.js</a>
          </li>
        
          <li>
            <a href="/2022/08/21/js获取方位信息/">js获取方位信息</a>
          </li>
        
          <li>
            <a href="/2022/08/20/js获取位置信息/">js获取位置信息</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 奔跑的蜗牛<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">分类</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>